
<p>If you have services that run on Docker containers in Amazon ECS (like Cassandra, Redis, MySQL, and <a href="#requirements">other supported services</a>), you can use New Relic to report data from those services, from the host, and from the containers.</p>
<h2>Requirements</h2>
<p>To monitor services running on ECS, you must meet these requirements:</p>
<ul>
  <li>An <a href="https://aws.amazon.com/autoscaling/">auto-scaling</a> ECS cluster running Amazon Linux, CentOS, or RHEL that meets the <a href="/docs/infrastructure/new-relic-infrastructure/getting-started/compatibility-requirements-new-relic-infrastructure">infrastructure agent compatibility and requirements</a>.</li>
  <li>ECS tasks must have <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html#network_mode">network mode</a> set to <code>none</code> or <code>bridge</code> (<code>awsvpc</code> and <code>host</code> not supported).</li>
  <li>A supported service running on ECS that meets our integration requirements:
    <ul>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/apache-monitoring-integration">Apache</a> (does not report <a href="/docs/integrations/new-relic-integrations/getting-started/understand-use-data-infrastructure-integrations#overview">inventory data</a>)</li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/cassandra-monitoring-integration">Cassandra</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/couchbase-monitoring-integration">Couchbase</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/elasticsearch-monitoring-integration">Elasticsearch</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/haproxy-monitoring-integration">HAProxy</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/hashicorp-consul-monitoring-integration">HashiCorp Consul</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/jmx-monitoring-integration">JMX</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/kafka-monitoring-integration">Kafka</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/memcached-monitoring-integration">Memcached</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/mongodb-monitoring-integration">MongoDB</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/mysql-monitoring-integration">MySQL</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/nginx-monitoring-integration">NGINX</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/postgresql-monitoring-integration">PostgreSQL</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/rabbitmq-monitoring-integration">RabbitMQ</a> (does not report <a href="/docs/integrations/new-relic-integrations/getting-started/understand-use-data-infrastructure-integrations#overview">inventory data</a>)</li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/redis-monitoring-integration">Redis</a></li>
      <li><a href="/docs/integrations/host-integrations/host-integrations-list/snmp-monitoring-integration">SNMP</a></li>
    </ul>
  </li>
</ul>
<h2>How to enable [#enable-overview]</h2>
<p>Before explaining how to enable monitoring of services running in ECS, here's an overview of the process:</p>
<ol>
  <li><a href="#enable-ec2">Enable Amazon EC2</a> to install our infrastructure agent on your ECS clusters.</li>
  <li><a href="#enable-services">Enable monitoring of services</a> using a service-specific configuration file.</li>
</ol>
<h2>Step 1: Enable EC2 to install the infrastructure agent [#enable-ec2]</h2>
<p>First, you must enable Amazon EC2 to install our infrastructure agent on ECS clusters. To do this, you'll first need to update your user data to install the infrastructure agent on launch.</p>
<p>Here are instructions for changing EC2 launch configuration (taken from <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/change-launch-config.html">Amazon EC2 documentation</a>):</p>
<ol>
  <li>
    <p>Open the <a href="https://console.aws.amazon.com/ec2">Amazon EC2 console</a>.</p>
  </li>
  <li>
    <p>On the navigation pane, under <strong>Auto scaling</strong>, choose <strong>Launch configurations</strong>.</p>
  </li>
  <li>
    <p>On the next page, select the launch configuration you want to update.</p>
  </li>
  <li>
    <p>Right click and select <strong>Copy launch configuration</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Launch configuration details</strong> tab, click <strong>Edit details</strong>.</p>
  </li>
  <li>
    <p>Replace user data with one of the following snippets:</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoib3MtMSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiRm9yIENlbnRPUyA2LCBSSEVMIDYsIEFtYXpvbiBMaW51eCAxIn1d">
        <div data-prop-text="title">For CentOS 6, RHEL 6, Amazon Linux 1</div>
        <p>Replace the highlighted fields with relevant values:</p>
        <pre><code>Content-Type: multipart/mixed; boundary="MIMEBOUNDARY"
MIME-Version: 1.0

--MIMEBOUNDARY
Content-Disposition: attachment; filename="init.cfg"
Content-Transfer-Encoding: 7bit
Content-Type: text/cloud-config
Mime-Version: 1.0

yum_repos:
    newrelic-infra:
        baseurl: https://download.newrelic.com/infrastructure_agent/linux/yum/el/6/x86_64
        gpgkey: https://download.newrelic.com/infrastructure_agent/gpg/newrelic-infra.gpg
        gpgcheck: 1
        repo_gpgcheck: 1
        enabled: true
        name: New Relic Infrastructure
write_files:
-   content: |
        ---
        # New Relic config file
        license_key: YOUR_LICENSE_KEY
    path: /etc/newrelic-infra.yml
packages:
  - newrelic-infra
  - nri-*
runcmd:
  - [ systemctl, daemon-reload ]
  - [ systemctl, enable, newrelic-infra-service ]
  - [ systemctl, start, --no-block, newrelic-infra-service ]

--MIMEBOUNDARY
Content-Transfer-Encoding: 7bit
Content-Type: text/x-shellscript
Mime-Version: 1.0

#!/bin/bash

# ECS config
{
  echo "ECS_CLUSTER=YOUR_CLUSTER_NAME"
} >> /etc/ecs/ecs.config

start ecs

echo "Done"
--MIMEBOUNDARY--

</code></pre>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoib3MtMiJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiQ2VudE9TIDcsIFJIRUwgNywgQW1hem9uIExpbnV4IDIifV0=">
        <div data-prop-text="title">CentOS 7, RHEL 7, Amazon Linux 2</div>
        <p>Replace the highlighted fields with relevant values:</p>
        <pre><code>Content-Type: multipart/mixed; boundary="MIMEBOUNDARY"
MIME-Version: 1.0

--MIMEBOUNDARY
Content-Disposition: attachment; filename="init.cfg"
Content-Transfer-Encoding: 7bit
Content-Type: text/cloud-config
Mime-Version: 1.0

yum_repos:
    newrelic-infra:
        baseurl: https://download.newrelic.com/infrastructure_agent/linux/yum/el/7/x86_64
        gpgkey: https://download.newrelic.com/infrastructure_agent/gpg/newrelic-infra.gpg
        gpgcheck: 1
        repo_gpgcheck: 1
        enabled: true
        name: New Relic Infrastructure
write_files:
-   content: |
        ---
        # New Relic config file
        license_key: YOUR_LICENSE_KEY
    path: /etc/newrelic-infra.yml
packages:
  - newrelic-infra
  - nri-*
runcmd:
  - [ systemctl, daemon-reload ]
  - [ systemctl, enable, newrelic-infra-service ]
  - [ systemctl, start, --no-block, newrelic-infra-service ]

--MIMEBOUNDARY
Content-Transfer-Encoding: 7bit
Content-Type: text/x-shellscript
Mime-Version: 1.0

#!/bin/bash

# ECS config
{
  echo "ECS_CLUSTER=YOUR_ECS_CLUSTER_NAME"
} >> /etc/ecs/ecs.config

start ecs

echo "Done"
--MIMEBOUNDARY--

</code></pre>
      </div>
    </div>
  </li>
  <li>
    <p>Choose <strong>Skip to review</strong>.</p>
  </li>
  <li>
    <p>Choose <strong>Create launch configuration</strong>.</p>
  </li>
</ol>
<p>Next, update the auto scaling group:</p>
<ol>
  <li>Open the <a href="https://console.aws.amazon.com/ec2">Amazon EC2 console</a>.</li>
  <li>On the navigation pane, under <strong>Auto scaling</strong>, choose <strong>Auto scaling groups</strong>.</li>
  <li>Select the auto scaling group you want to update.</li>
  <li>From the <strong>Actions</strong> menu, choose <strong>Edit</strong>.</li>
  <li>In the drop-down menu for <strong>Launch configuration</strong>, select the new launch configuration created.</li>
  <li>Click <strong>Save</strong>.</li>
</ol>
<p>To test if the agent is automatically detecting instances, <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/terminating-instances.html">terminate an EC2 instance</a> in the auto scaling group: the replacement instance will now be launched with the new user data. After five minutes, you should see data from the new host on the <a href="/docs/infrastructure/infrastructure-ui-pages/infrastructure-ui/infrastructure-hosts-page">Hosts page</a>.</p>
<p>Next, move on to enabling the monitoring of services.</p>
<h2>Step 2: Enable monitoring of services [#enable-services]</h2>
<p>Once you've <a href="#enable-ec2">enabled EC2 to run the infrastructure agent</a>, the agent starts monitoring the containers running on that host.</p>
<p>Next, we'll explain how to monitor services deployed on ECS. For example, you can monitor an ECS task containing an NGINX instance that sits in front of your application server.</p>
<p>Here's a brief overview of how you'd monitor a <a href="#requirements">supported service</a> deployed on ECS:</p>
<ol>
  <li>Create a YAML configuration file for the service you want to monitor. This will eventually be placed in the EC2 user data section via the AWS console. But before doing that, you can test that the config is working by placing that file in the infrastructure agent folder (<code>etc/newrelic-infra/integrations.d</code>) in EC2. That config file must use our <a href="/docs/integrations/host-integrations/installation/container-auto-discovery">container auto-discovery</a> format, which allows it to automatically find containers. The exact config options will depend on the specific <a href="/docs/integrations/host-integrations/host-integrations-list">integration</a>.</li>
  <li>Check to see that data from the service is being reported to New Relic.</li>
  <li>If you are satisfied with the data you see, you can then use the EC2 console to add that configuration to the appropriate launch configuration, in the <code>write_files</code> section, and then update the auto scaling group.</li>
</ol>
<p>Here's a detailed example of doing the above procedure for NGINX:</p>
<ol>
  <li>
    <p>Ensure you have SSH access to the server or access to <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html">AWS Systems Manager Session Manager</a>. Log in to the host running the infrastructure agent.</p>
  </li>
  <li>
    <p>Via the command line, change the directory to the integrations configuration folder:</p>
    <pre><code>cd /etc/newrelic-infra/integrations.d
</code></pre>
  </li>
  <li>
    <p>Create a file called <code>nginx-config.yml</code> and add the following snippet:</p>
    <pre><code>---
discovery:
  docker:
    match:
      image: /nginx/
integrations:
  - name: nri-nginx
    env:
      STATUS_URL: http://${discovery.ip}:/status
      REMOTE_MONITORING: true
      METRICS: 1
</code></pre>
    <p>This configuration causes the infrastructure agent to look for containers in ECS that contain <code>nginx</code>. Once a container matches, it then connects to the NGINX status page. For details on how the <code>discovery.ip</code> snippet works, see <a href="/docs/integrations/host-integrations/installation/container-auto-discovery">auto-discovery</a>. For details on general NGINX configuration, see the <a href="/docs/integrations/host-integrations/host-integrations-list/nginx-monitoring-integration#config">NGINX integration</a>.</p>
  </li>
  <li>
    <p>If your NGINX status page is set to serve requests from the <code>STATUS_URL</code> on port 80, the infrastructure agent starts monitoring it. After five minutes, verify that NGINX data is appearing in the Infrastructure UI (either: <a href="http://one.newrelic.com"><strong>one.newrelic.com</strong></a> <strong>> Infrastructure > Third party services</strong>, or <strong><a href="https://one.newrelic.com">one.newrelic.com</a> > Entity explorer > On-host</strong>).</p>
  </li>
  <li>
    <p>If the configuration works, place it in the EC2 launch configuration:</p>
    <ol>
      <li>
        <p>Open the <a href="https://console.aws.amazon.com/ec2">Amazon EC2 console</a>.</p>
      </li>
      <li>
        <p>On the navigation pane, under <strong>Auto scaling</strong>, choose <strong>Launch configurations</strong>.</p>
      </li>
      <li>
        <p>On the next page, select the launch configuration you want to update.</p>
      </li>
      <li>
        <p>Right click and select <strong>Copy launch configuration</strong>.</p>
      </li>
      <li>
        <p>On the <strong>Launch configuration details</strong> tab, click <strong>Edit details</strong>.</p>
      </li>
      <li>
        <p>In the <strong>User data</strong> section, edit the <code>write_files</code> section (in the part marked <code>text/cloud-config</code>).</p>
      </li>
      <li>
        <p>Add a new file/content entry:</p>
        <pre><code>-   content: |
   ---
   discovery:
     docker:
       match:
         image: /nginx/
   integrations:
     - name: nri-nginx
       env:
         STATUS_URL: http://${discovery.ip}:/status
         REMOTE_MONITORING: true
         METRICS: 1
    path: /etc/newrelic-infra/integrations.d/nginx-config.yml
</code></pre>
      </li>
    </ol>
  </li>
  <li>
    <p>Choose <strong>Skip to review</strong>.</p>
  </li>
  <li>
    <p>Choose <strong>Create launch configuration</strong>.</p>
  </li>
  <li>
    <p>Next, update the auto scaling group:</p>
    <ol>
      <li>Open the <a href="https://console.aws.amazon.com/ec2/">Amazon EC2 console</a>.</li>
      <li>On the navigation pane, under <strong>Auto scaling</strong>, choose <strong>Auto scaling groups</strong>.</li>
      <li>Select the auto scaling group you want to update.</li>
      <li>From the <strong>Actions</strong> menu, choose <strong>Edit</strong>.</li>
      <li>In the drop down menu for <strong>Launch configuration</strong>, select the new launch configuration created.</li>
      <li>Click <strong>Save</strong>.</li>
    </ol>
  </li>
</ol>
<p>When an EC2 instance is terminated, it is replaced with a new one that automatically looks for new NGINX containers.</p>
