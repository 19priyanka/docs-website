
<p>The second version of our StatsD integration was released on May 25 2020. It's an improvement on our <a href="/docs/integrations/host-integrations/host-integrations-list/statsd-monitoring-integration">first StatsD integration</a>. Improvements include: simpler configuration, and a simpler method for adding tags (key-value pairs).</p>
<h2>Features</h2>
<p>Our StatsD integration (version 2) lets you easily get <a href="https://github.com/statsd/statsd">StatsD</a>-format data into New Relic. You can also add any arbitrary tags (key-value pairs) to your data. Once your metrics are in New Relic, you can <a href="#find-use-data">query your data</a> and create custom charts and dashboards.</p>
<h2>Requirements</h2>
<p>This integration uses our <a href="/docs/data-ingest-apis/get-data-new-relic/metric-api/introduction-metric-api">Metric API</a> and our <a href="/docs/insights/insights-data-sources/custom-data/introduction-event-api">Event API</a> to ingest data. To use these APIs, you'll need an <a href="/docs/insights/insights-data-sources/custom-data/introduction-event-api#register">Insert API key</a>.</p>
<p>The integration adheres to the Metric API <a href="/docs/data-ingest-apis/get-data-new-relic/metric-api/metric-api-limits-restricted-attributes">requirements and data limits</a>. The default rate limit is 100,000 data points per minute (DPM). If you think you're missing metrics or sending more than 100K DPM, see <a href="/docs/data-ingest-apis/get-data-new-relic/metric-api/metric-api-limits-restricted-attributes#accounts-asterisk">Request data changes</a>. To see if your account is hitting the rate limit, run the following <a href="/docs/query-data/nrql-new-relic-query-language/getting-started/introduction-nrql">NRQL query</a>:</p>
<pre><code>SELECT count(*) FROM NrIntegrationError 
  WHERE newRelicFeature ='Metrics' 
  FACET category, message
  LIMIT 100 since 1 day ago
</code></pre>
<h2>Install</h2>
<p>This section will explain how to do a standard install. If you want to run StatsD in Kubernetes, see <a href="#kubernetes">Kubernetes install</a>.</p>
<p>To install the StatsD integration, run the following command and include your <a href="/docs/accounts/install-new-relic/account-setup/account-id">New Relic account ID</a> and <a href="#requirements">New Relic Insert API key</a>. This generates a TOML configuration file used by <code>gostatsd</code>.</p>
<pre><code>docker run \
  -d --restart unless-stopped \
  --name newrelic-statsd \
  -h $(hostname) \
  -e NR_ACCOUNT_ID=YOUR_ACCOUNT_ID \
  -e NR_API_KEY=YOUR_INSERT_API_KEY \
  -p 8125:8125/udp \
  newrelic/nri-statsd:2.0.0
</code></pre>
<p>If your account is in the <a href="/docs/using-new-relic/welcome-new-relic/get-started/introduction-eu-region-data-center">EU data center region</a>, add this to the above command:</p>
<pre><code>-e NR_EU_REGION=true \
</code></pre>
<p>After installing, you can:</p>
<ul>
  <li>Do optional <a href="#configure">additional configuration</a></li>
  <li><a href="#metric-format">Define your metrics</a></li>
  <li><a href="#add-tags">Add custom tags</a> to your data</li>
  <li><a href="#alerts">Create alerts</a></li>
</ul>
<h3>Install for Kubernetes [#kubernetes]</h3>
<p>Here are examples of Kubernetes manifests for deployment and service objects:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiazhzLW1hbmlmZXN0LWV4YW1wbGVzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJLdWJlcm5ldGVzIG1hbmlmZXN0IGV4YW1wbGVzIn1d">
    <div data-prop-text="title">Kubernetes manifest examples</div>
    <p>Below are examples of Kubernetes manifests to deploy StatsD in a Kubernetes environment and create a StatsD service named <code>newrelic-statsd</code>. You need to insert your <a href="/docs/accounts/install-new-relic/account-setup/account-id">account ID</a> and your <a href="/docs/accounts/install-new-relic/account-setup/license-key">license key</a>.</p>
    <p><strong>deployment.yml</strong>:</p>
    <pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: newrelic-statsd
  namespace: tooling
  labels:
    app: newrelic-statsd
spec:
  selector:
    matchLabels:
      app: newrelic-statsd
  replicas: 2
  revisionHistoryLimit: 2
  template:
    metadata:
      labels:
        app: newrelic-statsd
    spec:
      containers:
      - name: newrelic-statsd
        image: newrelic/nri-statsd:2.0.0
        env:
        - name: NR_ACCOUNT_ID
          value: "NEW_RELIC_ACCOUNT_ID"
        - name: NR_API_KEY
          value: "NEW_RELIC_LICENSE_KEY"

</code></pre>For configuration details, see [Kubernetes configuration](#k8s-config).
    <pre><code>
apiVersion: v1
kind: Service
metadata:
  name: newrelic-statsd
  namespace: tooling
  labels:
    app: newrelic-statsd
spec:
  type: ClusterIP
  ports:
  - name: newrelic-statsd
    port: 80
    targetPort: 8125
    protocol: UDP
  selector:
    app: newrelic-statsd

</code></pre>**service.yml**:
  </div>
</div>
<h2>Configure</h2>
<p>In the <a href="#install">install procedure</a>, you run <code>nri-statsd</code> with environment variables, and this generates a TOML configuration file. Additionally, you can set these configuration options:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Configuration options</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>expiry-interval</code></p>
        <p><em>string</em></p>
      </div>
      <div>
        <p>If a metric is not updated for this amount of time, we stop reporting that metric. Default is <code>5m</code>.</p>
        <p>If you want to send the metrics only if the value was updated between the flush intervals, configure this to <code>1ms</code>. To never expire metrics, set it to <code>0</code>.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>percent-threshold</code></p>
        <p><em>list of integers</em></p>
      </div>
      <div>
        <p>Specifies the percentiles used for metrics aggregation. Default: <code>90</code>.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>metrics-addr</code></p>
        <p><em>string</em></p>
      </div>
      <div>
        <p>Indicates address on which to listen for metrics. Default: <code>:8125</code>.</p>
      </div>
    </div>
  </div>
</div>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>To ensure FedRAMP compliance when using the StatsD integration you must define the following endpoints in the custom configuration:</p>
  <p><em>address = '<a href="https://gov-insights-collector.newrelic.com/v1/accounts/">https://gov-insights-collector.newrelic.com/v1/accounts/</a>$_NR_ACCOUNT_ID</em>/events'_</p>
  <p><em>address-metrics = '<a href="https://gov-infra-api.newrelic.com/metric/v1">https://gov-infra-api.newrelic.com/metric/v1</a>'</em></p>
</div>
<p>Here are some examples of customizing configuration by overwriting the default configuration:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlnLWV4YW1wbGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkV4YW1wbGUgb2YgY3VzdG9tIGNvbmZpZ3VyYXRpb24ifV0=">
    <div data-prop-text="title">Example of custom configuration</div>
    <pre><code># Specify after how long do we expire metrics, default:5m
expiry-interval = '1ms'

# percent-threshold specify a list of percentiles for metrics aggregation, default:90
percent-threshold = [90, 99]

backends='newrelic'
[newrelic]
# flush types supported: metrics,  insights, infra
flush-type = 'metrics'
transport = 'default'
address = 'https://insights-collector.newrelic.com/v1/accounts/$NR_ACCOUNT_ID/events'
address-metrics = 'https://metric-api.newrelic.com/metric/v1'
api-key = 'NEW_RELIC_API_KEY'

</code></pre>
    <pre><code>
# disabled-sub-metrics configuration section allows disabling timer sub-metrics
[disabled-sub-metrics]
# Regular metrics
count=false
count-per-second=false
mean=false
median=false
lower=false
upper=false
stddev=false
sum=false
sum-squares=false

# Percentile metrics
count-pct=false
mean-pct=false
sum-pct=false
sum-squares-pct=false
lower-pct=false
upper-pct=false

</code></pre>**Disable timer sub-metrics:**
    By default, `nri_statsd` calculates the following for timer metrics: standard deviation, mean, median, sum, lower, and upper bounds for the flush interval. If you want to disable those metrics you can do it by adding a `disabled-sub-metrics` configuration section and set `true` for the ones you want disabled. Here's an example:
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJjbGFzc05hbWUiLCJ2YWx1ZSI6ImZyZXEtbGluayJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZG9ja2VyLWNvbmZpZyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiRG9ja2VyOiBvdmVyd3JpdGUgZGVmYXVsdCBjb25maWd1cmF0aW9uIn1d">
    <div data-prop-text="title">Docker: overwrite default configuration</div>
    <p>To overwrite the default <code>nri-statsd</code> configuration while running in a container, you can mount a configuration file inside the container.</p>
    <p>You can adopt the following template as needed for your situation.</p>
    <p>Example:</p>
    <pre><code>backends='newrelic'
flush-interval='10s'

[newrelic]
# flush types supported: metrics,  insights, infra
flush-type = 'metrics'
transport = 'default'
address-metrics = 'https://metric-api.newrelic.com/metric/v1'
api-key = 'NEW_RELIC_API_KEY'

</code></pre>
    <pre><code>
docker run \
  ...
  -v ${PWD}/nri-statsd.toml:/etc/opt/newrelic/nri-statsd.toml \
  ...
  newrelic/nri-statsd:2.0.0

</code></pre>To run the container with the file mounted in the appropriate path:
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJjbGFzc05hbWUiLCJ2YWx1ZSI6ImZyZXEtbGluayJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiazhzLWNvbmZpZyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiS3ViZXJuZXRlczogb3ZlcndyaXRlIGRlZmF1bHQgY29uZmlndXJhdGlvbiJ9XQ==">
    <div data-prop-text="title">Kubernetes: overwrite default configuration</div>
    <p>The best approach to configure <code>nri-statsd</code> running in Kubernetes is to use a <code>configMap</code> and mount the <code>configMap</code> into the container. (This is a similar process to mounting the configuration file in Docker.)</p>
    <p>Example:</p>
    <pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: nri-statsd-config
  namespace: default
data:
  nri-statsd.toml: |
    backends='newrelic'
    flush-interval='10s'

    [newrelic]
    # flush types supported: metrics,  insights, infra
    flush-type = 'metrics'
    transport = 'default'
    address = 'https://metric-api.newrelic.com/metric/v1'
    api-key = '$NEW_RELIC_API_KEY'

</code></pre>
    <pre><code>
apiVersion: apps/v1
kind: Deployment
spec:
  template:
    spec:
    containers:
      ....
      volumeMounts:
        - mountPath: /etc/opt/newrelic/
          name: nri-statsd-config
    volumes:
      - name: nri-statsd-config
        configMap:
          name: nri-statsd-config

</code></pre>To use the configMap, declare a volume on your deployment spec template and then declare a `volumeMount` on your container spec.
    Example:
  </div>
</div>
<h2>Metric format</h2>
<p>The integration receives metrics using the <a href="https://github.com/statsd/statsd">StatsD protocol</a>. Optionally, the sample rate can be configured and tags can be added.</p>
<p>Here's the metric data format we use:</p>
<pre><code>&#x3C;metric name>:&#x3C;value>|&#x3C;type>|@&#x3C;sample rate>|#&#x3C;tags>
</code></pre>
<p>Here are explanations of these fields:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Field name</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>&#x3C;metric name><br><code>string</code></p>
      </div>
      <div>
        <p><strong>Required.</strong> Name of the metric.</p>
      </div>
    </div>
    <div>
      <div>
        <p>&#x3C;value><br><code>string</code></p>
      </div>
      <div>
        <p><strong>Required.</strong> The <a href="#metric-types">metric type</a>:</p>
        <ul>
          <li><code>c</code> = counter</li>
          <li><code>g</code> = gauge</li>
          <li><code>ms</code> = timer</li>
        </ul>
      </div>
    </div>
    <div>
      <div>
        <p>@&#x3C;sample rate><br><code>float</code></p>
      </div>
      <div>
        <p><strong>Optional</strong> for simple counters or timer counters. When many metrics must be sent, you can use sampling to reduce network traffic. The downside is a reduction in the resolution of the data.</p>
        <p>An example of how this would work for sample rates below <code>1</code>: If you set this to <code>0.1</code>, the counter would send a measurement one out of every 10 times.</p>
      </div>
    </div>
    <div>
      <div>
        <p>#&#x3C;tags><br><code>string</code></p>
      </div>
      <div>
        <p><strong>Optional.</strong> Tags attached to your metrics are converted into attributes (key-value pairs). For more on tagging options, see <a href="#add-tags">Tags</a>.</p>
      </div>
    </div>
  </div>
</div>
<h2>Metric types</h2>
<p>Here are the types of metrics and how to format them:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY291bnRlciJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiQ291bnRlciJ9XQ==">
    <div data-prop-text="title">Counter</div>
    <p>A counter measures the number of occurrences of an event. Examples include cache hits per reporting interval and the number of threads created per reporting interval.</p>
    <p>A counter can be incremented or decremented during the same flush interval by adding a sign to the value. In the following example, the counter value will be <code>2</code>:</p>
    <pre><code>counter:4|c
 counter:-2|c

</code></pre>
    <pre><code>
counter:4|c@0.1

</code></pre>At each flush, the current count is sent and reset to `0`. If the count is not updated, at the next flush it will send the value `0`. You can opt to disable this behavior by setting [`expiry-interval`](#configure) to `1ms`.
    Here’s an example of a counter that is being sampled 1 out of 10 times:
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZ2F1Z2UifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkdhdWdlIn1d">
    <div data-prop-text="title">Gauge</div>
    <p>A gauge represents a value that can increase or decrease with time. Examples of gauges include temperature, CPU usage, and memory. Here's an example:</p>
    <pre><code>temperature:40|g

</code></pre>If the gauge is not updated, at the next flush it will send the previous value. You can opt to disable this behavior by setting [`expiry-interval`](#configure) to `1ms`.
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidGltZXIifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IlRpbWVyIn1d">
    <div data-prop-text="title">Timer</div>
    <p>The timer metric type measures timing data.</p>
    <p>By default, <code>nri_statsd</code> calculates the following for timer metrics: standard deviation, mean, median, sum, lower, and upper bounds for the flush interval. These are sent as sub-metrics in the following format:</p>
    <pre><code>&#x3C;metric_base_name>.std_dev 
&#x3C;metric_base_name>.median
&#x3C;metric_base_name>.summary
&#x3C;metric_base_name>.sum_squares
&#x3C;metric_base_name>.mean
&#x3C;metric_base_name>.per_second

</code></pre>The percentile threshold can be tweaked with the [`percent-threshold`](#configure) config option. These can be controlled through the [`disabled-sub-metrics` configuration section](#config-example).
    <pre><code>
&#x3C;metric_base_name>.sum_squares.percentiles
&#x3C;metric_base_name>.sum.percentiles
&#x3C;metric_base_name>.count.percentiles
&#x3C;metric_base_name>.upper.percentiles
&#x3C;metric_base_name>.mean.percentiles

</code></pre>The configured percentiles will generate the following metrics. The percentile threshold value will be attached as a tag.
  </div>
</div>
<h2>Add tags (attributes) [#add-tags]</h2>
<p>You can add tags to your data, which we save as <a href="/docs/using-new-relic/welcome-new-relic/get-started/glossary#attribute">attributes</a> (key-value pairs). There are two options for adding tags:</p>
<ul>
  <li>Add default tags that apply to all metrics: These apply to all metrics. They are fixed and don't change over time.</li>
  <li>Add metric-level tags: These apply to specific metrics and allow the value to be changed between two submits.</li>
</ul>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidGFncy1ucmktc3RhdHNkIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJBZGQgZGVmYXVsdCB0YWdzIHRoYXQgYXBwbHkgdG8gYWxsIG1ldHJpY3MifV0=">
    <div data-prop-text="title">Add default tags that apply to all metrics</div>
    <p>Add tags to metrics and events by defining an environment variable in the <a href="#install">startup command</a>.</p>
    <p>Here's an example that would create two tags:</p>
    <pre><code>-e TAGS="environment:production region:us"

</code></pre>
    <pre><code>
docker run \
  -d --restart unless-stopped \
  --name newrelic-statsd \
  -h $(hostname) \
  -e NR_ACCOUNT_ID=YOUR_ACCOUNT_ID \
  -e NR_API_KEY=YOUR_INSERT_API_KEY \
  -e TAGS="environment:production region:us" \ 
  -p 8125:8125/udp \
  newrelic/nri-statsd:2.0.0

</code></pre>Here's that environment variable used in the [startup command](#install):
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidGFncy1hcHAtY29kZSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiQWRkIG1ldHJpYy1sZXZlbCB0YWdzIn1d">
    <div data-prop-text="title">Add metric-level tags</div>
    <p>When defining the <a href="#metric-format">metric format</a>, you can add tags using this format:</p>
    <pre><code>&#x3C;bucket name>:&#x3C;value>|&#x3C;type>|#&#x3C;tags>

</code></pre>In this example, `&#x3C;tags>` is a comma-separated list of tags. Tags format is: `simple` or `key:value`.
  </div>
</div>
<p>Here's an example <a href="/docs/query-data/nrql-new-relic-query-language/getting-started/introduction-nrql">NRQL</a> query that includes a custom tag:</p>
<pre><code>SELECT count(*) FROM Metric WHERE environment = 'production'
</code></pre>
<h2>Create alerts [#alerts]</h2>
<p>You can alert on StatsD data using <a href="/docs/alerts/new-relic-alerts/defining-conditions/create-alert-conditions-nrql-queries">NRQL alert conditions</a>.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYWxlcnQtZXhhbXBsZSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiQWxlcnQgZXhhbXBsZSJ9XQ==">
    <div data-prop-text="title">Alert example</div>
    <p>This procedure walks you through sending some sample data and then creating an alert condition using that data.</p>
    <p>First, send this data to New Relic’s StatsD container:</p>
    <pre><code>echo "prod.test.num:32|g" | nc -v -w 1 -u localhost 8125

</code></pre>
    <pre><code>
echo "prod.test.num:60|g" | nc -v -w 1 -u localhost 8125

</code></pre>Here's an image showing creating this NRQL alert condition. Notice that the sample data sent in is represented by the blue dot on the upper right of the chart.
    ![StatsD NRQL alert condition query](./images/statsd-nrql-alert-condition-example.png "statsd-nrql-alert-condition-example.png")
    Now we can create the alert condition with these settings:
    ![StatsD NRQL alert condition creation](./images/statsd-nrql-alert-condition-example-2.png "statsd-nrql-alert-condition-example-2.png")
    Remember to set the **Condition name**.
    If a metric with a value above 50 is sent, then an incident is created and notified. The incident is closed automatically after 24 hours. To test that the alert is working, run this command:
    <pre><code>
SELECT latest(prod.test.num) FROM Metric WHERE metricName = 'prod.test.num'

</code></pre>Next, create a [NRQL alert condition](/docs/alerts/new-relic-alerts/defining-conditions/create-alert-conditions-nrql-queries) using this query:
  </div>
</div>
<h2>Find and use data [#find-use-data]</h2>
<p>To query your data, you'd use any New Relic <a href="/docs/using-new-relic/data/understand-data/query-new-relic-data">query option</a>. For example, you might run a <a href="/docs/query-data/nrql-new-relic-query-language/getting-started/introduction-nrql">NRQL</a> query like:</p>
<pre><code>SELECT count(*) FROM Metric WHERE metricName = 'myMetric' and environment = 'production'
</code></pre>
<p>For more on how to query the <code>Metric</code> data type, see <a href="/docs/data-ingest-apis/get-data-new-relic/metric-api/view-query-you-metric-data">Query metric data</a>.</p>
<h2>Check the source code [#source-code]</h2>
<p>This integration is open source software. That means you can <a href="https://github.com/newrelic/nri-statsd/" title="Link opens in a new window.">browse its source code</a> and send improvements, or create your own fork and build it.</p>
