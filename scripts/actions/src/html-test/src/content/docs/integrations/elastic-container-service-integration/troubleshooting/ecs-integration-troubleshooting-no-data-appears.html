
<h2>Problem</h2>
<p>You installed our <a href="/docs/introduction-amazon-ecs-integration">on-host ECS integration</a> and waited a few minutes, but your cluster is not showing in the entity explorer.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>We have two ECS integrations: a <a href="/docs/integrations/amazon-integrations/aws-integrations-list/aws-ecsecr-monitoring-integration">cloud-based integration</a> and an on-host integration. This document is about the on-host integration.</p>
</div>
<h2>Solution</h2>
<p>If your New Relic account had previously installed the infrastructure agent or an infrastructure on-host integration, your data should appear in <a href="/docs/ecs-integration-understand-use-data">the UI</a> within a few minutes.</p>
<p>If your account had not previously done either of those things before installing the on-host ECS integration, it may take tens of minutes for data to appear in the UI. In that case, we recommend waiting up to an hour before doing the following troubleshooting steps or contacting support.</p>
<p>There are several options for troubleshooting no data appearing:</p>
<ul>
  <li><a href="#awscli">Troubleshoot via the awscli tool</a> (recommended when talking to New Relic technical support)</li>
  <li><a href="#ui">Troubleshoot via the UI</a></li>
</ul>
<p>For information about stopped tasks, see <a href="#stopped-tasks">Stopped tasks reasons</a>.</p>
<h3>Troubleshoot via awscli [#awscli]</h3>
<p>When interacting with New Relic support, use this method and send the generated files with your support request:</p>
<ol>
  <li>
    <p>Retrieve the information related to the <code>newrelic-infra</code> service or the Fargate service that contains a task with a <code>newrelic-infra</code> sidecar:</p>
    <pre><code>aws ecs describe-services --cluster YOUR_CLUSTER_NAME --service newrelic-infra > newrelic-infra-service.json
</code></pre>
    <pre><code>aws ecs describe-services --cluster YOUR_CLUSTER_NAME --service YOUR_FARGATE_SERVICE_WITH_NEW_RELIC_SIDECAR > newrelic-infra-sidecar-service.json
</code></pre>
  </li>
  <li>
    <p>The <code>failures</code> attribute details any errors for the services.</p>
  </li>
  <li>
    <p>Under <code>services</code> is the <code>status</code> attribute. It says <code>ACTIVE</code> if the service has no issues.</p>
  </li>
  <li>
    <p>The <code>desiredCount</code> should match the <code>runningCount</code>. This is the number of tasks the service is handling. Because we use the daemon service type, there should be one task per container instance in your cluster. The <code>pendingCount</code> attribute should be zero, because all tasks should be running.</p>
  </li>
  <li>
    <p>Inspect the <code>events</code> attribute of <code>services</code> to check for issues with scheduling or starting the tasks. For example: if the service is unable to start tasks successfully, it will display a message like:</p>
    <pre><code>{
  "id": "5295a13c-34e6-41e1-96dd-8364c42cc7a9",
  "createdAt": "2020-04-06T15:28:18.298000+02:00",
  "message": "(service newrelic-ifnra) is unable to consistently start tasks successfully. For more information, see the Troubleshooting section of the Amazon ECS Developer Guide."
}
</code></pre>
  </li>
  <li>
    <p>In the same section, you can also see which tasks were started by the service from the events:</p>
    <pre><code>{
  "id": "1c0a6ce2-de2e-49b2-b0ac-6458a804d0f0",
  "createdAt": "2020-04-06T15:27:49.614000+02:00",
  "message": "(service fargate-fail) has started 1 tasks: (task YOUR_TASK_ID)."
}
</code></pre>
  </li>
  <li>
    <p>Retrieve the information related to the task with this command:</p>
    <pre><code>aws ecs describe-tasks --tasks YOUR_TASK_ID --cluster YOUR_CLUSTER_NAME > newrelic-infra-task.json
</code></pre>
  </li>
  <li>
    <p>The <code>desiredStatus</code> and <code>lastStatus</code> should be <code>RUNNING</code>. If the task couldn't start normally, it will have a <code>STOPPED</code> status.</p>
  </li>
  <li>
    <p>Inspect the <code>stopCode</code> and <code>stoppedReason</code>. One reason example: a task that couldn't be started because the task execution role doesn't have the appropriate permissions to download the license-key-containing secret would have the following output:</p>
    <pre><code>"stopCode": "TaskFailedToStart",
"stoppedAt": "2020-04-06T15:28:54.725000+02:00",
"stoppedReason": "Fetching secret data from AWS Secrets Manager in region YOUR_AWS_REGION: secret arn:aws:secretsmanager:YOUR_AWS_REGION:YOUR_AWS_ACCOUNT:secret:NewRelicLicenseKeySecret-Dh2dLkgV8VyJ-80RAHS-fail: AccessDeniedException: User: arn:aws:sts::YOUR_AWS_ACCOUNT:assumed-role/NewRelicECSIntegration-Ne-NewRelicECSTaskExecution-1C0ODHVT4HDNT/8637b461f0f94d649e9247e2f14c3803 is not authorized to perform: secretsmanager:GetSecretValue on resource: arn:aws:secretsmanager:YOUR_AWS_REGION:YOUR_AWS_ACCOUNT:secret:NewRelicLicenseKeySecret-Dh2dLkgV8VyJ-80RAHS-fail-DmLHfs status code: 400, request id: 9cf1881e-14d7-4257-b4a8-be9b56e09e3c",
"stoppingAt": "2020-04-06T15:28:10.953000+02:00",
</code></pre>
  </li>
  <li>
    <p>If the task is running but you’re still not seeing data, generate <a href="/docs/infrastructure/infrastructure-troubleshooting/troubleshoot-logs/infrastructure-agent-logging-behavior">verbose logs</a> and examine them for errors.</p>
  </li>
</ol>
<p>For details about reasons for stopped tasks, see <a href="#stopped-tasks">Stopped tasks</a>.</p>
<h3>Troubleshoot in the UI [#ui]</h3>
<p>To use the UI to troubleshoot:</p>
<ol>
  <li>Log in to your AWS Console and navigate to the EC2 Container Service section.</li>
  <li>Click on the cluster where you installed the New Relic ECS integration.</li>
  <li>On the <strong>Services</strong> tab, use the filter to search for the integration service. If you used the automatic install script, the name of the service will be <code>newrelic-infra</code>. If you are using Fargate, it will be the name of your monitored service. Once found, click on the name.</li>
  <li>The service page shows the <strong>Status</strong> of the service. It says <code>ACTIVE</code> if the service has no issues.</li>
  <li>On the same page, the <strong>Desired</strong> count should match the <strong>Running</strong> count. This is the number of tasks the service is handling. Because we use the daemon service type, there should be one task per container instance in your cluster. Pending count should be zero, because all tasks should be running.</li>
  <li>Inspect the <strong>Events</strong> tab to check for issues with scheduling or starting the tasks.</li>
  <li>In the <strong>Tasks</strong> tab of your service, you can inspect the running tasks and the stopped tasks by clicking on the <strong>Task status</strong> selector. Containers that failed to start are shown when you select the <strong>Stopped</strong> status.</li>
  <li>Click on a task to go to the task details page. Under <strong>Stopped reason</strong>, it displays a message explaining why the task was stopped.</li>
  <li>If the task is running but you’re still not seeing data, generate <a href="/docs/infrastructure/infrastructure-troubleshooting/troubleshoot-logs/infrastructure-agent-logging-behavior">verbose logs</a> and examine them for errors.</li>
</ol>
<p>For details about reasons for stopped tasks, see <a href="#stopped-tasks">Stopped tasks</a>.</p>
<h3>Reasons for stopped tasks [#stopped-tasks]</h3>
<p>In the <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/troubleshooting.html">AWS ECS troubleshooting documentation</a> you can find information on common causes of errors related to running tasks and services. See below for details about some reasons for stopped tasks.</p>
<p><strong>Task stopped with reason:</strong></p>
<pre><code>Fetching secret data from AWS Secrets Manager 
  in region YOUR_AWS_REGION: 
  secret arn:aws:secretsmanager:YOUR_AWS_REGION:YOUR_AWS_ACCOUNT:secret:YOUR_SECRET_NAME: 
  AccessDeniedException: User: arn:aws:sts::YOUR_AWS_ACCOUNT:assumed-role/YOUR_ROLE_NAME 
  is not authorized to perform: secretsmanager:GetSecretValue 
  on resource: arn:aws:secretsmanager:YOUR_AWS_REGION:YOUR_AWS_ACCOUNT:secret:YOUR_SECRET_NAME 
  status code: 400, request id: 9cf1881e-14d7-4257-b4a8-be9b56e09e3c"
</code></pre>
<p>This means that the IAM role specified using <code>executionRoleArn</code> in the task definition doesn't have access to the secret used for the <code>NRIA_LICENSE_KEY</code>. The execution role should have a policy attached that grants it access to read the secret.</p>
<ol>
  <li>
    <p>Get the execution role of your task:</p>
    <pre><code>aws ecs describe-task-definition --task-definition newrelic-infra --output text --query taskDefinition.executionRoleArn
</code></pre>
    <p>You can replace the <code>--task-definition newrelic-infra</code> with the name of your fargate task that includes the sidecar container.</p>
    <pre><code>aws ecs describe-task-definition --task-definition YOUR_FARGATE_TASK_NAME --output text --query taskDefinition.executionRoleArn
</code></pre>
  </li>
  <li>
    <p>List the policies attached to role:</p>
    <pre><code>aws iam list-attached-role-policies --role-name YOUR_EXECUTION_ROLE_NAME
</code></pre>
    <p>This should return 3 policies <code>AmazonECSTaskExecutionRolePolicy</code>, <code>AmazonEC2ContainerServiceforEC2Role</code> and a third one that should grant read access to the license key. In the following example the policy it's named <code>NewRelicLicenseKeySecretReadAccess</code>.</p>
    <pre><code>{
  "AttachedPolicies": [
    {
      "PolicyName": "AmazonECSTaskExecutionRolePolicy",
      "PolicyArn": "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
    },
    {
      "PolicyName": "AmazonEC2ContainerServiceforEC2Role",
      "PolicyArn": "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role"
    },
    {
      "PolicyName": "YOUR_POLICY_NAME",
      "PolicyArn": "arn:aws:iam::YOUR_AWS_ACCOUNT:policy/YOUR_POLICY_NAME"
    }
  ]
}
</code></pre>
  </li>
  <li>
    <p>Retrieve the default policy version:</p>
    <pre><code>aws iam get-policy-version --policy-arn arn:aws:iam::YOUR_AWS_ACCOUNT:policy/YOUR_POLICY_NAME --version-id $(aws iam get-policy --policy-arn arn:aws:iam::YOUR_AWS_ACCOUNT:policy/YOUR_POLICY_NAME --output text --query Policy.DefaultVersionId)
</code></pre>
    <p>This retrieves the policy permissions. There should be an entry for Action<code>secretsmanager:GetSecretValue</code> if you used AWS Secrets Manager to store your license key, or an entry for <code>ssm:GetParameters</code>if you used AWS Systems Manager Parameter Store:</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYXdzLXNlY3JldHMtbWFuYWdlciJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiQVdTIFNlY3JldHMgTWFuYWdlciJ9XQ==">
        <div data-prop-text="title">AWS Secrets Manager</div>
        <pre><code>{
  "PolicyVersion": {
    "Document": {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Action": "secretsmanager:GetSecretValue",
          "Resource": "arn:aws:secretsmanager:YOUR_AWS_REGION:YOUR_AWS_ACCOUNT:secret:YOUR_SECRET_NAME",
          "Effect": "Allow"
        }
      ]
    },
    "VersionId": "v1",
    "IsDefaultVersion": true,
    "CreateDate": "2020-03-31T13:47:07+00:00"
  }
}

</code></pre>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYXdzLXN5c3RlbXMtbWFuYWdlci1wYXJhbWV0ZXItc3RvcmUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkFXUyBTeXN0ZW1zIE1hbmFnZXIgUGFyYW1ldGVyIFN0b3JlIn1d">
        <div data-prop-text="title">AWS Systems Manager Parameter Store</div>
        <pre><code>{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": "ssm:GetParameters",
      "Resource": [
        "arn:aws:ssm:YOUR_AWS_REGION:YOUR_AWS_ACCOUNT:parameter/YOUR_SECRET_NAME"
      ],
      "Effect": "Allow"
    }
  ]
}

</code></pre>
      </div>
    </div>
  </li>
</ol>
