
<p>Unless otherwise noted, configuration options for your Prometheus OpenMetrics integration with New Relic apply to both Docker and Kubernetes environments. At a minimum, the following configuration values are <strong>required</strong>:</p>
<ul>
  <li><a href="/docs/accounts-partnerships/accounts/account-setup/license-key">License key</a></li>
  <li><a href="#definitions-configuration-file">Cluster name</a></li>
</ul>
<p><strong>Recommendation:</strong> Configure your New Relic license key as an environment variable named <code>LICENSE_KEY</code>. This provides a more secure environment, as New Relic can load your environment variable from a <a href="/docs/integrations/prometheus-integrations/install-configure/add-mutual-tls-prometheus-endpoints">mutual TLS authentication secret</a>.</p>
<h2>Configure nri-prometheus-latest.yaml [#general-config]</h2>
<p>The <code>nri-prometheus-latest.yaml</code> manifest file includes the <code>nri-prometheus-cfg</code> map showing an example configuration. Use the manifest file to configure the following parameters.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1jb25maWd1cmF0aW9uLWZpbGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkV4YW1wbGUgY29uZmlndXJhdGlvbiBmaWxlIn1d">
    <div data-prop-text="title">Example configuration file</div>
    <p>The following is an example configuration file that you can save and modify to fit your needs. For more information, see the documentation about <a href="/docs/integrations/prometheus-integrations/install-configure/add-mutual-tls-prometheus-endpoints">mutual TLS authentication</a> and <a href="/docs/integrations/prometheus-integrations/view-query-data/translate-promql-queries-nrql">translating PromQL to NRQL</a>.</p>
    <pre><code># The name of your cluster. It's important to match other New Relic products to relate the data.
cluster_name: "my-cluster-name"

# How often the integration should run. Defaults to 30s.
# scrape_duration: "30s"

# The HTTP client timeout when fetching data from endpoints. Defaults to 5s.
# scrape_timeout: "5s"

# Whether the integration should run in verbose mode or not. Defaults to false.
verbose: false

# Whether the integration should skip TLS verification or not. Defaults to false.
insecure_skip_verify: false

# The label used to identify scrapeable targets. Defaults to "prometheus.io/scrape".
scrape_enabled_label: "prometheus.io/scrape"

# Whether nodes need to be labeled to be scraped or not. Defaults to true.
require_scrape_enabled_label_for_nodes: true

# targets:
# - description: "Secure etcd example"
#   urls: ["https://123.456.7.1:2379", "https://123.456.7.2:2379"]
#   tls_config:
#     ca_file_path: "/etc/etcd/etcd-client-ca.crt"
#     cert_file_path: "/etc/etcd/etcd-client.crt"
#     key_file_path: "/etc/etcd/etcd-client.key"

# Proxy to be used by the emitters when submitting metrics. It should be
# in the format [scheme]://[domain]:[port].
# The emitter is the component in charge of sending the scraped metrics.
# This proxy won't be used when scraping metrics from the targets.
# By default it's empty, meaning that no proxy will be used.
# emitter_proxy: "http://localhost:8888"

# Certificate to add to the root CA that the emitter will use when
# verifying server certificates.
# If left empty, TLS uses the host's root CA set.
# emitter_ca_file: "/path/to/cert/server.pem"

# Whether the emitter should skip TLS verification when submitting data.
# Defaults to false.
# emitter_insecure_skip_verify: false

# Set to true in order to disable autodiscovery in the k8s cluster. 
# It can be useful when running the Pod with a service account
# having limited privileges. Defaults to false.
# disable_autodiscovery: false

# Histogram support is based on New Relic's guidelines for higher
# level metrics abstractions https://github.com/newrelic/newrelic-exporter-specs/blob/master/Guidelines.md.
# To better support visualization of this data, percentiles are calculated
# based on the histogram metrics and sent to New Relic.
# By default, the following percentiles are calculated: 50, 95 and 99.
#
# percentiles:
# - 50
# - 95
# - 99

# transformations: 
#   - description: "Transformation for MySQL exporter" 
#     rename_attributes: 
#       - metric_prefix: "mysql_" 
#         attributes: 
#           table: "tableName" 
#     copy_attributes: 
#       - from_metric: "mysql_version_info" 
#         to_metrics: - "mysql_" 
#         attributes: 
#           - "innodb_version" 
#           - "version" 
#     ignore_metrics: 
#       - except: 
#         - "mysql_"

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZGVmaW5pdGlvbnMtY29uZmlndXJhdGlvbi1maWxlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJLZXkgbmFtZXMgYW5kIGRlZmluaXRpb25zIn1d">
    <div data-prop-text="title">Key names and definitions</div>
    <p>Here are some key names and definitions for your Prometheus OpenMetrics config file.</p>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p>Key name</p>
          </div>
          <div>
            <p>Description</p>
          </div>
        </div>
      </div>
      <div>
        <div>
          <div>
            <p><code>cluster_name</code></p>
            <p><strong>Required.</strong></p>
          </div>
          <div>
            <p>The name of the cluster. This value will be included as the <code>clusterName</code> attribute for all metrics.</p>
          </div>
        </div>
        <div>
          <div>
            <p><code>verbose</code></p>
          </div>
          <div>
            <p>Stringified boolean.</p>
            <ul>
              <li><code>true</code> (default): Logs debugging information.</li>
              <li><code>false</code>: Only logs error messages.</li>
            </ul>
          </div>
        </div>
        <div>
          <div>
            <p><code>targets</code></p>
          </div>
          <div>
            <p>Configuration of static endpoints to be scraped by the integration. It contains a list of objects. For more information about this structure, see the documentation about <a href="#target-config">target configuration</a>.</p>
          </div>
        </div>
        <div>
          <div>
            <p><code>scrape_enabled_label</code></p>
            <p>
              <img src="./images/img-integration-k8s%402x.png" alt="img-integration-k8s@2x.png" title="img-integration-k8s@2x.png"> <strong>Kubernetes</strong>
            </p>
          </div>
          <div>
            <p>String. The integration will check if the Kubernetes pod and service are annotated or have a label with this value to decide if it has to be scraped.</p>
            <p>This is particularly useful when you want to limit the amount of data by ignoring metrics or including specific metrics that are sent to New Relic. Since by default we use the same label Prometheus uses to discover targets that can be scraped, most exporters that you install automatically set this label.</p>
            <p>To keep a fine-grained control on the targets you want the integration to scrape, you can set this option to some other value (such as <code>newrelic/scrape</code>) and then add the annotation or label <code>newrelic/scrape: "true"</code> to your Kubernetes objects. If both are set, annotations take precedence over labels.</p>
            <p>Default: <code>"prometheus.io/scrape"</code></p>
          </div>
        </div>
        <div>
          <div>
            <p><code>scrape_duration</code></p>
          </div>
          <div>
            <p>How often should the scraper run.</p>
            <ul>
              <li>
                <p>To lower memory usage, increase this value.</p>
              </li>
              <li>
                <p>To raise memory usage, decrease this value.</p>
                <p>The impact on memory usage is due to distributing target fetching over the scrape interval to avoid querying (and buffering) all the data at once.</p>
                <p>Default is <code>30s</code>. Valid values include <code>1s</code>, <code>15s</code>, <code>30s</code>, <code>1m</code>, <code>5m</code>, etc.</p>
              </li>
            </ul>
          </div>
        </div>
        <div>
          <div>
            <p><code>scrape_timeout</code></p>
          </div>
          <div>
            <p>The HTTP client timeout when fetching data from endpoints.</p>
            <p>Default: <code>5s</code>. Valid values include <code>1s</code>, <code>15s</code>, <code>30s</code>, <code>1m</code>, <code>5m</code>, etc.</p>
          </div>
        </div>
        <div>
          <div>
            <p><code>require_scrape_enabled_label_for_nodes</code></p>
            <p>
              <img src="./images/img-integration-k8s%402x.png" alt="img-integration-k8s@2x.png" title="img-integration-k8s@2x.png"> <strong>Kubernetes</strong>
            </p>
          </div>
          <div>
            <p>Whether or not Kubernetes nodes need labels to be scraped.</p>
            <p>Default: <code>true</code>.</p>
          </div>
        </div>
        <div>
          <div>
            <p><code>percentiles</code></p>
          </div>
          <div>
            <p>Histogram support is based on <a href="https://github.com/newrelic/newrelic-exporter-specs/blob/master/Guidelines.md">New Relic's guidelines for higher level metrics abstractions</a>.</p>
            <p>To better support visualization of this data, percentiles are calculated based on the histogram metrics and sent to New Relic. Valid values include <code>50</code>, <code>95</code>, and <code>99</code>.</p>
          </div>
        </div>
        <div>
          <div>
            <p><code>emitter_proxy</code></p>
          </div>
          <div>
            <p>Proxy used by the integration when submitting metrics:</p>
            <p><code>[scheme]://[domain]:[port]</code></p>
            <p>This proxy won't be used when fetching metrics from the targets.</p>
            <p>By default this is empty, and no proxy will be used.</p>
          </div>
        </div>
        <div>
          <div>
            <p><code>emitter_ca_file</code></p>
          </div>
          <div>
            <p>Certificate to add to the root CA that the emitter will use when verifying server certificates. If left empty, TLS uses the host's root CA set.</p>
          </div>
        </div>
        <div>
          <div>
            <p><code>emitter_insecure_skip_verify</code></p>
          </div>
          <div>
            <p>Whether the emitter should skip TLS verification when submitting data. Default: <code>false</code>.</p>
          </div>
        </div>
        <div>
          <div>
            <p><code>disable_autodiscovery</code></p>
          </div>
          <div>
            <p>Set to true in order to disable autodiscovery in the k8s cluster. It can be useful when running the Pod with a service account having limited privileges. Default: <code>false</code>.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<h2>Configure objects in target key [#target-config]</h2>
<p>If you want the target key in the configuration file to contain one or more objects, use the following structure in the YAML list:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Key name</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>description</code></p>
      </div>
      <div>
        <p>A description for the URLs in this target.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>urls</code></p>
      </div>
      <div>
        <p>A list of strings with the URLs to be scraped.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>tls_config</code></p>
      </div>
      <div>
        <p>Authentication configuration used to send requests. It supports TLS and Mutual TLS. For more information, see the documentation about <a href="/docs/integrations/prometheus-integrations/install-configure/add-mutual-tls-prometheus-endpoints">mutual TLS authentication</a>.</p>
      </div>
    </div>
  </div>
</div>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic3BlY2lmeS1wYXRoLXBvcnQifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6Ikt1YmVybmV0ZXMgcG9ydCBhbmQgZW5kcG9pbnQgcGF0aCJ9XQ==">
    <div data-prop-text="title">Kubernetes port and endpoint path</div>
    <p>New Relic's Prometheus OpenMetrics integration automatically discovers which targets to scrape. To specify the port and endpoint path to be used when constructing the target, you can use the <code>prometheus.io/port</code> and <code>prometheus.io/path</code> annotations or label in your Kubernetes pods and services. Annotations take precedence over labels.</p>
    <ul>
      <li>If <code>prometheus.io/port</code> is not present, the integration will try to scrape each <code>port</code> or <code>ContainerPort</code> defined for the service.</li>
      <li>If <code>prometheus.io/path</code> is not present, the integration will default to <code>/metrics</code>.</li>
      <li>If a service is not running on the default <code>/my-metrics-path</code> path, add a label to the pod <code>prometheus.io/path=my-metrics-path</code>. If the path to the metrics endpoint is more complex and cannot be a valid label value (for example, <code>foo/bar</code>), use annotations instead.</li>
    </ul>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1wb3J0LXBhdGgifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkV4YW1wbGU6IExhYmVscyBmb3IgS3ViZXJuZXRlcyBwb3J0IGFuZCBwYXRoIn1d">
    <div data-prop-text="title">Example: Labels for Kubernetes port and path</div>
    <p>In this example, you have a deployment in your cluster, and the pods expose Prometheus metrics on port <code>8080</code> and in the path <code>my-metrics.</code></p>
    <p>In the <code>PodSpec</code> metadata of the deployment manifest, set the labels <code>prometheus.io/port: "8080"</code> and <code>prometheus.io/path: "my-metrics"</code>. When the integration tries to retrieve the metrics from your pods, it will send a request to <code>http://&#x3C;pod-ip>:8080/my-metrics</code>.</p>
    <pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
        prometheus.io/scrape: "true" 
        prometheus.io/port: "8080" 
        prometheus.io/path: "my-metrics"

</code></pre>
  </div>
</div>
<h2>Reload the configuration [#reload-config]</h2>
<p>The Prometheus OpenMetrics integration <strong>does not</strong> automatically reload the configuration when you make changes to the configuration file.</p>
<p>
  <img src="./images/docker-logo-crop.png" alt="Docker icon" title="Docker icon"> <strong>Docker:</strong>
</p>
<p>To reload the configuration, restart the container running the integration:</p>
<pre><code>docker restart nri-prometheus
</code></pre>
<p>
  <img src="./images/img-integration-k8s%402x.png" alt="img-integration-k8s@2x.png" title="img-integration-k8s@2x.png"> <strong>Kubernetes:</strong>
</p>
<p>To reload the configuration, restart the integration. <strong>Recommendation:</strong> Scale the deployment down to zero replicas, and then scale it back to one replica:</p>
<pre><code>kubectl scale deployment nri-prometheus --replicas=0
kubectl scale deployment nri-prometheus --replicas=1
</code></pre>
<h2>Docker: Run previous config file [#run-previous]</h2>
<p>
  <img src="./images/docker-logo-crop.png" alt="Docker icon" title="Docker icon"> <strong>Docker:</strong> To run the integration with the previous configuration file:
</p>
<ol>
  <li>
    <p>Copy the content and save it to a <code>config.yaml</code> file.</p>
  </li>
  <li>
    <p>From within the same directory, run the command:</p>
    <pre><code>docker run -d --restart unless-stopped \
    --name nri-prometheus \
    -e CLUSTER_NAME="YOUR_CLUSTER_NAME" \
    -e LICENSE_KEY="YOUR_LICENSE_KEY" \
    -v "$(pwd)/config.yaml:/config.yaml" \
    newrelic/nri-prometheus:latest --configfile=/config.yaml
</code></pre>
  </li>
</ol>
