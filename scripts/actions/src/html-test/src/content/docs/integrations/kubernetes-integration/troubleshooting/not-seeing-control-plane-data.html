
<h2>Problem</h2>
<p>You have completed the <a href="/docs/kubernetes-monitoring-integration#install">installation procedure</a> for New Relic's Kubernetes integration, you are seeing Kubernetes data in your New Relic account but there is no data from any of the control plane components.</p>
<h2>Solution</h2>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaW52YWxpZC1saWNlbnNlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJDaGVjayB0aGF0IHRoZSBtYXN0ZXIgbm9kZXMgaGF2ZSB0aGUgY29ycmVjdCBsYWJlbHMifV0=">
    <div data-prop-text="title">Check that the master nodes have the correct labels</div>
    <p>Execute the following commands to manually find the master nodes:</p>
    <pre><code>kubectl get nodes -l node-role.kubernetes.io/master=""

</code></pre>If no nodes are found, there are two scenarios:
    Your master nodes don’t have the required labels that identify them as masters, in this case you need to add both labels to your master nodes.
    You’re in a managed cluster and your provider is handling the master nodes for you. In this case there is nothing you can do, since your provider is limiting the access to those nodes.
    <pre><code>
NAME                         STATUS  ROLES   AGE   VERSION
ip-10-42-24-4.ec2.internal   Ready   master  42d   v1.14.8

</code></pre>If the master nodes follow the labeling convention defined in the [discovery of master nodes and control plane components documentation section](https://docs.newrelic.com/docs/integrations/kubernetes-integration/installation/configure-control-plane-monitoring#discover-nodes-components), you should get some output like:
    <pre><code>
kubectl get nodes -l kubernetes.io/role="master"

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidW5hYmxlLWNvbm5lY3QifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkNoZWNrIHRoYXQgdGhlIGludGVncmF0aW9uIGlzIHJ1bm5pbmcgb24gdGhlIG1hc3RlciBub2RlcyJ9XQ==">
    <div data-prop-text="title">Check that the integration is running on the master nodes</div>
    <p>Replace the placeholder in the following command with one of the node names returned in the previous step to get an integration pod running on a master node:</p>
    <pre><code>kubectl get pods --field-selector spec.nodeName=NODE_NAME -l name=newrelic-infra --all-namespaces

</code></pre>If everything is correct you should get some output like:
    <pre><code>
kubectl get pods --field-selector spec.nodeName=$(kubectl get nodes -l node-role.kubernetes.io/master="" -o jsonpath="{.items[0].metadata.name}") -l name=newrelic-infra --all-namespaces

</code></pre>The next command is the same, just that it selects the node for you:
  </div>
  <div>
    <pre><code>NAME                   READY   STATUS    RESTARTS   AGE
newrelic-infra-whvzt   1/1     Running   0          6d20h

</code></pre>
    <pre><code>
kubectl get daemonsets -l app=newrelic-infra --all-namespaces

</code></pre>If the integration is not running on your master nodes, check that the daemonset has all the desired instances running and ready.
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaW5kaWNhdG9ycyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiQ2hlY2sgdGhhdCB0aGUgY29udHJvbCBwbGFuZSBjb21wb25lbnRzIGhhdmUgdGhlIHJlcXVpcmVkIGxhYmVscyJ9XQ==">
    <div data-prop-text="title">Check that the control plane components have the required labels</div>
    <p>Refer to the <a href="https://docs.newrelic.com/docs/integrations/kubernetes-integration/installation/configure-control-plane-monitoring#discover-nodes-components">discovery of master nodes and control plane components documentation section</a> and look for the labels the integration uses to discover the components. Then run the following commands to see if there are any pods with such labels and the nodes where they are running:</p>
    <pre><code>kubectl get pods -l k8s-app=kube-apiserver --all-namespaces

</code></pre>
    <pre><code>
kubectl get pods -l k8s-app=kube-kube-controller-manager --all-namespaces

</code></pre>
    <pre><code>
kubectl get pods -l k8s-app=kube-scheduler --all-namespaces

</code></pre>
    <pre><code>
kubectl get pods -l k8s-app=etcd-manager-main --all-namespaces

</code></pre>The same should be done with the rest of the components:
    <pre><code>
NAMESPACE    NAME                                        READY  STATUS   RESTARTS  AGE
kube-system  kube-apiserver-ip-10-42-24-42.ec2.internal  1/1    Running  3         49d

</code></pre>If there is component with the given label you should see something like:
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY2Fubm90LWxpc3QtcG9kcy1mb3ItY2x1c3RlciJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiUmV0cmlldmUgdGhlIHZlcmJvc2UgbG9ncyBvZiBvbmUgb2YgdGhlIGludGVncmF0aW9ucyBydW5uaW5nIG9uIGEgbWFzdGVyIG5vZGUgYW5kIGNoZWNrIGZvciB0aGUgY29udHJvbCBwbGFuZSBjb21wb25lbnRzIGpvYnMifV0=">
    <div data-prop-text="title">Retrieve the verbose logs of one of the integrations running on a master node and check for the control plane components jobs</div>
    <p>To retrieve the logs, follow the instructions on <a href="https://docs.newrelic.com/docs/integrations/kubernetes-integration/troubleshooting/get-logs-version">get logs from pod running on a master node</a>. The integration logs for every component the following message <em>“Running job: COMPONENT_NAME”</em>. Ex:</p>
    <pre><code>Running job: scheduler

</code></pre>
    <pre><code>
Skipping job creation for component etcd: etcd requires TLS configuration, none given

</code></pre>If you didn’t specify the `ETCD_TLS_SECRET_NAME` configuration option you’ll find the following message in the logs:
    <pre><code>
Running job: api-server

</code></pre>
    <pre><code>
Running job: controller-manager

</code></pre>
    <pre><code>
Running job: etcd

</code></pre>
  </div>
  <div>
    <p>If any error occurs while querying the metrics of any component it will be logged after the <code>Running job</code> message.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY2Fubm90LWxpc3QtcG9kcy1mb3ItY2x1c3RlciJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiTWFudWFsbHkgcXVlcnkgdGhlIG1ldHJpY3Mgb2YgdGhlIGNvbXBvbmVudHMifV0=">
    <div data-prop-text="title">Manually query the metrics of the components</div>
    <p>Refer to the <a href="https://docs.newrelic.com/docs/integrations/kubernetes-integration/installation/configure-control-plane-monitoring#discover-nodes-components">discovery of master nodes and control plane components documentation section</a> to get the endpoint of the control plane component you want to query. With the endpoint we can use the integration pod that’s running on the same node as the component to query. The following are examples on how to query the Kubernetes scheduler:</p>
    <pre><code>kubectl exec -ti POD_NAME -- wget -O - localhost:10251/metrics

</code></pre>
    <pre><code>
Connecting to localhost:10251 (127.0.0.1:10251)
# HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.
# TYPE apiserver_audit_event_total counter
apiserver_audit_event_total 0
# HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.
# TYPE apiserver_audit_requests_rejected_total counter
apiserver_audit_requests_rejected_total 0
# HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.
# TYPE apiserver_client_certificate_expiration_seconds histogram
apiserver_client_certificate_expiration_seconds_bucket{le="0"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="1800"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="3600"} 0

</code></pre>If everything is correct you should get some metrics on the Prometheus format, something like:
    <pre><code>
kubectl exec -ti $(kubectl get pods --all-namespaces --field-selector spec.nodeName=$(kubectl get nodes -l node-role.kubernetes.io/master="" -o jsonpath="{.items[0].metadata.name}") -l name=newrelic-infra -o jsonpath="{.items[0].metadata.name}") -- wget -O - localhost:10251/metrics

</code></pre>The following command does the same, but also chooses the pod for you:
  </div>
</div>
