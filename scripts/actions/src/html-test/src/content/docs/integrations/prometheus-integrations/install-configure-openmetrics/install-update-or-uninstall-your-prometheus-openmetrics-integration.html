
<p>Before you install New Relic's Prometheus OpenMetrics integration, review the requirements for your environment:</p>
<ul>
  <li><a href="/docs/integrations/prometheus-integrations/get-started/monitor-prometheus-new-relic#OpenMetrics-Compatibility">Docker requirements</a></li>
  <li><a href="/docs/integrations/prometheus-integrations/get-started/monitor-prometheus-new-relic#OpenMetrics-Compatibility">Kubernetes requirements</a></li>
</ul>
<h2>Install the integration [#install]</h2>
<p>To install the Prometheus OpenMetrics integration, follow the procedures for Docker or Kubernetes as applicable:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZG9ja2VyLWluc3RhbGwifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkRvY2tlciBpbnN0YWxsYXRpb24ifV0=">
    <div data-prop-text="title">Docker installation</div>
    <p>To install the New Relic Prometheus OpenMetrics integration in a Docker environment:</p>
    <ol>
      <li>
        <p>Create a configuration file <code>config.yaml</code>. Use the <a href="https://docs.newrelic.com/docs/integrations/prometheus-integrations/install-configure/configure-prometheus-openmetrics-integration#example-configuration-file">example configuration file</a>, or look at the <a href="https://download.newrelic.com/infrastructure_agent/integrations/kubernetes/nri-prometheus-latest.yaml"><code>nri-prometheus-latest.yaml</code></a> manifest file, which includes the <code>nri-prometheus-cfg</code> config map and an example configuration.</p>
        <ul>
          <li><strong>Required:</strong> Add your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">New Relic license key</a> and a cluster name to identify your Docker container.</li>
          <li>Add the endpoints to scrape; for example, add the <code>http://localhost:8080/metrics</code> endpoint to collect metrics about the integration itself.</li>
          <li>Specify which metrics you want to ignore or include according to the prefixes for the metrics and labels. For more information, see the <a href="https://docs.newrelic.com/docs/integrations/prometheus-integrations/configure/filter-prometheus-metrics">metrics filtering</a> documentation.</li>
        </ul>
      </li>
      <li>
        <p>Start the integration in the background:</p>
        <pre><code>docker run -d --restart unless-stopped \
    --name nri-prometheus \
    -e LICENSE_KEY="YOUR_LICENSE_KEY" \
    -v "$(pwd)/config.yaml:/config.yaml" \
    newrelic/nri-prometheus:1.5
</code></pre>
      </li>
      <li>
        <p>Confirm the container is running properly:</p>
        <pre><code>docker ps -f "name=nri-prometheus"
</code></pre>
      </li>
      <li>
        <p>Confirm that the integration has been configured correctly: Wait a few minutes, then go to the New Relic UI, and run this NRQL query to see if data has been reported:</p>
        <pre><code>FROM Metric SELECT count(*) WHERE clusterName = 'YOUR_CLUSTER_NAME' since 1 hour ago
</code></pre>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoia3ViZXJuZXRlcy1pbnN0YWxsIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJLdWJlcm5ldGVzIGluc3RhbGxhdGlvbiJ9XQ==">
    <div data-prop-text="title">Kubernetes installation</div>
    <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
      <p>To prevent your data from being duplicated, configure your New Relic Prometheus OpenMetrics integration <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/">only with <strong>one replica</strong></a>. Running two or more replicas will result in duplicated data. For more information, see the troubleshooting procedures for <a href="https://docs.newrelic.com/docs/integrations/prometheus-integrations/troubleshooting/restarts-gaps-data-kubernetes">restarts and gaps in data</a>.</p>
    </div>
    <p>To install the New Relic Prometheus OpenMetrics integration in a Kubernetes environment:</p>
    <ol>
      <li>
        <p>Download the integration manifest <code>.yaml</code> file:</p>
        <pre><code>curl -O https://download.newrelic.com/infrastructure_agent/integrations/kubernetes/nri-prometheus-latest.yaml
</code></pre>
      </li>
      <li>
        <p>Edit the <code>nri-prometheus-latest.yaml</code> manifest file:</p>
        <p><strong>Required:</strong> Add your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">New Relic license key</a> and a cluster name to identify your Kubernetes cluster.</p>
        <pre><code>env: - name: LICENSE_KEY 
       value: "&#x3C;YOUR_LICENSE_KEY>"
[...]
config.yaml: |
  cluster_name: "&#x3C;YOUR_CLUSTER_NAME>"
</code></pre>
      </li>
      <li>
        <p>Specify which metrics you want to ignore or include according to the prefixes for the metrics and labels. By default, the New Relic Prometheus OpenMetrics integration uses the same labels as Prometheus to discover targets. For more information, see the <a href="https://docs.newrelic.com/docs/integrations/prometheus-integrations/configure/filter-prometheus-metrics">metrics filtering</a> documentation.</p>
      </li>
      <li>
        <p>Deploy the integration in your Kubernetes cluster:</p>
        <pre><code>kubectl apply -f nri-prometheus-latest.yaml
</code></pre>
      </li>
      <li>
        <p>To confirm that the deployment has been created successfully, look at the <code>CURRENT</code> replicas in the results generated by this command:</p>
        <pre><code>kubectl get deployments nri-prometheus
</code></pre>
      </li>
      <li>
        <p>Confirm that the integration has been configured correctly: Wait a few minutes, then go to the New Relic UI, and run this NRQL query to see if data has been reported:</p>
        <pre><code>FROM Metric SELECT count(*) WHERE clusterName = 'YOUR_CLUSTER_NAME' since 1 hour ago
</code></pre>
      </li>
    </ol>
  </div>
</div>
<h2>Update the integration [#update]</h2>
<p>To update the Prometheus OpenMetrics integration, follow the procedures for Docker or Kubernetes as applicable:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZG9ja2VyLXVwZGF0ZSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiRG9ja2VyIHVwZGF0ZSBwcm9jZWR1cmVzIn1d">
    <div data-prop-text="title">Docker update procedures</div>
    <ol>
      <li>
        <p>Remove the Docker container.</p>
      </li>
      <li>
        <p>Follow <a href="#docker-install">standard installation procedures</a> to start a new Docker container.</p>
        <p>The integration logs its current version when it starts up. To determine the running version:</p>
        <pre><code>docker logs nri-prometheus 2>&#x26;1 | grep "Integration version"
</code></pre>
        <p>Example output:</p>
        <pre><code>time="2019-02-26T09:21:21Z" level=info msg="Starting New Relic's Prometheus OpenMetrics Integration version 1.0.0"
</code></pre>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoia3ViZXJuZXRlcy11cGRhdGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6Ikt1YmVybmV0ZXMgdXBkYXRlIHByb2NlZHVyZXMifV0=">
    <div data-prop-text="title">Kubernetes update procedures</div>
    <ol>
      <li>
        <p>Follow <a href="#kubernetes-install">standard installation procedures</a>.</p>
      </li>
      <li>
        <p>Reapply the <code>nri-prometheus-latest.yaml</code> manifest file.</p>
        <p>The integration logs its version when it starts up. To determine the running version:</p>
        <pre><code>kubectl logs deploy/nri-prometheus | grep "Integration version"
</code></pre>
        <p>Example output:</p>
        <pre><code>time="2019-02-26T09:21:21Z" level=info msg="Starting New Relic's Prometheus OpenMetrics Integration version 1.0.0"
</code></pre>
      </li>
    </ol>
  </div>
</div>
<h2>Uninstall</h2>
<p>To uninstall the Prometheus OpenMetrics integration for Docker or Kubernetes, execute the following command:</p>
<p>
  <img src="./images/docker-logo-crop.png" alt="Docker icon" title="Docker icon"> <strong>Docker:</strong>
</p>
<pre><code>docker rm -f nri-prometheus
</code></pre>
<p>
  <img src="./images/img-integration-k8s%402x.png" alt="img-integration-k8s@2x.png" title="img-integration-k8s@2x.png"> <strong>Kubernetes:</strong>
</p>
<pre><code>kubectl delete -f nri-prometheus-latest.yaml
</code></pre>
