
<p>Our Microsoft SQL Server <a href="https://docs.newrelic.com/docs/integrations/host-integrations/getting-started/introduction-host-integrations">integration</a> collects and sends inventory and metrics from your MS SQL Server environment to our platform, where you can see the health of your MS SQL Server environment. We collect both database and instance-level metrics so that you can pinpoint the source of any problems.</p>
<p>Read on to install the integration, and to see what data we collect.</p>
<h2>Compatibility and requirements [#about]</h2>
<p>Our integration is compatible with Microsoft SQL Server 2008 R2 SP3 or higher.</p>
<p>Before installing the integration, make sure that you meet the following requirements:</p>
<ul>
  <li><a href="/docs/infrastructure/install-infrastructure-agent/get-started/install-infrastructure-agent-new-relic">Install the infrastructure agent</a>.</li>
  <li>Windows distribution <a href="/docs/infrastructure/new-relic-infrastructure/getting-started/compatibility-requirements-new-relic-infrastructure">compatible with the infrastructure agent</a>.</li>
  <li>Microsoft SQL Server user with <a href="#users-privileges">user privileges</a> for both <code>CONNECT</code> and <code>VIEW SERVER STATE</code>, and <code>READ</code> access permissions.</li>
</ul>
<h2>Microsoft SQL users and privileges [#users-privileges]</h2>
<p>In the Microsoft SQL Server that is to be monitored, execute the following script to create a new user and grant <code>CONNECT</code>, <code>VIEW SERVER STATE</code>, and read access permissions to that user.</p>
<p>See the Microsoft documentation for details on <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-login-transact-sql?view=sql-server-2017">creating logins</a> and <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-user-transact-sql?view=sql-server-2017">users</a> in Microsoft SQL Server.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>The Microsoft SQL Server Integration currently only supports SQL Authentication.</p>
</div>
<ol>
  <li>
    <p>Use the following statements to create a new login and to grant <code>CONNECT</code> and <code>VIEW SERVER STATE</code> permissions to the login.</p>
    <pre><code>USE master;
    CREATE LOGIN newrelic WITH PASSWORD = 'tmp_password'; --insert new password here
    GRANT CONNECT SQL TO newrelic;
    GRANT VIEW SERVER STATE TO newrelic;
    GRANT VIEW ANY DEFINITION TO newrelic;
</code></pre>
  </li>
  <li>
    <p>Use the following statements to grant read access privileges to the user.</p>
    <pre><code>DECLARE @name SYSNAME
    DECLARE db_cursor CURSOR 
    READ_ONLY FORWARD_ONLY
    FOR
    SELECT NAME
    FROM master.sys.databases
    WHERE NAME NOT IN ('master','msdb','tempdb','model','rdsadmin','distribution')
    OPEN db_cursor
    FETCH NEXT FROM db_cursor INTO @name WHILE @@FETCH_STATUS = 0
    BEGIN
        EXECUTE('USE "' + @name + '"; CREATE USER newrelic FOR LOGIN newrelic;' );
        FETCH next FROM db_cursor INTO @name
    END
    CLOSE db_cursor
    DEALLOCATE db_cursor
</code></pre>
  </li>
  <li>
    <p>Run the following command to verify that the user was successfully created.</p>
    <pre><code>sqlcmd -U user_name -S host_name
</code></pre>
  </li>
</ol>
<h2>Install and activate [#install]</h2>
<p>To install the Microsoft SQL Server integration:</p>
<ol>
  <li>
    <p>Download the latest .MSI installer image from:</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiMzItYml0LXdpbmRvd3MifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjMyLWJpdCBXaW5kb3dzIn1d">
        <div data-prop-text="title">32-bit Windows</div>
        <pre><code>http://download.newrelic.com/infrastructure_agent/windows/integrations/nri-mssql/386/nri-mssql-386.msi

</code></pre>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiNjQtYml0LXdpbmRvd3MifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjY0LWJpdCBXaW5kb3dzIn1d">
        <div data-prop-text="title">64-bit Windows</div>
        <pre><code>http://download.newrelic.com/infrastructure_agent/windows/integrations/nri-mssql/nri-mssql-amd64.msi

</code></pre>
      </div>
    </div>
  </li>
  <li>
    <p>In an admin account, run the install script using an absolute path.</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiMzItYml0LXBhdGgifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjMyLWJpdCBXaW5kb3dzIn1d">
        <div data-prop-text="title">32-bit Windows</div>
        <pre><code>msiexec.exe /qn /i PATH\TO\nri-mssql-amd386.msi

</code></pre>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiNjQtYml0LXBhdGgifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjY0LWJpdCBXaW5kb3dzIn1d">
        <div data-prop-text="title">64-bit Windows</div>
        <pre><code>msiexec.exe /qn /i PATH\TO\nri-mssql-amd64.msi

</code></pre>
      </div>
    </div>
  </li>
  <li>
    <p>Rename <code>C:\Program Files\New Relic\newrelic-infra\integrations.d\mssql-config.yml.sample</code> to <code>mssql-config.yml</code>, and edit according to your instance.</p>
  </li>
  <li>
    <p><a href="https://docs.newrelic.com/docs/infrastructure/new-relic-infrastructure/configuration/start-stop-restart-check-infrastructure-agent-status">Restart the infrastructure agent</a>.</p>
  </li>
</ol>
<p>Additional notes:</p>
<ul>
  <li><strong>On-host integrations do not automatically update.</strong> For best results, regularly <a href="/docs/integrations/host-integrations/installation/update-infrastructure-host-integration-package">update the integration package</a> and <a href="/docs/infrastructure/new-relic-infrastructure/installation/update-infrastructure-agent">the infrastructure agent</a>.</li>
</ul>
<h2>Configure the integration [#config]</h2>
<p>An integration's YAML-format configuration is where you can place required login credentials and configure how data is collected. Which options you change depend on your setup and preference.</p>
<p>For an example configuration, see the <a href="#example-config">example config file</a>.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>With secrets management, you can configure on-host integrations with New Relic Infrastructure's agent to use sensitive data (such as passwords) without having to write them as plain text into the integration's configuration file. For more information, see <a href="https://docs.newrelic.com/docs/integrations/host-integrations/installation/secrets-management">Secrets management</a>.</p>
</div>
<h3>Commands</h3>
<p>The <code>mssql-config.yml</code> file accepts the following commands:</p>
<ul>
  <li><code>all_data</code>: collects both inventory and metric data from the Microsoft SQL Server environment.</li>
</ul>
<h3>Arguments</h3>
<p>The <code>all_data</code> command accepts the following arguments:</p>
<ul>
  <li><code>username</code>: username used to authenticate the MS SQL Server. To use Windows Authentication, specify this argument in the <code>DOMAIN\username</code> form. This field is required.</li>
  <li><code>password</code>: password used to authenticate the MS SQL Server. This field is required.</li>
  <li><code>hostname</code>: hostname or IP of the MS SQL Server installation. Default: <code>127.0.0.1</code>.</li>
  <li><code>port</code>: port number on which the MS SQL Server is listening. This is only required when <code>instance</code> is not specified.</li>
  <li><code>instance</code>: instance the Microsoft SQL Server is connected to. <code>instance</code> can be used in place of <code>port</code> by enabling <code>SQL Browser</code>; if enabled, do not include <code>port</code> in the argument.</li>
  <li><code>enable_ssl</code>: indicates whether SSL is used to connect to the MS SQL Server. Default: <code>false</code>.</li>
  <li><code>trust_server_certificate</code>: if set to <code>true</code>, server certificate is not verified for SSL. If set to <code>false</code>, certificate will be verified against supplied certificate.</li>
  <li><code>certificate_location</code>: certificate file to verify SSL encryption against.</li>
  <li><code>timeout</code>: timeout for queries, in seconds. Default: <code>30</code>.</li>
  <li><code>enable_buffer_metrics</code>: enables the collection of buffer pool metrics. These can be resource intensive for large systems. Default: <code>true</code>.</li>
  <li><code>enable_database_reserve_metrics</code>: enables the collection of database partition reserve space. These can be resource intensive for large systems. Default: <code>true</code>.</li>
  <li><code>custom_metrics_query</code>: an SQL query with the required columns <code>metric_name</code>, <code>metric_type</code>, and <code>metric_value</code>. The <code>metric_type</code> can be <code>gauge</code>, <code>rate</code>, <code>delta</code>, or <code>attribute</code>. Additional columns collected with the query are added to the metric set as attributes.</li>
</ul>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>If both port and instance are omitted, the default port of 1433 is used.</p>
</div>
<h3>Example configurations [#example-config]</h3>
<p>Example <code>mssql-config.yml</code> file configuration:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1jb25maWcifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkNvbmZpZ3VyYXRpb24gZm9yIG9uZSBxdWVyeSJ9XQ==">
    <div data-prop-text="title">Configuration for one query</div>
    <pre><code>integration_name: com.newrelic.mssql

instances:
  - name: mssql-server
    command: all_data
    arguments:
      hostname: mssql.localnet
      username: mssql_user
      password: mssql_password
      port: 1433
      custom_metrics_query: >-
        SELECT 
          'instance_buffer_pool_size' AS metric_name,
          Count_big(*) * (8*1024) AS metric_value,
          'gauge' as metric_type,
          database_id
        FROM sys.dm_os_buffer_descriptors WITH (nolock)
        GROUP BY database_id
    labels:
      env: production
      role: mssql

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1jb25maWctbXVsdGlwbGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkNvbmZpZ3VyYXRpb24gZm9yIG11bHRpcGxlIHF1ZXJpZXMifV0=">
    <div data-prop-text="title">Configuration for multiple queries</div>
    <p>If you need multiple SQL queries, add them to <code>mssql-custom-query.yml</code>, and then reference that file.</p>
    <pre><code>integration_name: com.newrelic.mssql

instances:
  - name: mssql-server
    command: all_data
    arguments:
      hostname: mssql.localnet
      username: mssql_user
      password: mssql_password
      port: 1433
      custom_metrics_config: full_path_to_file
    labels:
      env: production
      role: mssql

</code></pre>
    <pre><code>
queries: 
    # Example for metric_name / metric_type specified in this config
- query: SELECT count(*) AS 'metric_value' FROM sys.databases
  metric_name: dbCount
  metric_type: gauge
    # Example for metric_name from query, metric_type auto-detected, additional attribute 'category_type'
- query: SELECT CONCAT('category_', category_id) AS metric_name, name AS metric_value, category_type FROM syscategories
  database: msdb
    # Example for stored procedure 'exec dbo.sp_server_info @attribute_id = 2'
- query: dbo.sp_server_info @attribute_id = 2

</code></pre>Here's an example `mssql-custom-query.yml`.
  </div>
</div>
<p>For more about the general structure of on-host integration configuration, see <a href="/docs/integrations/integrations-sdk/file-specifications/host-integration-configuration-overview">Configuration</a>.</p>
<h2>Find and use data [#find-and-use]</h2>
<p>To find your integration data go to <a href="http://one.newrelic.com"><strong>one.newrelic.com</strong></a> <strong>> Infrastructure > Third-party services</strong> and select one of the Microsoft SQL Server integration links.</p>
<p>Microsoft SQL Server data is attached to the following <a href="/docs/using-new-relic/welcome-new-relic/getting-started/glossary#event">event types</a>:</p>
<ul>
  <li><code>MssqlDatabaseSample</code></li>
  <li><code>MssqlInstanceSample</code></li>
  <li><code>MssqlWaitSample</code></li>
</ul>
<p>For more on how to find and use your data, see <a href="/docs/infrastructure/integrations/find-use-infrastructure-integration-data">Understand integration data</a>.</p>
<h2>Metric data [#metrics]</h2>
<p>The Microsoft SQL Server integration collects the following metric data attributes. Some metric name are prefixed with a category indicator and a period, such as <code>asserts.</code> or <code>flush.</code>.</p>
<h3>Database metrics [#database-metric]</h3>
<p>These attributes can be found by querying the <code>MssqlDatabaseSample</code> event.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Metric</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>bufferpool.sizePerDatabaseInBytes</code></p>
      </div>
      <div>
        <p>The size of the buffer pool per database.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>io.stallInMilliseconds</code></p>
      </div>
      <div>
        <p>Wait time of stall since last restart, in milliseconds.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>log.transactionGrowth</code></p>
      </div>
      <div>
        <p>Total number of times the transaction log for the database has been expanded since the last restart.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>pageFileAvailable</code></p>
      </div>
      <div>
        <p>Available page file size, in bytes.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>pageFileTotal</code></p>
      </div>
      <div>
        <p>Total page file size, in bytes.</p>
      </div>
    </div>
  </div>
</div>
<h3>Instance metrics [#instance-metric]</h3>
<p>The Microsoft SQL Server integration collects the following instance metrics. These attributes can be found by querying the <code>MssqlInstanceSample</code> event.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Metric</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>access.pageSplitsPerSecond</code></p>
      </div>
      <div>
        <p>The number of page splits per second.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>activeConnections</code></p>
      </div>
      <div>
        <p>The number of active connections.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>buffer.cacheHitRatio</code></p>
      </div>
      <div>
        <p>The ratio of data pages found and read from the buffer cache over all data page requests.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>buffer.checkpointPagesPerSecond</code></p>
      </div>
      <div>
        <p>The number of pages flushed to disk per second by a checkpoint or other operation that require all dirty pages to be flushed.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>bufferpool.batchRequestsPerSecond</code></p>
      </div>
      <div>
        <p>The number of batch requests per second on the buffer pool.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>bufferpool.pageLifeExptancyInMilliseconds</code></p>
      </div>
      <div>
        <p>The life expectancy of a page in the buffer pool, in milliseconds.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>bufferpool.sizeInBytes</code></p>
      </div>
      <div>
        <p>The size of the buffer pool, in bytes.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.backgroundProcessesCount</code></p>
      </div>
      <div>
        <p>The number of background processes on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.blockedProcessesCount</code></p>
      </div>
      <div>
        <p>The number of blocked processes on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.diskInBytes</code></p>
      </div>
      <div>
        <p>The amount of disk space on the instance, in bytes.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.dormantProcessesCount</code></p>
      </div>
      <div>
        <p>The number of dormant processes on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.forcedParameterizationsPerSecond</code></p>
      </div>
      <div>
        <p>The number of forced parameterizations per second on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.preconnectProcessesCount</code></p>
      </div>
      <div>
        <p>The number of preconnect processes on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.runnableProcessesCount</code></p>
      </div>
      <div>
        <p>The number of runnable processes on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.runnableTasks</code></p>
      </div>
      <div>
        <p>The number of runnable tasks on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.runningProcessesCount</code></p>
      </div>
      <div>
        <p>The number of running processes on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.sleepingProcessesCount</code></p>
      </div>
      <div>
        <p>The number of sleeping processes on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.suspendedProcessesCount</code></p>
      </div>
      <div>
        <p>The number of suspended processes on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>instance.transactionsPerSecond</code></p>
      </div>
      <div>
        <p>The number of transactions per second on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>memoryAvailable</code></p>
      </div>
      <div>
        <p>The available physical memory, in bytes.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>memoryTotal</code></p>
      </div>
      <div>
        <p>The total physical memory, in bytes.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>memoryUtilization</code></p>
      </div>
      <div>
        <p>The percentage of memory utilization.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>stats.connections</code></p>
      </div>
      <div>
        <p>The number of user connections.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>stats.deadlocksPerSecond</code></p>
      </div>
      <div>
        <p>The number of lock requests per second that resulted in a deadlock since the last restart.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>stats.killConnectionErrorsPerSecond</code></p>
      </div>
      <div>
        <p>The number of kill connection errors per second since the last restart.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>stats.lockWaitsPerSecond</code></p>
      </div>
      <div>
        <p>The number of times per second that MS SQL Server is unable to retain a lock right away for a resource.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>stats.sqlCompilations</code></p>
      </div>
      <div>
        <p>The number of MS SQL compilations per second.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>stats.sqlRecompilationsPerSecond</code></p>
      </div>
      <div>
        <p>The number of MS SQL re-compilations per second.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>stats.userErrorsPerSecond</code></p>
      </div>
      <div>
        <p>The number of user errors per second since the last restart.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>system.bufferPoolHit</code></p>
      </div>
      <div>
        <p>The percentage of buffer pools hits on the instance.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>system.waitTimeInMillisecondsPerSecond</code></p>
      </div>
      <div>
        <p>The number of milliseconds per second spent waiting across the instance.</p>
      </div>
    </div>
  </div>
</div>
<h3>Wait metrics [#wait-metric]</h3>
<p>These attributes can be found by querying the <code>MssqlWaitSample</code> event.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Metric</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>system.waitTimeCount</code></p>
      </div>
      <div>
        <p>Total wait time for this wait type, in milliseconds. This time is inclusive of <code>signal_wait_time_ms</code>.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>system.waitTimeInMillisecondsPerSecond</code></p>
      </div>
      <div>
        <p>The number of waits on this wait type, in milliseconds. This counter is incremented at the start of each wait.</p>
      </div>
    </div>
  </div>
</div>
<h2>Inventory data [#inventory]</h2>
<p>The Microsoft SQL Server integration captures the configuration parameters and current settings of the Microsoft SQL Server environment. It collects the results of the <code>sp_configure</code> stored procedure, as well as current running configuration settings from the <code>sys.configurations</code> table.</p>
<p>The data is available on the <a href="/docs/infrastructure/new-relic-infrastructure/infrastructure-ui-pages/infrastructure-inventory-page-search-your-entire-infrastructure">Inventory page</a>, under the <strong>config/mssql</strong> source. For more about inventory data, see <a href="/docs/infrastructure/integrations-getting-started/getting-started/understand-integration-data-data-types#inventory-data">Understand integration data</a>.</p>
<h2>Check the source code [#source-code]</h2>
<p>This integration is open source software. That means you can <a href="https://github.com/newrelic/nri-mssql" title="Link opens in a new window.">browse its source code</a> and send improvements, or create your own fork and build it.</p>
