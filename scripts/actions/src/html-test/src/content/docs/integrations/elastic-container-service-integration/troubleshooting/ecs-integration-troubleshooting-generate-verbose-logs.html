
<h2>Problem</h2>
<p>When <a href="/docs/ecs-integration-no-data-appears">troubleshooting the on-host ECS integration</a>, you can generate verbose logs for a few minutes to find and investigate errors. This can be useful for conducting your own troubleshooting or when providing information to <a href="https://support.newrelic.com/">New Relic support</a>.</p>
<p>Verbose logging generates a lot of data very quickly. When finished generating logs, be sure to set <code>verbose: 0</code> to reduce disk space consumption.</p>
<p>You can automate this process by using the <code>newrelic-infra-ctl</code> command. For more information, see <a href="/docs/infrastructure/install-configure-manage-infrastructure/manage-your-agent/troubleshoot-running-agent">Troubleshooting a running agent</a>.</p>
<h2>Solution</h2>
<p>Generating verbose log files requires editing your task definition file. For a sample config file that includes all applicable settings, see <a href="/docs/infrastructure/install-configure-manage-infrastructure/configuration/infrastructure-configuration-settings">Infrastructure configuration settings</a>.</p>
<p>You have several options for implementing verbose logs:</p>
<ul>
  <li><a href="#env-variable">Change the task definition environment variable and do a task restart</a></li>
  <li>For EC2 launch type: <a href="#retrieve-logs-via-ssh">Retrieve logs via SSH</a></li>
  <li><a href="#forward-logs-cloudwatch">Forward to CloudWatch and download with awscli</a></li>
  <li><a href="#running-container">Run a command from the running container</a></li>
</ul>
<h3>Using task definition environment variable [#env-variable]</h3>
<p>To enable verbose logs by changing the environment variable and doing a task restart:</p>
<ol>
  <li>
    <p>Edit your task definition. Change the value of <code>NRIA_VERBOSE</code> from <code>0</code> to:</p>
    <ul>
      <li><code>1</code> for always-on verbose logs</li>
      <li><code>2</code> for smart logging</li>
      <li><code>3</code> for sending to New Relic</li>
    </ul>
    <p>Read <a href="/docs/infrastructure/install-configure-manage-infrastructure/configuration/infrastructure-configuration-settings#verbose">more about these options</a>.</p>
  </li>
  <li>
    <p>Save your task definition.</p>
  </li>
  <li>
    <p>Update your service to use the newly registered task definition.</p>
  </li>
  <li>
    <p>If you chose <code>NRIA_VERBOSE=3</code> and you're not sending the logs directly to New Relic, you have two options for viewing and downloading the logs:</p>
    <ul>
      <li>For EC2 launch type: you can <a href="#retrieve-logs-via-ssh">retrieve the logs via SSH</a>, or</li>
      <li><a href="#forward-logs-cloudwatch">Forward logs to CloudWatch</a></li>
    </ul>
  </li>
  <li>
    <p>Return your settings to default:</p>
    <ol>
      <li>Disable verbose logging by editing your task definition and setting <code>NRIA_VERBOSE</code> to <code>0</code>.</li>
      <li>Save your task definition.</li>
      <li>Update your service to the latest version of your task.</li>
    </ol>
  </li>
  <li>
    <p>Examine the log file for errors.</p>
  </li>
  <li>
    <p>If you need to send your log file to <a href="https://support.newrelic.com/">New Relic support</a>:</p>
    <ol>
      <li>
        <p>Include the line in your log file that contains the ECS integration version:</p>
        <pre><code>New Relic ECS integration version X.YY.ZZZ
</code></pre>
      </li>
      <li>
        <p>Attach the log file to your support ticket, along with your task definition .yml file.</p>
      </li>
    </ol>
  </li>
</ol>
<h3>Retrieve logs via SSH (EC2 launch type only) [#retrieve-logs-via-ssh]</h3>
<p>To get logs via SSH:</p>
<ol>
  <li>
    <p>Edit your task definition. Change the value of <code>NRIA_VERBOSE</code> from <code>0</code> to:</p>
    <ul>
      <li><code>1</code> for always-on verbose logs</li>
      <li><code>2</code> for smart logging</li>
      <li><code>3</code> for sending to New Relic</li>
    </ul>
    <p>Read <a href="/docs/infrastructure/install-configure-manage-infrastructure/configuration/infrastructure-configuration-settings#verbose">more about these options</a>.</p>
  </li>
  <li>
    <p>SSH into one of your container instances.</p>
  </li>
  <li>
    <p>Find the container ID of the New Relic integration container, by running the command <code>docker ps -a</code>. The name of the container should be <code>nri-ecs</code>.</p>
  </li>
  <li>
    <p>Save the logs from the container with the command <code>docker logs NRI_ECS_CONTAINER_ID > logs.txt</code>. Leave the command running for about three minutes to generate sufficient logging data.</p>
  </li>
  <li>
    <p>Continue with the instructions in the <a href="#env-variable">enable verbose logs</a> section.</p>
  </li>
</ol>
<h3>Forward logs to CloudWatch and download them with awscli [#forward-logs-cloudwatch]</h3>
<p>To get logs via CloudWatch:</p>
<ol>
  <li>
    <p>Edit your task definition. Change the value of <code>NRIA_VERBOSE</code> from <code>0</code> to:</p>
    <ul>
      <li><code>1</code> for always-on verbose logs</li>
      <li><code>2</code> for smart logging</li>
      <li><code>3</code> for sending to New Relic</li>
    </ul>
    <p>Read <a href="/docs/infrastructure/install-configure-manage-infrastructure/configuration/infrastructure-configuration-settings#verbose">more about these options</a>.</p>
  </li>
  <li>
    <p>We use a CloudWatch log group called <code>/newrelic-infra/ecs</code> to forward the logs to. To see if it already exists, run:</p>
    <pre><code>aws logs describe-log-groups --log-group-name-prefix /newrelic-infra/ecs
</code></pre>
    <p>If a log group exists with that prefix, you'll get this output:</p>
    <pre><code>{
  "logGroups": [
    {
      "logGroupName": "/newrelic-infra/ecs",
      "creationTime": 1585828615225,
      "metricFilterCount": 0,
      "arn": "arn:aws:logs:YOUR_REGION:YOUR_AWS_ACCOUNT:log-group:/newrelic-infra/ecs:*",
      "storedBytes": 122539356
    }
  ]
}
</code></pre>
    <p>Because this command matches log groups with prefixes, ensure the log group name returned is exactly <code>/newrelic-infra/ecs</code>. If the log group doesn't exist, the output will be:</p>
    <pre><code>{
  "logGroups": []
}
</code></pre>
  </li>
  <li>
    <p>If the log group doesn't exist, create it by running:</p>
    <pre><code>aws logs create-log-group --log-group-name /newrelic-infra/ecs
</code></pre>
  </li>
  <li>
    <p>Edit your task definition. In the container definition for the <code>newrelic-infra</code> container, add the following <code>logConfiguration</code>:</p>
    <pre><code>"logConfiguration": {
  "logDriver": "awslogs",
  "options": {
    "awslogs-group": "/newrelic-infra/ecs",
    "awslogs-region": "AWS_REGION_OF_YOUR_CLUSTER",
    "awslogs-stream-prefix": "verbose"
  }
}
</code></pre>
  </li>
  <li>
    <p>Register the new task version and update your service.</p>
  </li>
  <li>
    <p>Next you'll look for the relevant log stream. If you have multiple instances of the task running, they'll all send their logs to the same log group but each will have its own log stream. Log streams names follow the structure <code>AWSLOGS_STREAM_PREFIX/TASK_FAMILY_NAME/TASK_ID</code>. In this case, it will be <code>verbose/newrelic-infra/TASK_ID</code>.</p>
    <p>To get all the log streams for a given log group, run this command:</p>
    <pre><code>aws logs describe-log-streams --log-group-name /newrelic-infra/ecs
</code></pre>
    <p>The following is an example output of a log group with two streams:</p>
    <pre><code>{
    "logStreams": [
        {
            "logStreamName": "verbose/newrelic-infra/9dfb28114e40415ebc399ec1e53a21b7",
            "creationTime": 1586166741197,
            "firstEventTimestamp": 1586166742030,
            "lastEventTimestamp": 1586173933472,
            "lastIngestionTime": 1586175101220,
            "uploadSequenceToken": "49599989655680038369205623273330095416487086853777112338",
            "arn": "arn:aws:logs:AWS_REGION_OF_YOUR_CLUSTER:YOUR_AWS_ACCOUNT:log-group:/newrelic-infra/ecs:log-stream:verbose/newrelic-infra/9dfb28114e40415ebc399ec1e53a21b7",
            "storedBytes": 0
        },
        {
            "logStreamName": "verbose/newrelic-infra/f6ce0be416804bc4bfa658da5514eb00",
            "creationTime": 1586166745643,
            "firstEventTimestamp": 1586166746491,
            "lastEventTimestamp": 1586173037927,
            "lastIngestionTime": 1586175100660,
            "uploadSequenceToken": "49605664273821671319096446647846424799651902350804230514",
            "arn": "arn:aws:logs:AWS_REGION_OF_YOUR_CLUSTER:YOUR_AWS_ACCOUNT:log-group:/newrelic-infra/ecs:log-stream:verbose/newrelic-infra/f6ce0be416804bc4bfa658da5514eb00",
            "storedBytes": 0
        }
    ]
}
</code></pre>
  </li>
  <li>
    <p>From the previous list of log streams, identify the one with the task ID for which you want to retrieve the logs and use the logStreamName in this command:</p>
    <pre><code>aws logs get-log-events --log-group-name /newrelic-infra/ecs --log-stream-name "LOG_STREAM_NAME" --output text > logs.txt
</code></pre>
  </li>
  <li>
    <p>Continue with the <a href="#env-variable">enable verbose logs</a> instructions.</p>
  </li>
</ol>
<h3>From running container [#running-container]</h3>
<p>To enable verbose logs by running a command from the running container:</p>
<ol>
  <li>
    <p>SSH into one of your container instances.</p>
  </li>
  <li>
    <p>Find the container ID of the New Relic integration container by running the command <code>docker ps -a</code>. The name of the container should be <code>nri-ecs</code>.</p>
  </li>
  <li>
    <p>Enable verbose logs for a limited period of time by using <code>newrelic-infra-ctl</code>. Run the command:</p>
    <pre><code>docker exec INTEGRATION_CONTAINER_ID /usr/bin/newrelic-infra-ctl
</code></pre>
    <p>For more details, see <a href="//docs.newrelic.com/docs/infrastructure/install-configure-manage-infrastructure/manage-your-agent/troubleshoot-running-agent">Troubleshoot the agent</a>.</p>
  </li>
  <li>
    <p>Save the logs from the container with the command</p>
    <pre><code>docker logs INTEGRATION_CONTAINER_ID > logs.txt
</code></pre>
    <p>Leave the command running for about three minutes to generate sufficient logging data.</p>
  </li>
  <li>
    <p>Examine the log file for errors.</p>
  </li>
</ol>
<p>If you need to send your log file to <a href="https://support.newrelic.com/">New Relic support</a>:</p>
<ol>
  <li>
    <p>Include the line in your log file that contains the ECS integration version:</p>
    <pre><code>New Relic ECS integration version X.YY.ZZZ
</code></pre>
  </li>
  <li>
    <p>Attach the log file to your support ticket, along with your task definition .yml file.</p>
  </li>
</ol>
