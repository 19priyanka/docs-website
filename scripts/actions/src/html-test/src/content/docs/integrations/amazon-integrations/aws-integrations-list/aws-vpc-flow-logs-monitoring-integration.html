
<p><a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html">Amazon's</a> <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/flow-logs.html">Enhanced AWS VPC Flow Logs</a> enables you to capture information about the IP traffic going to and from network interfaces in your VPC. The VPC Flow Logs integration with New Relic allows you to parse all network logs generated by the private networks in order to monitor accepted/rejected traffic in public IPs and inside the VPC itself.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>The New Relic VPC Flow Logs integration can only process logs in AWS's default format. For more information on VPC Flow Logs formatting, see <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html#flow-log-records">Amazon's VPC Flow Logs documentation</a>.</p>
</div>
<h2>Requirements</h2>
<p>For the VPC logs to send data to New Relic, you must enable a Lambda function provided by New Relic that will perform the ingestion work. Unlike other AWS integrations that have <a href="/docs/infrastructure/infrastructure-integrations/amazon-integrations/aws-polling-intervals-infrastructure-integrations">polling intervals</a>, the VPC Flow Logs integration receives data when it is sent to the Lambda function. The push rate of VPC Flow log data is 15 seconds.</p>
<h2>Enable VPC Flow Logs monitoring [#enable]</h2>
<p>In order to send data to the New Relic ingest service, New Relic provides a specific Lambda function that supports pushes from CloudWatch logs and fetches data from S3 buckets. To assign the Lambda function and enable VPC Flow Logs monitoring:</p>
<ol>
  <li>Create a new AWS Lambda function: Select <strong>Lambda > Functions > AWS Serverless Application Repository</strong>, enable the <strong>Show apps that create custom IAM roles or resource policies</strong> option, and use the application called <code>NewRelic-log-ingestion</code>.</li>
  <li>(Optional) Introduce your New Relic account license key, which is used to populate the <code>LICENSE_KEY</code> environment variable.</li>
  <li>Select <strong>Deploy</strong> to create a new CloudFormation stack, a new function called <code>newrelic-log-ingestion</code>, and the required role.</li>
  <li>Go to <code>newrelic-log-ingestion</code> function. If you haven't already introduced your New Relic account license key, add it now to the <code>LICENSE_KEY</code> environment variable.</li>
  <li>Continue with the procedure to <a href="#stream-logs">stream logs to the Lambda function</a>.</li>
</ol>
<p>Make sure that the <code>NewRelic-log-ingestion</code> function execution role has attached the <code>arn:aws:iam::aws:policy/CloudWatchLogsReadOnlyAccess</code> policy, so it has the appropriate permissions to read CloudWatch Logs.</p>
<h2>Stream logs to Lambda function [#stream-logs]</h2>
<p>To stream logs to the Lambda function:</p>
<ol>
  <li>From the <a href="https://console.aws.amazon.com/cloudwatch/home">CloudWatch Management Console</a>, select <strong>Logs</strong>.</li>
  <li>Select <strong>/aws/vpc/flow-logs</strong> and click <strong>Actions > Stream to AWS Lambda</strong>.</li>
  <li>Select the New Relic Lambda function you created (<code>newrelic-log-ingestion</code>) when you <a href="#enable">enabled VPC Flow Logs monitoring</a>, then select <strong>Next</strong>.</li>
  <li>Keep the default <strong>Log format</strong> (Amazon VPC Flow Logs) and select <strong>Next</strong>.</li>
  <li>Review the configuration, then select <strong>Start streaming</strong>.</li>
</ol>
<h2>Configure traffic logs [#configuration]</h2>
<p>You can configure traffic logs from within AWS in three modes:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Type</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Accepted traffic</p>
      </div>
      <div>
        <p>Logs will only capture traffic in the right</p>
      </div>
    </div>
    <div>
      <div>
        <p>Rejected traffic</p>
      </div>
      <div>
        <p>Logs will only reflect rejected traffic</p>
      </div>
    </div>
    <div>
      <div>
        <p>All traffic</p>
      </div>
      <div>
        <p>Logs will show both accepted and rejected traffic</p>
      </div>
    </div>
  </div>
</div>
<h2>Polling frequency [#polling]</h2>
<p>Unlike other AWS integrations that have <a href="/docs/infrastructure/infrastructure-integrations/amazon-integrations/aws-polling-intervals-infrastructure-integrations">polling intervals</a>, the VPC Flow Logs integration receives data when it is sent to the Lambda function. The push rate of VPC Flow log data is 15 seconds.</p>
<h2>Amazon VPC Flow Logs data processed [#metrics]</h2>
<p>New Relic collects only these log fields from the <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/flow-logs.html#flow-log-records">Amazon VPC Flow Log records</a>.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Field</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>version</code></p>
      </div>
      <div>
        <p>The VPC Flow Logs version.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>account-id</code></p>
      </div>
      <div>
        <p>The AWS account ID for the flow log.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>interface-id</code></p>
      </div>
      <div>
        <p>The ID of the network interface for which the log stream applies.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>srcaddr</code></p>
      </div>
      <div>
        <p>The source IPv4 or IPv6 address. The IPv4 address of the network interface is always its private IPv4 address.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>dstaddr</code></p>
      </div>
      <div>
        <p>The destination IPv4 or IPv6 address. The IPv4 address of the network interface is always its private IPv4 address.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>srcport</code></p>
      </div>
      <div>
        <p>The source port of the traffic.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>dstport</code></p>
      </div>
      <div>
        <p>The destination port of the traffic.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>protocol</code></p>
      </div>
      <div>
        <p>The IANA protocol number of the traffic. For more information, go to Assigned Internet Protocol Numbers.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>packets</code></p>
      </div>
      <div>
        <p>The number of packets transferred during the capture window.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>bytes</code></p>
      </div>
      <div>
        <p>The number of bytes transferred during the capture window.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>start</code></p>
      </div>
      <div>
        <p>The time, in Unix seconds, of the start of the capture window.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>end</code></p>
      </div>
      <div>
        <p>The time, in Unix seconds, of the end of the capture window.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>action</code></p>
      </div>
      <div>
        <p>The action associated with the traffic:</p>
        <ul>
          <li><code>ACCEPT</code>: The recorded traffic was permitted by the security groups or network ACLs.</li>
          <li><code>REJECT</code>: The recorded traffic was not permitted by the security groups or network ACLs.</li>
        </ul>
      </div>
    </div>
    <div>
      <div>
        <p><code>log-status</code></p>
      </div>
      <div>
        <p>The logging status of the flow log:</p>
        <ul>
          <li>OK: Data is logging normally to CloudWatch Logs.</li>
          <li><code>NODATA</code>: There was no network traffic to or from the network interface during the capture window.</li>
          <li><code>SKIPDATA</code>: Some flow log records were skipped during the capture window. This may be because of an internal capacity constraint, or an internal error.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<h2>VPC Flow Log metrics [#metrics]</h2>
<p>New Relic processes these traffic metrics:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Metrics</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>provider.bytes</code></p>
      </div>
      <div>
        <p>The number of bytes.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.packets</code></p>
      </div>
      <div>
        <p>The number of packets.</p>
      </div>
    </div>
  </div>
</div>
<h2>VPC Flow Log dimensions [#dimensions]</h2>
<p>New Relic allows you to slice and dice metrics for accepted or rejected traffic using these dimensions:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Dimensions</p>
      </div>
      <div>
        <p>Definition</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>provider.action</code></p>
      </div>
      <div>
        <p>If the packet was accepted or rejected</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.destinationAddress</code></p>
      </div>
      <div>
        <p>Destination IP address</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.destinationPort</code></p>
      </div>
      <div>
        <p>The destination port</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.interfaceId</code></p>
      </div>
      <div>
        <p>The network interface ID where the packet is registered</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.privateDnsName</code></p>
      </div>
      <div>
        <p>The private DNS name</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.privateIp</code></p>
      </div>
      <div>
        <p>The private IP</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.protocol</code></p>
      </div>
      <div>
        <p>The internet protocol number</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.publicDnsName</code></p>
      </div>
      <div>
        <p>The public DNS name</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.publicIp</code></p>
      </div>
      <div>
        <p>The public IP</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.requesterManaged</code></p>
      </div>
      <div>
        <p>Indicator that the network interface was created by the user or by AWS</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.sourceAddress</code></p>
      </div>
      <div>
        <p>The source IP address</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.sourcePort</code></p>
      </div>
      <div>
        <p>The source port</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.subnetId</code></p>
      </div>
      <div>
        <p>The subnet ID</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>provider.vpcId</code></p>
      </div>
      <div>
        <p>The VPC ID where the network interface belongs</p>
      </div>
    </div>
  </div>
</div>
