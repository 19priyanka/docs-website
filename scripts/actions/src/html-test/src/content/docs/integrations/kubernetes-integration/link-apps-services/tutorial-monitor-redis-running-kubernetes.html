
<p>If you have a service running on Kubernetes, and it's a <a href="/docs/monitor-service-running-kubernetes#integration-configs">service we support</a>, you can enable monitoring of that service by adding a configuration section for that integration to the Kubernetes integration's config.</p>
<p>This tutorial shows how to enable monitoring for a Redis service running on the Kubernetes PHP Guestbook. For the general procedure, see <a href="/docs/monitor-service-running-kubernetes">Monitor a Kubernetes-running service</a>.</p>
<h2>What you need [#requirements]</h2>
<ul>
  <li>See the <a href="/docs/monitor-service-running-kubernetes#requirements">general requirements for this feature</a>, including supported services.</li>
  <li>The <code>kubectl</code> command-line tool must be configured to communicate with your cluster. If you don't have a cluster, you can create one using <a href="https://kubernetes.io/docs/setup/minikube">Minikube</a>.</li>
</ul>
<h2>Step 1: Set up an example Redis application [#set-up-redis]</h2>
<p>This tutorial builds on the Kubernetes tutorial <a href="https://kubernetes.io/docs/tutorials/stateless-application/guestbook/">Deploying a PHP Guestbook application with Redis</a>. Skip the Kubernetes tutorial and run the following command to set up the application needed for our tutorial:</p>
<pre><code>kubectl create -f https://raw.githubusercontent.com/kubernetes/examples/master/guestbook/all-in-one/guestbook-all-in-one.yaml
</code></pre>
<p>If you'd like to first complete the <a href="https://kubernetes.io/docs/tutorials/stateless-application/guestbook/">Kubernetes tutorial</a>, follow their tutorial instructions but do <strong>not</strong> follow the instructions in the <strong>Cleaning up</strong> section.</p>
<h2>Step 2: Enable monitoring of Redis instances [#monitor-redis]</h2>
<p>The PHP Guestbook application has three Redis instances: one master and two slave instances. Each instance is tagged with a label where <code>app=redis</code>. For this example, we're using our <a href="https://docs.newrelic.com/docs/integrations/host-integrations/host-integrations-list/redis-monitoring-integration">Redis monitoring integration</a>. It can monitor both master and slave instances of Redis, so we donâ€™t have to distinguish between them.</p>
<ol>
  <li>
    <p>In the Kubernetes integration's YAML config file (<code>newrelic-infrastructure-k8s-latest.yaml</code>), you need to update the <code>nri-integration-cfg</code> section. From <a href="/docs/monitor-service-running-kubernetes#integration-configs">the list of integration configs</a>, get the Redis integration YAML and add it to the Kubernetes config. The Redis YAML is highlighted below.</p>
    <pre><code>---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nri-integration-cfg
  namespace: default
data:
  redis-config.yml: |
    ---
    # Run auto discovery to find pods with label "app=redis"
    # https://docs.newrelic.com/docs/integrations/host-integrations/installation/container-auto-discovery
    discovery:
      command:
        # Run discovery for Kubernetes. Use the following optional arguments:
        # --namespaces: Comma separated list of namespaces to discover pods on
        # --tls: Use secure (TLS) connection
        # --port: Port used to connect to the kubelet. Default is 10255
        exec: /var/db/newrelic-infra/nri-discovery-kubernetes --port PORT --tls
        match:
          label.app: redis
    integrations:
      - name: nri-redis
        env:
          # using the discovered IP as the hostname address
          HOSTNAME: ${discovery.ip}
          PORT: 6379
          KEYS: '{"0":["&#x3C;KEY_1>"],"1":["&#x3C;KEY_2>"]}'
          REMOTE_MONITORING: true
        labels:
          env: production
</code></pre>
  </li>
  <li>
    <p>Deploy the updated service:</p>
    <pre><code>kubectl create -f newrelic-infrastructure-k8s-latest.yaml
</code></pre>
    <p>You should be able to see the following in the logs for the pod <code>newrelic-infra</code>:</p>
    <pre><code>time="2019-12-23T17:37:07Z" level=info msg="Integration health check starting" instance=redis-metrics integration=com.newrelic.redis prefix=integration/com.newrelic.redis working-dir=/var/db/newrelic-infra/newrelic-integrations
time="2019-12-23T17:37:07Z" level=info msg="Integration health check finished with success" instance=redis-metrics integration=com.newrelic.redis prefix=integration/com.newrelic.redis working-dir=/var/db/newrelic-infra/newrelic-integrations
</code></pre>
  </li>
</ol>
<p>If there are no errors, you should see Redis data in the Infrastructure UI. To find the Redis dashboards, go to <a href="http://one.newrelic.com"><strong>one.newrelic.com</strong></a> <strong>> Infrastructure > Third party services</strong>, and select the <strong>Redis</strong> dashboard.</p>
<p>For the general procedure of how to monitor services running on Kubernetes, including more detail about how configuration works, see <a href="/docs/monitor-service-running-kubernetes">Monitor a Kubernetes-running service</a>.</p>
