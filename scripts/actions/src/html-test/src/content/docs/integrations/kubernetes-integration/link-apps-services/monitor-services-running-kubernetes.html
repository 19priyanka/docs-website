
<p>With New Relic's Kubernetes integration you can monitor both Kubernetes and the services running on it, such as Cassandra, Redis, MySQL, and <a href="#requirements">other supported services</a>.</p>
<h2>Get started [#overview]</h2>
<p>Our Kubernetes integration comes bundled with <a href="#requirements">some of our on-host integrations</a> (like Cassandra, MySQL, and Apache). This lets you get data for those supported services by adding a section to the Kubernetes integration's configuration, which lives as a ConfigMap inside a manifest.</p>
<ul>
  <li><a href="#requirements">What you need</a></li>
  <li><a href="#enable">Enable this feature for a service</a></li>
  <li><a href="#config-details">Details about how configuration works</a></li>
</ul>
<p>For an example of how to monitor Redis running on a Kubernetes PHP Guestbook, see <a href="/docs/monitor-service-running-kubernetes-tutorial">this tutorial</a>.</p>
<h2>What you need [#requirements]</h2>
<p>To monitor services running on Kubernetes, you only need a Kubernetes cluster running the Kubernetes integration, version 1.13.0 or higher (<a href="/docs/integrations/kubernetes-integration/installation/kubernetes-installation-configuration">install</a> | <a href="/docs/integrations/kubernetes-integration/installation/kubernetes-installation-configuration#update">check version</a> | <a href="/docs/integrations/kubernetes-integration/installation/kubernetes-installation-configuration#update">update</a>).</p>
<p>We support the following services running on Kubernetes:</p>
<ul>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/apache-monitoring-integration">Apache</a> (does not report <a href="/docs/integrations/new-relic-integrations/getting-started/understand-use-data-infrastructure-integrations#overview">inventory data</a>)</li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/cassandra-monitoring-integration">Cassandra</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/couchbase-monitoring-integration">Couchbase</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/elasticsearch-monitoring-integration">Elasticsearch</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/haproxy-monitoring-integration">HAProxy</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/hashicorp-consul-monitoring-integration">HashiCorp Consul</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/jmx-monitoring-integration">JMX</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/kafka-monitoring-integration">Kafka</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/memcached-monitoring-integration">Memcached</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/mongodb-monitoring-integration">MongoDB</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/mysql-monitoring-integration">MySQL</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/nginx-monitoring-integration">NGINX</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/postgresql-monitoring-integration">PostgreSQL</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/rabbitmq-monitoring-integration">RabbitMQ</a> (does not report <a href="/docs/integrations/new-relic-integrations/getting-started/understand-use-data-infrastructure-integrations#overview">inventory data</a>)</li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/redis-monitoring-integration">Redis</a></li>
  <li><a href="/docs/integrations/host-integrations/host-integrations-list/snmp-monitoring-integration">SNMP</a></li>
</ul>
<h2>Enable monitoring of services [#enable]</h2>
<p>To enable our Kubernetes integration to monitor one or more services:</p>
<ol>
  <li>
    <p>Expand this dropdown and get the YAML snippets for the service(s) you want to monitor:</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaW50ZWdyYXRpb24tY29uZmlncyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiR2V0IHRoZSBjb25maWcgWUFNTCBmb3IgdGhlIGludGVncmF0aW9uIn1d">
        <div data-prop-text="title">Get the config YAML for the integration</div>
        <p>For the services you want to monitor, follow the links to GitHub to get the YAML snippets you'll need for the next step:</p>
        <ul>
          <li><a href="https://github.com/newrelic/nri-apache/blob/master/apache-config.yml.k8s_sample">Apache</a></li>
          <li><a href="https://github.com/newrelic/nri-cassandra/blob/master/cassandra-config.yml.k8s_sample">Cassandra</a></li>
          <li><a href="https://github.com/newrelic/nri-couchbase/blob/master/couchbase-config.yml.k8s_sample">Couchbase</a></li>
          <li><a href="https://github.com/newrelic/nri-elasticsearch/blob/master/elasticsearch-config.yml.k8s_sample">Elasticsearch</a></li>
          <li><a href="https://github.com/newrelic/nri-haproxy/blob/master/haproxy-config.yml.k8s_sample">HAProxy</a></li>
          <li><a href="https://github.com/newrelic/nri-consul/blob/master/consul-config.yml.k8s_sample">HashiCorp Consul</a></li>
          <li><a href="https://github.com/newrelic/nri-jmx/blob/master/jmx-config.yml.k8s_sample">JMX</a></li>
          <li><a href="https://github.com/newrelic/nri-kafka/blob/master/kafka-config.yml.k8s_sample">Kafka</a></li>
          <li><a href="https://github.com/newrelic/nri-memcached/blob/master/memcached-config.yml.k8s_sample">Memcached</a></li>
          <li><a href="https://github.com/newrelic/nri-mongodb/blob/master/mongodb-config.yml.k8s_sample">MongoDB</a></li>
          <li><a href="https://github.com/newrelic/nri-mysql/blob/master/mysql-config.yml.k8s_sample">MySQL</a></li>
          <li><a href="https://github.com/newrelic/nri-nginx/blob/master/nginx-config.yml.k8s_sample">NGINX</a></li>
          <li><a href="https://github.com/newrelic/nri-postgresql/blob/master/postgresql-config.yml.k8s_sample">PostgreSQL</a></li>
          <li><a href="https://github.com/newrelic/nri-rabbitmq/blob/master/rabbitmq-config.yml.k8s_sample">RabbitMQ</a></li>
          <li><a href="https://github.com/newrelic/nri-redis/blob/master/redis-config.yml.k8s_sample">Redis</a></li>
          <li><a href="https://github.com/newrelic/nri-snmp/blob/master/snmp-config.yml.k8s_sample">SNMP</a></li>
        </ul>
      </div>
    </div>
  </li>
  <li>
    <p>Add the snippet to the Kubernetes integration's ConfigMap, after the <code>data:</code> section:</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1jb25maWctbWFwIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJFeGFtcGxlIGNvbmZpZ3VyYXRpb24ifV0=">
        <div data-prop-text="title">Example configuration</div>
        <p>This example shows the YAML config for the Apache integration (highlighted) added to the Kubernetes integration's config. Respect the indentation levels.</p>
        <pre><code>---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nri-integration-cfg
  namespace: default
data:
  apache-config.yaml: |
    ---
    # Run auto discovery to find pods with label "app=apache"
    # https://docs.newrelic.com/docs/integrations/host-integrations/installation/container-auto-discovery
    discovery:
      command:
        # Use the optional arguments:
        # --namespaces: Comma separated namespaces to discover pods on
        # --tls: Use secure (TLS) connection
        # --port: Port used to connect to the kubelet. Default is 10255
        exec: /var/db/newrelic-infra/nri-discovery-kubernetes --port PORT --tls
        match:
          label.app: apache
    integrations:
      - name: nri-apache
        env:
          # Use the discovered IP as the host address
          STATUS_URL: http://${discovery.ip}/server-status?auto
          METRICS: 1

</code></pre>
      </div>
    </div>
    <p>You can add snippets for multiple services to the same config file. <a href="#add-service">See an example.</a></p>
  </li>
  <li>
    <p>Depending on your environment, you may need or want to set additional config options. Expand the dropdown below for links to configuration options.</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaW50ZWdyYXRpb24tY29uZmlnLWxpbmtzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJDb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIGVhY2ggaW50ZWdyYXRpb24ifV0=">
        <div data-prop-text="title">Configuration options for each integration</div>
        <p>Select a service to see available config options:</p>
        <ul>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/apache-monitoring-integration#config">Apache</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/cassandra-monitoring-integration#config">Cassandra</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/couchbase-monitoring-integration#config">Couchbase</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/elasticsearch-monitoring-integration#config">Elasticsearch</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/haproxy-monitoring-integration#config">HAProxy</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/hashicorp-consul-monitoring-integration#config">HashiCorp Consul</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/jmx-monitoring-integration#config">JMX</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/Kafka-monitoring-integration#config">Kafka</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/memcached-monitoring-integration#config">Memcached</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/mongodb-monitoring-integration#config">MongoDB</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/mysql-monitoring-integration#config">MySQL</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/nginx-monitoring-integration#config">NGINX</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/postgresql-monitoring-integration#config">PostgreSQL</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/rabbitmq-monitoring-integration#config">RabbitMQ</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/redis-monitoring-integration#config">Redis</a></li>
          <li><a href="/docs/integrations/host-integrations/host-integrations-list/snmp-monitoring-integration#config">SNMP</a></li>
        </ul>
      </div>
    </div>
  </li>
  <li>
    <p>Verify monitoring is enabled: Go to <strong><a href="http://one.newrelic.com">one.newrelic.com</a> > Infrastructure</strong>, select <strong>Third party services</strong>, and then select the service's dashboard. You should see data being reported.</p>
  </li>
</ol>
<p>Additional notes about enabling services:</p>
<ul>
  <li>Enabling multiple services may use more resources than what is set in the resource limits of the Kubernetes integration config file. If this becomes an issue, raise the limit in the <code>resources</code> section.</li>
  <li>The Kubernetes integration does not automatically update. For best results, regularly <a href="/docs/integrations/kubernetes-integration/installation/kubernetes-installation-configuration#update">update</a>.</li>
</ul>
<h3>Monitor services in our Kubernetes integration installed with Helm [#monitor-services-helm]</h3>
<p>If you <a href="/docs/integrations/kubernetes-integration/installation/install-kubernetes-integration-using-helm">installed our Kubernetes integration using Helm</a>, to monitor services you need to <a href="https://helm.sh/docs/helm/helm_upgrade/">update the existing installation</a> with the new configuration, which contains the services to monitor:</p>
<pre><code>helm upgrade --reuse-values -f values.yaml [RELEASE] [CHART]
</code></pre>
<p>If you use <a href="https://github.com/newrelic/helm-charts/blob/master/charts/nri-bundle/README.md"><code>nri-bundle</code> charts</a>, you need to update the children's chart values. Find some examples <a href="https://github.com/newrelic/helm-charts/blob/master/charts/nri-bundle/README.md">here</a>.</p>
<h3>Learn more [#update-kear-more"]</h3>
<p>More resources for learning about configuration:</p>
<ul>
  <li>Learn <a href="#config-details">technical details about how configuration works</a>.</li>
  <li>Learn how to <a href="#add-service">configure monitoring of multiple services with the same config file</a>.</li>
  <li>See a <a href="/docs/monitor-service-running-kubernetes-tutorial">step-by-step tutorial showing how to monitor a Redis service on Kubernetes</a>.</li>
</ul>
<h2>Manually configure service monitoring [#config-details]</h2>
<p>The <a href="#enable">enable procedure</a> should be all you need to get monitoring working, but if you run into problems, understanding some technical details about configuration can be helpful. This section goes into more detail about how configuration works.</p>
<p>For each service you wish to monitor, you must add a configuration file for that integration to our Kubernetes integration's configuration. This document will cover these subjects:</p>
<ul>
  <li><a href="#integration-config">How the service-specific configuration YAML snippet works</a></li>
  <li><a href="#configmap">Adding the service-specific YAML in the Kubernetes integration's config file</a></li>
  <li><a href="#add-service">Adding multiple services to the Kubernetes integration's config file</a></li>
</ul>
<h3>How the service-specific YAML config works [#integration-config]</h3>
<p>Our Kubernetes integration's configuration follows the <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap</a> format. Using a <code>ConfigMap</code> allows us to decouple the configuration for the integrations from the Kubernetes image. The other benefit is that a <code>ConfigMap</code> can be updated automatically without reloading the running container.</p>
<p>Because the infrastructure agent uses YAML to configure its associated integrations, <code>ConfigMaps</code> are a good choice for storing YAML. (For more information on config file format, see the <a href="/docs/integrations/integrations-sdk/file-specifications/integration-configuration-file-specifications">Integration config file format</a>.)</p>
<p>The Kubernetes integration image comes with an <a href="https://github.com/newrelic/nri-discovery-kubernetes">auto-discovery feature</a> that simplifies the configuration of multiple instances of services using a single configuration file. For example, if you have several NGINX instances running, creating an <a href="/docs/integrations/host-integrations/host-integrations-list/nginx-monitoring-integration#config">NGINX integration configuration file</a> for every instance would be hard to implement and hard to update. With our auto-discovery option, you can discover and monitor all your NGINX instances with a single configuration file.</p>
<p>Each integration has its own <a href="#integration-config-links">specific configuration YAML</a>. Our NGINX integration default config file looks like this:</p>
<pre><code>nginx-config.yml: |
    ---
    discovery:
      command:
        exec: /var/db/newrelic-infra/nri-discovery-kubernetes
        match:
          label.app: nginx
    integrations:
      - name: nri-nginx
        env:
          STATUS_URL: http://${discovery.ip}/status
          STATUS_MODULE: discover
          METRICS: 1
</code></pre>
<p>The above config enables the following:</p>
<ul>
  <li>Runs <code>nri-discovery-kubernetes</code> to query the data for the node we are currently on.</li>
  <li>Parses the data that comes back and looks for any Kubernetes pod that has a Kubernetes container with an <code>app=</code> label with value <code>nginx</code>.</li>
  <li>For any matches, it attempts to run the NGINX integration. The status URL is built from:
    <ul>
      <li>The pod's IP address</li>
      <li>The status page is pulled from the label on K8s pod called <code>status_url</code></li>
    </ul>
  </li>
</ul>
<p>This automatic discovery works the same as the <a href="/docs/integrations/host-integrations/installation/container-auto-discovery">container auto-discovery</a> used by the infrastructure agent. For more advanced options, see <a href="/docs/integrations/host-integrations/installation/container-auto-discovery">Container auto-discovery</a>.</p>
<h3>Add a service YAML to the Kubernetes integration config [#configmap]</h3>
<p>It's best practice to configure enabled integrations alongside the Kubernetes integration configuration. This is easier than maintaining configuration files for every single service/integration instance.</p>
<p>Below is an example of a Kubernetes integration's ConfigMap. The highlighted section shows where an integration configuration YAML (in this case, NGINX) is placed.</p>
<p>For more information on <code>discovery:</code>, see <a href="/docs/integrations/host-integrations/installation/container-auto-discovery">Container auto-discovery for on-host integrations</a>.</p>
<pre><code>---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nri-integration-cfg
  namespace: default
data:
  nginx-config.yml: |
    ---
    # Run auto discovery to find pods with label "app=nginx"
    # https://docs.newrelic.com/docs/integrations/host-integrations/installation/container-auto-discovery
    discovery:
      command:
        # Use the following optional arguments:
        # --namespaces: Comma separated list of namespaces to discover pods on
        # --tls: Use secure (TLS) connection
        # --port: Port used to connect to the kubelet. Default is 10255
        exec: /var/db/newrelic-infra/nri-discovery-kubernetes --port PORT --tls
        match:
          label.app: nginx
    integrations:
      - name: nri-nginx
        env:
          # If you're using ngx_http_api_module be certain to use the full path up to and including the version number
          # Use the discovered IP as the host address
          STATUS_URL: http://${discovery.ip}/status
          # Comma separated list of ngx_http_api_module, NON PARAMETERIZED, Endpoints
          # endpoints: /nginx,/processes,/connections,/ssl,/slabs,/http,/http/requests,/http/server_zones,/http/caches,/http/upstreams,/http/keyvals,/stream,/stream/server_zones,/stream/upstreams,/stream/keyvals,/stream/zone_sync
          # Name of Nginx status module OHI is to query against. discover | ngx_http_stub_status_module | ngx_http_status_module | ngx_http_api_module
          STATUS_MODULE: discover
          METRICS: 1
</code></pre>
<p>This configuration map can then be referenced in the DaemonSet, the same as the one that was generated via the command line.</p>
<p>Make sure the <code>namespace</code> used is the same one used by the Kubernetes integration manifest. If you haven't changed it in the downloaded manifest file, the value is <code>default</code>.</p>
<h3>Add multiple services to the same config [#add-service]</h3>
<p>You can monitor several services using the same Kubernetes integration config file. To do this, add another integration <a href="#integration-config-links">configuration YAML</a> to the same Kubernetes integration config file. Below is the Kubernetes config created in the last section, with a new section for the Cassandra integration's config (highlighted).</p>
<pre><code>---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nri-integration-cfg
  namespace: default
data:
  nginx-config.yml: |
    ---
    # Run auto discovery to find pods with label "app=nginx"
    # https://docs.newrelic.com/docs/integrations/host-integrations/installation/container-auto-discovery
    discovery:
      command:
        # Run discovery for Kubernetes. Use the following optional arguments:
        # --namespaces: Comma separated list of namespaces to discover pods on
        # --tls: Use secure (TLS) connection
        # --port: Port used to connect to the kubelet. Default is 10255
        exec: /var/db/newrelic-infra/nri-discovery-kubernetes --port PORT --tls
        match:
          label.app: nginx
    integrations:
      - name: nri-nginx
        env:
          # If you're using ngx_http_api_module be certain to use the full path up to and including the version number
          # Use the discovered IP as the host address
          STATUS_URL: http://${discovery.ip}/status
          # Comma separated list of ngx_http_api_module, NON PARAMETERIZED, Endpoints
          # endpoints: /nginx,/processes,/connections,/ssl,/slabs,/http,/http/requests,/http/server_zones,/http/caches,/http/upstreams,/http/keyvals,/stream,/stream/server_zones,/stream/upstreams,/stream/keyvals,/stream/zone_sync
          # Name of Nginx status module OHI is to query against. discover | ngx_http_stub_status_module | ngx_http_status_module | ngx_http_api_module
          STATUS_MODULE: discover
          METRICS: 1
  cassandra-configuration.yml: |
    ---
    # Run auto discovery to find pods with label "app=cassandra"
    # https://docs.newrelic.com/docs/integrations/host-integrations/installation/container-auto-discovery
    discovery:
      command:
        # Run discovery for Kubernetes. Use the following optional arguments:
        # --namespaces: Comma separated list of namespaces to discover pods on
        # --tls: Use secure (TLS) connection
        # --port: Port used to connect to the kubelet. Default is 10255
        exec: /var/db/newrelic-infra/nri-discovery-kubernetes --port PORT --tls
        match:
          label.app: cassandra
    integrations:
      - name: nri-cassandra
        env:
          # Use the discovered IP as the host address
          HOSTNAME: ${discovery.ip}
          PORT: 7199
          USERNAME: cassandra
          PASSWORD: cassandra
          METRICS: 1/mark
</code></pre>
<p>The Kubernetes integration config is now set up to monitor these two services. Additionally, depending on your environment, there may be some additional <a href="#integration-config-links">service-specific configuration</a> you must do.</p>
<p>When you've completed configuration, our infrastructure agent looks for any pod with a label <code>cassandra</code> and runs the integration against it.</p>
