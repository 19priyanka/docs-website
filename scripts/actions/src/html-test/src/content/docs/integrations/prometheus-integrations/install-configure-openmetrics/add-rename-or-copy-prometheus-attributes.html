
<p>The New Relic Prometheus OpenMetrics integration provides controls to transform the Prometheus metrics for Docker and Kubernetes before sending them to New Relic. After you define the transformations in the integration config file, they are performed for all endpoints.</p>
<h2>Hierarchy</h2>
<p>The <a href="https://download.newrelic.com/infrastructure_agent/integrations/kubernetes/nri-prometheus-latest.yaml"><code>nri-prometheus-latest.yaml</code></a> manifest file includes the <code>nri-prometheus-cfg</code> config map showing an example configuration. The transformations are executed in the following order:</p>
<ol>
  <li>Ignore metrics.</li>
  <li>Add or include attributes.</li>
  <li>Rename attributes.</li>
  <li>Copy attributes.</li>
</ol>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Avoid sending Prometheus OpenMetrics integration data that is not relevant to your monitoring needs. Instead, use filters to ignore or include specific metrics. This will help you control the amount and types of data you send to New Relic. This will also help you avoid additional billing charges. For more information, see <a href="https://docs.newrelic.com/docs/integrations/prometheus-integrations/install-configure/ignore-or-include-prometheus-metrics">Ignore or include Prometheus metrics</a>.</p>
</div>
<h2>Example configuration [#transformation-configuration]</h2>
<p>To use these options, set up the scraper container configuration file (<code>config.yaml</code> in the current directory):</p>
<pre><code>docker run -d --restart unless-stopped \
    --name nri-prometheus \
    -e CLUSTER_NAME="YOUR_CLUSTER_NAME"
    -e LICENSE_KEY="YOUR_LICENSE_KEY" \
    -v "$(pwd)/config.yaml:/config.yaml" \
    newrelic/nri-prometheus:latest --configfile=/config.yaml
</code></pre>
<p>Here is an example configuration file containing all of these examples:</p>
<pre><code>transformations:
 - description: "Transformation for MySQL exporter"
   add_attributes:
     - metric_prefix: "mysql_"
       attributes:
         owningTeam: "database-team"
   rename_attributes:
     - metric_prefix: "mysql_"
       attributes:
         table: "tableName"
         under_score: "CamelCase"
   copy_attributes:
     - from_metric: "mysql_version_info"
       to_metrics:
         - "mysql_"
       attributes:
         - "innodb_version"
         - "version"
   ignore_metrics:
     - prefixes:
       - "go_"
       - "process_"
</code></pre>
<h2>Add attributes</h2>
<p>This transformation allows you to include a set of statically defined attributes to a set of target metrics.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1jb3B5In0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJBZGQgYXR0cmlidXRlcyJ9XQ==">
    <div data-prop-text="title">Add attributes</div>
    <p><strong>Configuration:</strong></p>
    <p>To include the <code>owningTeam</code> attribute to all metrics starting with <code>mysql_</code>:</p>
    <pre><code>add_attributes:
  - prefix: "mysql_"
    attributes: 
      owningTeam: "database-team"

</code></pre>
    <pre><code>
mysql_info_schema_table_rows{schema="sys",table="host_summary","owningTeam":"database-team","datacenter":"europe"} 123 another_metric{table="first","datacenter":"europe"} 800

</code></pre>**Output:**
    <pre><code>
mysql_info_schema_table_rows{schema="sys",table="host_summary"} 123 another_metric{table="first"} 800

</code></pre>**Input:**
    <pre><code>
add_attributes:
  - prefix: ""
    attributes: 
      datacenter: "europe"

</code></pre>To include the `datacenter` attribute to all the metrics:
  </div>
</div>
<h2>Rename attributes</h2>
<p>Not all Prometheus endpoints have consistent naming. You can rename the attributes as needed.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1yZW5hbWUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IlJlbmFtZSBhdHRyaWJ1dGVzIn1d">
    <div data-prop-text="title">Rename attributes</div>
    <p><strong>Configuration:</strong></p>
    <p>To rename the <code>table</code> attribute to <code>tableName</code> for metrics that start with <code>mysql_</code>:</p>
    <pre><code>rename_attributes:
  - metric_prefix: "mysql_" 
    attributes:
      table: "tableName"

</code></pre>
    <pre><code>
mysql_info_schema_table_rows{schema="sys",tableName="host_summary"} 123 another_metric{table="first"} 800

</code></pre>**Output:**
    <pre><code>
mysql_info_schema_table_rows{schema="sys",table="host_summary"} 123 another_metric{table="first"} 800

</code></pre>**Input:**
  </div>
</div>
<h2>Copy attributes</h2>
<p>Some Prometheus endpoints provide an <code>_info</code> or <code>_static</code> metric containing metadata about the service, such as the version. It can be helpful to have this attribute on all metrics for that service. This transformation allows you to copy attributes from a source metric to a set of target metrics.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>You can only copy attributes between metrics in the same endpoint.</p>
</div>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1jb3B5In0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJDb3B5IGF0dHJpYnV0ZXMifV0=">
    <div data-prop-text="title">Copy attributes</div>
    <p><strong>Configuration:</strong></p>
    <p>To copy the <code>innodb_version</code> and <code>version</code> attributes from the <code>mysql_version_info</code> metric to all metrics starting with <code>mysql_</code>:</p>
    <pre><code>copy_attributes:
  - from_metric: "mysql_version_info"
    to_metrics:
      - "mysql_" 
    attributes: 
      - "innodb_version"
      - "version"

</code></pre>
    <pre><code>
mysql_global_variables_slave_transaction_retries{innodb_version="5.7.14",version="5.7.14"} 10

</code></pre>**Output:**
    <pre><code>
# HELP mysql_version_info MySQL version and distribution. mysql_version_info{innodb_version="5.7.14",version="5.7.14",version_comment="MySQL Community Server (GPL)"} 1

# HELP mysql_global_variables_slave_transaction_retries Generic gauge metric from SHOW GLOBAL VARIABLES. mysql_global_variables_slave_transaction_retries 10

</code></pre>**Input:**
  </div>
</div>
