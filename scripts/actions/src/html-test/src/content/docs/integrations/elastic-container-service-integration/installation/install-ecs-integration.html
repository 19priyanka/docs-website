
<p>New Relic's <a href="/docs/introduction-amazon-ecs-integration">ECS integration</a> reports and displays performance data from your <a href="https://docs.aws.amazon.com/ecs/index.html">Amazon ECS</a> environment. This document explains how to install this integration.</p>
<h2>Install overview</h2>
<p>Before you install our ECS integration, we recommend reviewing the <a href="/docs/introduction-amazon-ecs-integration#requirements">requirements</a>.</p>
<p>Here's a brief overview of what happens during the install process:</p>
<ul>
  <li>
    <p>For EC2 launch type:</p>
    <ul>
      <li>The infrastructure agent (<code>newrelic-infra</code>) gets deployed onto an ECS cluster as a service using the <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/scheduling_tasks.html">daemon scheduling</a> strategy.</li>
      <li>This deployment installs the infrastructure agent in all the container instances of the cluster. The infrastructure agent then monitors ECS and Docker containers.</li>
    </ul>
  </li>
  <li>
    <p>For Fargate launch type:</p>
    <ul>
      <li>The infrastructure agent (<code>newrelic-infra</code>) gets deployed as a sidecar in every task to monitor.</li>
    </ul>
  </li>
</ul>
<p>Install options:</p>
<ul>
  <li><a href="#cloud-formation-install">Install using AWS CloudFormation</a></li>
  <li><a href="#auto-script-install">Install using automatic script</a></li>
  <li><a href="#manual-install">Install manually</a></li>
</ul>
<h2>Install using CloudFormation [#cloud-formation-install]</h2>
<p>One <a href="#install-overview">install option</a> is using AWS CloudFormation. We provide some CloudFormation templates that install the ECS integration onto your AWS account for both EC2 and Fargate launch types:</p>
<ol>
  <li>
    <p>To register the New Relic's ECS integration task, deploy <a href="https://console.aws.amazon.com/cloudformation/home#/stacks/create/review?templateURL=https://nr-downloads-main.s3.amazonaws.com/infrastructure_agent/integrations/ecs/cloudformation/task/master.yaml&#x26;stackName=NewRelicECSIntegration">this stack</a>. Ensure youâ€™re deploying the stack to your desired region(s). This stack creates the following resources:</p>
    <ul>
      <li>A secret that stores the <a href="/docs/accounts/install-new-relic/account-setup/license-key">license key</a>.</li>
      <li>A policy to access the license key.</li>
      <li>An instance role to be used as an ECS task <code>ExecutionRole</code>, with access to the license key.</li>
      <li>For EC2 launch type: Registers the New Relic Infrastructure ECS integration task.</li>
    </ul>
  </li>
  <li>
    <p>Follow the additional instructions for your launch type:</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZWMyLWNsb3VkZm9ybWF0aW9uIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJFQzIgbGF1bmNoIHR5cGUifV0=">
        <div data-prop-text="title">EC2 launch type</div>
        <p>Additional steps for EC2 launch type:</p>
        <p>To create a service that runs the task on every container instance, deploy <a href="https://console.aws.amazon.com/cloudformation/home#/stacks/create/review?templateURL=https://nr-downloads-main.s3.amazonaws.com/infrastructure_agent/integrations/ecs/cloudformation/service.yaml&#x26;NewRelicInfraTaskVersion=1">this stack</a>.</p>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZmFyZ2F0ZS1jbG91ZGZvcm1hdGlvbiJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiRmFyZ2F0ZSBsYXVuY2ggdHlwZSJ9XQ==">
        <div data-prop-text="title">Fargate launch type</div>
        <p>Additional steps for Fargate launch type:</p>
        <ol>
          <li>
            <p>Download the task definition example with the sidecar container to be deployed:</p>
            <pre><code>curl -O https://download.newrelic.com/infrastructure_agent/integrations/ecs/newrelic-infra-ecs-fargate-example-latest.json
</code></pre>
          </li>
          <li>
            <p>Add the <code>newrelic-infra</code> container in this task definition as a sidecar to the task definitions you want monitored.</p>
          </li>
        </ol>
      </div>
    </div>
  </li>
</ol>
<p>Next steps:</p>
<ul>
  <li>Wait a few minutes and then <a href="/docs/ecs-integration-understand-use-data">look for your data in the UI</a>.</li>
  <li>Recommended: Install our <a href="https://docs.newrelic.com/docs/integrations/amazon-integrations/aws-integrations-list/aws-ecsecr-monitoring-integration">ECS cloud integration</a>, which gets you other ECS data, including information about clusters and services.</li>
  <li>See <a href="/docs/ecs-integration-recommended-alert-conditions">recommended alert conditions</a>.</li>
  <li>Understand the <a href="#aws-resources">AWS resources</a> created by this process.</li>
</ul>
<h2>Install with automatic script [#auto-script-install]</h2>
<p>One <a href="#install-overview">install option</a> is using our install script. To use the automatic install script:</p>
<ol>
  <li>
    <p>Download the ECS integration installer:</p>
    <pre><code>curl -O https://download.newrelic.com/infrastructure_agent/integrations/ecs/newrelic-infra-ecs-installer.sh
</code></pre>
  </li>
  <li>
    <p>Add execute permissions to the installer:</p>
    <pre><code>chmod +x newrelic-infra-ecs-installer.sh
</code></pre>
  </li>
  <li>
    <p>Execute it with <code>-h</code> to see the documentation and requirements:</p>
    <pre><code>./newrelic-infra-ecs-installer.sh -h
</code></pre>
  </li>
  <li>
    <p>Check that your AWS profile points to the same region where your ECS cluster was created:</p>
    <pre><code>$ aws configure get region
us-east-1

$ aws ecs list-clusters
YOUR_CLUSTER_ARNS 	
arn:aws:ecs:us-east-1:YOUR_AWS_ACCOUNT:cluster/YOUR_CLUSTER
</code></pre>
  </li>
  <li>
    <p>Execute the installer, specifying your <a href="/docs/accounts/install-new-relic/account-setup/license-key">license key</a> and cluster name.</p>
    <p>EC2 launch type:</p>
    <pre><code>./newrelic-infra-ecs-installer.sh -c YOUR_CLUSTER_NAME -l YOUR_LICENSE_KEY
</code></pre>
    <p>Fargate launch type:</p>
    <pre><code>./newrelic-infra-ecs-installer.sh -fargate -c YOUR_CLUSTER_NAME -l YOUR_LICENSE_KEY
</code></pre>
  </li>
  <li>
    <p>Additional steps for <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/launch_types.html">Fargate launch type</a> (not EC2 launch type):</p>
    <ul>
      <li>
        <p>Download the task definition example with the sidecar container to be deployed:</p>
        <pre><code>curl -O https://download.newrelic.com/infrastructure_agent/integrations/ecs/newrelic-infra-ecs-fargate-example-latest.json
</code></pre>
      </li>
      <li>
        <p>Add the single container in this task definition as a sidecar to the task definitions you want monitored.</p>
      </li>
    </ul>
  </li>
</ol>
<p>Next steps:</p>
<ul>
  <li>Wait a few minutes and then <a href="/docs/ecs-integration-understand-use-data">look for your data in the UI</a>.</li>
  <li>Recommended: Install our <a href="https://docs.newrelic.com/docs/integrations/amazon-integrations/aws-integrations-list/aws-ecsecr-monitoring-integration">ECS cloud integration</a>, which gets you other ECS data, including information about clusters and services.</li>
  <li>See <a href="/docs/ecs-integration-recommended-alert-conditions">recommended alert conditions</a>.</li>
  <li>Understand the <a href="#aws-resources">AWS resources</a> created by this process.</li>
</ul>
<h2>Manual install</h2>
<p>One <a href="#install-overview">install option</a> is to manually do the steps that are done by the <a href="#auto-script-install">automatic installer script</a>. We will describe how this is done using the <code>awscli</code> tool:</p>
<ol>
  <li>
    <p>Check that your AWS profile points to the same region where your ECS cluster was created:</p>
    <pre><code>$ aws configure get region
us-east-1

$ aws ecs list-clusters
YOUR_CLUSTER_ARNS
arn:aws:ecs:us-east-1:YOUR_AWS_ACCOUNT:cluster/YOUR_CLUSTER
</code></pre>
  </li>
  <li>
    <p>Save your <a href="/docs/accounts/install-new-relic/account-setup/license-key">New Relic license key</a> as a Systems Manager (SSM) parameter:</p>
    <pre><code>aws ssm put-parameter \
  --name "/newrelic-infra/ecs/license-key" \
  --type SecureString \
  --description 'New Relic license key for ECS monitoring' \
  --value "NEW_RELIC_LICENSE_KEY"
</code></pre>
  </li>
  <li>
    <p>Create an IAM policy to access the license key parameter:</p>
    <pre><code>aws iam create-policy \
	--policy-name "NewRelicSSMLicenseKeyReadAccess" \
	--policy-document "{"Version"\"2012-10-17","Statement":[{"Effect":"Allow","Action":["ssm:GetParameters"],"Resource":["ARN_OF_LICENSE_KEY_PARAMETER"]}]}"
	--description "Provides read access to the New Relic SSM license key parameter"
</code></pre>
  </li>
  <li>
    <p>Create an IAM role to be used as the task execution role:</p>
    <pre><code>aws iam create-role \
  --role-name "NewRelicECSTaskExecutionRole" \
  --assume-role-policy-document '{"Version":"2008-10-17","Statement":[{"Sid":"","Effect":"Allow","Principal":{"Service":"ecs-tasks.amazonaws.com"},"Action":"sts:AssumeRole"}]}' \
  --description "ECS task execution role for New Relic infrastructure"
</code></pre>
  </li>
  <li>
    <p>Attach the policies <code>NewRelicSSMLicenseKeyReadAccess</code>, <code>AmazonEC2ContainerServiceforEC2Role</code>, and <code>AmazonECSTaskExecutionRolePolicy</code> to the role:</p>
    <pre><code>aws iam attach-role-policy \
  	--role-name "NewRelicECSTaskExecutionRole" \
  	--policy-arn "POLICY_ARN"
</code></pre>
  </li>
  <li>
    <p>Choose your launch type for more instructions:</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibWFudWFsLWVjMiJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiRUMyIGxhdW5jaCB0eXBlIn1d">
        <div data-prop-text="title">EC2 launch type</div>
        <p>Additional steps for EC2 launch type:</p>
        <ol>
          <li>
            <p>Download the New Relic ECS integration task definition template file:</p>
            <pre><code>curl -O https://download.newrelic.com/infrastructure_agent/integrations/ecs/newrelic-infra-ecs-ec2-latest.json
</code></pre>
          </li>
          <li>
            <p>Replace the task execution role in the template file with the newly created role:</p>
            <pre><code>"executionRoleArn": "NewRelicECSTaskExecutionRole",
</code></pre>
          </li>
          <li>
            <p>Replace the <code>valueFrom</code> attribute of the <code>secret</code> with the name of the Systems Manager parameter:</p>
            <pre><code>secrets": [
  {
    "valueFrom": "/newrelic-infra/ecs/license-key",
    "name": "NRIA_LICENSE_KEY"
  }
],
</code></pre>
          </li>
          <li>
            <p>Register the task definition file:</p>
            <pre><code>aws ecs register-task-definition --cli-input-json file://newrelic-infra-ecs-ec2-latest.json
</code></pre>
          </li>
          <li>
            <p>Create a service with the <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html">daemon scheduling</a> strategy for the registered task:</p>
            <pre><code>aws ecs create-service --cluster "YOUR_CLUSTER_NAME" --service-name "newrelic-infra" --task-definition "newrelic-infra" --scheduling-strategy DAEMON
</code></pre>
          </li>
        </ol>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibWFudWFsLWZhcmdhdGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkZhcmdhdGUgbGF1bmNoIHR5cGUifV0=">
        <div data-prop-text="title">Fargate launch type</div>
        <p>Additional steps for the Fargate launch type:</p>
        <ol>
          <li>
            <p>Download the task definition example with the sidecar container to be deployed:</p>
            <pre><code>curl -O https://download.newrelic.com/infrastructure_agent/integrations/ecs/newrelic-infra-ecs-fargate-example-latest.json
</code></pre>
          </li>
          <li>
            <p>Add the <code>newrelic-infra</code> container in this task definition as a sidecar to the task definitions you want monitored.</p>
          </li>
        </ol>
      </div>
    </div>
  </li>
</ol>
<p>Next steps:</p>
<ul>
  <li>Wait a few minutes and then <a href="/docs/ecs-integration-understand-use-data">look for your data in the UI</a>.</li>
  <li>Recommended: Install our <a href="https://docs.newrelic.com/docs/integrations/amazon-integrations/aws-integrations-list/aws-ecsecr-monitoring-integration">ECS cloud integration</a>, a separate integration which gets you supplementary ECS data, including information about clusters and services.</li>
  <li>See <a href="/docs/ecs-integration-recommended-alert-conditions">recommended alert conditions</a>.</li>
  <li>Understand the <a href="#aws-resources">AWS resources</a> created by this process.</li>
</ul>
<h2>AWS resources created [#aws-resources]</h2>
<p>When you install the ECS integration using default/recommended values, it does the following in AWS:</p>
<ul>
  <li>Creates Systems Manager (SSM) parameter <code>/newrelic-infra/ecs/license-key</code>. This system parameter contains the New Relic <a href="/docs/accounts/install-new-relic/account-setup/license-key">license key</a>.</li>
  <li>Creates IAM policy <code>NewRelicSSMLicenseKeyReadAccess</code>, which enables access to the SSM parameter with the license key.</li>
  <li>Creates IAM role <code>NewRelicECSTaskExecutionRole</code> used as the <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html">task execution role</a>. Policies attached to the role:
    <ul>
      <li><code>NewRelicSSMLicenseKeyReadAccess</code> (created by the installer).</li>
      <li><code>AmazonEC2ContainerServiceforEC2Role</code></li>
      <li><code>AmazonECSTaskExecutionRolePolicy</code></li>
    </ul>
  </li>
  <li>For EC2 <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/launch_types.html">launch type</a>, this is also done:
    <ul>
      <li>Registers the <code>newrelic-infra</code> ECS task definition.</li>
      <li>Creates the service <code>newrelic-infra</code> for the registered task using a <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html">daemon scheduling</a> strategy.</li>
    </ul>
  </li>
</ul>
