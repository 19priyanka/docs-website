
<p>New Relic's on-host <a href="https://docs.newrelic.com/docs/introduction-amazon-ecs-integration">ECS integration</a> reports and displays performance data from your <a href="https://docs.aws.amazon.com/ecs/index.html">Amazon ECS</a> environment. Read on to learn how to uninstall this integration.</p>
<h2>Uninstall</h2>
<p>There are several uninstall options, depending on how you <a href="/docs/install-ecs-integration#install-ec2">installed</a>:</p>
<ul>
  <li><a href="#cloudformation">Uninstall with CloudFormation</a></li>
  <li><a href="#auto-installer">Use automatic installer script</a></li>
  <li><a href="#manual-uninstall">Manual uninstall</a></li>
</ul>
<h3>CloudFormation uninstall [#cloudformation]</h3>
<p>To uninstall the ECS integration using the CloudFormation templates:</p>
<ol>
  <li>Go to the <a href="https://console.aws.amazon.com/cloudformation/home?#/stacks?filteringText=&#x26;filteringStatus=active&#x26;viewNested=true&#x26;hideStacks=false">list of stacks in your AWS console.</a></li>
  <li>For each New Relic stack:
    <ol>
      <li>Select the stack</li>
      <li>Click the delete button</li>
      <li>Click the delete stack button on the confirmation pop-up.</li>
    </ol>
  </li>
</ol>
<h3>Automatic uninstall [#auto-installer]</h3>
<p>To uninstall the ECS integration using the installer script:</p>
<ul>
  <li>
    <p>For EC2 launch type: run</p>
    <pre><code>$ ./newrelic-infrastructure-ecs-installer.sh -u -c YOUR_CLUSTER_NAME
</code></pre>
  </li>
  <li>
    <p>For Fargate launch type:</p>
    <pre><code>$ ./newrelic-infrastructure-ecs-installer.sh -f -u -c YOUR_CLUSTER_NAME
</code></pre>
  </li>
</ul>
<p>You only need to execute the command once, regardless of the number of nodes in your cluster. The command will delete the <a href="/docs/install-ecs-integration#aws-resources">AWS resources created during the install procedure</a>.</p>
<p>The installer provides a dry run mode that shows you the awscli commands that are going to be executed. The dry run mode for the uninstall process is activated by passing the <code>-d</code> flag to the command:</p>
<pre><code>$ ./newrelic-infrastructure-ecs-installer.sh -d -u -c YOUR_CLUSTER_NAME
</code></pre>
<h3>Manual uninstall</h3>
<p>To uninstall manually, you must delete all the <a href="/docs/install-ecs-integration#aws-resources">AWS resources</a> related to the integration. To do this:</p>
<ol>
  <li>
    <p>Check that your AWS profile points to the same region where your ECS cluster was created:</p>
    <pre><code>$ aws configure get region
us-east-1

$ aws ecs list-clusters
YOUR_CLUSTER_ARNS	
arn:aws:ecs:us-east-1:YOUR_AWS_ACCOUNT:cluster/YOUR_CLUSTER
</code></pre>
  </li>
  <li>
    <p>Delete the Systems Manager (SSM) parameter that stores the New Relic license key:</p>
    <pre><code>aws ssm delete-parameter --name "/newrelic-infra/ecs/license-key"
</code></pre>
  </li>
  <li>
    <p>Before deleting the IAM role, you need to detach all of its policies. To get a list of the attached policies:</p>
    <pre><code>aws iam list-attached-role-policies --role-name "NewRelicECSTaskExecutionRole" --output text
--query 'AttachedPolicies[*].PolicyArn'
</code></pre>
  </li>
  <li>
    <p>Detach all the policies returned in the previous step from the IAM role:</p>
    <pre><code>aws iam detach-role-policy --role-name "NewRelicECSTaskExecutionRole" --policy-arn "POLICY_ARN"
</code></pre>
  </li>
  <li>
    <p>Delete the IAM role:</p>
    <pre><code>aws iam delete-role --role-name "NewRelicECSTaskExecutionRole"
</code></pre>
  </li>
  <li>
    <p>Delete the IAM policy <code>NewRelicSSMLicenseKeyReadAccess</code>, which grants System Manager license key access:</p>
    <pre><code>aws iam delete-policy --policy-arn "POLICY_ARN"
</code></pre>
  </li>
  <li>
    <p>The remaining steps are only for EC2 launch type, and not Fargate:</p>
    <ol>
      <li>
        <p>Delete the service:</p>
        <pre><code>aws ecs delete-service --service "newrelic-infra" --cluster "YOUR_CLUSTER_NAME"
</code></pre>
      </li>
      <li>
        <p>List the task definition for the <code>newrelic-infra</code> family of tasks:</p>
        <pre><code>aws ecs list-task-definitions \
--family-prefix newrelic-infra \
            --output text \
            --query taskDefinitionArns
</code></pre>
      </li>
      <li>
        <p>Deregister the tasks:</p>
        <pre><code>aws ecs deregister-task-definition --task-definition "TASK_DEFINITION_ARN"
</code></pre>
      </li>
    </ol>
  </li>
</ol>
