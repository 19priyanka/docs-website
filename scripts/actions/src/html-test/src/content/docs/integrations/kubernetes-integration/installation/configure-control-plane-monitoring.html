
<p><a href="https://docs.newrelic.com/docs/infrastructure/new-relic-infrastructure/getting-started/introduction-new-relic-infrastructure">New Relic</a> provides <a href="http://kubernetes.io/docs/concepts/#kubernetes-control-plane">Control Plane</a> support for your Kubernetes integration, allowing you to monitor and collect metrics from your cluster's Control Plane components. That data can then be found in New Relic and used to <a href="/docs/using-new-relic/data/understand-data/query-new-relic-data">create queries and charts</a>.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>Control plane monitoring requires <a href="/docs/release-notes/platform-release-notes/host-integrations-release-notes/new-relic-integration-kubernetes-1110">Kubernetes integration version 1.11.0 or higher</a>.</p>
</div>
<h2>Features [#control-plane-integration-features]</h2>
<p>We monitor and collect <a href="http://docs.newrelic.com/docs/integrations/kubernetes-integration/understand-use-data/understand-use-data#metrics">metrics</a> from the following control plane components:</p>
<ul>
  <li><strong>ETCD</strong>: leader information, resident memory size, number of OS threads, consensus proposals data, etc. For a list of supported metrics, see <a href="https://docs.newrelic.com/docs/integrations/kubernetes-integration/understand-use-data/understand-use-data#etcd-data">ETCD data</a>.</li>
  <li><strong>API server</strong>: rate of <code>apiserver</code> requests, breakdown of <code>apiserver</code> requests by HTTP method and response code, etc. For the complete list of supported metrics, see <a href="https://docs.newrelic.com/docs/integrations/kubernetes-integration/understand-use-data/understand-use-data#api-server-data">API server data</a>.</li>
  <li><strong>Scheduler</strong>: requested CPU/memory vs available on the node, tolerations to taints, any set affinity or anti-affinity, etc. For the complete list of supported metrics, see <a href="https://docs.newrelic.com/docs/integrations/kubernetes-integration/understand-use-data/understand-use-data#scheduler-data">Scheduler data</a>.</li>
  <li><strong>Controller manager</strong>: resident memory size, number of OS threads created, goroutines currently existing, etc. For the complete list of supported metrics, see <a href="https://docs.newrelic.com/docs/integrations/kubernetes-integration/understand-use-data/understand-use-data#controller-manager-data">Controller manager data</a>.</li>
</ul>
<h2>Compatibility and requirements [#compatibility]</h2>
<ul>
  <li>Control plane monitoring requires <a href="/docs/release-notes/platform-release-notes/host-integrations-release-notes/new-relic-integration-kubernetes-1110">Kubernetes integration version 1.11.0 or higher</a>.</li>
  <li>Control plane monitoring support is not enabled for managed clusters. This is because providers (EKS, GKE, AKS, etc.) abstract away the concept of master nodes and control plane components, so that access to them is limited or non-existent.</li>
  <li>The <a href="https://docs.newrelic.com/docs/integrations/kubernetes-integration/installation/kubernetes-installation-configuration#unprivileged">unprivileged version of the Kubernetes integration</a> does not support control plane monitoring.</li>
  <li><a href="http://learn.openshift.com/?extIdCarryOver=true&#x26;sc_cid=701f2000001OH7iAAG">OpenShift</a> 4.x uses control plane component metric endpoints that are different than the default.</li>
</ul>
<h2>Discovery of master nodes and control plane components [#discover-nodes-components]</h2>
<p>The Kubernetes integration relies on the <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">kubeadm</a> labeling conventions to discover the master nodes and the control plane components. This means that master nodes should be labeled with <code>node-role.kubernetes.io/master=""</code> or <code>kubernetes.io/role="master"</code>.</p>
<p>The control plane components should have either the <code>k8s-app</code> or the <code>tier</code> and <code>component</code> labels. Refer to the following table for accepted label combinations and values:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Component</p>
      </div>
      <div>
        <p>Label</p>
      </div>
      <div>
        <p>Endpoint</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>API server</p>
      </div>
      <div>
        <p><strong>Kubeadm / Kops / ClusterAPI</strong></p>
        <p><code>k8s-app=kube-apiserver</code></p>
        <p><code>tier=control-plane component=kube-apiserver</code></p>
        <p><strong>OpenShift</strong></p>
        <p><code>app=openshift-kube-apiserver apiserver=true</code></p>
      </div>
      <div>
        <p><code>localhost:443/metrics</code> by default (can be configured) if the request fails falls back to <code>localhost:8080/metrics</code></p>
      </div>
    </div>
    <div>
      <div>
        <p>ETCD</p>
      </div>
      <div>
        <p><strong>Kubeadm / Kops / ClusterAPI</strong></p>
        <p><code>k8s-app=etcd-manager-main</code></p>
        <p><code>tier=control-plane component=etcd</code></p>
        <p><strong>OpenShift</strong></p>
        <p><code>k8s-app=etcd</code></p>
      </div>
      <div>
        <p><code>localhost:4001/metrics</code></p>
      </div>
    </div>
    <div>
      <div>
        <p>Scheduler</p>
      </div>
      <div>
        <p><strong>Kubeadm / Kops / ClusterAPI</strong></p>
        <p><code>k8s-app=kube-scheduler</code></p>
        <p><code>tier=control-plane component=kube-scheduler</code></p>
        <p><strong>OpenShift</strong></p>
        <p><code>app=openshift-kube-scheduler scheduler=true</code></p>
      </div>
      <div>
        <p><code>localhost:10251/metrics</code></p>
      </div>
    </div>
    <div>
      <div>
        <p>Controller manager</p>
      </div>
      <div>
        <p><strong>Kubeadm / Kops / ClusterAPI</strong></p>
        <p><code>k8s-app=kube-controller-manager</code></p>
        <p><code>tier=control-plane component=kube-controller-manager​</code></p>
        <p><strong>OpenShift</strong></p>
        <p><code>app=kube-controller-manager kube-controller-manager=true</code></p>
      </div>
      <div>
        <p><code>localhost:10252/metrics</code></p>
      </div>
    </div>
  </div>
</div>
<p>When the integration detects that it is running inside a master node, it tries to find which components are running on the node by looking for pods that match the labels listed in the table above. For every running component, the integration makes a request to its metrics endpoint.</p>
<h2>Configuration</h2>
<p>Control plane monitoring is automatic for agents running inside master nodes. The only component that requires an extra step to run is ETCD, because it uses mutual TLS authentication (mTLS) for client requests. The API Server can also be configured to be queried using the <a href="https://kubernetes.io/docs/reference/access-authn-authz/controlling-access/#api-server-ports-and-ips">Secure Port</a>.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Control plane monitoring for <a href="http://learn.openshift.com/?extIdCarryOver=true&#x26;sc_cid=701f2000001OH7iAAG">OpenShift</a> 4.x requires additional configuration. For more information, see the <a href="#openshift-4x-configuration">OpenShift 4.x Configuration</a> section.</p>
</div>
<h3>ETCD</h3>
<p>In order to set mTLS for querying ETCD, there are two configuration options that need to be set:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Option</p>
      </div>
      <div>
        <p>Value</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>ETCD_TLS_SECRET_NAME</code></p>
      </div>
      <div>
        <p>Name of a Kubernetes secret that contains the mTLS configuration.</p>
        <p>The secret should contain the following keys:</p>
        <ul>
          <li>
            <p><code>cert</code>: the certificate that identifies the client making the request. It should be signed by an ETCD trusted CA.</p>
          </li>
          <li>
            <p><code>key</code>: the private key used to generate the client certificate.</p>
          </li>
          <li>
            <p><code>cacert</code>: the root CA used to identify the ETCD server certificate.</p>
            <p>If the <code>ETCD_TLS_SECRET_NAME</code> option is not set, ETCD metrics won't be fetched.</p>
            <p>For step by step instructions on how to create a certificate and sign it with the ETCD client CA, see <a href="#mtls-how-to">Set up mTLS from the ETCD client CA</a>.</p>
          </li>
        </ul>
      </div>
    </div>
    <div>
      <div>
        <p><code>ETCD_TLS_SECRET_NAMESPACE</code></p>
      </div>
      <div>
        <p>The namespace where the secret specified in the <code>ETCD_TLS_SECRET_NAME</code> was created. If not set, the <code>default</code> namespace is used.</p>
      </div>
    </div>
  </div>
</div>
<h3>API server</h3>
<p>By default, the API server metrics are queried using the <code>localhost:8080</code> unsecured endpoint. If this port is disabled, you can also query these metrics over the secure port. To enable this, set the following configuration option in the Kubernetes integration manifest file:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Option</p>
      </div>
      <div>
        <p>Value</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>API_SERVER_ENDPOINT_URL</code></p>
      </div>
      <div>
        <p>The (secure) URL to query the metrics. The API server uses <code>localhost:443</code> by default</p>
        <p>Ensure that the <code>ClusterRole</code> has been updated to the newest version found in the manifest</p>
        <p>Added in version 1.15.0</p>
      </div>
    </div>
  </div>
</div>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Note that the port can be different according to the secure port used by the API server.</p>
  <p>For example, in Minikube the API server secure port is 8443 and therefore <code>API_SERVER_ENDPOINT_URL</code> should be set to <code>https://localhost:8443</code></p>
</div>
<h2>OpenShift configuration [#openshift-4x-configuration]</h2>
<p>Control plane components on <a href="http://learn.openshift.com/?extIdCarryOver=true&#x26;sc_cid=701f2000001OH7iAAG">OpenShift</a> 4.x use endpoint URLs that require SSL and service account based authentication. Therefore, <a href="https://docs.newrelic.com/docs/integrations/kubernetes-integration/installation/configure-control-plane-monitoring#discover-nodes-components">the default</a> endpoint URLs can not be used.</p>
<p>To configure control plane monitoring on OpenShift, uncomment the following environment variables in the <a href="https://docs.newrelic.com/docs/integrations/kubernetes-integration/installation/kubernetes-integration-install-configure#customized-manifest">customized manifest</a>. URL values are pre-configured to the default base URLs for the control plane monitoring metrics endpoints in <a href="http://learn.openshift.com/?extIdCarryOver=true&#x26;sc_cid=701f2000001OH7iAAG">OpenShift</a> 4.x.</p>
<pre><code>- name: "SCHEDULER_ENDPOINT_URL"
  value: "https://localhost:10259
- name: "ETCD_ENDPOINT_URL"
  value: "https://localhost:9979"
- name: "CONTROLLER_MANAGER_ENDPOINT_URL"
  value: "https://localhost:10257"
- name: "API_SERVER_ENDPOINT_URL"
  value: "https://localhost:6443"
</code></pre>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Even though the custom <code>ETCD_ENDPOINT_URL</code> is defined, ETCD requires HTTPS and mTLS authentication to be configured. For more on configuring mTLS for ETCD in OpenShift, see <a href="#mtls-how-to-openshift">Set up mTLS for ETCD in OpenShift</a>.</p>
</div>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>When installing through Helm <code>openshift</code>, specify the config to automatically include these endpoints. Setting <code>openshift.enabled=true</code> and <code>openshift.version="4.x"</code> will include the secure endpoints and enable the <code>/var/run/crio.sock</code> runtime.</p>
</div>
<h2>Set up mTLS from the ETCD client CA [#mtls-how-to]</h2>
<p>The instructions below are based on the Kubernetes documentation. For more information, see <a href="https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster">Managing TLS certificates in a cluster</a>. For OpenShift, see <a href="#mtls-how-to-openshift">Set up mTLS for ETCD in OpenShift</a>.</p>
<p>To set up mTLS from the ETCD client CA:</p>
<ol>
  <li>
    <p>Download and install the tool <a href="https://pkg.cfssl.org/">cfssl</a>, selecting the correct binaries for your OS from the list.</p>
  </li>
  <li>
    <p>Once installed, execute the following command:</p>
    <pre><code>cat &#x3C;&#x3C;EOF | cfssl genkey - | cfssljson -bare server
{
    "hosts": [
        "localhost"
    ],
    "CN": "newrelic-infra.pod.cluster.local",
    "key": {
        "algo": "ecdsa",
        "size": 256
    }
}
EOF
</code></pre>
    <p>This command generates two files; <code>server.csr</code> containing the PEM encoded pkcs#10 certification request and <code>server-key.pem</code> containing the PEM encoded key to the certificate to be created.</p>
  </li>
  <li>
    <p>Use the generated certificate authority (CA) of ETCD to sign your CSR. Depending on your cluster configuration, you may already have this information. For default install configuration, download the CA certificate and the private key directly from ETCD with the following commands:</p>
    <pre><code>kubectl cp $(kubectl get pods -l k8s-app=etcd-manager-main -n kube-system -o jsonpath="{.items[0].metadata.name}"):/etc/kubernetes/pki/etcd-manager/etcd-clients-ca.crt ./cacert -n kube-system
kubectl cp $(kubectl get pods -l k8s-app=etcd-manager-main -n kube-system -o jsonpath="{.items[0].metadata.name}"):/etc/kubernetes/pki/etcd-manager/etcd-clients-ca.key ./cacert.key -n kube-system
</code></pre>
    <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
      <p>This requires that the <code>etcd-manager-main</code> pod has the label <code>k8s-app=etcd-manager-main</code>, which is a <a href="#compatibility">requirement for control plane monitoring</a> . If your <code>etc-manager-main</code> pod is located in a different namespace, change the <code>-n kube-system</code> flags accordingly.</p>
    </div>
  </li>
  <li>
    <p>With those files downloaded, use the following command to sign your CSRF:</p>
    <pre><code>cfssl sign -ca cacert -ca-key cacert.key server.csr | cfssljson -bare cert
</code></pre>
  </li>
  <li>
    <p>Create the secret that is used to retrieve the TLS config for making requests to ETC. We recommend renaming the certificate and the private key:</p>
    <pre><code>cp cert.pem cert &#x26;&#x26; cp server-key.pem key
</code></pre>
    <pre><code>kubectl -n default create secret generic newrelic-infra-etcd-tls-secret --from-file=./cert --from-file=./key --from-file=./cacert
</code></pre>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZnV0dXJlLWluc3RhbGxhdGlvbnMtc25pcHBldCJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiVG8gZWFzZSBmdXR1cmUgaW5zdGFsbGF0aW9ucyJ9XQ==">
        <div data-prop-text="title">To ease future installations</div>
        <p>Use the following commands to simultaneously create the CSR, retrieve the CA, generate the certificate by signing the CSR, and create the secret with all the required fields:</p>
        <pre><code>cat &#x3C;&#x3C;EOF | cfssl genkey - | cfssljson -bare server &#x26;&#x26; \
    kubectl cp $(kubectl get pods -l k8s-app=etcd-manager-main -n kube-system -o jsonpath="{.items[0].metadata.name}"):/etc/kubernetes/pki/etcd-manager/etcd-clients-ca.crt ./cacert -n kube-system &#x26;&#x26; \
    kubectl cp $(kubectl get pods -l k8s-app=etcd-manager-main -n kube-system -o jsonpath="{.items[0].metadata.name}"):/etc/kubernetes/pki/etcd-manager/etcd-clients-ca.key ./cacert.key -n kube-system &#x26;&#x26; \
    cp server-key.pem key &#x26;&#x26; \
    cfssl sign -ca cacert -ca-key cacert.key server.csr | cfssljson -bare cert &#x26;&#x26; \
    cp cert.pem cert &#x26;&#x26; \
    kubectl -n default create secret generic newrelic-infra-etcd-tls-secret --from-file=./cert --from-file=./key --from-file=./cacert
    {
        "hosts": [
        "localhost"
        ],
        "CN": "newrelic-infra.pod.cluster.local",
        "key": {
            "algo": "ecdsa",
            "size": 256
        }
    }
    EOF

</code></pre>
      </div>
    </div>
  </li>
  <li>
    <p>The last step is to update the configuration in the manifest and apply it. In the configuration section, there are two options related to ETCD mTLS:</p>
    <ul>
      <li><code>ETCD_TLS_SECRET_NAME</code> with the name of the secret that we just created.</li>
      <li><code>ETCD_TLS_SECRET_NAMESPACE</code> with the namespace that we used to create the secret.</li>
    </ul>
    <p>To complete the installation, add these variables to the container spec of the integration <code>DaemonSet</code> and apply the changes:</p>
    <pre><code>- name: "ETCD_TLS_SECRET_NAME”
    value: "newrelic-infra-etcd-tls-secret"
- name: "ETCD_TLS_SECRET_NAMESPACE"
    value: "default"
</code></pre>
  </li>
</ol>
<h2>Set up mTLS for ETCD in OpenShift [#mtls-how-to-openshift]</h2>
<p>Follow these instructions to set up mutual TLS authentication for ETCD in <a href="http://learn.openshift.com/?extIdCarryOver=true&#x26;sc_cid=701f2000001OH7iAAG">OpenShift</a> 4.x:</p>
<ol>
  <li>
    <p>Export the ETCD client certificates from the cluster to an opaque secret. In a default managed OpenShift cluster, the secret is named <code>kube-etcd-client-certs</code> and it is stored in the <code>openshift-monitoring</code> namespace.</p>
    <pre><code>kubectl get secret/kube-etcd-client-certs -n openshift-monitoring -o yaml > etcd-secret.yaml
</code></pre>
  </li>
  <li>
    <p>Open the secret file and change the keys:</p>
    <ul>
      <li>Rename the <strong>certificate authority</strong> to <code>cacert</code>.</li>
      <li>Rename the <strong>client certificate</strong> to <code>cert</code>.</li>
      <li>Rename the <strong>client key</strong> to <code>key</code>.</li>
    </ul>
  </li>
  <li>
    <p>Optional: change the secret name and namespace to something meaningful.</p>
  </li>
  <li>
    <p>Remove these unnecessary keys in the metadata section:</p>
    <ul>
      <li><code>creationTimestamp</code></li>
      <li><code>resourceVersion</code></li>
      <li><code>selfLink</code></li>
      <li><code>uid</code></li>
    </ul>
  </li>
  <li>
    <p>Install the manifest with its new name and namespace:</p>
    <pre><code>kubectl apply -f etcd-secret.yaml
</code></pre>
  </li>
  <li>
    <p>Go to <a href="#update-config">Update manifest configuration</a> (the last step under <a href="#mtls-how-to">Set up MTL from ETCD client</a>) to configure the required environment variables.</p>
  </li>
</ol>
<h2>See your data [#check-integration-works]</h2>
<p>If the integration has been been set up correctly, the <a href="/docs/integrations/kubernetes-integration/cluster-explorer/kubernetes-cluster-explorer">Kubernetes cluster explorer</a> contains all the Control Plane components and their status in a dedicated section, as shown below.</p>
<p>
  <img src="./images/new-relic-one-k8s-cluster-explorer-control-plane-parameters.png" alt="New Relic One - Kubernetes Cluster Explorer - Control Plane section" title="new-relic-one-k8s-cluster-explorer-control-plane-parameters.png">
</p>
<p><strong><a href="https://one.newrelic.com">one.newrelic.com</a> > Kubernetes Cluster Explorer</strong>: Use the Kubernetes cluster explorer to monitor and collect metrics from your cluster's Control Plane components</p>
<p>You can also check for Control Plane data with this <a href="/docs/query-data/nrql-new-relic-query-language/getting-started/introduction-nrql">NRQL</a> query:</p>
<pre><code>SELECT latest(timestamp) FROM K8sApiServerSample, K8sEtcdSample, K8sSchedulerSample, K8sControllerManagerSample FACET entityName where clusterName = 'MY_CLUSTER_NAME'
</code></pre>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>If you still can't see Control Plane data, try the solution described in <a href="/docs/integrations/kubernetes-integration/troubleshooting/kubernetes-integration-troubleshooting-not-seeing-data">Kubernetes integration troubleshooting: Not seeing data</a>.</p>
</div>
