
<p>With secrets management, you can configure on-host integrations with New Relic's infrastructure agent to use sensitive data (such as passwords) without having to write them as plain text into the integration's configuration file. Currently, Hashicorp Vault, AWS KMS, and CyberArk are supported.</p>
<h2>Define secrets</h2>
<p>To use secrets in an integration configuration YAML file:</p>
<ol>
  <li>Define a <code>variables</code> section, where each entry is a name for a secret object.</li>
  <li>In each entry, include the source of the secret and the proper configuration to retrieve those secrets.</li>
  <li>In the integration configuration section, set <code>${variable.property}</code> placeholders that will be automatically replaced by the properties of the secret object.</li>
</ol>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>If the secrets retrieval fails, the integration won't be executed, as the infrastructure agent does not have all the data it requires to execute.</p>
</div>
<p>For example, the following configuration will retrieve an object named <code>creds</code> from Vault. (You can define the object's name for the secret.) Let's assume that the stored object is a JSON with a property named <code>user</code> and another property named <code>password</code>. We want to use them to set the basic HTTP credentials of the <code>status_url</code> property from an Nginx on-host integration:</p>
<pre><code>integration_name: com.newrelic.nginx
variables:
  creds:
    vault:
      http:
        url: http://my.vault.host/v1/newengine/data/secret
        headers:
          X-Vault-Token: my-vault-token
instances:
  - name: nginx-server-metrics
    command: metrics
    arguments:
      status_url: http://${creds.user}:${creds.password}@example.com/status
      status_module: discover
      remote_monitoring: true
    labels:
      env: production
      role: load_balancer
</code></pre>
<h2>Secrets variables [#variables]</h2>
<p>Define secrets in each integration configuration under a <code>variables</code> section. Each entry is a user-defined secret name that will store the properties of the retrieved secrets. Each variable can contain the following properties:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>YAML key</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>ttl</code></p>
        <p>Type: String</p>
      </div>
      <div>
        <p>Amount of time before a secret is refreshed. This can be a number followed by a time unit (<code>s</code>, <code>m</code> or <code>h</code>).</p>
        <p>Examples: <code>30s</code>, <code>10m</code>, <code>1h</code></p>
        <p>Default: <code>1h</code></p>
      </div>
    </div>
    <div>
      <div>
        <p><code>aws-kms</code></p>
        <p>Type: YAML properties</p>
      </div>
      <div>
        <p><a href="#aws-kms-secrets">AWS KMS secret retrieval configuration</a></p>
      </div>
    </div>
    <div>
      <div>
        <p><code>vault</code></p>
        <p>Type: Vault</p>
      </div>
      <div>
        <p><a href="#vault-secrets">Vault secret retrieval configuration</a></p>
      </div>
    </div>
    <div>
      <div>
        <p><code>cyberark-cli</code></p>
        <p>Type: YAML properties</p>
      </div>
      <div>
        <p>CyberArk command line interface configuration</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>cyberark-api</code></p>
        <p>Type: YAML properties</p>
      </div>
      <div>
        <p><a href="#cyberark-api">CyberArk REST API configuration</a></p>
      </div>
    </div>
  </div>
</div>
<h2>AWS KMS secrets</h2>
<p>To retrieve your secrets from Amazon KMS, you can set the following properties in your <code>aws-kms</code> section. Not all fields are required. For example, you will need either <code>data</code>, <code>file</code>, or <code>http</code> to provide the encoded KMS string.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>YAML key</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>data</code></p>
        <p>Type: String</p>
      </div>
      <div>
        <p>Base64 encoded KMS string to decrypt</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>file</code></p>
        <p>Type: String</p>
      </div>
      <div>
        <p>Path to file containing Base64 encoded KMS string to decrypt</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>http</code></p>
        <p>Type: YAML properties</p>
      </div>
      <div>
        <p>HTTP configuration to use to request Base64 encoded KMS string to decrypt. For more information, see <a href="#vault-secrets">Vault <code>http</code></a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>credential_file</code></p>
        <p>Type: String</p>
      </div>
      <div>
        <p>Path to AWS credentials file</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>config_file</code></p>
        <p>Type: String</p>
      </div>
      <div>
        <p>Path to AWS config file</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>region</code></p>
        <p>Type: String</p>
      </div>
      <div>
        <p>AWS KMS region</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>type</code></p>
        <p>Type: String (<code>plain</code>, <code>equal</code>, or <code>json</code>)</p>
      </div>
      <div>
        <p>Secret value format:</p>
        <ul>
          <li>
            <p><code>plain</code>: a raw string to be stored directly into the destination variable.</p>
          </li>
          <li>
            <p><code>equal</code>: a <code>key=property</code> one-line string to be stored as object properties into the destination variable.</p>
          </li>
          <li>
            <p><code>json</code>: a JSON object to be stored as properties into the destination variable.</p>
            <p>Secrets of type <code>plain</code> or <code>json</code> use dot notation; for example, <code>${mysecret.nestedkey}</code>.</p>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
<p>The following example will allow retrieving a plain password string from AWS KMS. It must be decrypted from the provided <code>data</code> encoded string.</p>
<pre><code>variables:
  myPassword:
    aws-kms:
      data: T0hBSStGTEVY
      region: ap-southeast-2
      credential_file: "./my-aws-credentials-file"
      config_file: "./my-aws-config-file"
      type: plain
</code></pre>
<h2>Vault secrets</h2>
<p>Vault must enable an <code>http</code> field containing the HTTP configuration used to connect to Vault. The http entry can contain the following entries:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>YAML key</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>url</code></p>
        <p>Type: String</p>
      </div>
      <div>
        <p>URL to request data from</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>tls_config</code></p>
        <p>Type: YAML properties</p>
      </div>
      <div>
        <p>Use the <a href="#tls-config-properties">TLS configuration properties</a></p>
      </div>
    </div>
    <div>
      <div>
        <p><code>headers</code></p>
        <p>Type: YAML map</p>
      </div>
      <div>
        <p>Request headers</p>
      </div>
    </div>
  </div>
</div>
<h3>tls_config properties [#tls-config-properties]</h3>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Secrets must use dot notation, for example, <code>${mysecret.nestedkey}</code>.</p>
</div>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>YAML key</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>enable</code></p>
        <p>Type: Boolean</p>
      </div>
      <div>
        <p>Enable TLS</p>
        <p>Default: <code>false</code></p>
      </div>
    </div>
    <div>
      <div>
        <p><code>insecure_skip_verify</code></p>
        <p>Type: Boolean</p>
      </div>
      <div>
        <p>Skip verifying serverâ€™s certificate chain and host</p>
        <p>Default: <code>false</code></p>
      </div>
    </div>
    <div>
      <div>
        <p><code>min_version</code></p>
        <p>Type: UInt16</p>
      </div>
      <div>
        <p>The minimum SSL/TLS version that is acceptable</p>
        <p>Default: <code>0</code> (which uses TLS version 1.0)</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>max_version</code></p>
        <p>Type: UInt16</p>
      </div>
      <div>
        <p>The maximum SSL/TLS version that is acceptable</p>
        <p>Default: <code>0</code> (which uses TLS version 1.3)</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>ca</code></p>
        <p>Type: String</p>
      </div>
      <div>
        <p>TLS certificate</p>
        <p><code>""</code></p>
      </div>
    </div>
  </div>
</div>
<p>The following example will retrieve a secret using a Vault token from a secured server, and skip the server certificates verification:</p>
<pre><code>variables:
  mydata:
    vault:
      http:
        url: https://my.vault.host/v1/newengine/data/secret
        headers:
          X-Vault-Token: my-vault-token
        tls_config:
          insecure_skip_verify: true
</code></pre>
<h2>CyberArk command line interface [#cyberark-cli]</h2>
<p>To retrieve secrets from the CyberArk command line interface (CLI) use the following configuration, all keys are required</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>YAML Key</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>cli</code></p>
        <p>Type: string</p>
      </div>
      <div>
        <p>Full path to the CyberArk CLI executable</p>
        <p>Default: ""</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>app</code>-id</p>
        <p>Type: string</p>
      </div>
      <div>
        <p>Application id of the secret holder</p>
        <p>Default: ""</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>safe</code></p>
        <p>Type: string</p>
      </div>
      <div>
        <p>Safe containing the secret</p>
        <p>Default: ""</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>folder</code></p>
        <p>Type: string</p>
      </div>
      <div>
        <p>Folder containing the secret</p>
        <p>Default: ""</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>object</code></p>
        <p>Type: string</p>
      </div>
      <div>
        <p>The object the secret is associated with</p>
        <p>Default: ""</p>
      </div>
    </div>
  </div>
</div>
<p>The following example will retrieve a CyberArk secret using the command line interface:</p>
<pre><code>variables:
  credentials:
    cyberark-cli:
      cli: /full/path/to/clipasswordsdk
      app-id: my-appid
      safe: my-safe
      folder: my-folder
      object: my-object
</code></pre>
<h2>CyberArk REST API [#cyberark-api]</h2>
<p>To retrieve secrets using the CyberArk REST API there must be a <code>http</code> key containing the HTTP configuration. The <code>http</code> key contains these sub-keys, only <code>url</code> is required:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>YAML key</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>url</code></p>
        <p>Type: String</p>
      </div>
      <div>
        <p>URL to request data from, this key is required</p>
        <p>Default: none</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>tls_config</code></p>
        <p>Type: YAML properties</p>
      </div>
      <div>
        <p>Use the <a href="#tls-config-properties">TLS configuration properties</a></p>
      </div>
    </div>
    <div>
      <div>
        <p><code>headers</code></p>
        <p>Type: YAML map</p>
      </div>
      <div>
        <p>Request headers</p>
      </div>
    </div>
  </div>
</div>
<p>The following example will retrieve a secret using the CyberArk REST API, skipping server certificate verification:</p>
<pre><code>variables:
  credentials:
    cyberark-api:
      http:
        url: https://hostname/AIMWebService/api/Accounts?AppID=myAppID&#x26;Query=Safe=mySafe;Object=myObject
        tls_config:
          insecure_skip_verify: true
</code></pre>
