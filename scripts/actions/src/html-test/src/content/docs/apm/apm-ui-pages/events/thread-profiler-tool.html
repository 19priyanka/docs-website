
<p>The thread profiler is a low-impact profiling tool that can be used in production to identify bottlenecks in an application. It works by periodically (100ms) capturing the stack trace of each thread for a specified duration. At the end of the specified duration, the stack traces are aggregated to build a tree. The call count in the tree corresponds to the number of times that function was present in the stack traces under the same context.</p>
<p>Although the call tree cannot capture the entire execution, a large enough sample can be a good representation of the application behavior. This provides insights into the "hot" functions of the app where most of the time is spent. With this scope, entries sampled less than 0.05% are omitted.</p>
<h2>Supported agents [#agents]</h2>
<p>This feature is available only for specific agents and versions:</p>
<ul>
  <li>Java: Agent versions 1.2.004.6 or higher</li>
  <li>.NET:
    <ul>
      <li>Framework: Agent versions 2.12.146.0 or higher</li>
      <li>.NET Core 2.0: Agent versions 8.3.360.0 or higher (Windows only)</li>
      <li>Linux: .NET Core 3.0 or higher and agent versions 8.23 or higher</li>
    </ul>
  </li>
  <li>Python: Agent versions 1.7.0 or higher</li>
  <li>Ruby: Agent versions 3.5.5 or higher</li>
</ul>
<h2>Start the profiler [#starting]</h2>
<p>The thread profiler feature is enabled by default. You also may be able to turn it on or off in your agent configuration file:</p>
<ul>
  <li>Java: <code>thread_profiler.enabled</code></li>
  <li>NET: You <strong>cannot</strong> disable the thread profiler with .NET apps.</li>
  <li>Python: <code>thread_profiler.enabled</code></li>
  <li>Ruby: <code>thread_profiler.enabled</code></li>
</ul>
<p>When enabled, you can view the thread profiler from our user interface:</p>
<ol>
  <li>Go to <strong><a href="https://one.newrelic.com">one.newrelic.com</a> > APM > (select an app) > Events > Thread profiler</strong>.</li>
  <li>Select the host you want to run the profiler on.</li>
  <li>Set the duration for the profiling session.</li>
  <li>Select <strong>Start profiler</strong>.</li>
</ol>
<p>This triggers the agent to start the thread profiler during the next harvest cycle (every one minute) and capture data for the specified duration. We record thread backtraces whether or not they are in a runnable state at the time the sample is taken. Threads that are sleeping or blocked on IO may appear in the call tree.</p>
<p>
  <img src="./images/thread-profiler-start_1.png" alt="This is an image of the thread profiler." title="thread-profiler-start.png">
</p>
<p><strong><a href="https://one.newrelic.com">one.newrelic.com</a> > APM > (select an app) > Events > Thread profiler</strong>: Use this page to define the settings for the thread profiler duration and to view the results.</p>
<h2>View profile data [#viewing]</h2>
<p>After the profiler finishes running, the agent will report the profile data. The call tree automatically appears on the <strong>Thread profiler</strong> page. The percentages in the call tree represent the percentage of thread backtrace samples in which each call path appeared during the profiling session. The data collection started at the PROFILE COLLECTED time.</p>
<p>
  <img src="./images/thread-profile-view_0.png" alt="thread-profile-view.png" title="thread-profile-view.png">
</p>
<p><strong><a href="https://one.newrelic.com">one.newrelic.com</a> > APM > (select an app) > Events > Thread profiler > (selected profile)</strong>: Here is an example of a call tree from a thread profile.</p>
<p>The page color-codes the tree results:</p>
<ul>
  <li>Red: Percentages greater than 30%</li>
  <li>Yellow: Percentages greater than 10%</li>
  <li>Black: Percentages less than 10%</li>
</ul>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p><strong>If you want to...</strong></p>
      </div>
      <div>
        <p><strong>Do this...</strong></p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Change how the thread profile information appears</p>
      </div>
      <div>
        <p>Select your choices of available options in the <strong>Tree settings</strong>, and select <strong>Refresh tree</strong>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Change how much information appears</p>
      </div>
      <div>
        <p>Select the <strong>Expand</strong> or <strong>Collapse</strong> options above the call tree, or select the name or arrow on any line in the call tree.</p>
      </div>
    </div>
    <div>
      <div>
        <p>View summary information about any line in the call tree</p>
      </div>
      <div>
        <p>Mouse over the line.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Email the thread profile results to others</p>
      </div>
      <div>
        <p>Select <strong>Share this profile</strong>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Start another session or view a different thread profile</p>
      </div>
      <div>
        <p>Select <strong>Back to all profiles</strong>.</p>
      </div>
    </div>
  </div>
</div>
<h2>Agent considerations [#agent-requirements]</h2>
<p>Depending on which agent you use, the thread profiling feature has additional considerations.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibmV0In0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIuTkVULXNwZWNpZmljIG5vdGVzIn1d">
    <div data-prop-text="title">.NET-specific notes</div>
    <p>When using thread profiling with the .NET Framework agent, be aware of the following.</p>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p><strong>.NET agent</strong></p>
          </div>
          <div>
            <p><strong>Thread profiler notes</strong></p>
          </div>
        </div>
      </div>
      <div>
        <div>
          <div>
            <p>Supported on <strong>Linux</strong></p>
          </div>
          <div>
            <p>Thread profiling on <strong>Linux</strong> is supported on .NET Core 3.0 or later applications when running .NET agent version 8.23 or later.</p>
          </div>
        </div>
        <div>
          <div>
            <p>Managed threads only</p>
          </div>
          <div>
            <p>For .NET agents, the thread profiler only captures stack traces on managed threads. It does not capture stack traces on unmanaged threads. If a call to an unmanaged function occurs on a managed thread, the thread profiler will show <code>Native:Function Call</code> in the call tree.</p>
          </div>
        </div>
        <div>
          <div>
            <p>No line numbers</p>
          </div>
          <div>
            <p>A .NET thread profile does not include line numbers in the call tree. The <strong>Show line numbers</strong> checkbox in the Tree Settings does not have any effect.</p>
          </div>
        </div>
        <div>
          <div>
            <p>Bug with 64-bit v4.0 .NET CLR</p>
          </div>
          <div>
            <p>There is a bug in the 64-bit version 4.0 .NET Common Language Runtime (CLR) that interferes with the agent's ability to retrieve managed stack traces. If your app experiences this bug, APM will show empty thread profiles. This bug does not affect 32-bit applications.</p>
            <p>The bug is fixed in the CLR releases for .NET 4.5. To verify whether your 64-bit application has the fixed version, look at the full version of the <code>mscorlib.dll</code> in the <strong>C:\Windows\Microsoft.NET\Framework64\v4.0.30319</strong> directory. The fix is in versions 4.0.30319.17379 or higher.</p>
          </div>
        </div>
        <div>
          <div>
            <p><strong>Other</strong> category only</p>
          </div>
          <div>
            <p>All threads are put in the <strong>Other</strong> category. The <strong>Web Request</strong> and <strong>Background</strong> categories are not supported.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYWdlbnQtdGhyZWFkLXByb2ZpbGluZyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiUHl0aG9uLXNwZWNpZmljIG5vdGVzIn1d">
    <div data-prop-text="title">Python-specific notes</div>
    <p>When using thread profiling with the Python agent, be aware of the following.</p>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p><strong>Python agent</strong></p>
          </div>
          <div>
            <p><strong>Thread profiler notes</strong></p>
          </div>
        </div>
      </div>
      <div>
        <div>
          <div>
            <p>Co-routine based systems</p>
          </div>
          <div>
            <p>There are limits to capturing details when a co-routine based system is being used, such as gevent or eventlet modes of gunicorn. If creating a new thread, the Python agent will actually create a greenlet instead of a thread profiler background thread. Therefore, the thread profiler will not capture any web request and background transactions on the thread profiler page.</p>
          </div>
        </div>
        <div>
          <div>
            <p>Greenlets</p>
          </div>
          <div>
            <p>A greenlet can run only when other greenlets explicitly yield control, such as when they block. For example, if the thread sampler does get to run, it will only sample the stack for other greenlets at a point where they are blocked. It will not sample them when they are executing arbitrary code. It can completely miss execution within a greenlet if it never blocked or otherwise yielded to another greenlet.</p>
          </div>
        </div>
        <div>
          <div>
            <p>Time in Python code</p>
          </div>
          <div>
            <p>Time spent in pure Python code that isn't blocking requests will not be picked up, and no information will be recorded or reported. This is because results are misleading when co-routines are used.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicnVieSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiUnVieS1zcGVjaWZpYyBub3RlcyJ9XQ==">
    <div data-prop-text="title">Ruby-specific notes</div>
    <p>When using thread profiling with the Ruby agent, be aware of the following.</p>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p><strong>Ruby agent</strong></p>
          </div>
          <div>
            <p><strong>Thread profiler notes</strong></p>
          </div>
        </div>
      </div>
      <div>
        <div>
          <div>
            <p>Backtraces</p>
          </div>
          <div>
            <p>The thread profiler depends on the ability to capture thread backtraces from within your Ruby application. For this reason, it requires <strong>MRI 1.9.2 or higher</strong> (for the <code>Thread#backtrace</code> method).</p>
          </div>
        </div>
        <div>
          <div>
            <p>Resque</p>
          </div>
          <div>
            <p>The Ruby agent does not currently support thread profiles with Resque background jobs. A thread profiling session initiated against Resque will only capture traces from the parent process, not the job processes.</p>
          </div>
        </div>
        <div>
          <div>
            <p>JRuby</p>
          </div>
          <div>
            <p>JRuby support is considered experimental at this time. There are known issues with JRuby's <code>Thread#backtrace</code> implementation that will affect the accuracy of and reliability of backtraces collected under JRuby.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
