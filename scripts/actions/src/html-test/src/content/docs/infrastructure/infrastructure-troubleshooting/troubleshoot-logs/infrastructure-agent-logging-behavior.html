
<p>New Relic's infrastructure agent gathers its own data as well as integrations's logs and consolidates them in a single source. By default, logs appear in <code>standard-output</code> and are added to a <a href="https://docs.newrelic.com/docs/infrastructure/install-configure-infrastructure/configuration/infrastructure-configuration-settings#log-file">log file</a>. To disable logs in standard output, <a href="/docs/infrastructure/install-configure-infrastructure/configuration/infrastructure-configuration-settings#log-to-stdout">see the agent's config options</a>.</p>
<h2>Logging severity levels [#security-levels]</h2>
<p>Infrastructure uses a subset of the standard <a href="https://en.wikipedia.org/wiki/Syslog#Severity_level">Syslog severity levels</a>:</p>
<ul>
  <li><code>ERROR</code>: Error conditions met</li>
  <li><code>WARN</code>: Warning conditions met</li>
  <li><code>INFO</code>: Informational messages</li>
  <li><code>DEBUG</code>: Contains debug-level messages (useful when troubleshooting)</li>
</ul>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p><code>DEBUG</code> level is only shown when the <a href="/docs/infrastructure/new-relic-infrastructure/troubleshooting/generate-logs-troubleshooting-infrastructure">verbose mode</a> is enabled.</p>
</div>
<h2>Log formatting</h2>
<p>For <a href="https://docs.newrelic.com/docs/release-notes/infrastructure-release-notes/infrastructure-agent-release-notes">infrastructure agent v1.4.9 or higher</a>, log messages are inlined with context values. This offers better grouping and filtering; for example:</p>
<pre><code>containerized agent found in container
     containerID: VALUE
</code></pre>
<p>By default, Infrastructure logs are formatted as text:</p>
<ul>
  <li>
    <p>In foreground mode, log output is colored, without a timestamp:</p>
    <pre><code>DEBUG Sending deltas divided in blocks component=PatchSender mentityKey=ohaimaci mnumberOfBlocks=1
</code></pre>
  </li>
  <li>
    <p>In background mode, logs are timestamped output, used when running as a service or dumping logs to a file:</p>
    <pre><code>time="2019-07-12T09:54:15+02:00" level=info msg="Agent service manager shutdown completed successfully." component=AgentService service=newrelic-infra
</code></pre>
  </li>
</ul>
<p>Alternatively, logs can be formatted as a JSON file:</p>
<pre><code>{"context":{},"level":"info","msg":"upstart_interval_sec: 0","timestamp":"2019-07-11T18:24:03+02:00"} 
{"context":{},"level":"info","msg":"plugin_dir: ","timestamp":"2019-07-11T18:24:03+02:00"}
</code></pre>
<p>To change the log format, see the <a href="/docs/infrastructure/install-configure-infrastructure/configuration/infrastructure-configuration-settings#log-format">agent configuration settings</a>.</p>
<h2>Log rotation</h2>
<p>The infrastructure agent does not provide any native log rotation or compression mechanism. Instead, we encourage you to use consolidated log rotation tools, such as the <a href="http://man7.org/linux/man-pages/man8/logrotate.8.html">Linux logrotate tool</a>, which is usually installed by default in most Linux distributions.</p>
<p><code>Logrotate</code> can be configured as an entry in <code>/etc/logrotate.conf</code>, or as a file in the <code>/etc/logrotate.d</code> directory.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibG9ncm90YXRlLWNvbmZpZy1zYW1wbGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkxvZ3JvdGF0ZSBjb25maWcgZmlsZSBzYW1wbGUifV0=">
    <div data-prop-text="title">Logrotate config file sample</div>
    <p>A sample <code>logrotate</code> config file looks like this:</p>
    <pre><code>/var/log/newrelic-infra/newrelic-infra.log { 
     copytruncate 
     compress 
     daily 
     dateext 
     maxage 7 
}

</code></pre>Where:
    * `/var/log/newrelic-infra/newrelic-infra.log`: The Infrastructure agent log file. It must match the [`log_file` configuration parameter](/docs/infrastructure/install-configure-infrastructure/configuration/infrastructure-configuration-settings#log-file) in the [`/etc/newrelic-infra.yml` file](/docs/infrastructure/new-relic-infrastructure/configuration/infrastructure-config-file-template-newrelic-infrayml).
    * `copytruncate`: Indicates that the log file is truncated but not deleted when it is rotated. **This configuration option is mandatory**, otherwise the log file will be deleted and wonâ€™t be recreated.
    * `compress`: Compresses (usually in Gzip format) the rotated log files.
    * `daily`: The agent rotates logs daily.
    * `dateext`: Appends a date (by default, in the format YYYYMMDD) to the rotated log file (e.g. `newrelic-infra.log-20190708.gz`)
    * `maxage 7`: Makes `logrotate` remove rotated files after 7 days.
    &#x3C;Callout variant="tip">
    For a complete description of the `logrotate` configuration options, see the [Linux Logrotate documentation](https://linux.die.net/man/8/logrotate).
    &#x3C;/Callout>
  </div>
</div>
<p>Since <code>logrotate</code> is usually executed automatically as a cron job, verify that there is a <code>logrotate</code> entry in cron (for example, <code>/etc/cron.daily/logrotate</code>) similar to:</p>
<pre><code>#!/bin/sh 

/usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /etc/logrotate.conf EXITVALUE=$? 
if [ $EXITVALUE != 0 ]; then 
     /usr/bin/logger -t logrotate "ALERT exited abnormally with [$EXITVALUE]" 
fi 
exit 0
</code></pre>
<h2>Smart verbose mode</h2>
<p>For <a href="https://docs.newrelic.com/docs/release-notes/infrastructure-release-notes/infrastructure-agent-release-notes">infrastructure agent versions 1.9.0 or higher</a>, you can enable smart verbose mode for logs.</p>
<p>Smart verbose mode prevents debug messages being logged until an error message is logged. Once an error has been logged, the cached debug messages are logged, but only the most recent number of configured debug messages. For example, if you have a configured limit of 10, after an error is logged, only the 10 most recent debug messages are logged, and older logs are discarded.</p>
<p>For more information on how to enable smart verbose mode and the debug message limit, see <a href="https://docs.newrelic.com/docs/infrastructure/install-configure-manage-infrastructure/configuration/infrastructure-configuration-settings#verbose">Infrastructure configuration settings</a>.</p>
<h2>Logging before Infrastructure agent v1.4.9 [#logging-before]</h2>
<p>Here is a comparison of functionality for Infrastructure agent versions before and after <a href="/docs/release-notes/infrastructure-release-notes/infrastructure-agent-release-notes/new-relic-infrastructure-agent-149">v1.4.9</a>:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Agent v1.4.9 and higher</p>
      </div>
      <div>
        <p>Before v1.4.9</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Foreground mode logged.</p>
      </div>
      <div>
        <p>The agent couldn't log some entries in foreground mode because the logging service wasn't able to write data until the agent was completely configured.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Logs in text and JSON formats.</p>
      </div>
      <div>
        <p>Logs in text only.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Logs displayed as inline text.</p>
      </div>
      <div>
        <p>Logs displayed as static literals in a single, decontextualized line.</p>
      </div>
    </div>
  </div>
</div>
<h2>Integration log management</h2>
<p>Integrations write JSON payloads into STDOUT and plain-text (JSON structured in the future) logs into STDERR.</p>
<p>The infrastructure agent handles integration STDERR lines and forward this output into the agent one, usually the service log.</p>
<p>Agent handles each STDERR line as follows:</p>
<ul>
  <li><strong>when agent runs in verbose mode</strong>: it just forwards the full STDERR line as a DEBUG agent log entry placing integration line contexts within the `msg` field.</li>
  <li><strong>otherwise</strong>: it parses the line against the expected format (see below) and only logs as agent ERROR level, entries produced by integrations with `fatal` or `error` severity levels. In this case fields are extracted and forwarded in structured manner (therefore if JSON output is enabled for the agent fields become queryable.</li>
</ul>
<h3>Integration STDERR expected format</h3>
<p>A line is expected to be a list of key-value pairs separated by an equal character. Keys can contain any character, whereas values can have three different formats:</p>
<ol>
  <li>string: &#x3C;quote>any character including escaped quotes \"&#x3C;quote></li>
  <li>map: &#x26;{any character}</li>
  <li>word: any character except spaces</li>
</ol>
<p>Internally agent used this regex to extract the fields:</p>
<pre><code>([^\s]*?)=(".*?[^\\]"|&#x26;{.*?}|[^\s]*)
</code></pre>
<p>For instance, this line:</p>
<pre><code>time="2015-03-26T01:27:38-04:00" level=error msg="Foo bar baz" foo=bar
</code></pre>
<p>Will generate a structured agent log line with these fields:</p>
<pre><code>- "time": "2015-03-26T01:27:38-04:00"
- "level": "error"
- "msg": "Foo bar baz"
- "foo": "bar"
</code></pre>
