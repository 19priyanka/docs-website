
<h2>Problem</h2>
<p>Your New Relic infrastructure agent is up and running, but when your CPU reaches a high percentage of usage, the agent stops intermittently to submit data.</p>
<h2>Solution</h2>
<p><strong>Required agent version</strong>: 1.0.1002 or later</p>
<p>The following steps mitigate the data gaps problem:</p>
<ol>
  <li>
    <p>Remove the limit of one thread for the agent, allowing one thread per core.</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYXB0LWluc3RhbGwtdmVyaWZ5In0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJFZGl0IHRoZSBuZXdyZWxpYy1pbmZyYS55bWwgY29uZmlndXJhdGlvbiBmaWxlIChXaW5kb3dzKSJ9XQ==">
        <div data-prop-text="title">Edit the newrelic-infra.yml configuration file (Windows)</div>
        <ol>
          <li>
            <p>Open the following file in your favorite plain text editor: C:\Program Files\New Relic\newrelic-infra\newrelic-infra.yml</p>
          </li>
          <li>
            <p>Add the following configuration option:</p>
            <pre><code>max_procs: -1
</code></pre>
          </li>
        </ol>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYXB0LWluc3RhbGwtdmVyaWZ5In0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJFZGl0IHRoZSBuZXdyZWxpYy1pbmZyYS55bWwgY29uZmlndXJhdGlvbiBmaWxlIChMaW51eCkifV0=">
        <div data-prop-text="title">Edit the newrelic-infra.yml configuration file (Linux)</div>
        <ol>
          <li>
            <p>Open the following file in your favorite plain text editor: /etc/newrelic-infra.yml</p>
          </li>
          <li>
            <p>Add the following configuration option:</p>
            <pre><code>max_procs: -1
</code></pre>
          </li>
        </ol>
      </div>
    </div>
  </li>
  <li>
    <p>Use <a href="/docs/infrastructure/new-relic-infrastructure/configuration/start-stop-restart-check-infrastructure-agent-status#init-system">your init system</a> to restart the agent service:</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic3lzdGVtZC12ZXJpZnktc3RhdHVzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJSZXN0YXJ0IHRoZSBhZ2VudCB3aXRoIFN5c3RlbUQifV0=">
        <div data-prop-text="title">Restart the agent with SystemD</div>
        <p>Use SystemD commands with CentOS 7, Debian 8, RHEL 7, and Ubuntu 15.04 or higher:</p>
        <pre><code>sudo systemctl restart newrelic-infra

</code></pre>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic3lzdGVtdi12ZXJpZnktc3RhdHVzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJSZXN0YXJ0IHRoZSBhZ2VudCB3aXRoIFN5c3RlbSBWIn1d">
        <div data-prop-text="title">Restart the agent with System V</div>
        <p>Use System V commands with Debian 7:</p>
        <pre><code>sudo /etc/init.d/newrelic-infra restart

</code></pre>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidXBzdGFydC12ZXJpZnktc3RhdHVzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJSZXN0YXJ0IHRoZSBhZ2VudCB3aXRoIFVwc3RhcnQifV0=">
        <div data-prop-text="title">Restart the agent with Upstart</div>
        <p>Use Upstart commands with Amazon Linux, CentOS 6, RHEL 6, and Ubuntu 14.10 or lower:</p>
        <pre><code>sudo initctl restart newrelic-infra

</code></pre>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoid2luZG93cy12ZXJpZnktc3RhdHVzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJSZXN0YXJ0IHRoZSBhZ2VudCBpbiBXaW5kb3dzIn1d">
        <div data-prop-text="title">Restart the agent in Windows</div>
        <pre><code>net stop newrelic-infra
net start newrelic-infra

</code></pre>
      </div>
    </div>
  </li>
</ol>
<h2>Cause</h2>
<p>The New Relic Infrastructure agent, by default, runs in a single operating system thread. This may mean that, especially in Windows environments, the process scheduler gives it little chance to get CPU time when the system is overloaded.</p>
<p>The <code>max_procs: -1</code> configuration option removes this limitation and allows the agent to use one thread per CPU core (as maximum).</p>
