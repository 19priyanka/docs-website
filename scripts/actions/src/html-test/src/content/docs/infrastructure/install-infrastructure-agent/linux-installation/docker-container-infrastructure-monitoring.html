
<p>The infrastructure agent for Linux <a href="/docs/infrastructure/install-infrastructure-agent/linux-installation/docker-instrumentation-infrastructure">supports Docker environments</a> by default. If you're running a container OS or have restrictions that require deploying the agent as a container, you can run a containerized version of our infrastructure agent, which can monitor metrics for the container itself, as well as the underlying host.</p>
<p>Using the <a href="#custom-setup">custom (recommended)</a> or <a href="#simple-setup">basic setup</a> allows the infrastructure agent to run inside a container environment. A host can only be running one instance of the agent at a time, whether that's the containerized agent or the non-containerized version.</p>
<h2>What you need [#requirements]</h2>
<p>The containerized version of the infrastructure agent requires Docker 1.12 or higher. The container must run any of the <a href="/docs/infrastructure/install-infrastructure-agent/get-started/compatibility-requirements-infrastructure-agent#operating-systems">Linux distributions and versions</a> supported by our agent.</p>
<h2>Custom setup (recommended) [#custom-setup]</h2>
<p>The following are basic instructions for creating a custom Docker Image on Linux, which allows you to deploy the infrastructure agent as a container that can monitor its underlying host.</p>
<p>We recommend extending the <a href="https://hub.docker.com/r/newrelic/infrastructure/"><code>newrelic/infrastructure</code> image</a> and using your own <code>newrelic-infra.yml</code> agent <a href="/docs/infrastructure/new-relic-infrastructure/configuration/configure-infrastructure-agent">config file</a>. Once your image is built, you can easily spin up a container without having to provide more launch time configurations.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>Providing secrets via environment variables with Docker is discouraged.</p>
</div>
<h3>Docker CLI</h3>
<ol>
  <li>
    <p>Create the <code>newrelic-infra.yml</code> agent <a href="/docs/infrastructure/new-relic-infrastructure/configuration/configure-infrastructure-agent">config file</a> with your New Relic <a href="/docs/accounts/install-new-relic/account-setup/license-key">license key</a>:</p>
    <pre><code>license_key: YOUR_LICENSE_KEY
</code></pre>
  </li>
  <li>
    <p>Create the <code>Dockerfile</code> extending the <code>newrelic/infrastructure</code> image, and add your config to <code>/etc/newrelic-infra.yml</code>:</p>
    <pre><code>FROM newrelic/infrastructure:latest
ADD newrelic-infra.yml /etc/newrelic-infra.yml
</code></pre>
  </li>
  <li>
    <p>Build and tag your image:</p>
    <pre><code>docker build -t YOUR_IMAGE_NAME .
</code></pre>
  </li>
  <li>
    <p>Run the container from the image you built with the required <a href="#required-privileges">required run flags</a>:</p>
    <pre><code>docker run \
    -d \
    --name newrelic-infra \
    --network=host \
    --cap-add=SYS_PTRACE \
    --privileged \
    --pid=host \
    -v "/:/host:ro" \
    -v "/var/run/docker.sock:/var/run/docker.sock" \
    YOUR_IMAGE_NAME
</code></pre>
  </li>
</ol>
<h3>Docker Compose</h3>
<ol>
  <li>
    <p>Create a folder to store the configuration files:</p>
    <pre><code>mkdir ~/newrelic-infra-setup
</code></pre>
  </li>
  <li>
    <p>Change directory to the one you've just created:</p>
    <pre><code>cd ~/newrelic-infra-setup
</code></pre>
  </li>
  <li>
    <p>Create the <code>newrelic-infra.yml</code> agent <a href="/docs/infrastructure/new-relic-infrastructure/configuration/configure-infrastructure-agent">config file</a> with your New Relic <a href="/docs/accounts/install-new-relic/account-setup/license-key">license key</a>:</p>
    <pre><code>echo "license_key: YOUR_LICENSE_KEY" > newrelic-infra.yml
</code></pre>
  </li>
  <li>
    <p>Create the <code>newrelic-infra.dockerfile</code> extending the <code>newrelic/infrastructure</code> image, and add your config to <code>/etc/newrelic-infra.yml</code>:</p>
    <pre><code>touch newrelic-infra.dockerfile
</code></pre>
    <pre><code>vim newrelic-infra.dockerfile #you can use any text editor
</code></pre>
    <p>Put the following content in the file:</p>
    <pre><code>FROM newrelic/infrastructure:latest
ADD newrelic-infra.yml /etc/newrelic-infra.yml
</code></pre>
  </li>
  <li>
    <p>Create <code>docker-compose.yaml</code>:</p>
    <pre><code>touch docker-compose.yaml
</code></pre>
    <pre><code>vim docker-compose.yaml #you can use any text editor
</code></pre>
    <p>Put following content in the file:</p>
    <pre><code>version: '3'

services:
  agent:
    container_name: newrelic-infra
    build:
      context: .
      dockerfile: newrelic-infra.dockerfile
    cap_add:
      - SYS_PTRACE
    network_mode: host
    pid: host
    privileged: true
    volumes:
      - "/:/host:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
    restart: unless-stopped
</code></pre>
  </li>
  <li>
    <p>Build and start <code>docker-compose</code>:</p>
    <pre><code>docker-compose -f docker-compose.yaml up -d
</code></pre>
  </li>
</ol>
<h2>Basic setup [#simple-setup]</h2>
<p>To use the basic setup with a base New Relic infrastructure image:</p>
<h3>Docker CLI</h3>
<ol>
  <li>
    <p>Run the container with the <a href="#required-privileges">required run flags</a>:</p>
    <pre><code>docker run \
   -d \
   --name newrelic-infra \
   --network=host \
   --cap-add=SYS_PTRACE \
   --privileged \
   --pid=host \
   -v "/:/host:ro" \
   -v "/var/run/docker.sock:/var/run/docker.sock" \
   -e NRIA_LICENSE_KEY=YOUR_LICENSE_KEY \
   newrelic/infrastructure:latest
</code></pre>
  </li>
</ol>
<h3>Docker Compose</h3>
<ol>
  <li>
    <p>Create <code>docker-compose.yaml</code>:</p>
    <pre><code>touch docker-compose.yaml
</code></pre>
    <pre><code>vim docker-compose.yaml #you can use any text editor
</code></pre>
    <p>Put following content in the file:</p>
    <pre><code>version: '3'

services:
  agent:
    container_name: newrelic-infra
    image: newrelic/infrastructure:latest
    cap_add:
      - SYS_PTRACE
    network_mode: host
    pid: host
    privileged: true
    volumes:
      - "/:/host:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
    environment:
      NRIA_LICENSE_KEY: "YOUR_LICENSE_KEY"
    restart: unless-stopped
</code></pre>
  </li>
  <li>
    <p>Build and start <code>docker-compose</code>:</p>
    <pre><code>docker-compose -f docker-compose.yaml up -d
</code></pre>
  </li>
</ol>
<h2>Required container privileges [#required-privileges]</h2>
<p>Due to resource isolation from the host and other containers via Linux namespaces, a container has a very restricted view and control of its underlying host's resources by default. Without these extra privileges, the infrastructure agent cannot monitor the host and its containers.</p>
<p>The infrastructure agent collects data about its host using system files and system calls. For more information about how the infrastructure agent collects data, see <a href="/docs/infrastructure/new-relic-infrastructure/getting-started/infrastructure-security">Infrastructure and security</a>. Required privileges include:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Privilege</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>--network=host</code></p>
      </div>
      <div>
        <p>Sets the container's network namespace to the host's network namespace. This allows the agent to collect the network metrics about the host.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>-v "/:/host:ro"</code></p>
      </div>
      <div>
        <p>Bind mounts the host's root volume to the container. This read-only access to the host's root allows the agent to collect process and storage metrics as well as Inventory data from the host.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>--cap-add=SYS_PTRACE</code></p>
      </div>
      <div>
        <p>Adds the Linux capability to trace system processes. This allows the agent to gather data about processes running on the host. Read more <a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities">here</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>--privileged</code></p>
      </div>
      <div></div>
    </div>
    <div>
      <div>
        <p><code>--pid=host</code></p>
      </div>
      <div></div>
    </div>
    <div>
      <div>
        <p><code>-v "/var/run/docker.sock:/var/run/docker.sock"</code></p>
      </div>
      <div>
        <p>Bind mounts the host's Docker daemon socket to the container. This allows the agent to connect to the Engine API via the Docker daemon socket to collect the host's container data.</p>
      </div>
    </div>
  </div>
</div>
<h2>Inventory collected [#inventory]</h2>
<p><a href="/docs/infrastructure/new-relic-infrastructure/infrastructure-ui-pages/infrastructure-inventory-page-search-your-entire-infrastructure">Inventory</a> is collected from the infrastructure agent's built-in data collectors. The infrastructure agent collects this data for Linux systems running with containers.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p><strong>Category</strong></p>
      </div>
      <div>
        <p><strong>Source</strong></p>
      </div>
      <div>
        <p><strong>Data collected using</strong></p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>metadata</code></p>
      </div>
      <div>
        <p><code>agent_config</code></p>
      </div>
      <div>
        <p>Agent's complete config file</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>system</code></p>
      </div>
      <div>
        <p><code>uptime -s, /etc/redhat-release, /proc/cpuinfo, /etc/os-release, /proc/sys/kernel/random/boot_id, /proc/sys/kernel/osrelease, /sys/class/dmi/id/product_uuid, /sys/devices/virtual/dmi/id/sys_vendor, /sys/devices/virtual/dmi/id/product_name</code></p>
      </div>
    </div>
  </div>
</div>
<h2>Container data [#view]</h2>
<p>Once the infrastructure agent is running in a Docker container, it can collect the same <a href="/docs/infrastructure/new-relic-infrastructure/infrastructure-ui-pages/infrastructure-compute-page-measure-resource-usage">host compute data</a> and <a href="/docs/infrastructure/new-relic-infrastructure/infrastructure-ui-pages/infrastructure-events-page-live-feed-every-config-change">event data</a> that the infrastructure agent is capable of collecting when running natively on a host.</p>
<p>For container data, see <a href="/docs/infrastructure/install-infrastructure-agent/linux-installation/docker-instrumentation-infrastructure#find-data">Find your Docker data</a>.</p>
<h2>Containerized agent image [#view]</h2>
<p>The containerized agent image is built from an <strong>Alpine</strong> base image, but a <strong>CentOS</strong> based image is also available.</p>
<p><strong>Alpine</strong> is used as the base image since version 0.0.55 . This is the one pointed by <code>latest</code> tag.</p>
<p>Prior versions used <strong>CentOS 7</strong> as base image. In order to keep using that legacy image some backports might be included there, you can point to <code>latest-centos</code> tag to fetch latest <strong>CentOS 7</strong> based image.</p>
<h2>Check the source code [#source-code]</h2>
<p>This integration is open source software. That means you can <a href="https://github.com/newrelic/infrastructure-bundle" title="Link opens in a new window.">browse its source code</a> and send improvements, or create your own fork and build it.</p>
