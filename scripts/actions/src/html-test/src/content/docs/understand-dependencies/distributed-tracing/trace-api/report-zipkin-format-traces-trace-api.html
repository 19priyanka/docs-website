
<p>Our <a href="https://docs.newrelic.com/docs/apm/distributed-tracing/trace-api/introduction-new-relic-trace-api">Trace API</a> accepts two types of data formats:</p>
<ul>
  <li><code>zipkin</code> for Zipkin trace data</li>
  <li><a href="/docs/apm/distributed-tracing/trace-api/report-new-relic-format-traces-trace-api"><code>newrelic</code></a> for all other trace data</li>
</ul>
<p>This document explains how to send Zipkin data.</p>
<h2>Zipkin version requirements [#zipkin-requirements]</h2>
<p>The Trace API supports data from <a href="https://zipkin.io/">Zipkin</a> JSON v2 (or higher) without any modification. For details on this version, see <a href="https://github.com/openzipkin/zipkin/releases/tag/2.0.0">Zipkin v2 release details</a> and the <a href="https://zipkin.io/zipkin-api/#/default/post_spans">Zipkin v2 schema</a>.</p>
<h2>Quick start: Send Zipkin data via <code>curl</code> request [#send-zipkin-curl]</h2>
<p>This procedure describes how to send a simple Zipkin trace to New Relic. Alternatively, you can go to <a href="#existing-zipkin">Report data from existing Zipkin instrumentation</a>.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Note that this is only a simple trace, in order to show you how the API works. In practice, you might have a more complex trace structure, with additional attributes.</p>
</div>
<ol>
  <li>
    <p>Get an <a href="/docs/insights/insights-data-sources/custom-data/send-custom-events-event-api#">Insights insert API key</a>: Go to the <a href="https://one.newrelic.com/launcher/api-keys-ui.api-keys-launcher">API keys UI</a> and select <strong>Insights insert keys</strong>. If you don't already have a key, create a new one by selecting <strong>Insert keys +</strong>.</p>
  </li>
  <li>
    <p>Insert that key into the following JSON and then send the JSON to our endpoint. Tips:</p>
    <ul>
      <li>To copy the JSON, hover over the code to see a <strong>Copy</strong> button.</li>
      <li>If you send more than one post, change the trace.id to a different value. Sending the same payload or span <code>id</code> multiple times for the same <code>traceId</code> may result in fragmented traces in the UI.</li>
    </ul>
    <pre><code>curl -i -H 'Content-Type: application/json' \
 -H 'Api-Key: NEW_RELIC_INSERT_API_KEY' \
 -H 'Data-Format: zipkin' \
 -H 'Data-Format-Version: 2' \
 -X POST \
 -d '[
         {
             "traceId": "test-zipkin-trace-id-1",
             "id": "3e0f5885710776cd",
             "kind": "CLIENT",
             "name": "post",
             "duration": 508068,
             "localEndpoint": {
                 "serviceName": "service-1",
                 "ipv4": "127.0.0.1",
                 "port": 8080
             },
             "tags": {
             }
         },
         {
             "traceId": "test-zipkin-trace-id-1",
             "parentId": "3e0f5885710776cd",
             "id": "asdf9asdn123lkasdf",
             "kind": "CLIENT",
             "name": "service 2 span",
             "duration": 2019,
             "localEndpoint": {
                 "serviceName": "service-2",
                 "ipv4": "127.0.0.1",
                 "port": 8080
             },
             "tags": {
             }
         }
     ]' 'https://trace-api.newrelic.com/trace/v1'
</code></pre>
  </li>
</ol>
<p>Within a minute, the trace should be available in the <a href="https://one.newrelic.com/launcher/distributed-tracing-nerdlets.distributed-tracing">our distributed tracing UI</a>. To find it, run a query for the <code>trace.id</code>. In this example, it was <code>test-zipkin-trace-id-1</code> and we search by the translated term of <code>trace.id</code>.</p>
<p>
  <img src="./images/Screen-Shot-2020-08-13-at-1.26.17-PM.png" alt="Distributed Tracing Zipkin Integration Searching for sample trace" title="Distributed Tracing Zipkin Integration Searching for sample trace">
</p>
<p>Learn more:</p>
<ul>
  <li><a href="/docs/understand-dependencies/distributed-tracing/ui-data/additional-distributed-tracing-features-new-relic-one#find-data">Learn where Trace API data shows up in the UI</a>.</li>
  <li><a href="#existing-zipkin">Send data from an existing Zipkin instrumentation</a>.</li>
  <li><a href="/docs/apm/distributed-tracing/trace-api/trace-api-decorate-spans-attributes">Learn how to decorate spans</a> to customize how they're displayed for a richer, more detailed experience. For example, you can have spans show up as datastore spans or display the presence of errors.</li>
  <li>Learn about general <a href="/docs/apm/distributed-tracing/trace-api/trace-api-endpoint-requirements-limits">endpoint information (data limits, required metadata, and response validation</a>).</li>
  <li>Learn about how <a href="#zipkin-transform">Zipkin data is transformed and stored</a>.</li>
  <li>If you don't see your trace data, see <a href="/docs/apm/distributed-tracing/trace-api/troubleshooting-missing-trace-api-data">Troubleshooting</a>.</li>
</ul>
<h2>Send data from existing Zipkin instrumentation [#existing-zipkin]</h2>
<p>To report data from your Zipkin instrumentation, you will point the Zipkin tracer at the Trace API endpoint (<code>https://trace-api.newrelic.com/trace/v1</code>) with some required request metadata. You can send the required metadata as headers or query parameters (some Zipkin tracer versions don't allow specifying HTTP headers).</p>
<p>Here's an example of what it might look like to create a Zipkin <code>OkHttpSender</code> in Java configured for the Trace API:</p>
<pre><code>OkHttpSender.create("https://trace-api.newrelic.com/trace/v1?Api-Key=NEW_RELIC_INSERT_API_KEY&#x26;Data-Format=zipkin&#x26;Data-Format-Version=2");
</code></pre>
<p>For an explanation of <code>Api-Key</code> and the other metadata, see <a href="/docs/apm/distributed-tracing/trace-api/trace-api-endpoint-requirements-limits#headers-query-parameters">Request metadata</a>.</p>
<h2>Transformation of Zipkin data [#zipkin-transform]</h2>
<p>To create a consistent search/query experience, some Zipkin data will be transformed to match New Relic <a href="/docs/using-new-relic/welcome-new-relic/get-started/glossary#attribute">attribute</a> naming. For more on how we store and structure trace data, see <a href="/docs/understand-dependencies/distributed-tracing/get-started/how-new-relic-distributed-tracing-works">How distributed tracing works</a>.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Zipkin tag</p>
      </div>
      <div>
        <p>Stored in New Relic as...</p>
      </div>
      <div>
        <p>Details</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>traceId</p>
      </div>
      <div>
        <p>trace.id</p>
      </div>
      <div>
        <p>Unique identifier for a trace.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>id</code></p>
      </div>
      <div>
        <p><code>id</code></p>
      </div>
      <div>
        <p>Unique identifier for a span.</p>
      </div>
    </div>
    <div>
      <div>
        <p>parentId</p>
      </div>
      <div>
        <p>parent.id</p>
      </div>
      <div>
        <p>Identifier of the upstream span that called the service.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>kind</code></p>
      </div>
      <div>
        <p><code>kind</code></p>
      </div>
      <div>
        <p>Either <code>Client</code> or <code>Server</code>.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>name</code></p>
      </div>
      <div>
        <p><code>name</code></p>
      </div>
      <div>
        <p>Name of span.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>duration</code></p>
      </div>
      <div>
        <p><code>duration.ms</code></p>
      </div>
      <div>
        <p>Zipkin v2 spans must have durations specified in microseconds, and will be converted to milliseconds.</p>
      </div>
    </div>
    <div>
      <div>
        <p>localEndpoint: <code>serviceName</code></p>
      </div>
      <div>
        <p><code>service.name</code></p>
      </div>
      <div>
        <p>We use the Zipkin v2 service name to identify the entity that created this span.</p>
      </div>
    </div>
    <div>
      <div>
        <p>localEndpoint: <code>port</code></p>
      </div>
      <div>
        <p><code>localEndpoint.port</code></p>
      </div>
      <div>
        <p>All values in the <code>localEndpoint</code> object will be flattened to a span attribute called <code>localEndpoint.key</code></p>
      </div>
    </div>
    <div>
      <div>
        <p><code>tags</code></p>
      </div>
      <div>
        <p>reported as <a href="/docs/using-new-relic/welcome-new-relic/get-started/glossary#attribute">attributes</a></p>
      </div>
      <div>
        <p>Key:value pairs in the <code>tags</code> object in Zipkin v2 will be written as span attributes.</p>
      </div>
    </div>
    <div>
      <div>
        <p>annotations</p>
      </div>
      <div>
        <p>not supported</p>
      </div>
      <div>
        <p>We do not currently support annotations in the Trace API. Spans will not be rejected if they contain annotations, but the annotations data will not be written.</p>
      </div>
    </div>
  </div>
</div>
<h2>Add other tags/attributes [#other-tags]</h2>
<p>You can add any tags you want to the <code>tags</code> block, with the exception of the <a href="/docs/apm/distributed-tracing/trace-api/trace-api-endpoint-requirements-limits#restricted-attributes">restricted tags</a>. For example, you might want to add attributes like <code>customer.id</code> or <code>user.id</code> to help you analyze your trace data. Tags will be converted to New Relic <a href="/docs/using-new-relic/welcome-new-relic/get-started/glossary#attribute">attributes</a>.</p>
<p>To learn how to control how spans appear in New Relic (for example, adding errors or setting a span as a datastore span), see <a href="/docs/apm/distributed-tracing/trace-api/trace-api-decorate-spans-attributes">Decorate spans</a>.</p>
