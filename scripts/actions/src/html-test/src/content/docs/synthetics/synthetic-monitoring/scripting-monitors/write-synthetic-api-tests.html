
<p>Use synthetic monitoring's <a href="/docs/synthetics/new-relic-synthetics/getting-started/types-synthetics-monitors">API tests</a> to monitor your API endpoint to ensure it is functioning correctly. New Relic uses the <a href="https://github.com/request/request">http-request</a> module internally to make HTTP calls to your endpoint and validate the results.</p>
<p>Here we present some example functions showing how to use the <code>$http</code> object to submit your request. For detailed documentation on the options available for this object, see the <a href="https://github.com/request/request">http-request readme</a>.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>To view and share other API test examples, visit the <a href="https://discuss.newrelic.com/tags/c/support-products-agents/synthetics/synthetics-script">synthetics scripts</a> section in Explorer's Hub.</p>
</div>
<h2>Use API http-request module [#overview]</h2>
<p>API tests are powered by the <a href="https://github.com/request/request">http-request</a> module, which is available through the <code>$http</code> object. Once each frequency interval, New Relic queries your endpoint from each of your selected locations. For instructions on creating a monitor, see <a href="/docs/synthetics/new-relic-synthetics/using-monitors/adding-editing-monitors#adding-monitors">Adding monitors</a>.</p>
<p>Read on to learn how to <a href="#request-options">define metadata for your request</a>, <a href="#get">make a GET request</a>, <a href="#post">make a POST request</a>, and how to <a href="#validating">validate the results</a>.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>After a maximum run time of three minutes, New Relic manually stops the script.</p>
</div>
<p>
  <img src="./images/api-test-snap_0.png" alt="api-test-snap.png" title="api-test-snap.png">
</p>
<p><a href="http://one.newrelic.com/"><strong>one.newrelic.com</strong></a> <strong>> Synthetics > Create monitor</strong>: The script editor suggests functions, selectors, and other elements to simplify <a href="https://github.com/request/request">scripting commands (available in GitHub)</a>.</p>
<h2>Configure request options [#request-options]</h2>
<p>To start your script:</p>
<ul>
  <li>Declare a variable (such as <code>options</code>) to store your <a href="http://github.com/request/request#requestoptions-callback">request options object</a>.</li>
  <li>Define request options such as the URL endpoint, and custom headers.</li>
  <li>If you're setting SSL or agent options, see <a href="#ssl-options">SSL and agentOptions requirements</a>.</li>
</ul>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>For a full list of supported request options, see <a href="https://github.com/request/request#requestoptions-callback">request(options, callback)</a> in the <code>http-request</code> documentation on GitHub.</p>
</div>
<p>Here's an example of optional metadata in the options object:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibWV0YWRhdGEtMSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiVXNpbmcgb3B0aW9uYWwgbWV0YWRhdGEifV0=">
    <div data-prop-text="title">Using optional metadata</div>
    <pre><code>//Declare optional metadata
var options = {
        //Specify the endpoint URL
        url: 'https://api-endpoint.example.com',
        //Specify optional headers
        headers: {
                'Endpoint-Key': 'uqNTC57Phe72pnnB8JuJmwAr7b09nKSKSz',
                'Additional-Header': 'Additional-Header-Data'
        }
};

</code></pre>
  </div>
</div>
<p><strong>For SSL and agentOptions:</strong> If you are setting SSL options or providing an <a href="https://github.com/request/request#using-optionsagentoptions"><code>agentOptions</code></a> object, the <code>agent</code> property in the request <code>options</code> object will need to be set to <code>$globalAgents.https</code> or <code>$globalAgents.http</code> to ensure your HTTP requests use the instrumented global agent.</p>
<p>Here's an example of using a SSL option or <code>agentOptions</code>:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidXNlLWFnZW50T3B0aW9ucyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiVXNpbmcgYSBTU0wgb3B0aW9uIG9yIGFnZW50T3B0aW9ucyJ9XQ==">
    <div data-prop-text="title">Using a SSL option or agentOptions</div>
    <p>This example uses <code>agentOptions</code>:</p>
    <pre><code>//Declare optional metadata
var options = {
       //Specify the endpoint URL
       url: 'https://api-endpoint.example.com',
       //Specify optional headers
       headers: {
               'Endpoint-Key': 'uqNTC57Phe72pnnB8JuJmwAr7b09nKSKSz',
               'Additional-Header': 'Additional-Header-Data'
       }
       //Specify global agent as the http agent
       agent: $globalAgents.https,
       //Set SSL option
       strictSSL: true,
       //Specify http agent options
       agentOptions: {
         â€‹maxVersion: 'TLSv1.1'   
       },
};

</code></pre>
  </div>
</div>
<h2>Send a GET request [#get]</h2>
<p>To make a GET request, use the <a href="https://github.com/request/request#requestget"><code>$http.get</code></a> method to submit your request. Define your <a href="#request-options">request options</a>, make your request using <code>$http.get</code>, then <a href="#validating">validate</a> the response to ensure your endpoint is returning the correct results.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZ2V0LWluc2lnaHRzLWV4YW1wbGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6Ikluc2lnaHRzIEdFVCBleGFtcGxlIn1d">
    <div data-prop-text="title">Insights GET example</div>
    <p>This example queries the Insights API by using GET:</p>
    <pre><code>//Define your authentication credentials
var myAccountID = '{YOUR_ACCOUNT_ID}';
var myQueryKey = '{YOUR_QUERY_KEY}';
var options = {
    //Define endpoint URI
    uri: 'https://insights-api.newrelic.com/v1/accounts/'+myAccountID+'/query?nrql=SELECT%20average(amount)%20FROM%20SyntheticsEvent',
    //Define query key and expected data type.
    headers: {
    'X-Query-Key': myQueryKey,
    'Accept': 'application/json'
}
};

//Define expected results using callback function.
function callback (err, response, body){
//Log JSON results from endpoint to Synthetics console.
 console.log(JSON.parse(body)); 
 console.log('done with script');
}

//Make GET request, passing in options and callback.
$http.get(options,callback);

</code></pre>
  </div>
</div>
<h2>Send a POST request [#post]</h2>
<p>To make a POST request, use the <a href="https://github.com/request/request#requestpost"><code>$http.post</code></a> method to submit your request. Define your <a href="#request-options">request options</a>, make your request using <code>$http.post</code>, then <a href="#validating">validate</a> the response to ensure your endpoint is returning the correct results.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicG9zdC1pbnNpZ2h0cy1leGFtcGxlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJJbnNpZ2h0cyBQT1NUIGV4YW1wbGUifV0=">
    <div data-prop-text="title">Insights POST example</div>
    <p>This example POSTs a <a href="/docs/insights/new-relic-insights/adding-querying-data/inserting-custom-events">custom Insights event</a> containing static integers:</p>
    <pre><code>//Define your authentication credentials.
var myAccountID = '{YOUR_ACCOUNT_ID}';
var myInsertKey = '{INSERT_KEY}';
//Import the 'assert' module to validate results.
var assert = require('assert');

var options = {
    //Define endpoint URL.
    url: "https://insights-collector.newrelic.com/v1/accounts/"+myAccountID+"/events",
    //Define body of POST request.
    body: '[{"eventType":"SyntheticsEvent","integer1":1000,"integer2":2000}]',
    //Define insert key and expected data type.
    headers: {
        'X-Insert-Key': myInsertKey,
        'Content-Type': 'application/json'
        }
};

//Define expected results using callback function.
function callback(error, response, body) {
    //Log status code to Synthetics console.
    console.log(response.statusCode + " status code")
    //Verify endpoint returns 200 (OK) response code.
    assert.ok(response.statusCode == 200, 'Expected 200 OK response');
    //Parse JSON received from Insights into variable.
    var info = JSON.parse(body);
    //Verify that `info` contains element named `success` with a value of `true`.
    assert.ok(info.success == true, 'Expected True results in Response Body, result was ' + info.success);
    //Log end of script.
    console.log("End reached");
}

//Make POST request, passing in options and callback.
$http.post(options, callback);

</code></pre>
  </div>
</div>
<h2>Validate results [#validating]</h2>
<p>To validate your results, import the <code>assert</code> module to define your test case. Call an <code>assert</code> method to validate your endpoint's response. If any <code>assert</code> functions fail, the entire monitor will be considered a failed check. This may trigger <a href="/docs/synthetics/new-relic-synthetics/using-monitors/alerting-synthetics#alerts">alert notifications</a> and affect your metrics.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Synthetic monitoring does not allow thrown exceptions. Thrown exceptions result in script failure. Use the <code>assert</code> module to validate your results, and use <code>console.log()</code> to <a href="/docs/synthetics/new-relic-synthetics/scripting-monitors/writing-scripted-browsers#logging">log results to the synthetic's console</a>.</p>
</div>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidmFsaWRhdGlvbi1pbnNpZ2h0cy1leGFtcGxlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJJbnNpZ2h0cyB2YWxpZGF0aW9uIGV4YW1wbGUifV0=">
    <div data-prop-text="title">Insights validation example</div>
    <p>This example POSTs to the Insights API, then validates that the response is <code>{"success":true}</code>:</p>
    <pre><code>//Define your authentication credentials.
var myAccountID = '{YOUR_ACCOUNT_ID}';
var myInsertKey = '{INSERT_KEY}';
//Import the `assert` module to validate results.
var assert = require('assert');

var options = {
    //Define endpoint URL.
    url: "https://insights-collector.newrelic.com/v1/accounts/"+myAccountID+"/events",
    //Define body of POST request.
    body: '[{"eventType":"SyntheticsEvent","integer1":1000,"integer2":2000}]',
    //Define insert key and expected data type.
    headers: {
        'X-Insert-Key': myInsertKey,
        'Content-Type': 'application/json'
        }
};

$http.post(options, function(error, response, body) {
    //Log status code to Synthetics console. The status code is logged before the `assert` function, 
    //because a failed assert function ends the script.
    console.log(response.statusCode + " status code")
    //Call `assert` method, expecting a `200` response code.
    //If assertion fails, log `Expected 200 OK response` as error message to Synthetics console.
    assert.ok(response.statusCode == 200, 'Expected 200 OK response');  
        var info = JSON.parse(body);
    //Call `assert` method, expecting body to return `{"success":true}`.
    //If assertion fails, log `Expected True results in Response Body,` plus results as error message to Synthetics console. 
    assert.ok(info.success == true, 'Expected True results in Response Body, result was ' + info.success);
});

</code></pre>
  </div>
</div>
