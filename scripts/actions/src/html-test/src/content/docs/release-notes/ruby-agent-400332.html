
<h2>v4.0.0</h2>
<ul>
  <li>
    <p>Require Ruby 2.0.0+</p>
    <p>The agent no longer supports Ruby versions prior to 2.0, JRuby 1.7 and earlier, and all versions of Rubinius. Customers using affected Rubies can continue to run 3.x agent versions, but new features or bugfixes will not be published for 3.x agents. For more information, check out our <a href="https://discuss.newrelic.com/t/support-for-ruby-jruby-1-x-is-being-deprecated-in-ruby-agent-4-0-0/44787">community forum</a>.</p>
  </li>
  <li>
    <p>OkJson vendored library removed</p>
    <p>Ruby 1.8 did not include the JSON gem by default, so the agent included a vendored version of <a href="https://github.com/kr/okjson">OkJson</a> that it would fall back on using in cases where the JSON gem was not available. This has been removed.</p>
  </li>
  <li>
    <p>YAJL workaround removed</p>
    <p><a href="https://github.com/brianmario/yajl-ruby">yajl-ruby</a> versions prior to 1.2 had the potential to cause a segmentation fault when working large, deeply-nested objects like thread profiles. If you are using yajl-ruby with the <code>JSON</code> monkey patches enabled by requiring <code>yajl/json_gem</code>, you should upgrade to at least version 1.2.</p>
  </li>
  <li>
    <p>Deprecated APIs removed</p>
    <ul>
      <li><code>Agent.abort_transaction!</code></li>
      <li><code>Agent.add_custom_parameters</code></li>
      <li><code>Agent.add_request_parameters</code></li>
      <li><code>Agent.browser_timing_footer</code></li>
      <li><code>Agent.get_stats</code></li>
      <li><code>Agent.get_stats_no_scope</code></li>
      <li><code>Agent.record_transaction</code></li>
      <li><code>Agent.reset_stats</code></li>
      <li><code>Agent.set_user_attributes</code></li>
      <li><code>Agent::Instrumentation::Rack</code></li>
      <li><code>ActionController#newrelic_notice_error</code></li>
      <li><code>ActiveRecordHelper.rollup_metrics_for</code> (may be incompatible with newrelic_moped)</li>
      <li><code>Instrumentation::MetricFrame.recording_web_transaction?</code></li>
      <li><code>Instrumentation::MetricFrame.abort_transaction!</code></li>
      <li><code>MethodTracer.get_stats_scoped</code></li>
      <li><code>MethodTracer.get_stats_unscoped</code></li>
      <li><code>MethodTracer.trace_method_execution</code></li>
      <li><code>MethodTracer.trace_method_execution_no_scope</code></li>
      <li><code>MethodTracer.trace_method_execution_with_scope</code></li>
      <li><code>MetricSpec#sub</code></li>
      <li><code>MetricStats#get_stats</code></li>
      <li><code>MetricStats#get_stats_no_scope</code></li>
      <li><code>NoticedError#exception_class</code></li>
      <li><code>Rack::ErrorCollector</code></li>
      <li><code>StatsEngine::Samplers.add_sampler</code></li>
      <li><code>StatsEngine::Samplers.add_harvest_sampler</code></li>
    </ul>
    <p>The above methods have had deprecation notices on them for some time and have now been removed. Assistance migrating usage of these APIs is available at <a href="https://docs.newrelic.com/docs/agents/ruby-agent/troubleshooting/update-deprecated-api-calls">https://docs.newrelic.com/docs/agents/ruby-agent/troubleshooting/update-...</a> .</p>
    <p>The agent no longer deletes deprecated keys passed to <code>add_method_tracer</code>. Passing in deprecated keys can cause an exception. Ensure that you are not passing any of the following keys: <code>:force, :scoped_metric_only, :deduct_call_time_from_parent</code> to <code>add_method_tracer</code>.</p>
    <p>The agent no longer deletes deprecated keys passed in as options to <code>NewRelic::Agent.notice_error</code>. If you are passing any of these deprecated keys: <code>:request_params, :request, :referer</code> to the <code>notice_error</code> API, please delete them otherwise they will be collected as custom attributes.</p>
  </li>
  <li>
    <p>Error handling changes</p>
    <p>The agent now only checks for <code>original_exception</code> in environments with Rails versions prior to 5. Checking for <code>Exception#cause</code> has been removed. In addition, the agent now will match class name with message and backtrace when noticing errors that have an <code>original_exception</code>.</p>
  </li>
</ul>
