
<h1>New Relic Ruby Agent Release Notes</h1>
<ul>
  <li>
    <p><strong>Added support for W3C Trace Context, with easy upgrade from New Relic trace context</strong></p>
    <ul>
      <li><a href="https://docs.newrelic.com/docs/understand-dependencies/distributed-tracing/get-started/introduction-distributed-tracing#w3c-support">Distributed tracing now supports W3C Trace Context headers</a> for HTTP protocols when distributed tracing is enabled. Our implementation can accept and emit both the W3C trace header format and the New Relic trace header format. This simplifies agent upgrades, allowing trace context to be propagated between services with older and newer releases of New Relic agents. W3C trace header format will always be accepted and emitted. New Relic trace header format will be accepted, and you can optionally disable emission of the New Relic trace header format.</li>
      <li>When distributed tracing is enabled by setting <code>distributed_tracing.enabled</code> to <code>true</code>, the Ruby agent will now accept W3C's <code>traceparent</code> and <code>tracestate</code> headers when calling <code>DistributedTracing.accept_distributed_trace_headers</code> or automatically via <code>http</code> instrumentation. When calling <code>DistributedTracing.insert_distributed_trace_headers</code>, or automatically via <code>http</code> instrumentation, the Ruby agent will include the W3C headers along with the New Relic distributed tracing header, unless the New Relic trace header format is disabled by setting <code>exclude_newrelic_header</code> setting to <code>true</code>.</li>
      <li>Added <code>DistributedTracing.accept_distributed_trace_headers</code> API for accepting both New Relic and W3C TraceContext distributed traces.</li>
      <li>Deprecated <code>DistributedTracing.accept_distributed_trace_payload</code> which will be removed in a future major release.</li>
      <li>Added <code>DistributedTracing.insert_distributed_trace_headers</code> API for adding outbound distributed trace headers. Both W3C TraceContext and New Relic formats will be included unless <code>distributed_tracing.exclude_newrelic_header: true</code>.</li>
      <li>Deprecated <code>DistributedTracing.create_distributed_trace_payload</code> which will be removed in a future major release.</li>
    </ul>
    <p>Known issues and workarounds:</p>
    <ul>
      <li>If a .NET agent is initiating distributed traces as the root service, you must update that .NET agent to version 8.24 or later before upgrading your downstream Ruby New Relic agents to this agent release.</li>
    </ul>
  </li>
  <li>
    <p><strong>Official Ruby 2.7 support</strong></p>
    <p>The Ruby agent has been verified to run with Ruby 2.7.0.</p>
  </li>
  <li>
    <p><strong>Reduced allocations when tracing transactions using API calls</strong></p>
    <p>Default empty hashes for <code>options</code> parameter were not frozen, leading to excessive and unnecessary allocations when calling APIs for tracing transactions.</p>
    <p>Thanks to Joel Turkel (jturkel) for the contribution!</p>
  </li>
  <li>
    <p><strong>Bugfix for Resque worker thread race conditions</strong></p>
    <p>Recent changes in Rack surfaced issues marshalling data for Resque, surfaced a potential race-condition with closing out the worker-threads before flushing the data pipe. This is now fixed.</p>
    <p>Thanks to Bertrand Paquet (bpaquet) for the contribution!</p>
  </li>
  <li>
    <p><strong>Bugfix for Content-Length when injecting browser monitoring JS</strong></p>
    <p>The Content-Length HTTP header would be incorrect after injecting the browser monitoring JS into the HEAD tag of the HTML source with Content-Length and lead to the HTML BODY content being truncated in some cases. The Content-Length is now correctly updated after injecting the browser monitoring JS script.</p>
    <p>Thanks to Slava Kardakov (ojab) for the contribution!</p>
  </li>
</ul>
