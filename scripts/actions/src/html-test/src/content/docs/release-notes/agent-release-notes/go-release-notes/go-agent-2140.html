
<h2>2.14.0</h2>
<h3>New Features</h3>
<ul>
  <li>
    <p>Added support for a new segment type, <a href="https://godoc.org/github.com/newrelic/go-agent#MessageProducerSegment"><code>MessageProducerSegment</code></a>, to be used to track time spent adding messages to message queuing systems like RabbitMQ or Kafka.</p>
    <pre><code>seg := &#x26;newrelic.MessageProducerSegment{
  StartTime:       newrelic.StartSegmentNow(txn),
  Library:         "RabbitMQ",
  DestinationType: newrelic.MessageExchange,
  DestinationName: "myExchange",
}
// add message to queue here
seg.End()
</code></pre>
  </li>
  <li>
    <p>Added new attribute constants for use with message consumer transactions. These attributes can be used to add more detail to a transaction that tracks time spent consuming a message off a message queuing system like RabbitMQ or Kafka. They can be added using <a href="https://godoc.org/github.com/newrelic/go-agent#Transaction"><code>txn.AddAttribute</code></a>.</p>
    <pre><code>// The routing key of the consumed message.
txn.AddAttribute(newrelic.AttributeMessageRoutingKey, "myRoutingKey")
// The name of the queue the message was consumed from.
txn.AddAttribute(newrelic.AttributeMessageQueueName, "myQueueName")
// The type of exchange used for the consumed message (direct, fanout,
// topic, or headers).
txn.AddAttribute(newrelic.AttributeMessageExchangeType, "myExchangeType")
// The callback queue used in RPC configurations.
txn.AddAttribute(newrelic.AttributeMessageReplyTo, "myReplyTo")
// The application-generated identifier used in RPC configurations.
txn.AddAttribute(newrelic.AttributeMessageCorrelationID, "myCorrelationID")
</code></pre>
    <p>It is recommended that at most one message is consumed per transaction.</p>
  </li>
  <li>
    <p>Added support for <a href="https://golang.org/doc/go1.13#error_wrapping">Go 1.13's Error wrapping</a>. <code>Transaction.NoticeError</code> now uses <a href="https://golang.org/pkg/errors/#Unwrap">Unwrap</a> recursively to identify the error's cause (the deepest wrapped error) when generating the error's class field. This functionality will help group your errors usefully.</p>
    <p>For example, when using Go 1.13, the following code:</p>
    <pre><code>type socketError struct{}

func (e socketError) Error() string { return "socket error" }

func gamma() error { return socketError{} }
func beta() error  { return fmt.Errorf("problem in beta: %w", gamma()) }
func alpha() error { return fmt.Errorf("problem in alpha: %w", beta()) }

func execute(txn newrelic.Transaction) {
err := alpha()
txn.NoticeError(err)
}
</code></pre>
    <p>captures an error with message <code>"problem in alpha: problem in beta: socket error"</code> and class <code>"main.socketError"</code>. Previously, the class was recorded as <code>"*fmt.wrapError"</code>.</p>
  </li>
  <li>
    <p>A <code>Stack</code> field has been added to <a href="https://godoc.org/github.com/newrelic/go-agent#Error">Error</a>, which can be assigned using the new <a href="https://godoc.org/github.com/newrelic/go-agent#NewStackTrace">NewStackTrace</a> function. This allows your error stack trace to show where the error happened, rather than the location of the <code>NoticeError</code> call.</p>
    <p><code>Transaction.NoticeError</code> not only checks for a stack trace (using <a href="https://godoc.org/github.com/newrelic/go-agent#StackTracer">StackTracer</a>) in the error parameter, but in the error's cause as well. This means that you can create an <a href="https://godoc.org/github.com/newrelic/go-agent#Error">Error</a> where your error occurred, wrap it multiple times to add information, notice it with <code>NoticeError</code>, and still have a useful stack trace. Take a look!</p>
    <pre><code>func gamma() error {
return newrelic.Error{
    Message: "something went very wrong",
    Class:   "socketError",
    Stack:   newrelic.NewStackTrace(),
}
}

func beta() error  { return fmt.Errorf("problem in beta: %w", gamma()) }
func alpha() error { return fmt.Errorf("problem in alpha: %w", beta()) }

func execute(txn newrelic.Transaction) {
err := alpha()
txn.NoticeError(err)
}
</code></pre>
    <p>In this example, the topmost stack trace frame recorded is <code>"gamma"</code>, rather than <code>"execute"</code>.</p>
  </li>
  <li>
    <p>Added support for configuring a maximum number of transaction events per minute to be sent to New Relic. It can be configured as follows:</p>
    <pre><code>config := newrelic.NewConfig("Application Name", os.Getenv("NEW_RELIC_LICENSE_KEY"))  
config.TransactionEvents.MaxSamplesStored = 100
</code></pre>
    <ul>
      <li>For additional configuration information, see our <a href="https://docs.newrelic.com/docs/agents/go-agent/configuration/go-agent-configuration">documentation</a></li>
    </ul>
  </li>
</ul>
<h3>Miscellaneous</h3>
<ul>
  <li>
    <p>Updated the <a href="https://godoc.org/github.com/newrelic/go-agent/_integrations/nrmicro"><code>nrmicro</code></a> package to use the new segment type <a href="https://godoc.org/github.com/newrelic/go-agent#MessageProducerSegment"><code>MessageProducerSegment</code></a> and the new attribute constants:</p>
    <ul>
      <li><a href="https://godoc.org/github.com/newrelic/go-agent/_integrations/nrmicro#ClientWrapper"><code>nrmicro.ClientWrapper</code></a> now uses <code>newrelic.MessageProducerSegment</code>s instead of <code>newrelic.ExternalSegment</code>s for calls to <a href="https://godoc.org/github.com/micro/go-micro/client#Client"><code>Client.Publish</code></a>.</li>
      <li><a href="https://godoc.org/github.com/newrelic/go-agent/_integrations/nrmicro#SubscriberWrapper"><code>nrmicro.SubscriberWrapper</code></a> updates transaction names and adds the attribute <code>message.routingKey</code>.</li>
    </ul>
  </li>
  <li>
    <p>Updated the <a href="https://godoc.org/github.com/newrelic/go-agent/_integrations/nrnats"><code>nrnats</code></a> and <a href="https://godoc.org/github.com/newrelic/go-agent/_integrations/nrstan"><code>nrstan</code></a> packages to use the new segment type <a href="https://godoc.org/github.com/newrelic/go-agent#MessageProducerSegment"><code>MessageProducerSegment</code></a> and the new attribute constants:</p>
    <ul>
      <li><a href="https://godoc.org/github.com/newrelic/go-agent/_integrations/nrnats#StartPublishSegment"><code>nrnats.StartPublishSegment</code></a> now starts and returns a <code>newrelic.MessageProducerSegment</code> type.</li>
      <li><a href="https://godoc.org/github.com/newrelic/go-agent/_integrations/nrnats#SubWrapper"><code>nrnats.SubWrapper</code></a> and <a href="https://godoc.org/github.com/newrelic/go-agent/_integrations/nrstan#StreamingSubWrapper"><code>nrstan.StreamingSubWrapper</code></a> updates transaction names and adds the attributes <code>message.routingKey</code>, <code>message.queueName</code>, and <code>message.replyTo</code>.</li>
    </ul>
  </li>
</ul>
