
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>The end-of-life date for this agent version is July 29, 2019. To update to the latest agent version, see <a href="/docs/agents/manage-apm-agents/installation/update-new-relic-agent">Update the agent</a>. For more information, see <a href="/docs/agents/manage-apm-agents/maintenance/new-relic-agent-plugin-end-life-policy">End-of-life policy</a>.</p>
</div>
<h3>Notes</h3>
<p>This release of the PHP agent automatically marks Drupal cron requests as background tasks, improves the categorization of PHP errors within the New Relic UI, and fixes several bugs. Additionally, the internals of the agent have been significantly refactored to improve the stability and performance of the agent.</p>
<h3>New Features</h3>
<ul>
  <li>
    <p>Treat Drupal cron requests as background tasks</p>
    <p>Drupal cron requests (identified by calls to <code>drupal_cron_run()</code>) will now be counted as background tasks (not web transactions) regardless of how they are started. Previously, it was necessary to use the <code>newrelic_background_job()</code> API to explicitly mark Drupal cron requests as background tasks.</p>
  </li>
  <li>
    <p>Use the exception class as the category for errors</p>
    <p>Errors created using the <code>newrelic_notice_error()</code> API function with an exception will be grouped according to the exception's class. Previously, all errors were grouped under 'NoticedError'.</p>
    <p>See <a href="https://docs.newrelic.com/docs/php/the-php-api#api-notice-error">https://docs.newrelic.com/docs/php/the-php-api#api-notice-error</a></p>
  </li>
  <li>
    <p>Limit the maximum number of nested PHP function calls</p>
    <p>The agent will now limit the maximum number of nested function calls within PHP applications. This is to provide protection against stack overflows due to infinite recursion. Previously, this would result in a segmentation fault. The agent will now log an error and terminate the process by raising a fatal PHP error. By default, this limit is set to a very high value of 500. Exceeding this limit should be extremely rare.</p>
  </li>
  <li>
    <p>Improve the stability and performance of the agent</p>
    <p>The internals of the agent and its background daemon process have been significantly refactored to improve interprocess communication, stability and performance. The maximum number of connections to the background daemon process has been doubled to 4096.</p>
  </li>
</ul>
<h3>Bug Fixes</h3>
<ul>
  <li>
    <p>Fix for installing on Ubuntu 13.10 when using PHP-FPM</p>
    <p>Previously the installer would fail to install a newrelic.ini file in the configuration directory for PHP-FPM (/etc/php5/fpm/conf.d), if one was present. This has been fixed, and the installer will correctly install a newrelic.ini for CLI, DSO and FPM configuration directories.</p>
  </li>
  <li>
    <p>Fix for <code>drupal_http_request()</code> always returning <code>NULL</code> under PHP 5.5</p>
    <p>Version 3.9.5.13 added support for external calls made using <code>drupal_http_request()</code>. Due to the way the agent instruments this function under PHP 5.5, this function would always return <code>NULL</code> instead of the correct return value. This has been fixed.</p>
  </li>
  <li>
    <p>Fix for real user monitoring when a Content-Length response header is present.</p>
    <p>When automatic real user monitoring is enabled, the agent will only perform JavaScript injection into HTML pages when a Content-Length header is not already present in the response. In some cases, this check was not working correctly leading to the value in the Content-Length header not matching the actual number of bytes sent to the client.</p>
  </li>
  <li>
    <p>Fixed a segmentation fault when Zend Thread Safety is enabled.</p>
    <p>Attempts to use the agent under Apache using a threaded MPM (e.g. worker or event) and mod_php would result in segmentation faults. This has been fixed, but New Relic <a href="https://docs.newrelic.com/docs/php/php-and-the-apache-worker-mpm">does not recommend</a> using the agent in these circumstances.</p>
  </li>
  <li>
    <p>Fixed high CPU usage under heavy load</p>
    <p>Under very high loads with thousands of PHP processes, the background daemon process could consume 100% CPU when the per-process file descriptor limit was exceeded. This has been fixed. The agent will now throttle the number of new connections accepted when per-process file descriptor limit is reached. A message is also printed to the log file.</p>
  </li>
</ul>
