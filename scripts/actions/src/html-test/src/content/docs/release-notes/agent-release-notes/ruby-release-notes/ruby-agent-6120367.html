
<h1>New Relic Ruby Agent Release Notes</h1>
<h2>v6.12.0</h2>
<ul>
  <li>
    <p>The New Relic Ruby agent is now open source under the <a href="https://github.com/newrelic/newrelic-ruby-agent/blob/dev/LICENSE">Apache 2 license</a> and you can now observe the project roadmap. See our <a href="https://github.com/newrelic/newrelic-ruby-agent/blob/main/CONTRIBUTING.md">Contributing guide</a> and <a href="https://github.com/newrelic/.github/blob/master/CODE_OF_CONDUCT.md">Code of Conduct</a> for details on contributing!</p>
  </li>
  <li>
    <p><strong>Security: Updated all uses of Rake to >= 12.3.3</strong></p>
    <p>All versions of Rake testing prior to 12.3.3 were removed to address <a href="https://nvd.nist.gov/vuln/detail/CVE-2020-8130">CVE-2020-8130</a>. No functionality in the agent was removed nor deprecated with this change, and older versions of rake are expected to continue to work as they have in the past. However, versions of rake &#x3C; 12.3.3 are no longer tested nor supported.</p>
  </li>
  <li>
    <p><strong>Bugfix: fixes an error capturing content length in middleware on multi-part responses</strong></p>
    <p>In the middleware tracing, the <code>Content-Length</code> header is sometimes returned as an array of values when content is a multi-part response. Previously, the agent would fail with "NoMethodError: undefined method <code>to_i</code> for Array" Error. This bug is now fixed and multi-part content lengths are summed for a total when an <code>Array</code> is present.</p>
  </li>
  <li>
    <p><strong>Added support for auto-instrumenting Mongo gem versions 2.6 to 2.12</strong></p>
  </li>
  <li>
    <p><strong>Bugfix: MongoDB instrumentation did not handle CommandFailed events when noticing errors</strong></p>
    <p>The mongo gem sometimes returns a CommandFailed object instead of a CommandSucceeded object with error attributes populated. The instrumentation did not handle noticing errors on CommandFailed objects and resulted in logging an error and backtrace to the log file.</p>
    <p>Additionally, a bug in recording the metric for "findAndModify" as all lowercased "findandmodify" for versions 2.1 through 2.5 was fixed.</p>
  </li>
  <li>
    <p><strong>Bugfix: Priority Sampler causes crash in high throughput environments in rare cases</strong></p>
    <p>Previously, the priority sampling buffer would, in rare cases, generate an error in high-throughput environments once capacity is reached and the sampling algorithm engages. This issue is fixed.</p>
  </li>
  <li>
    <p><strong>Additional transaction information applied to Spans</strong></p>
    <p>When distributed tracing and/or Infinite Tracing are enabled, the agent will now incorporate additional information from the Transaction event on to the root Span of the transaction.</p>
    <p>The following items are affected:</p>
    <ul>
      <li>Custom attribute values applied to the Transaction via our <a href="http://www.rubydoc.info/github/newrelic/newrelic-ruby-agent/NewRelic/Agent#add_custom_attributes-instance_method">add_custom_attributes</a> API method.</li>
      <li>Request parameters: <code>request.parameters.*</code></li>
      <li>Request headers: <code>request.headers.*</code></li>
      <li>Response headers: <code>response.headers.*</code></li>
      <li>Resque job arguments: <code>job.resque.args.*</code></li>
      <li>Sidekiq job arguments: <code>job.sidekiq.args.*</code></li>
      <li>Messaging arguments: <code>message.*</code></li>
      <li><code>httpResponseCode</code> (deprecated in this version; see note below)/<code>http.statusCode</code></li>
      <li><code>response.status</code></li>
      <li><code>request.uri</code></li>
      <li><code>request.method</code></li>
      <li><code>host.displayName</code></li>
    </ul>
  </li>
  <li>
    <p><strong>Security recommendation</strong></p>
    <p>Review your Transaction attributes <a href="https://docs.newrelic.com/docs/agents/ruby-agent/attributes/enable-disable-attributes-ruby#transaction_events-attributes-include">include</a> and <a href="https://docs.newrelic.com/docs/agents/ruby-agent/attributes/enable-disable-attributes-ruby#transaction_events-attributes-exclude">exclude</a> configurations. Any attribute include or exclude settings specific to Transaction events should be applied to your Span attributes <a href="https://docs.newrelic.com/docs/agents/ruby-agent/attributes/enable-disable-attributes-ruby#span-events-attributes-include">include</a> and <a href="https://docs.newrelic.com/docs/agents/ruby-agent/attributes/enable-disable-attributes-ruby#span-events-attributes-exclude">exclude</a> configuration or your global attributes <a href="https://docs.newrelic.com/docs/agents/ruby-agent/attributes/enable-disable-attributes-ruby#attributes-include">include</a> and <a href="https://docs.newrelic.com/docs/agents/ruby-agent/attributes/enable-disable-attributes-ruby#attributes-exclude">exclude</a> configuration.</p>
  </li>
  <li>
    <p><strong>Agent attribute deprecation: httpResponseCode</strong></p>
    <p>Starting in this agent version, the <a href="https://docs.newrelic.com/docs/agents/ruby-agent/attributes/ruby-agent-attributes#attributes">agent attribute</a> <code>httpResponseCode</code> (string value) has been deprecated. Customers can begin using <code>http.statusCode</code> (integer value) immediately, and <code>httpResponseCode</code> will be removed in the agent's next major version update.</p>
  </li>
  <li>
    <p><strong>Bugfix: Eliminate warnings for distributed tracing when using sidekiq</strong></p>
    <p>Previously, using sidekiq with distributed tracing disabled resulted in warning messages\ <code>WARN : Not configured to accept distributed trace headers</code>\ <code>WARN : Not configured to insert distributed trace headers</code>\ These messages no longer appear.</p>
  </li>
</ul>
