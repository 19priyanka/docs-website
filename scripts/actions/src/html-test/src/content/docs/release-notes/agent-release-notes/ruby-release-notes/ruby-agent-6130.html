
<h2>v6.13.0</h2>
<ul>
  <li>
    <p><strong>Bugfix: never use redirect host when accessing preconnect endpoint</strong></p>
    <p>When connecting to New Relic, the Ruby Agent uses the value in <code>Agent.config[:host]</code> to post a request to the New Relic preconnect endpoint. This endpoint returns a "redirect host" which is the URL to which agents send data from that point on.</p>
    <p>Previously, if the agent needed to reconnect to the collector, it would incorrectly use this redirect host to call the preconnect endpoint, when it should have used the original configured value in <code>Agent.config[:host]</code>. The agent now uses the correct host for all calls to preconnect.</p>
  </li>
  <li>
    <p><strong>Bugfix: calling <code>add_custom_attributes</code> no longer modifies the params of the caller</strong></p>
    <p>The previous agent's improvements to recording attributes at the span level had an unexpected side-effect of modifying the params passed to the API call as duplicated attributes were deleted in the process. This is now fixed and params passed in are no longer modified.</p>
    <p>Thanks to Pete Johns (@johnsyweb) for the PR that resolves this bug.</p>
  </li>
  <li>
    <p><strong>Bugfix: <code>http.url</code> query parameters spans are now obfuscated</strong></p>
    <p>Previously, the agent was recording the full URL of the external requests, including the query and fragment parts of the URL as part of the attributes on the external request span. This has been fixed so that the URL is obfuscated to filter out potentially sensitive data.</p>
  </li>
  <li>
    <p><strong>Use system SSL certificates by default</strong></p>
    <p>The Ruby agent previously used a root SSL/TLS certificate bundle by default. Now the agent will attempt to use the default system certificates, but will fall back to the bundled certs if there is an issue (and log that this occurred).</p>
  </li>
  <li>
    <p><strong>Bugfix: reduce allocations for segment attributes</strong></p>
    <p>Previously, every segment received an <code>Attributes</code> object on initialization. The agent now lazily creates attributes on segments, resulting in a significant reduction in object allocations for a typical transaction.</p>
  </li>
  <li>
    <p><strong>Bugfix: eliminate errors around Rake::VERSION with Rails</strong></p>
    <p>When running a Rails application with rake tasks, customers could see the following error:</p>
  </li>
  <li>
    <p><strong>Prevent connecting agent thread from hanging on shutdown</strong></p>
    <p>A bug in <code>Net::HTTP</code>'s Gzip decoder can cause the (un-catchable) thread-kill exception to be replaced with a (catchable) <code>Zlib</code> exception, which prevents a connecting agent thread from exiting during shutdown, causing the Ruby process to hang indefinitely. This workaround checks for an <code>aborting</code> thread in the <code>#connect</code> exception handler and re-raises the exception, allowing a killed thread to continue exiting.</p>
    <p>Thanks to Will Jordan (@wjordan) for chasing this one down and patching with tests.</p>
  </li>
  <li>
    <p><strong>Fix error messages about Rake instrumentation</strong></p>
    <p>When running a Rails application with rake tasks, customers could see the following error in logs resulting from a small part of rake functionality being loaded with the Rails test runner:</p>
    <pre><code>ERROR : Error while detecting rake_instrumentation:
ERROR : NameError: uninitialized constant Rake::VERSION
</code></pre>
    <p>Such error messages should no longer appear in this context.</p>
    <p>Thanks to @CamilleDrapier for pointing out this issue.</p>
  </li>
  <li>
    <p><strong>Remove NewRelic::Metrics</strong></p>
    <p>The <code>NewRelic::Metrics</code> module has been removed from the agent since it is no longer used.</p>
    <p>Thanks to @csaura for the contribution!</p>
  </li>
</ul>
