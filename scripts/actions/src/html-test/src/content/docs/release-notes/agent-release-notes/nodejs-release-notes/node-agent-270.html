
<h3>New features</h3>
<ul>
  <li>
    <p>Added agent attribute filtering via include and exclude rules.</p>
    <p><a href="/docs/agents/nodejs-agent/attributes/nodejs-agent-attributes">Agent attributes</a> can now be controlled using fine grained include and exclude rules. These rules, described below, replace <code>capture_params</code> and <code>ignored_params</code>. Any attributes listed in <code>ignored_params</code> will be migrated to <code>attributes.exclude</code> internally, unless <code>attributes.exclude</code> is explicitly set.</p>
    <p>There are three new configuration properties added to the root config and each destination (more on destinations later). These new configurations are:</p>
    <ul>
      <li><code>attributes.enabled</code> - Enables collection of attributes for the destination.</li>
      <li><code>attributes.include</code> - A list of attributes or wildcard rules to include.</li>
      <li><code>attributes.exclude</code> - A list of attributes or wildcard rules to exclude.</li>
    </ul>
    <p>The include and exclude rules can be exact rules (for example <code>request.headers.contentLength</code>), or wildcard rules which match just the beginning of attribute keys (for example <code>request.headers.*</code> would match any request header).</p>
    <p>These rules can be specified globally at the root of the configuration, or for specific destinations. These destinations are:</p>
    <ul>
      <li><code>transaction_tracer</code> - Controls transaction trace attributes.</li>
      <li><code>transaction_events</code> - Controls transaction event attributes.</li>
      <li><code>error_collector</code> - Controls error event attributes.</li>
      <li><code>browser_monitoring</code> - Controls browser/RUM transaction attributes.</li>
    </ul>
  </li>
  <li>
    <p>Renamed <code>addCustomParameter</code> to <code>addCustomAttribute</code>.</p>
    <p>The <code>addCustomParameter</code> method is now deprecated and will be removed in a future release of the agent. The <code>addCustomAttribute</code> method is a drop-in replacement for it.</p>
  </li>
  <li>
    <p>Added cache to agent attribute filtering.</p>
    <p>To minimize the overhead of applying attribute rules, the agent caches results of filtering specific attribute keys and destinations. The cache is limited to 1000 destination-key pairs by default but can be configured with <code>attributes.filter_cache_limit</code>. This cache offers a 10x improvement for applying filter rules for cache-hits.</p>
  </li>
  <li>
    <p>Added <code>allow_all_headers</code> to config options and updated <code>http</code> instrumentation.</p>
    <p>When set to <code>true</code>, the agent will collect all request headers. This collection respects the agent attribute include and exclude rules. A default set of exclusion rules are provided in <code>newrelic.js</code>. These rules exclude all cookies and authentication headers.</p>
  </li>
  <li>
    <p>Segments may now be flagged as opaque, causing internal segments to be omitted from the transaction trace.</p>
  </li>
</ul>
<h3>Improvements</h3>
<ul>
  <li>
    <p>Added limits for agent attributes to keep monitoring overhead down.</p>
    <p>Attribute keys and values are limited to 255 bytes each. Keys which are larger than 255 bytes are dropped, and a warning message is logged. Values larger than 255 bytes are truncated to 255 bytes, respecting multi-byte UTF-8 encoding. Custom attributes are limited to 64 per transaction. Attributes beyond the 64th are silently ignored.</p>
  </li>
  <li>
    <p>Added error to collector connection failure log message.</p>
  </li>
  <li>
    <p>Renamed <code>request_uri</code> attribute to <code>request.uri</code>.</p>
    <p>This brings the attribute name in line with all other request attributes.</p>
  </li>
  <li>
    <p>Updated <code>https-proxy-agent</code> dependency from <code>^0.3.5</code> to <code>^0.3.6</code>.</p>
  </li>
  <li>
    <p>Updated versioned tests where applicable to ensure most minor versions of instrumented modules work as expected.</p>
  </li>
  <li>
    <p>Fixed stalling test for v1 line of Mongo driver.</p>
  </li>
  <li>
    <p>Added tests verifying Hapi 404 transactions result in correctly named metrics.</p>
    <p>The Hapi instrumentation was doing the correct thing, but we did not have tests for this specific case.</p>
  </li>
</ul>
<h3>Bug fixes</h3>
<ul>
  <li>
    <p>The agent will no longer crash when <code>crypto.DEFAULT_ENCODING</code> has been changed.</p>
    <p>Previously, the agent would assume the result of <code>hash.digest()</code> was an instance of a Buffer. If <code>crypto.DEFAULT_ENCODING</code> is changed, <code>hash.digest()</code> will return a string and the agent would crash. The agent now ensures that the value is a Buffer instance before moving on.</p>
  </li>
  <li>
    <p>Fixed error if <code>process.config.variables.node_prefix</code> missing.</p>
    <p>If <code>process.config.variables.node_prefix</code> is falsey (which can happen if using electron, leading to this issue <a href="https://discuss.newrelic.com/t/new-relic-on-electron-nodejs/53601">https://discuss.newrelic.com/t/new-relic-on-electron-nodejs/53601</a>) the <code>getGlobalPackages</code> function in <code>lib/environment.js</code> will give an err when it shouldn't.</p>
    <p>Thanks to Jarred Filmer (@BrighTide) for the fix!</p>
  </li>
</ul>
