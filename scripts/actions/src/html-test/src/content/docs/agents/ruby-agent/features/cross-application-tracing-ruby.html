
<p>If you use a non-standard middleware framework, follow these procedures to install and configure New Relic's <a href="/docs/traces/cross-application-traces">cross application tracing feature</a>. If you have problems, follow the <a href="/docs/apm/transactions/cross-application-traces/troubleshooting-cross-application-tracing">troubleshooting procedures for cross application tracing</a>.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>New Relic also supports <a href="https://docs.newrelic.com/docs/apm/distributed-tracing/getting-started/introduction-distributed-tracing">distributed tracing</a>. Distributed tracing improves on cross application tracing and is recommended for large, distributed systems.</p>
</div>
<h2>Requirements</h2>
<p>Follow these requirements to use cross application tracing with the Ruby agent:</p>
<ol>
  <li>Make sure the requests being instrumented use a <a href="/docs/ruby/ruby-http-clients">supported HTTP client library</a>.</li>
  <li>Install or update to the <a href="/docs/ruby/ruby-agent-installation">latest Ruby agent</a> (version 3.5.5.38 or higher).</li>
  <li>Follow the requirements for middleware installation.</li>
</ol>
<h2>Middleware installation [#middleware]</h2>
<p>Cross application tracing works with Rack, and therefore requires Rails 2.3 or greater, or another compatible framework.</p>
<ul>
  <li>If you use Rails, the Ruby agent will install the middleware automatically.</li>
  <li>If you use a different Rack-based framework, manually add the <code>NewRelic::Rack::AgentHooks</code> middleware to your stack.</li>
</ul>
<h2>Configuration</h2>
<p>Cross application tracing can be controlled by a configuration flag.</p>
<pre><code>cross_application_tracer
	  enabled: true
</code></pre>
<p>The default for <code>cross_application_tracer.enabled</code> is <code>true</code>, even when unspecified. To disable cross application tracing, you must set this flag to <code>false</code>.</p>
<h2>Cross application trace measurements [#cat-measurements]</h2>
<p>The <strong>external</strong> measurement (from the calling application) will always be larger than the <strong>internal</strong> measurement (from the called application). The external measurement is collected by New Relic's instrumentation of the HTTP client library (such as Net::HTTP). The internal measurement is taken by New Relic's instrumentation of the web framework (such as Rails) in the called application.</p>
<p>Here are some of the major components included in the external measurement that are <strong>not</strong> included in the internal measurement:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY2FsbGluZyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiRnJvbSBjYWxsaW5nIGFwcCB0byB0YXJnZXQgaG9zdCJ9XQ==">
    <div data-prop-text="title">From calling app to target host</div>
    <ul>
      <li>DNS time to resolve the target hostname</li>
      <li>Time to establish a new TCP connection with the target host (TCP 3-way handshake plus SSL negotiation, if SSL is in use)</li>
      <li>Time spent in the HTTP client library to prepare and serialize the HTTP request</li>
      <li>Network latency to send the request across the wire to the target host</li>
    </ul>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicmVjZWl2aW5nIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJSZWNlaXZpbmcgaG9zdCJ9XQ==">
    <div data-prop-text="title">Receiving host</div>
    <ul>
      <li>
        <p>Time for the front-end web server on the receiving host to process the request and send it to the back-end web server on the receiving host</p>
      </li>
      <li>
        <p>Time for the request to be parsed in the back-end web server on the receiving host</p>
      </li>
      <li>
        <p>Time for the request to "percolate" through Rack middlewares on the receiving host</p>
      </li>
      <li>
        <p>Time for the web framework to route the request to the appropriate controller action</p>
        <p>Once the web framework has routed it to the appropriate controller action, this is where the internal measurement happens. Then:</p>
      </li>
      <li>
        <p>Time for the request to "percolate" back up through the Rack middlewares</p>
      </li>
      <li>
        <p>Network latency to write the response back to the requesting server</p>
      </li>
      <li>
        <p>Time on the requesting host for the HTTP response to be parsed by the HTTP client library</p>
      </li>
    </ul>
  </div>
</div>
<p>Some of these components are easier to control than others. For example, to capture timings for the <strong>Receiving host</strong> items above, make sure you have <a href="/docs/features/configuring-request-queue-reporting">request queue monitoring</a> set up on the receiving application.</p>
<h2>Get distributed tracing [#distributed-tracing]</h2>
<p>New Relic also offers <a href="/docs/apm/distributed-tracing/getting-started/introduction-distributed-tracing">distributed tracing</a>. Distributed tracing is an improvement on cross application tracing and is recommended for large, distributed systems.</p>
