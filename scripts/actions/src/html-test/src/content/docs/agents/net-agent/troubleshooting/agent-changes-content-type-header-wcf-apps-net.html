
<h2>Problem</h2>
<p>With the .NET agent enabled for a Windows Communication Foundation (WCF) application, the response header <code>Content-Type</code> is unexpectedly changed to <code>application/xml</code>.</p>
<h2>Solution</h2>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p><strong>Basic solutions</strong></p>
      </div>
      <div>
        <p><strong>Comments</strong></p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Disable the Cross Application Tracing (CAT) feature.</p>
      </div>
      <div>
        <p>Read about how to <a href="https://docs.newrelic.com/docs/agents/net-agent/configuration/net-agent-configuration#cross_application_tracer">change the CAT configuration</a>.</p>
        <p>If you need CAT to remain enabled, see the other solutions.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Use the Distributed Tracing (DT) feature instead of CAT.</p>
      </div>
      <div>
        <p>Read about how to <a href="https://docs.newrelic.com/docs/agents/net-agent/configuration/net-agent-configuration#distributed_tracing">enable the DT configuration</a>.</p>
        <p>DT is a new and improved way to accomplish tracing and has enhanced features, compared to CAT, in the New Relic UI.</p>
        <p>DT doesn't require modifications to response headers and won't be affected by changing response headers.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Add your desired <code>Content-Type</code> header to both the message and <code>OperationContext</code>.</p>
      </div>
      <div>
        <p>This solution requires you to modify your application code.</p>
      </div>
    </div>
  </div>
</div>
<h2>Cause</h2>
<p>The Cross Application Tracing (CAT) feature is enabled by default in the .NET agent. CAT works by adding headers to both request messages and response messages.</p>
<p>This is what happens in the Agent:</p>
<ol>
  <li>The WCF service method implementation executes.</li>
  <li>The agent will attempt to add CAT headers to the WCF response by adding an <code>HttpResponseMessageProperty</code> instance, with the CAT headers, to <code>OperationContext.Current.OutgoingMessageProperties</code>.</li>
  <li>The custom <code>DispatchMessageFormatter</code> executes and creates a new message where the expected <code>Content-Type</code> header is added directly to the new message.</li>
  <li>Microsoftâ€™s WCF implementation will attempt to merge the message properties defined in the response message with the message properties defined in the <code>OperationContext</code>. See this <a href="https://referencesource.microsoft.com/#System.ServiceModel/System/ServiceModel/Dispatcher/ImmutableDispatchRuntime.cs,725">Microsoft reference on ImmutableDispatchRuntime.cs</a> for more details.</li>
  <li>The <code>HttpResponseMessageProperty</code> doesn't support merging, so the value defined in the <code>OperationContext</code> is used instead of the value defined in the message.</li>
  <li>As a result, the <code>Content-Type</code> header that was originally added to the formatted message is thrown away, and the default <code>Content-Type</code> header is used.</li>
</ol>
<p>Since the agent must support multiple WCF Bindings, it needs to add our CAT headers to the <code>OperationContext</code>.</p>
