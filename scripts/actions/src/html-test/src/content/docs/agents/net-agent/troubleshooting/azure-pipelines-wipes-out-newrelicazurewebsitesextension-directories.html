
<h2>Problem</h2>
<p>For Azure web apps using the <code>NewRelic.Azure.WebSites.Extension</code>, and deployed with Azure Pipelines, the <code>newrelic</code> directories are deleted, so no instrumentation occurs. Further attempts to deploy using the Azure Pipeline indicate that the <code>NewRelic.Azure.WebSites.Extension</code> is already installed, so the extension cannot be re-installed using the Azure Pipeline.</p>
<h2>Solution</h2>
<p>To control <code>newrelic</code> folder retention, use the following options for WebDeploy:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p><strong>Basic solutions</strong></p>
      </div>
      <div>
        <p><strong>Comments</strong></p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Enable <code>skipAction=Delete</code> WebDeploy arguments.</p>
      </div>
      <div>
        <p>Explicitly exclude specific folders from deletion, such as the <code>newrelic</code> folders, with the following:</p>
        <p>Azure Pipelines UI:</p>
        <p>Add these arguments to the <strong>Azure App Service deploy -> Additional Deployment Options -> Additional Arguments</strong></p>
        <p><code>-skip:skipAction=Delete,objectName=dirPath,absolutePath='newrelic$' -skip:skipAction=Delete,objectName=dirPath,absolutePath='newrelic_core$'</code></p>
        <p>OR</p>
        <p>Pipeline.yml file:</p>
        <p>add the following <code>input</code> to the WebDeploy task:</p>
        <p><code>AdditionalArguments: '-skip:skipAction=Delete,objectName=dirPath,absolutePath=''newrelic$'' -skip:skipAction=Delete,objectName=dirPath,absolutePath=''newrelic_core$'''</code></p>
        <p>Note the escaped single quotes.</p>
      </div>
    </div>
  </div>
</div>
<p>[scald=13736:sdl_editor_representation]</p>
<h2>Cause</h2>
<p>If the <code>Remove additional files at destination</code> option is selected for the <code>AzureRmWebAppDeployment</code> task in the Azure Pipeline, the <code>newrelic</code> and <code>newrelic_core</code> directories are deleted from <code>wwwroot</code>, but the extension is not considered uninstalled by Azure. As a result, the next time the pipeline runs and attempts to install the extension, the pipeline displays the message <code>Extension 'NewRelic.Azure.WebSites.Extension' already installed.</code> The extension cannot run without its folders, and Azure will not re-install it because it considers it still installed.</p>
