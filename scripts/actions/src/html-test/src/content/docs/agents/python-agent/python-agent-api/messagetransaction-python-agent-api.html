
<h2>Syntax</h2>
<pre><code>newrelic.agent.message_transaction(library, destination_type, destination_name, application, routing_key=None, exchange_type=None, headers=None, queue_name=None, reply_to=None, correlation_id=None)
</code></pre>
<p>Report message functions as transactions.</p>
<h2>Requirements</h2>
<p>Agent version 2.88.0.72 or higher.</p>
<h2>Description</h2>
<p>This decorator returns a <a href="https://docs.python.org/3.6/library/functools.html#functools.partial">partial</a> of <code>MessageTransactionWrapper</code> that can be used as a decorator for a messaging function. When used, the returned decorator records a message transaction and its message-related <a href="/docs/accounts-partnerships/education/getting-started-new-relic/glossary#attribute">attributes</a>.</p>
<p>If the decorator will not work in your application, you can use one of the following:</p>
<ul>
  <li><strong>The context manager</strong>: The context manager form is <code>MessageTransaction</code>. It takes the same parameters as the decorator.</li>
  <li><strong>The wrapper</strong>: The wrapper form is <code>MessageTransactionWrapper</code>. It can be used to return a wrapped function without the use of a decorator.</li>
  <li><strong>The path-based wrapper</strong>: The path-based wrapper form is <code>wrap_message_transaction</code>. This applies the <code>MessageTransactionWrapper</code> to a given object through monkey patching. This takes the same parameters as the decorator plus an additional <code>module</code> and <code>object_path</code> parameter.</li>
</ul>
<p>For an explanation of when these different calls should be used, see <a href="/docs/python-agent-api-different-call-forms">Different call formats</a>. See <a href="#examples">Examples</a> for call examples.</p>
<h2>Parameters</h2>
<h3>Parameters for message_transaction and MessageTransaction [#decorator-context-mgr-parameters]</h3>
<pre><code>newrelic.agent.message_transaction(library, destination_type, destination_name, application, routing_key=None, exchange_type=None, headers=None, queue_name=None, reply_to=None, correlation_id=None)
</code></pre>
<pre><code>newrelic.agent.MessageTransaction(library, destination_type, destination_name, application, routing_key=None, exchange_type=None, headers=None, queue_name=None, reply_to=None, correlation_id=None)
</code></pre>
<p>The decorator and context manager use these parameters:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Parameter</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>library</code></p>
        <p><em>string</em> or <em>function</em></p>
      </div>
      <div>
        <p>Required. The name (or type) of message broker in use. Pass either a string which defines it or a function which returns it.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>destination_type</code></p>
        <p><em>string</em> or <em>function</em></p>
      </div>
      <div>
        <p>Required. The type of destination targeted by the operation. Pass either a string which defines it or a function which returns it. This is typically <code>Exchange</code> or <code>Queue</code>.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>destination_name</code></p>
        <p><em>string</em> or <em>function</em></p>
      </div>
      <div>
        <p>Required. The name of the destination being targeted by the operation. Pass either a string which defines it or a function which returns it.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>application</code></p>
        <p><em>Application</em></p>
      </div>
      <div>
        <p>Required. An application instance, as returned by <a href="/docs/agents/python-agent/python-agent-api/application"><code>application</code></a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>routing_key</code></p>
        <p><em>string</em> or <em>function</em></p>
      </div>
      <div>
        <p>Optional. The routing key of the message.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>exchange_type</code></p>
        <p><em>string</em> or <em>function</em></p>
      </div>
      <div>
        <p>Optional. The exchange type of the message.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>headers</code></p>
        <p><em>dictionary</em> or <em>function</em></p>
      </div>
      <div>
        <p>Optional. The headers of the message.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>queue_name</code></p>
        <p><em>string</em> or <em>function</em></p>
      </div>
      <div>
        <p>Optional. The queue name property of the message.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>reply_to</code></p>
        <p><em>string</em> or <em>function</em></p>
      </div>
      <div>
        <p>Optional. The <code>replyTo</code> property of the message.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>correlation_id</code></p>
        <p><em>string</em> or <em>function</em></p>
      </div>
      <div>
        <p>Optional. The <code>correlationID</code> property of the message.</p>
      </div>
    </div>
  </div>
</div>
<h3>Parameters for MessageTransactionWrapper [#wrapper-parameters]</h3>
<pre><code>newrelic.agent.MessageTransactionWrapper(wrapped, library, destination_type, destination_name, application, routing_key=None, exchange_type=None, headers=None, queue_name=None, reply_to=None, correlation_id=None)
</code></pre>
<p>The <code>MessageTransactionWrapper</code> takes all of the same parameters as the <a href="#decorator-context-mgr-parameters">decorator</a> in addition to this <code>wrapped</code> parameter:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Parameter</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>wrapped</code></p>
        <p><em>function</em></p>
      </div>
      <div>
        <p>Required. The messaging function to attribute to the message broker time.</p>
      </div>
    </div>
  </div>
</div>
<h3>Parameters for wrap_message_transaction [#path-based-parameters]</h3>
<pre><code>newrelic.agent.wrap_message_transaction(module, object_path, library, destination_type, destination_name, application, routing_key=None, exchange_type=None, headers=None, queue_name=None, reply_to=None, correlation_id=None)
</code></pre>
<p>This takes all of the parameters that the <a href="#decorator-context-mgr-parameters">decorator</a> does in addition to a <code>module</code> parameter and an <code>object_path</code> parameter:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Parameter</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>module</code></p>
        <p><em>object</em></p>
      </div>
      <div>
        <p>Required. The module containing the object to be wrapped.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>object_path</code></p>
        <p><em>string</em></p>
      </div>
      <div>
        <p>Required. The path to the object to be wrapped.</p>
      </div>
    </div>
  </div>
</div>
<h2>Return values</h2>
<p>The decorator <code>message_transaction</code> returns a <code>MessageTransactionWrapper</code> partial.</p>
<h2>Examples</h2>
<h3>message_transaction example [#decorator-example]</h3>
<p>An example of the decorator:</p>
<pre><code>mt = message_transaction('library', 'Exchange', 'x', routing_key='foo.bar')

@mt
def foo():
    pass
</code></pre>
<h3>MessageTransaction example [#context-mgr-example]</h3>
<p>An example using the context manager:</p>
<pre><code>def callback(method, properties, body):
    with MessageTransaction('library', 'Exchange', 'x', application=app):
        pass
</code></pre>
<h3>MessageTransactionWrapper example [#wrapper-example]</h3>
<p>An example using the wrapper:</p>
<pre><code>basic_consume_wrapper = newrelic.agent.MessageTransactionWrapper(basic_consume_register_callback, 'library', 'Queue', 'x')

method_frame, header_frame, body = basic_consume_wrapper('queue')
</code></pre>
<h3>wrap_message_transaction example [#path-based-example]</h3>
<p>An example using the path-based wrapper:</p>
<pre><code>wrap_message_transaction('module', 'Foo.bar', 'library', 'Exchange', 'x')
</code></pre>
