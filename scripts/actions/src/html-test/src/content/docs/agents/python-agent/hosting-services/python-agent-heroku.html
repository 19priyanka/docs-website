
<p><a href="https://devcenter.heroku.com/articles/newrelic">Heroku</a> is a Platform as a Service (PaaS) solution for hosting web applications in various agent languages, including Python. With the agent, you can extend Heroku with metrics from New Relic One.</p>
<p>This document describes special considerations for using Heroku as a hosting service with Python agent.</p>
<h2>Contents [#qiklinks]</h2>
<h2>Install the New Relic add-on [#installing]</h2>
<p>After deploying your Python app on Heroku, install the Python agent:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidmlhX2hlcm9rdSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiVmlhIHRoZSBIZXJva3Ugd2Vic2l0ZSJ9XQ==">
    <div data-prop-text="title">Via the Heroku website</div>
    <p>To install the New Relic add-on through the Heroku website, you must be logged in to Heroku:</p>
    <ol>
      <li>
        <p>From <a href="https://addons.heroku.com/newrelic">Heroku's Add-on page for New Relic</a>, select a subscription plan.</p>
      </li>
      <li>
        <p>From <strong>Select an app</strong>, select your New Relic app.</p>
      </li>
      <li>
        <p>Give your application a <a href="/docs/apm/new-relic-apm/installation-configuration/name-your-application">descriptive name</a> with this Heroku toolbelt command:</p>
        <pre><code>heroku config:set NEW_RELIC_APP_NAME='Your Application Name'
</code></pre>
      </li>
      <li>
        <p>Restart your dyno.</p>
      </li>
      <li>
        <p>Generate some traffic to your app.</p>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidmlhX3Rvb2xiZWx0In0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJWaWEgSGVyb2t1IHRvb2xiZWx0In1d">
    <div data-prop-text="title">Via Heroku toolbelt</div>
    <p>To install the Python agent add-on with Heroku the toolbelt:</p>
    <ol>
      <li>
        <p>Run the following command, where <code>$planlevel</code> is the <a href="https://addons.heroku.com/newrelic#plan_selector">appropriate subscription plan</a>:</p>
        <pre><code>heroku addons:create newrelic:$planlevel
</code></pre>
      </li>
      <li>
        <p>Give your application a <a href="/docs/apm/new-relic-apm/installation-configuration/name-your-application">descriptive name</a> with this toolbelt command:</p>
        <pre><code>heroku config:set NEW_RELIC_APP_NAME='Your Application Name'
</code></pre>
      </li>
      <li>
        <p>Restart your dyno.</p>
      </li>
      <li>
        <p>Generate some traffic to your app.</p>
      </li>
    </ol>
  </div>
</div>
<p>Installing the add-on automatically creates a private New Relic account and configures access for Heroku hosts. The agent will begin monitoring application performance, end user experience, and host performance collected after the add-on is installed. Within a few minutes, data should start appearing in your <a href="/docs/apm/applications-menu/monitoring/apm-overview-page">APM Summary page</a>.</p>
<h2>Upgrade from an existing agent installation [#upgrading]</h2>
<p>If an agent is already installed, reinstall the add-on using the Heroku toolbelt command.</p>
<pre><code>heroku config:set NEW_RELIC_APP_NAME='Your Application Name'
</code></pre>
<h2>Install the Python agent [#installing-the-python-agent]</h2>
<p>To install a third party Python package such as our Python agent on Heroku, use <strong>pip</strong>. Heroku automatically looks for a <strong>requirements.txt</strong> file in the root directory of your project. It installs anything listed in that file when you push your project to Heroku.</p>
<ol>
  <li>
    <p>Create or edit the <strong>requirements.txt</strong> file, adding the line:</p>
    <pre><code>newrelic
</code></pre>
  </li>
  <li>
    <p><strong>Django users:</strong> Modify the <strong>web</strong> entry of your Procfile, prefixing the value with <code>newrelic-admin run-program</code>. For example:</p>
    <pre><code>web: newrelic-admin run-program gunicorn mysite.wsgi
</code></pre>
  </li>
  <li>
    <p>Push your project up to Heroku.</p>
  </li>
</ol>
<p>This will install the the Python agent package with the latest version listed on the Python Package Index (PyPi).</p>
<h2>Update the Python agent [#updating-the-python-agent]</h2>
<p>Heroku caches packages and does not detect when a newer version of the Python agent is available. To force an upgrade:</p>
<ol>
  <li>
    <p>Edit the <strong>requirements.txt</strong> file by including the specific Python agent version (<code>n.n.n.n</code>) with the package name:</p>
    <pre><code>newrelic==n.n.n.n
</code></pre>
  </li>
  <li>
    <p>Push your project up to Heroku.</p>
  </li>
</ol>
<h2>Verify the New Relic add-on [#verify-new-relic-add-on]</h2>
<p>To verify that the New Relic add-on has been enabled, run:</p>
<pre><code>heroku run env | grep NEW_RELIC
</code></pre>
<p>This generates a list of New Relic-specific environment variables in Heroku. The Python agent uses these to determine which New Relic account and application data to use for reporting data.</p>
<p>At a minimum, you should see:</p>
<pre><code>NEW_RELIC_LOG=stdout
NEW_RELIC_LICENSE_KEY=0000000000000000000000000000000000000000
NEW_RELIC_APP_NAME=Your app name
</code></pre>
<p>The <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">license key</a> is unique to your New Relic account.</p>
<h2>Troubleshoot your installation [#troubleshooting]</h2>
<p>Within a few minutes of installing and configuring the agent, data should start appearing in your app's APM <a href="/docs/apm/applications-menu/monitoring/apm-overview-page">Summary page</a>. If no data appears, test that environment variables are being detected properly by running:</p>
<pre><code>heroku run newrelic-admin validate-config - stdout
</code></pre>
<p>This will create a connection and report test transaction data under the application <strong>Python Agent Test</strong>. Capture the output from running the test, and use the data to troubleshoot the issue. If you need further assistance, follow the <a href="/docs/agents/python-agent/troubleshooting/no-data-appears-python">Python agent troubleshooting procedures</a>.</p>
<h2>Initialize the Python agent [#initializing-the-python-agent]</h2>
<p>To initialize the Python agent:</p>
<ol>
  <li>From the root of your project, find the <strong>Procfile</strong>.</li>
  <li>Modify the <code>web</code> entry in your <strong>Procfile</strong> to define what to do to start up your Python web application.</li>
  <li>Refer to the following examples to insert <code>newrelic-admin run-program</code> at the start of the command.</li>
  <li>Run your Python web application under the control of the the Python agent's admin script.</li>
</ol>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Hosting mechanism</p>
      </div>
      <div>
        <p>Example web entry</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Flask with the built-in development host</p>
      </div>
      <div>
        <pre><code>web: newrelic-admin run-program python hello.py

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Flask with gunicorn</p>
      </div>
      <div>
        <pre><code>web: newrelic-admin run-program gunicorn -b "0.0.0.0:$PORT" -w 3 hello:app

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Django with gunicorn listed in <code>INSTALLED_APPS</code></p>
      </div>
      <div>
        <pre><code>web: newrelic-admin run-program python hellodjango/manage.py run_gunicorn -b "0.0.0.0:$PORT" -w 3

</code></pre>
      </div>
    </div>
  </div>
</div>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJjYXV0aW9uIn1d">
  <p>Avoid using the built-in development hosts of any web framework prior to Python version 2.7.4 or prior to Django 1.4. Instead, use <strong>gunicorn</strong> or <strong>uWSGI</strong>.</p>
  <p>The WSGI host using the <strong>wsgiref</strong> module was not fully WSGI compliant for development hosts prior to Python version 2.7.4. This prevented the Python agent from being able to report correct data.</p>
</div>
<h2>WSGI application wrapping [#wrapping-the-wsgi-application]</h2>
<p>The agent provides automatic wrapping of the the WSGI application point for these web frameworks:</p>
<ul>
  <li>Bottle</li>
  <li>Django</li>
  <li>Flask</li>
</ul>
<p>If you are using any of these Python web frameworks, no additional steps are required.</p>
<p>For others, you must modify the Python code file with your WSGI application entry point to wrap the WSGI application object with a WSGI application wrapper. This will initiate the timing for the web requests received by your application.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If the entry point is this...</p>
      </div>
      <div>
        <p>Do this...</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Entry point is a function</p>
      </div>
      <div>
        <p>Wrap it in a decorator:</p>
        <pre><code>import newrelic.agent

  @newrelic.agent.wsgi_application()
  def application(environ, start_response):
    ...

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Entry point is a function or object imported from a different module</p>
      </div>
      <div>
        <p>Wrap it in <code>pre</code> decorator style:</p>
        <pre><code>import myapp
  application = myapp.WSGIHandler()
  application = newrelic.agent.WSGIApplicationWrapper(application)

</code></pre>
      </div>
    </div>
  </div>
</div>
<h2>Track Celery tasks [#tracking-of-celery-tasks]</h2>
<p>To record execution time for Celery tasks as background tasks against your web application, wrap the startup of the Celery host with the <code>newrelic-admin</code> command.</p>
<p>Prefix the existing startup command defined by the <code>worker</code> entry in your <strong>Procfile</strong>:</p>
<pre><code>worker: newrelic-admin run-program python hellodjango/manage.py celeryd -E -B --loglevel=INFO
</code></pre>
<h2>Debug the Python agent [#debugging-the-python-agent]</h2>
<p>To begin debugging, collect the log output from the Python agent. Heroku sends Python agent output to standard output and captures it in the web server log.</p>
<p>To get access to the web server log for Heroku, run:</p>
<pre><code>heroku logs
</code></pre>
<p>By default the Python agent will log at <code>info</code> level. If New Relic Support requests an alternate level of logging, you must manually add a config variable. For example, to set logging output to <code>debug</code>, run:</p>
<pre><code>heroku config:add NEW_RELIC_LOG_LEVEL=debug
</code></pre>
<p>Your application automatically restarts when you change the log level.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJjYXV0aW9uIn1d">
  <p>The <code>debug</code> log level produces large quantities of output. Be sure to remove this setting as soon as it is no longer required, by running:</p>
  <pre><code>heroku config:remove NEW_RELIC_LOG_LEVEL
</code></pre>
</div>
<h2>Edit the agent configuration file [#agent-configuration-file]</h2>
<p>When using Heroku's add-on with New Relic, this automatically sets key environment variables for the Python agent. You can also customize additional settings with the agent configuration file, or use <a href="/docs/agents/python-agent/installation-configuration/python-agent-configuration#options">server-side configuration</a>.</p>
<p>Do not add core settings such as the license key, application name, etc. to the configuration file. Heroku automatically adds these settings.</p>
<p>To customize other settings, use the Python agent configuration file with Heroku:</p>
<ol>
  <li>
    <p>Add the <strong>newrelic.ini</strong> agent configuration file to the root directory of your project repository that you are pushing up to Heroku: In the <code>[newrelic]</code> section, include the specific configuration setting; for example:</p>
    <pre><code>[newrelic]
transaction_tracer.function_trace = mydbm:connect
</code></pre>
  </li>
  <li>
    <p>Commit the configuration file to your repository, and push the change up to Heroku.</p>
  </li>
  <li>
    <p>Use the <code>heroku config:add</code> command to set the <strong>NEW_RELIC_CONFIG_FILE</strong> environment variable for your deployed application:</p>
    <pre><code>heroku config:add NEW_RELIC_CONFIG_FILE=newrelic.ini
</code></pre>
  </li>
</ol>
<p>If you are using the <strong>newrelic-admin</strong> wrapper program to launch your WSGI host, the settings for your license key, application name, etc., will be picked up from the environment variables set by Heroku. Any additional settings you set in the agent configuration file will also be applied. Then, when the agent registers with New Relic, any server-side configuration will also be merged to create the final configuration the agent will use.</p>
<h2>For more help [#more_help]</h2>
<p>Additional documentation resources include:</p>
<ul>
  <li><a href="/docs/accounts-partnerships/partnerships/heroku-new-relic">Heroku and New Relic</a> (additional topics for Heroku users)</li>
  <li><a href="//devcenter.heroku.com/articles/newrelic">Heroku Dev Center</a> (information on the Heroku site on installing New Relic)</li>
</ul>
