
<p>With New Relic's <a href="/docs/agents/nodejs-agent/getting-started/introduction-new-relic-nodejs">Node.js agent</a>, you can monitor applications that reside in the <a href="https://cloud.google.com/appengine/docs/flexible/nodejs/">Google App Engine (GAE) flexible environment</a>. Adding New Relic to your GAE flex app gives you insight into the health and performance of your app and extends GAE with metrics you can view in <a href="/docs/apm/new-relic-apm/getting-started/introduction-new-relic-apm">APM</a> and <a href="/docs/browser/new-relic-browser/getting-started/introduction-new-relic-browser">browser monitoring</a>.</p>
<p>This document explains how to add New Relic to your GAE flex app using either of these methods:</p>
<ul>
  <li>Google App Engine's <a href="/docs/accounts-partnerships/partnerships/google-cloud-platform-gcp/google-app-engine-environment#native-mode">"native mode"</a> installation with a standard GAE runtime</li>
  <li>Docker installation using a <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/about-custom-runtimes">custom runtime</a></li>
</ul>
<h2>Use native deploy [#native-mode]</h2>
<p>To use Google App Engine's <a href="/docs/accounts-partnerships/partnerships/google-cloud-platform-gcp/google-app-engine-environment#native-mode">"native mode"</a> installation with your Node.js app:</p>
<ol>
  <li>
    <p>Follow standard procedures to <a href="/docs/agents/nodejs-agent/installation-configuration/install-nodejs-agent">install New Relic's Node.js agent</a>, including your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">license key</a>. Be sure to save the <code>newrelic</code> module to the <code>package.json</code> file.</p>
  </li>
  <li>
    <p>Follow <a href="https://cloud.google.com/appengine/docs/flexible/nodejs/quickstart">Google App Engine procedures for Node.js</a> to create a new Cloud Platform project, create an App Engine application, and complete other prerequisites for the <a href="https://cloud.google.com/sdk/gcloud/">Google Cloud SDK</a>.</p>
  </li>
  <li>
    <p>Optional: Set environment variables to configure the Node.js agent's <a href="https://cloud.google.com/appengine/docs/flexible/nodejs/configuring-your-app-with-app-yaml">GAE <code>app.yaml</code> file</a>.</p>
  </li>
  <li>
    <p>Use the Google Cloud SDK's <code>gcloud</code> command line tool to deploy GAE apps. To deploy your Node.js app to your <a href="https://cloud.google.com/sdk/docs/initializing">initialized GAE flexible environment</a>, run the following command:</p>
    <pre><code>gcloud --project new-relic-apm-nodejs app deploy
</code></pre>
  </li>
</ol>
<p>Google App Engine automatically includes your Node.js app's <code>newrelic.js</code> configuration file in the deployed package. Wait until the deployment completes, then view your GAE flex app data in the <a href="/docs/apm/applications-menu/monitoring/apm-overview-page">APM <strong>Summary</strong> page</a>.</p>
<h2>Build a custom runtime [#build-runtime]</h2>
<p>See <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/build">Google's documentation for building custom runtimes</a>. This example describes how to add New Relic to your GAE flex app by building a custom runtime for Docker. You can deploy the app without any special configuration.</p>
<p>For more information about deploying and configuring your Node.js app in the GAE flexible environment, see:</p>
<ul>
  <li><a href="https://cloud.google.com/appengine/docs/flexible/nodejs/">Google App Engine's documentation</a> for Node.js</li>
  <li><a href="https://cloud.google.com/community/tutorials/run-expressjs-on-google-app-engine">Google App Engine's tutorial</a> to deploy a Node.js app</li>
</ul>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic2V0dXAtZ2FlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIxLiBTZXQgdXAgdGhlIEdBRSBwcm9qZWN0IGFuZCBpbnN0YWxsIGRlcGVuZGVuY2llcyJ9XQ==">
    <div data-prop-text="title">1. Set up the GAE project and install dependencies</div>
    <ol>
      <li>
        <p>Follow standard procedures to <a href="/docs/agents/nodejs-agent/installation-configuration/install-nodejs-agent">install New Relic's Node.js agent</a>, including your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">license key</a>. Be sure to save the <code>newrelic</code> module to the <code>package.json</code> file.</p>
      </li>
      <li>
        <p>Follow <a href="https://cloud.google.com/appengine/docs/flexible/nodejs/quickstart">Google App Engine procedures for Node.js</a> to create a new Cloud Platform project, create an App Engine application, and complete other prerequisites for the <a href="https://cloud.google.com/sdk/gcloud/">Google Cloud SDK</a>.</p>
        <p>The Google Cloud SDK provides the <code>gcloud</code> command line tool to manage and deploy GAE apps.</p>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlndXJlLWFwcC15YW1sIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIyLiBDb25maWd1cmUgeW91ciBhcHAueWFtbCJ9XQ==">
    <div data-prop-text="title">2. Configure your app.yaml</div>
    <p>The <code>app.yaml</code> configuration file is required for a GAE flexible environment app with a custom runtime. At a minimum, make sure it contains:</p>
    <pre><code>runtime: custom
env: flex

</code></pre>Optional: Set environment variables.
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlndXJlLWRvY2tlcmZpbGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjMuIENvbmZpZ3VyZSBhbmQgZGVwbG95In1d">
    <div data-prop-text="title">3. Configure and deploy</div>
    <p>The <a href="http://docs.docker.com/engine/reference/builder/">Dockerfile</a> defines the Docker image to be built and is required for a GAE flexible environment app.</p>
    <ol>
      <li>To create the Dockerfile, build the container, and deploy your app, follow the <a href="https://cloud.google.com/appengine/docs/flexible/nodejs/run-flex-app-on-gke">GAE procedures for Node.js</a>.</li>
      <li>Wait until the deployment completes.</li>
      <li>To view your GAE flex app data in New Relic, go to the <a href="/docs/apm/applications-menu/monitoring/apm-overview-page">APM <strong>Summary</strong> page</a>.</li>
    </ol>
  </div>
</div>
<h2>Optional: Disable health checks [#health-checks]</h2>
<p>Google App Engine sends <a href="https://cloud.google.com/appengine/docs/flexible/go/configuring-your-app-with-app-yaml#health_checks">periodic health check requests</a> to confirm that an instance has been successfully deployed, and to check that a running instance maintains a healthy status. A health check is an HTTP request to the URL <code>/_ah/health</code>.</p>
<p>If you create a custom runtime, your app must be able to handle a large number of health check requests. Otherwise, your app data may not display correctly in New Relic APM.</p>
<p>If you notice performance issues, disable GAE health checks. In your <code>app.yaml</code>, add:</p>
<pre><code>health_check:
  enable_health_check: False
</code></pre>
<h2>Get New Relic agent troubleshooting logs from GAE [#agent-logs]</h2>
<p>Use these resources to troubleshoot your GAE flex environment app:</p>
<ul>
  <li>
    <p>To connect to the GAE instance and start a shell in the Docker container running your code, see <a href="https://cloud.google.com/appengine/docs/flexible/go/debugging-an-instance">Debugging an instance</a>.</p>
  </li>
  <li>
    <p>To redirect New Relic Node.js agent logs to <a href="http://cloud.google.com/logging/docs/view/logs_viewer_v2">Stackdriver</a> in the <a href="https://cloud.google.com/compute/docs/console">Cloud Platform Console</a>, change the <code>newrelic.js</code> configuration file to:</p>
    <pre><code>log_file_name: STDOUT
</code></pre>
  </li>
  <li>
    <p>To view the logs, use the <a href="https://cloud.google.com/appengine/docs/flexible/php/writing-application-logs">Cloud Platform Console's Log Viewer</a>.</p>
  </li>
</ul>
