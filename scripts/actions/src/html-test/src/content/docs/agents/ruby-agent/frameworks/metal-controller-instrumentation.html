
<p>By default, the New Relic Ruby agent does not instrument <code>ActionController::Metal</code> controllers. This is in keeping with the philosophy that the Metal controller provides only the bare minimum interface needed to deliver a valid Rack app. It's generally up to you to embellish the Metal Controllers as needed. This document describes how to have these controller actions appear on the <a href="/docs/apm/applications-menu/monitoring/transactions-page">APM <strong>Transactions</strong> page</a> and overviews alongside those inheriting from <code>ApplicationController</code> for Rails 3 apps or higher.</p>
<h2>Contents [#qiklinks]</h2>
<h2>Rails 4.0 or higher [#rails4]</h2>
<p>Starting with Rails 4.0, New Relic's controller instrumentation uses <code>ActiveSupport::Notifications</code>. Including the <code>ActionController::Instrumentation</code> module ensures that controller events are fired from your Metal controller. This enables New Relic to instrument those actions.</p>
<pre><code>class PlatinumController &#x3C; ActionController::Metal
  include ActionController::Rendering

  def show
    render :text => "Here is some text"
  end

  # Ensure ActiveSupport::Notifications events are fired
  include ActionController::Instrumentation
end
</code></pre>
<h2>Rails 3.0 through 3.2 [#rails3]</h2>
<h3>Method 1</h3>
<p>The following method auto-instruments all Metal controller actions just as with the Base Controller.</p>
<p>Include <code>NewRelic::Agent::Instrumentation::ControllerInstrumentation</code> and <code>NewRelic::Agent::Instrumentation::Rails3::ActionController</code> at the bottom of your Metal Controller classes:</p>
<pre><code>class SteelController &#x3C; ActionController::Metal
  include ActionController::Rendering

  def show
    render :text => "Here is some text"
  end

  include NewRelic::Agent::Instrumentation::ControllerInstrumentation
  include NewRelic::Agent::Instrumentation::Rails3::ActionController
end
</code></pre>
<h3>Method 2</h3>
<p>The following example enables you to opt in to tracing only specific action methods of the Metal controller.</p>
<p>Include <code>NewRelic::Agent::Instrumentation::ControllerInstrumentation</code> and call <code>add_transaction_tracer</code> for each method instrumentation:</p>
<pre><code>class SteelController &#x3C; ActionController::Metal
  include ActionController::Rendering
  include NewRelic::Agent::Instrumentation::ControllerInstrumentation

  def show
    render :text => "Here is some text"
  end
  add_transaction_tracer :show
end
</code></pre>
<h3>Method 3</h3>
<p>The final example is a more general way of adding tracing of the method that will work in any class, not just Metal Controller class.</p>
<p>Include <code>NewRelic::Agent::MethodTracer</code> and call <code>add_method_tracer</code> for each method instrumentation:</p>
<pre><code>class SteelController &#x3C; ActionController::Metal
  include ActionController::Rendering
  include NewRelic::Agent::MethodTracer

  def show
    render :text => "Here is some text"
  end
  add_method_tracer :show
end
</code></pre>
<h2>Rails 2.3 [#rails2]</h2>
<p>If you use the <code>Rails::Rack::Metal</code> class from Rails 2, you can instrument calls to your Metals as follows:</p>
<pre><code>require 'newrelic_rpm'

class MyMetal &#x3C; Rails::Rack::Metal
  def self.call(env)
    # ... your metal code ...
  end

  class &#x3C;&#x3C; self
    include NewRelic::Agent::Instrumentation::ControllerInstrumentation
    add_transaction_tracer :call
  end
end
</code></pre>
