
<h2>Problem</h2>
<p>You receive the error message <code>SystemStackError: stack level too deep</code> on the Error details page in your APM UI.</p>
<p>In addition, because of a bug in Ruby versions 2.1 and lower, you might receive only a one-line stack trace that points to the Ruby agent as the issue.</p>
<h2>Solution</h2>
<p>In most cases, the Ruby agent is not the underlying issue. The issue is that <code>alias_method</code> and <code>Module#prepend</code> work together only in particular situations and can cause non-terminating recursions when not used together properly.</p>
<ol>
  <li>
    <p>Upgrade to Ruby version 2.2 or higher to fix the one-line stack trace bug. Then, review the full stack trace to see if the Ruby agent is the issue.</p>
    <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
      <p>If you can't upgrade, refer to the URL included in the <code>SystemStackError</code> message to troubleshoot the issue or <a href="/docs/agents/ruby-agent/configuration/ruby-agent-configuration#disabling">disable the Ruby agent</a> to see if the problem disappears.</p>
    </div>
  </li>
  <li>
    <p>If the Ruby agent is not the cause of the error, look for evidence of non-terminating recursions including the following:</p>
    <ul>
      <li>You don't find <code>new_relic</code> near the top of the trace.</li>
      <li>You see repeating patterns in the trace.</li>
    </ul>
  </li>
  <li>
    <p>If you see evidence of a recursion, make sure that <code>alias_method</code> and <code>Module#prepend</code> are compatible with each other when used on the same method.</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYWN0aXZlcmVjb3JkNSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiV2hlbiB1c2VkIGluIEFjdGl2ZVJlY29yZCA1IGNvZGUifV0=">
        <div data-prop-text="title">When used in ActiveRecord 5 code</div>
        <p>Upgrade to Ruby agent version 3.17.2 or higher.</p>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibm90LWFjdGl2ZXJlY29yZDUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IldoZW4gdXNlZCBvdXRzaWRlIG9mIEFjdGl2ZVJlY29yZCA1IGNvZGUifV0=">
        <div data-prop-text="title">When used outside of ActiveRecord 5 code</div>
        <ul>
          <li>Verify that your app always calls <code>alias_method</code> before <code>Module#prepend</code> when used on the same method.</li>
          <li>Also, check to see if your app calls <code>Module#prepend</code> before the <strong>Ruby agent</strong> calls <code>alias_method</code> on the same method. If so, follow the recommendations in the New Relic blog post about <a href="https://blog.newrelic.com/2016/12/15/ruby-agent-module-prepend-alias-method-chains/">resolving <code>Module#prepend</code> and <code>alias_method</code> conflicts</a>.</li>
        </ul>
      </div>
    </div>
  </li>
</ol>
<h2>Cause</h2>
<p>When your app uses <code>Module#prepend</code> on a method that the Ruby agent later uses an <code>alias_method</code> on, it creates a non-terminating recursion and throws the <code>SystemStackError: stack level too deep</code> error.</p>
<p>If you upgraded to Rails 5, which deprecated <code>alias_method_chain</code>, you might have replaced <code>alias_method</code> with <code>Module#prepend</code>, and that could be the source of your issue.</p>
