
<p>The New Relic Java agent automatically collects data from <a href="https://kafka.apache.org/documentation/">Kafka</a>'s Java clients library. Because Kafka is a high-performance messaging system that generates a lot of data, you can customize the agent for your app's specific throughput and use cases.</p>
<p>This document explains how to collect and view three types of Kafka data:</p>
<ul>
  <li><a href="#view-kafka-metrics">Kafka metrics</a></li>
  <li><a href="#collect-kafka-events">Kafka events</a></li>
  <li><a href="#collect-kafka-distributed-traces">Kafka distributed traces</a></li>
</ul>
<p>Kafka instrumentation is available in Java agent versions 4.12.0 or higher. For supported Kafka client versions, see <a href="/docs/agents/java-agent/getting-started/compatibility-requirements-java-agent">Java compatibility and requirements</a>.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>For our Kafka integration, see <a href="/docs/integrations/host-integrations/host-integrations-list/kafka-monitoring-integration">Kafka monitoring integration</a>.</p>
</div>
<h2>View Kafka metrics</h2>
<p>After <a href="/docs/agents/java-agent/installation/install-java-agent">installation</a>, the agent automatically reports rich Kafka metrics with information about messaging rates, latency, lag, and more. The Java agent collects all <a href="https://kafka.apache.org/documentation/#monitoring">Kafka consumer and producer metrics</a> (but not connect or stream metrics).</p>
<p>To view these metrics, create a custom dashboard:</p>
<ol>
  <li>
    <p>Go to the <a href="/docs/insights/use-insights-ui/explore-data/metric-explorer-search-chart-metrics-sent-new-relic-agents">New Relic metric explorer</a>.</p>
  </li>
  <li>
    <p>Use the metric explorer to locate your metrics. You can find Kafka metrics in this metric folder:</p>
    <pre><code>MessageBroker/Kafka/Internal/KafkaMetricName
</code></pre>
    <p>For example, the <code>request-rate</code> metric is located at:</p>
    <pre><code>MessageBroker/Kafka/Internal/consumer-metrics/request-rate
</code></pre>
    <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
      <p>For a full list of Kafka consumer and producer metrics, see the <a href="https://kafka.apache.org/documentation/#monitoring">Kafka documentation</a>.</p>
    </div>
  </li>
  <li>
    <p>Add the metrics you want to monitor to a dashboard by clicking <strong>Add to dashboard</strong>.</p>
  </li>
</ol>
<h2>Enable Kafka event collection [#collect-kafka-events]</h2>
<p>You can configure the agent to collect event data instead of metric timeslice data (for the difference between metric timeslice and event data, see <a href="/docs/using-new-relic/metrics/analyze-your-metrics/data-collection-metric-timeslice-event-data#overview">data collection</a>). This allows you to use <a href="/docs/insights/nrql-new-relic-query-language/using-nrql/introduction-nrql">NRQL</a> to filter and facet the default Kafka metrics. When enabled, the agent collects one Kafka event every 30 seconds. This event contains all of the the data from <a href="https://kafka.apache.org/documentation/#monitoring">Kafka consumer and produce metrics</a> captured since the previous event.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>The agent records up to 2000 events per <a href="/docs/using-new-relic/welcome-new-relic/getting-started/glossary#harvest-cycle">harvest cycle</a>, though you can change this value with <a href="/docs/agents/java-agent/configuration/java-agent-configuration-config-file#ae-max_samples_stored"><code>max_samples_stored</code></a>. Kafka event data is included in this pool. If you use the <code>recordCustomEvent()</code> API call to send <a href="/docs/insights/insights-data-sources/custom-data/insert-custom-events-new-relic-apm-agents">custom events</a> to New Relic and you send more than 2000 events, the agent will discard some Kafka or custom events.</p>
</div>
<p>To enable Kafka event collection:</p>
<ol>
  <li>
    <p>Add the <code>kafka.metrics.as_events.enabled</code> element to your <code>newrelic.yml</code> config file:</p>
    <pre><code>kafka.metrics.as_events.enabled: true
</code></pre>
  </li>
  <li>
    <p>Restart your JVM.</p>
  </li>
  <li>
    <p>Use the <a href="/docs/insights/use-insights-ui/explore-data/event-explorer-query-chart-your-event-data">event explorer</a> to view your Kafka events, located in the <code>KafkaMetrics</code> event type. Or, use <a href="/docs/insights/nrql-new-relic-query-language/using-nrql/introduction-nrql">NRQL</a> to query your events directly. For example:</p>
    <pre><code>SELECT average('producer-metrics.record-send-rate') from KafkaMetrics SINCE 30 minutes ago timeseries
</code></pre>
  </li>
</ol>
<h2>Enable Kafka distributed traces [#collect-kafka-distributed-traces]</h2>
<p>The Java agent can also collect <a href="/docs/apm/distributed-tracing/getting-started/introduction-distributed-tracing">distributed traces</a> from Kafka clients. To collect distributed traces, you'll first need to enable the feature. Then, call the <a href="/docs/agents/java-agent/api-guides/guide-using-java-agent-api">Java agent API</a> to instrument transactions on both the producer and consumer side. The agent will still report metric or event data from Kafka with distributed tracing enabled.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJjYXV0aW9uIn1d">
  <p>Distributed tracing is only available for <strong>Kafka Clients 0.11.0.0 or higher</strong></p>
  <p>Test out Kafka distributed traces in a dev environment before you enable them in production. The instrumentation adds a 150 to 200 byte payload to the headers of each message. If your Kafka messages are very small, Kafka distributed traces can add significant processing and storage overhead. This additional payload size could cause Kafka to drop messages if they exceed your Kafka messaging size limit.</p>
</div>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>If you have not enabled distributed tracing for your app before, read the <a href="/docs/apm/distributed-tracing/getting-started/transition-guide-distributed-tracing">distributed tracing transition guide</a> before you enable it.</p>
</div>
<p>To collect distributed traces from Kafka:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZW5hYmxlLWR0LWthZmthIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIxLiBFbmFibGUgZGlzdHJpYnV0ZWQgdHJhY2luZyBpbiB0aGUgY29uZmlnIGZpbGUifV0=">
    <div data-prop-text="title">1. Enable distributed tracing in the config file</div>
    <p>If you have not enabled distributed tracing for your app before, read the <a href="/docs/apm/distributed-tracing/getting-started/transition-guide-distributed-tracing">distributed tracing transition guide</a> before you enable it.</p>
    <p>To enable Kafka distributed tracings, enable two settings in your <a href="/docs/agents/java-agent/configuration/java-agent-configuration-config-file#Structure"><code>newrelic.yml</code> config file</a>:</p>
    <ul>
      <li>
        <p>Set the <a href="/docs/agents/java-agent/configuration/java-agent-configuration-config-file#distributed-tracing"><code>distributed_tracing</code></a> element to <code>true</code>:</p>
        <pre><code>distributed_tracing:
  enabled: true
</code></pre>
      </li>
      <li>
        <p>Enable the Kafka-specific distributed tracing features by adding the following to your config file:</p>
        <pre><code>class_transformer:
  kafka-clients-spans:
    enabled: true
</code></pre>
      </li>
    </ul>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaW5zdHJ1bWVudC1rYWZrYS1wcm9kdWNlciJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiMi4gSW5zdHJ1bWVudCB0aGUgS2Fma2EgcHJvZHVjZXIifV0=">
    <div data-prop-text="title">2. Instrument the Kafka producer</div>
    <p>To instrument your Kafka producer, you'll need to start a transaction before any calls to <code>Producer.send(ProducerRecord&#x3C;K, V> record)</code>. To do this, add the Java agent <code>@Trace(dispatcher = true)</code> annotation to the method.</p>
    <p>For example:</p>
    <pre><code>@Trace(dispatcher = true)
public static void createAndSend(KafkaProducer&#x3C;String, String> producer){
    ProducerRecord&#x3C;String, String> data = new ProducerRecord&#x3C;String, String>("topic", "key", "value");
    producer.send(data);
}

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaW5zdHJ1bWVudC1rYWZrYS1jb25zdW1lciJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiMy4gSW5zdHJ1bWVudCB0aGUgS2Fma2EgY29uc3VtZXIifV0=">
    <div data-prop-text="title">3. Instrument the Kafka consumer</div>
    <p>To instrument your Kafka consumer, you'll need to start a transaction when the message is being processed. The agent stores the distributed tracing payload header under the <code>newrelic</code> key. Retrieve the header, then call the New Relic transaction API to accept the payload.</p>
    <p>For example:</p>
    <pre><code>@Trace(dispatcher = true)
private static void processMessage(ConsumerRecord&#x3C;String, String> rec){
    Iterable&#x3C;Header> headers = rec.headers().headers("newrelic");
    for(Header header: headers) {
        NewRelic.getAgent().getTransaction().acceptDistributedTracePayload(new String(header.value(), StandardCharsets.UTF_8));
    }
}

</code></pre>
  </div>
</div>
