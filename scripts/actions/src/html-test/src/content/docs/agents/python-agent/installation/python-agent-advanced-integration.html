
<p>This document gives more detail about the <strong>integration</strong> step of installing the Python agent.</p>
<p>For install instructions for the Python agent, see <a href="/docs/agents/python-agent/getting-started/python-agent-quick-start">Standard install</a>.</p>
<h2>Overview of integration procedure [#overview]</h2>
<p>After you install the Python agent package and create a config file, the Python agent must be integrated with your application. This step allows the agent to capture and report your application's important functions and web requests.</p>
<p>There are two integration methods:</p>
<ul>
  <li><a href="#wrapper-script">Running the admin script via command line</a>: This method is recommended because it is easy and doesn't require making changes to your app code.</li>
  <li><a href="#manual-integration">Manual integration</a>: If, for whatever reason, you cannot use the admin script method, you can manually initialize the Python agent in your app code.</li>
</ul>
<h2>Admin script integration method [#wrapper-script]</h2>
<p>For a simple explanation of how to use the admin script via the command line, see the <a href="/docs/agents/python-agent/installation-configuration/python-agent-installation#integration">integration section</a> of the advanced install instructions. Here are instructions with more details and context.</p>
<p>The <code>newrelic-admin</code> admin script prefixes the command you use to start your WSGI server or web app. This script works by wrapping your startup command and listening for certain function classes used by common frameworks. (To instrument functions and methods that are not instrumented by default, you would use <a href="/docs/agents/python-agent/custom-instrumentation/python-custom-instrumentation">custom instrumentation</a>.)</p>
<p>Here are examples of running the script:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Old command form</p>
      </div>
      <div>
        <p>New command form</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>YOUR_ORIGINAL_COMMAND_OPTIONS</code></p>
      </div>
      <div>
        <p><code>NEW_RELIC_CONFIG_FILE=newrelic.ini newrelic-admin run-program YOUR_ORIGINAL_COMMAND_OPTIONS</code></p>
      </div>
    </div>
    <div>
      <div>
        <p><code>VARIABLE=VALUE YOUR_ORIGINAL_COMMAND_OPTIONS</code></p>
      </div>
      <div>
        <p><code>NEW_RELIC_CONFIG_FILE=newrelic.ini VARIABLE=value newrelic-admin run-program YOUR_ORIGINAL_COMMAND_OPTIONS</code></p>
      </div>
    </div>
  </div>
</div>
<p>The following examples give instructions for a Bourne-style shell. You may need to adjust these instructions for a different shell.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZ3VuaWNvcm4ifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6Ikd1bmljb3JuIGV4YW1wbGUifV0=">
    <div data-prop-text="title">Gunicorn example</div>
    <p>If you're using Gunicorn (a popular Python web server) and your startup command is:</p>
    <pre><code>gunicorn -w 3 wsgi:application

</code></pre>
    <pre><code>
NEW_RELIC_CONFIG_FILE=newrelic.ini newrelic-admin run-program gunicorn -w 3 wsgi:application

</code></pre>Then your new agent-integrated command would be:
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZ3VuaWNvcm4ifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6InVXU0dJIHJ1biBkaXJlY3RseSBvbiBhIFdTR0kgYXBwbGljYXRpb24ifV0=">
    <div data-prop-text="title">uWSGI run directly on a WSGI application</div>
    <pre><code>newrelic-admin run-program uwsgi --socket /tmp/uwsgi.sock --single-interpreter --enable-threads wsgi.py

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZ3VuaWNvcm4ifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IlBhc3RlciBzZXJ2ZSJ9XQ==">
    <div data-prop-text="title">Paster serve</div>
    <p>Here's an example of running the admin script using paster serve on a WSGI app specified in a paster ini configuration file:</p>
    <pre><code>newrelic-admin run-program paster serve production.ini

</code></pre>
  </div>
</div>
<p>For framework-specific documentation on using the admin script, see <a href="/docs/agents/python-agent/web-frameworks-servers">Web frameworks and servers</a>.</p>
<p>Here are some advanced instructions for running the admin script:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibXVsdGktbGluZSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiU3BsaXR0aW5nIGFkbWluIHNjcmlwdCBjb21tYW5kIGFjcm9zcyBtdWx0aXBsZSBsaW5lcyJ9XQ==">
    <div data-prop-text="title">Splitting admin script command across multiple lines</div>
    <p>You can separately set and export the <code>NEW_RELIC_CONFIG_FILE</code> environment variable before running the script. Ensure you substitute your existing command options for <code>YOUR_COMMAND_OPTIONS</code>:</p>
    <pre><code>NEW_RELIC_CONFIG_FILE=newrelic.ini
export NEW_RELIC_CONFIG_FILE

newrelic-admin run-program YOUR_COMMAND_OPTIONS

</code></pre>
    <pre><code>
[program:warpdrive]
command = newrelic-admin run-program YOUR_COMMAND_OPTIONS
environment = NEW_RELIC_CONFIG_FILE=newrelic.ini

</code></pre>If you use a process management system such as **supervisord** where the environment variables must be set in a separate configuration setting, you cannot set them on the same line as the command.
    For example, under **supervisord** you might use this (ensure you substitute your existing command options for `YOUR_COMMAND_OPTIONS`):
    <pre><code>
NEW_RELIC_CONFIG_FILE=newrelic.ini
export NEW_RELIC_CONFIG_FILE

exec newrelic-admin run-program YOUR_COMMAND_OPTIONS

</code></pre>If your startup command uses `exec`, separate the setting of the environment variable from the execution of the admin script. Ensure you substitute your existing command options for `YOUR_COMMAND_OPTIONS`:
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicnVuLXByb2dyYW0ifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IlJ1bm5pbmcgYWRtaW4gc2NyaXB0IHdpdGggUHl0aG9uIGV4ZWN1dGFibGUifV0=">
    <div data-prop-text="title">Running admin script with Python executable</div>
    <p>If the command being run is the <code>python</code> executable and it is being run directly on a Python code file as <code>python main.py</code>, use either of the following:</p>
    <pre><code>newrelic-admin run-program python main.py

newrelic-admin run-python main.py

</code></pre>Using `run-python` will always use the same `python` executable as is installed in the Python installation or virtual environment that **newrelic-admin** is installed.
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibG9jYXRpb24tYWRtaW4ifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6Ik5vdGVzIGFib3V0IHRoZSBsb2NhdGlvbiBvZiBuZXdyZWxpYy1hZG1pbiJ9XQ==">
    <div data-prop-text="title">Notes about the location of newrelic-admin</div>
    <p>The <strong>newrelic-admin</strong> program you run must be coming from the same Python installation or virtual environment as your application is using. You cannot mix programs/components from different Python installations. If this is done, the agent will not run correctly.</p>
    <p>If you use a process management system such as <strong>supervisord</strong> in a virtual environment, you could use this configuration:</p>
    <pre><code>[program:warpdrive]
command = newrelic-admin run-program  
environment = PATH="/path/to/python/app/venv/bin",NEW_RELIC_CONFIG_FILE="newrelic.ini"
directory = /path/to/python/app
user = www-data

</code></pre>Note the `PATH` environment variable that points to the same path that would be used by the virtual environment.
    For more information on these options to **newrelic-admin** and the different configuration options based on user environment variables, see the more detailed documentation for the `run-program` and `run-python` options.
  </div>
</div>
<p>For more information on using the admin script, see <a href="/docs/agents/python-agent/installation-configuration/python-agent-admin-script">Admin script details</a>.</p>
<h2>Manual integration in app code [#manual-integration]</h2>
<p>If you cannot use the recommended <a href="#wrapper-script">admin script integration</a> method or don't wish to, you must initialize the Python agent manually in your web app code. This process involves importing a Python agent package into your app and making a call to initialize the agent. This call modifies your app's import mechanism so that when libraries are imported, the agent listens for the function classes it recognizes.</p>
<p>For manual integration, add the following to the beginning of the application script file or module that holds your WSGI entry point.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Unlike standard Python functionality, the import order matters: the agent package must be imported first.</p>
</div>
<pre><code>import newrelic.agent
newrelic.agent.initialize('/some/path/newrelic.ini')
... YOUR_OTHER_IMPORTS
</code></pre>
<p>In this example, /some/path/newrelic.ini represents the location of the copy of the config file created during <a href="/docs/agents/python-agent/getting-started/python-agent-quick-start">Python agent installation</a>. The config file must be readable by your web application.</p>
<p>For more on deployment environment overrides, select the following dropdown:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZW52aXJvbm1lbnQtb3ZlcnJpZGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkRlcGxveW1lbnQgZW52aXJvbm1lbnQgb3ZlcnJpZGVzIn1d">
    <div data-prop-text="title">Deployment environment overrides</div>
    <p>To specify an override in the agent config file corresponding to a specific deployment environment, the name of that environment should be supplied as the second argument to the <a href="/docs/agents/python-agent/python-agent-api/initialize"><code>initialize()</code> function</a>:</p>
    <pre><code>import newrelic.agent
newrelic.agent.initialize('/some/path/newrelic.ini', 'staging')

</code></pre>Alternatively, you can set the `NEW_RELIC_LICENSE_KEY` and `NEW_RELIC_APP_NAME` environment variables if the defaults for all other configuration settings are suitable.
    Do note however that when using an embedded environment, such as Apache/mod_wsgi, you generally cannot rely on being able to derive configuration from environment variables. This is because in embedded systems, more often than not, you don't have a way of being able to set process environment variables which are in turn available to the WSGI script file.
    For additional details see the documentation for the [initialize()](/docs/python/python-management-api#initialize) function.
    <pre><code>
import newrelic.agent
newrelic.agent.initialize()

</code></pre>If you have installed the Python package into a Python virtual environment, the above lines must be added after you activated or otherwise have setup **sys.path** to find your virtual environment.
    The above should, whenever possible, precede any imports for modules which are going to be instrumented. For some web frameworks, including Flask, this is mandatory. The instrumentation will not work correctly if not placed before all imports which cause code from that framework to be imported.
    If you do not use the admin script, but still wish to use the environment variables `NEW_RELIC_CONFIG_FILE` and `NEW_RELIC_ENVIRONMENT` to configure the agent, you can call the `initialize()` function with no arguments and they will be automatically consulted.
  </div>
</div>
<h2>Unsupported web frameworks [#wsgi-application]</h2>
<p>If you are using an unsupported web framework or are constructing a WSGI application using a WSGI component library such as Werkzeug or Paste, you may also need to manually wrap the WSGI application entry point. This would be in addition to doing one of the main integration methods (<a href="#wrapper-script">using the admin script</a>, or <a href="#manual-integration">manually initializing the Python agent</a>).</p>
<p>If the WSGI application entry point is a function declared in the file itself, use a decorator:</p>
<pre><code>@newrelic.agent.wsgi_application()
def application(environ, start_response):
...
</code></pre>
<p>If the WSGI application entry point is a function or object imported from a different module, wrap it with a wrapper object:</p>
<pre><code>import myapp
application = myapp.WSGIHandler()

application = newrelic.agent.WSGIApplicationWrapper(application)
</code></pre>
<p>If a supported web framework is being used, you might still use the decorator or wrapper explicitly if, for example, you were adding additional WSGI middleware around the supported web framework. This will ensure that execution of all WSGI middleware is also covered by the monitoring done by the agent.</p>
<p>For additional details on the decorator and wrapper see the documentation for the <a href="/docs/python/python-instrumentation-api#wsgi_application">wsgi_application()</a> and <a href="/docs/python/python-instrumentation-api#WSGIApplicationWrapper">WSGIApplicationWrapper</a> wrapper.</p>
