
<p>The New Relic Java agent API lets you control, customize, and extend the functionality of the APM <a href="/docs/agents/java-agent/getting-started/new-relic-java">Java agent</a>. This API consists of:</p>
<ul>
  <li>Static methods on the <code>com.newrelic.api.agent.NewRelic</code> class</li>
  <li>A <a href="/docs/agents/java-agent/custom-instrumentation/java-instrumentation-annotation">@Trace annotation</a> for implementing custom instrumentation</li>
  <li>A hierarchy of API objects providing additional functionality</li>
</ul>
<p>Use this API to set up <a href="/docs/agents/java-agent/custom-instrumentation/java-custom-instrumentation">custom instrumentation</a> of your Java app and collect more in-depth data. For detailed information about this API, see the complete <a href="http://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/NewRelic.html">Javadoc on GitHub</a>.</p>
<p>Another way to set up custom instrumentation is to use <a href="/docs/agents/java-agent/custom-instrumentation/java-instrumentation-xml">XML instrumentation</a>. The XML option is simpler and does not require modification of your app code, but it lacks the complete functionality of the Java agent API.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>For best results when using the API, ensure that you have the <a href="/docs/release-notes/agent-release-notes/java-release-notes">latest Java agent release</a>. Several APIs used in the examples require Java agent 3.36.0 or higher.</p>
</div>
<p>For all available New Relic APIs, see <a href="/docs/apis/getting-started/introduction-new-relic-apis">Intro to APIs</a>.</p>
<h2>Use the API [#api]</h2>
<p>To access the API class, add <code>newrelic-api.jar</code> to your application class path. The jar is in the New Relic Java agent's installation <code>zip</code> file. You can call the API when the Java agent is not running. The API methods are just stubs; the implementation is added when the Java agent loads the class.</p>
<h2>Transactions</h2>
<p>To instrument <a href="https://docs.newrelic.com/docs/apm/applications-menu/monitoring/transactions-page"><code>Transactions</code></a> in your application, use the following APIs.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Use this</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Create a <code>Transaction</code> when New Relic does not create one automatically</p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/Trace.html"><code>@Trace(dispatcher = true)</code></a> on the method that encompasses the work to be reported. When this annotation is used on a method within the context of an existing transaction, this will not start a new transaction, but rather include the method in the existing transaction.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Capture the duration of a method that New Relic does not automatically trace</p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/Trace.html"><code>@Trace()</code></a> on the method you want to time.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Set the name of the current <code>Transaction</code></p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/NewRelic.html"><code>NewRelic.setTransactionName(...)</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Start the timer for the response time of the current <code>Transaction</code> and to cause a <code>Transaction</code> you create to be reported as a <code>Web</code> transaction, rather than as an <code>Other</code> transaction</p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/NewRelic.html"><code>NewRelic.setRequestAndReponse(...)</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Add <a href="https://docs.newrelic.com/docs/agents/manage-apm-agents/agent-data/collect-custom-attributes">custom attributes</a> to <code>Transactions</code> and <code>TransactionEvents</code></p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/NewRelic.html"><code>NewRelic.addCustomParameter(...)</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Prevent a <code>Transaction</code> from being reported to New Relic</p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/NewRelic.html"><code>NewRelic.ignoreTransaction()</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Exclude a <code>Transaction</code> when calculating your app's <a href="https://docs.newrelic.com/docs/apm/new-relic-apm/apdex/apdex-measuring-user-satisfaction">Apdex</a> score</p>
      </div>
      <div>
        <p><a href="http://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/NewRelic.html"><code>NewRelic.ignoreApdex()</code></a></p>
      </div>
    </div>
  </div>
</div>
<h2>Instrument asynchronous work [#async]</h2>
<p>For detailed information, see <a href="/docs/agents/java-agent/async-instrumentation/java-agent-api-asynchronous-applications">Java agent API for asynchronous applications</a>.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Use this</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Trace an asynchronous method if it is linked to an existing <code>Transaction</code>...</p>
      </div>
      <div>
        <p><a href="http://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/NewRelic.html"><code>@Trace(async = true)</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Link the <code>Transaction</code> associated with the <code>Token</code> on the current thread...</p>
      </div>
      <div>
        <p><a href="http://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/Token.html"><code>Token.link()</code> or <code>Token.linkAndExpire()</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Expire a <code>Token</code> associated with the current <code>Transaction</code>...</p>
      </div>
      <div>
        <p><a href="http://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/Token.html"><code>Token.expire()</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Stop timing a <code>Segment</code> and have it report as part of its parent <code>Transaction</code></p>
      </div>
      <div>
        <p><a href="http://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/Segment.html"><code>Segment.end()</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Stop timing a <code>Segment</code> and <strong>not</strong> have it report as part of its parent <code>Transaction</code></p>
      </div>
      <div>
        <p><a href="http://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/Segment.html"><code>Segment.ignore()</code></a></p>
      </div>
    </div>
  </div>
</div>
<h2>Implement distributed tracing [#trace-calls]</h2>
<p>These APIs require <a href="https://docs.newrelic.com/docs/enable-distributed-tracing">distributed tracing to be enabled</a>.</p>
<p>Distributed tracing lets you see the path that a request takes as it travels through a distributed system. For general instructions on how to use the calls below to implement distributed tracing, see <a href="https://docs.newrelic.com/docs/enable-distributed-tracing#agent-apis">Use distributed tracing APIs</a>.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Use this</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Create a payload to be sent to a called service.</p>
      </div>
      <div>
        <pre><code>Transaction.createDistributedTracePayload()

</code></pre>For more on obtaining references to the current transaction and other entities, see [Obtain references](#obtain-references).
      </div>
    </div>
    <div>
      <div>
        <p>Accept a payload sent from the first service; this will link these services together in a trace.</p>
      </div>
      <div>
        <pre><code>Transaction.acceptDistributedTracePayload(...)

</code></pre>For more on obtaining references to the current transaction and other entities, see [Obtain references](#obtain-references).
      </div>
    </div>
    <div>
      <div>
        <p>Payload used to connect services. The <code>text()</code> call returns a JSON string representation of the payload.</p>
      </div>
      <div>
        <p><code>DistributedTracePayload.text()</code></p>
      </div>
    </div>
    <div>
      <div>
        <p>Payload used to connect services. The <code>httpSafe()</code> call returns a base64 encoded JSON string representation of the payload.</p>
      </div>
      <div>
        <p><code>DistributedTracePayload.httpSafe()</code></p>
      </div>
    </div>
    <div>
      <div>
        <p>Add <a href="https://docs.newrelic.com/docs/agents/manage-apm-agents/agent-data/collect-custom-attributes">custom attributes</a> to <code>SpanEvents</code> in distributed traces</p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/com/newrelic/api/agent/TracedMethod.html"><code>NewRelic.getAgent().getTracedMethod().addCustomAttribute(...)</code></a></p>
      </div>
    </div>
  </div>
</div>
<h2>Implement cross application tracing [#trace-calls]</h2>
<p>To track external calls and add <a href="https://docs.newrelic.com/docs/apm/transactions/cross-application-traces/cross-application-tracing">cross application tracing</a>, use the following APIs:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Use this</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Trace across a custom transport channel that New Relic does not support by default, such as a proprietary RPC transport</p>
      </div>
      <div>
        <pre><code>Transaction.getRequestMetadata(), .processRequestMetadata(...), .getResponseMetadata(), .processResponseMetadata(...)

</code></pre>Also refer to the information in this document about using `Transaction` to [obtain references to New Relic entities](#obtain-references).
      </div>
    </div>
    <div>
      <div>
        <p>View or change the metric name or a rollup metric name of a <code>TracedMethod</code></p>
        <p>(A rollup metric name, such as <code>OtherTransaction/all</code>, is not scoped to a specific transaction. It represents all background transactions.)</p>
      </div>
      <div>
        <pre><code>TracedMethod.getMetricName(), .setMetricName(...), .setRollupMetricName(...)

</code></pre>Also refer to the information in this document about using `TracedMethod` to [obtain references to New Relic entities](#obtain-references).
      </div>
    </div>
    <div>
      <div>
        <p>Report a call to an external HTTP service, database server, message queue, or other external resource that is being traced using the Java agent API's <a href="https://docs.newrelic.com/docs/agents/java-agent/custom-instrumentation/java-instrumentation-annotation"><code>@Trace</code> annotation</a></p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/TracedMethod.html"><code>TracedMethod.reportAsExternal(...)</code></a> passing arguments constructed using <a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/ExternalParameters.html"><code>ExternalParameters</code></a> builder.</p>
        <p>Also refer to the information in this document about using <code>TracedMethod</code> to <a href="#obtain-references">obtain references to New Relic entities</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Enable and add <a href="/docs/apm/transactions/cross-application-traces/cross-application-tracing">cross application tracing</a> when communicating with an external HTTP or JMS service that is instrumented by New Relic</p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/TracedMethod.html"><code>TracedMethod.addOutboundRequestHeaders(...)</code></a> along with <code>TracedMethod.reportAsExternal(...)</code></p>
        <p>Also refer to the information in this document about using <code>TracedMethod</code> to <a href="#obtain-references">obtain references to New Relic entities</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Add timing for an application server or dispatcher that is not supported automatically</p>
      </div>
      <div>
        <p><code>Transaction.setRequest(...), Transaction.setResponse(...)</code>, or <code>NewRelic.setRequestAndResponse(...)</code>, and <code>Transaction.markResponseSent()</code></p>
        <p>Also refer to the information in this document about using <code>Transaction</code> to <a href="#obtain-references">obtain references to New Relic entities</a>.</p>
      </div>
    </div>
  </div>
</div>
<h2>Obtain references to New Relic entities [#obtain-references]</h2>
<p>Other tasks require the New Relic <code>Agent</code> object. The <code>Agent</code> object exposes multiple objects that give you the following functionality:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Use this</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Get a reference to the current <code>Transaction</code></p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/Transaction.html"><code>NewRelic.getAgent().getTransaction()</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Get a <code>Token</code> to link asynchronous work</p>
      </div>
      <div>
        <pre><code>NewRelic.getAgent().getTransaction().getToken()

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Start and get a reference to a <code>Segment</code></p>
      </div>
      <div>
        <pre><code>NewRelic.getAgent().getTransaction().startSegment()

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Get a reference to the method currently being traced</p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/TracedMethod.html"><code>NewRelic.getAgent().getTracedMethod()</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Get a reference to the <code>Agent</code> logger</p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/Logger.html"><code>NewRelic.getAgent().getLogger()</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Get a reference to the <code>Agent</code> <a href="/docs/agents/java-agent/configuration/java-agent-configuration-config-file">configuration</a></p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/Config.html"><code>NewRelic.getAgent().getConfig()</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Get a reference to an aggregator for <a href="/docs/agents/manage-apm-agents/agent-data/custom-metrics">custom metrics</a></p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/MetricAggregator.html"><code>NewRelic.getAgent().getAggregator()</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Get a reference to <code>Insights</code> in order to record <a href="/docs/insights/new-relic-insights/custom-events/inserting-custom-events-new-relic-apm-agents">custom events</a></p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/Insights.html"><code>NewRelic.getAgent().getInsights()</code></a></p>
      </div>
    </div>
  </div>
</div>
<h2>Additional API functionality [#additional]</h2>
<p>The following APIs provide additional functionality, such as setting app server info, reporting errors, adding <a href="/docs/agents/java-agent/instrumentation/page-load-timing-java">page load timing</a> information, recording <a href="/docs/agents/manage-apm-agents/agent-data/custom-metrics">custom metrics</a>, and sending <a href="/docs/insights/new-relic-insights/custom-events/inserting-custom-events-new-relic-apm-agents">custom events to Insights</a>.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Use this</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Explicitly set port, name, and version information for an application server or dispatcher and the instance name for a JVM</p>
      </div>
      <div>
        <pre><code>NewRelic.setAppServerPort(...), .setServerInfo(...), and .setInstanceName(...)

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Report an error that New Relic does not report automatically</p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/NewRelic.html"><code>NewRelic.noticeError(...)</code></a></p>
        <p>When inside a transaction, the first call to <code>noticeError</code> wins. Only 1 error will be reported per transaction.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Add browser <a href="/docs/agents/java-agent/custom-instrumentation/java-agent-api-example-program#include-browser">page load timing</a> for <code>Transactions</code> that New Relic does not add to the header automatically</p>
      </div>
      <div>
        <pre><code>NewRelic.getBrowserTimingHeader(), .getBrowserTimingFooter(), .setUserName(String name), .setAccountName(String name), and .setProductName(String name)

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Create and accumulate <a href="https://docs.newrelic.com/docs/agents/manage-apm-agents/agent-data/custom-metrics">custom metrics</a></p>
      </div>
      <div>
        <p><a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/NewRelic.html"><code>NewRelic.recordMetric(...)</code>, <code>.recordResponseTimeMetric(...)</code>, or <code>.incrementCounter(...)</code></a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Record <a href="/docs/insights/new-relic-insights/custom-events/inserting-custom-events-new-relic-apm-agents">custom events</a></p>
      </div>
      <div>
        <p><code>Insights.recordCustomEvent(...)</code></p>
        <p>Or, use <a href="https://newrelic.github.io/java-agent-api/javadoc/index.html?com/newrelic/api/agent/NewRelic.html"><code>NewRelic.addCustomParameter(...)</code></a> to add custom attributes to the New Relic-defined <code>TransactionEvent</code> type.</p>
        <p>Also refer to the information in this document about using <code>Insights</code> to <a href="#obtain-references">obtain references to New Relic entities</a>.</p>
      </div>
    </div>
  </div>
</div>
<h2>Additional API usage examples [#api-examples]</h2>
<p>For detailed code examples about using the APIs, see New Relic's documentation about custom instrumentation for:</p>
<ul>
  <li><a href="/docs/agents/java-agent/custom-instrumentation/java-agent-api-overview-custom-instrumentation-external-calls-cat-messaging-datastore-web-frameworks">External calls, cross application traces, messaging, datastores, and web frameworks</a></li>
  <li><a href="/docs/agents/java-agent/custom-instrumentation/java-agent-api-example-application-using-custom-instrumentation-cross-application-tracing-cat">Cross application tracing and external datastore calls</a></li>
  <li><a href="/docs/agents/java-agent/custom-instrumentation/java-agent-api-example-program">Apps using custom instrumentation with annotation</a></li>
  <li><a href="/docs/agents/java-agent/custom-instrumentation/java-agent-instrumentation-api">Custom framework instrumentation API</a></li>
  <li><a href="/docs/agents/java-agent/instrumentation/blocking-instrumentation-java">Preventing unwanted instrumentation</a></li>
  <li><a href="/docs/data-analysis/metrics/collecting-custom-attributes#java-att">Inserting custom attributes</a></li>
  <li><a href="/docs/insights/new-relic-insights/adding-querying-data/inserting-custom-events-new-relic-apm-agents#java-att">Inserting custom events</a></li>
  <li><a href="/docs/apm/other-features/metrics/custom-metrics">Collecting custom metrics</a></li>
</ul>
