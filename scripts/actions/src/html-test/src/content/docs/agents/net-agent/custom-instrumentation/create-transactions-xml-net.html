
<p>New Relic instruments <a href="/docs/agents/net-agent/getting-started/compatibility-requirements-net-agent">supported frameworks</a> automatically. However, you may also have other frameworks for which some transactions are not being created automatically or additional methods that you would like to instrument. You can <a href="/docs/agents/net-agent/custom-instrumentation/introduction-net-custom-instrumentation">add custom instrumentation</a> to these methods by creating <a href="/docs/accounts-partnerships/education/getting-started-new-relic/glossary#transaction">transactions</a>. Transactions created via XML are <a href="/docs/agents/net-agent/custom-instrumentation/introduction-net-custom-instrumentation#web-background">classified as non-web</a> in the New Relic UI.</p>
<p>This document describes how to create transactions with an XML file. You can also:</p>
<ul>
  <li>Add details to <a href="/docs/agents/net-agent/custom-instrumentation/custom-instrumentation-xml-net">existing transactions using XML</a></li>
  <li>Create transactions and add detail to existing transactions with the <a href="/docs/agents/net-agent/api-guides/net-agent-api-instrument-using-attributes">.NET agent API</a>.</li>
</ul>
<p>If you have a non-IIS application, XML instrumentation requires enabling the <code>Instrument all</code> option during the <a href="/docs/agents/net-agent/installation-configuration/install-net-agent#installing">.NET agent installation</a>.</p>
<h2>Create transactions using XML [#creating-custom-txn]</h2>
<p>Custom transactions (transactions not instrumented automatically) are defined in a custom instrumentation XML file. You define a method that triggers the creation of a transaction. You can also instrument additional methods called by the trigger method.</p>
<p>Some important rules to know before you create a custom transaction:</p>
<ul>
  <li>Database and external calls do not require custom instrumentation because they're automatically instrumented.</li>
  <li>Ensure your XML file is in the correct path. To define its instrumentation set, the .NET agent reads every XML file in the <code>Extensions</code> directory.</li>
  <li>If a method you attempt to instrument is already part of an existing transaction, it will be added as a segment to that transaction. No new transaction will be created. This will occur even if the parent method is instrumented using custom instrumentation.</li>
  <li>Avoid instrumenting things like Main() as this method won't end until the application ends and data may not be sent to New Relic.</li>
</ul>
<p>To create a custom instrumentation file:</p>
<ol>
  <li>
    <p>Create a new <code>.xml</code> file in the <code>Extensions</code> directory within your .NET Agent directory. The location of this directory depends on your OS:</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoid2luZG93cy1pbnN0YWxsLWxvYyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiRm9yIHRoZSAuTkVUIEZyYW1ld29yayBvciBDb3JlIGFnZW50IG9uIFdpbmRvd3MifV0=">
        <div data-prop-text="title">For the .NET Framework or Core agent on Windows</div>
        <pre><code>C:\ProgramData\New Relic\.NET Agent\Extensions

</code></pre>&#x3C;Callout variant="important">
        Use the `ProgramData` directory, **not** the `Program Files` directory.
        &#x3C;/Callout>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibGludXgtaW5zdGFsbC1sb2MifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkZvciB0aGUgLk5FVCBDb3JlIGFnZW50IG9uIExpbnV4In1d">
        <div data-prop-text="title">For the .NET Core agent on Linux</div>
        <pre><code>PATH_TO_AGENT_DIRECTORY/Extensions

</code></pre>`PATH_TO_AGENT_DIRECTORY` will be the default `/usr/local/newrelic-netcore20-agent` or the directory chosen at installation.
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiQXp1cmUgQXBwIFNlcnZpY2VzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJGb3IgQXp1cmUgQXBwIFNlcnZpY2VzIn1d">
        <div data-prop-text="title">For Azure App Services</div>
        <p>.NET Framework agent:</p>
        <pre><code>D:\home\site\wwwroot\newrelic\extensions

</code></pre>
        <pre><code>
D:\home\site\wwwroot\newrelic_core\extensions

</code></pre>.NET Core agent:
      </div>
    </div>
  </li>
  <li>
    <p>Copy this template into the file you created. This template defines two separate class and methods as transactions but more can be added:</p>
    <pre><code>&#x3C;?xml version="1.0" encoding="utf-8"?>
&#x3C;extension xmlns="urn:newrelic-extension">
  &#x3C;instrumentation>
    &#x3C;!-- Define the method which triggers the creation of a transaction. -->
    &#x3C;tracerFactory name="NewRelic.Agent.Core.Tracer.Factories.BackgroundThreadTracerFactory" metricName="Name">
      &#x3C;match assemblyName="AssemblyName" className="NameSpace.ClassName">
        &#x3C;exactMethodMatcher methodName="MethodName" />
      &#x3C;/match>
    &#x3C;/tracerFactory>
    &#x3C;!-- Define the method which triggers the creation of a transaction. -->
    &#x3C;tracerFactory name="NewRelic.Agent.Core.Tracer.Factories.BackgroundThreadTracerFactory" metricName="Name2">
      &#x3C;match assemblyName="AssemblyName" className="NameSpace.ClassName2">
        &#x3C;exactMethodMatcher methodName="MethodName2" />
      &#x3C;/match>
    &#x3C;/tracerFactory>
  &#x3C;/instrumentation>
&#x3C;/extension>
</code></pre>
  </li>
</ol>
<ol>
  <li>In the file you created, customize the attribute values <code>Name</code>, <code>AssemblyName</code>, <code>NameSpace.ClassName</code>, and <code>MethodName</code>. Customize these values for both the trigger method and for any methods called by the trigger method.
    <ul>
      <li><code>Name</code>: Defines the transaction name. The metricName attribute is optional. If omitted, the transaction name will be <code>NameSpace.ClassName</code>/<code>MethodName</code>. The transaction category will be "Custom". The resulting full metric name will be "OtherTransaction/Custom/<code>Name</code> . If you wish to change the transaction category from "Custom", use the <a href="https://docs.newrelic.com/docs/agents/net-agent/net-agent-api/settransactionname-net-agent-api">SetTransactionName</a> api call. The New Relic UI groups transactions under categories in the <a href="#custom-txn-screen">transaction type field</a>.</li>
      <li><code>AssemblyName</code>: The assembly that contains the trigger method.</li>
      <li><code>NameSpace.ClassName</code>: The fully-qualified class name that contains the trigger method.</li>
      <li><code>MethodName</code>: The exact name of the trigger method.</li>
    </ul>
  </li>
  <li>Adding additional methods must include the "NewRelic.Agent.Core.Tracer.Factories.BackgroundThreadTracerFactory" attribute to be defined as a transaction. Tags without this attribute will <a href="https://docs.newrelic.com/docs/agents/net-agent/custom-instrumentation/add-detail-transactions-xml-net">add detail to existing</a> transactions only.</li>
  <li>Optional: To check if the XML file is formatted correctly, you can check it against the XSD (located at <code>C:\ProgramData\New Relic\.NET Agent\Extensions\extension.xsd</code>) using any XSD validator.</li>
</ol>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Do not use brackets <code>[suffix]</code> at the end of your transaction name. New Relic automatically strips brackets from the name. Instead, use parentheses <code>(suffix)</code> or other symbols if needed.</p>
</div>
<h2>View transactions in the UI [#viewing-custom-txn]</h2>
<p>The custom transaction starts when the method specified by <code>methodName</code> is invoked in the assembly specified by <code>assemblyName</code>. The transaction ends when the method returns or throws an exception.</p>
<p>You can view these metrics in the <a href="/docs/applications-menu/transactions-dashboard#tx_viewing"><strong>Transactions</strong> page</a> and in <a href="/docs/traces/viewing-transaction-traces">transaction traces</a>. To view the transaction: Go to <strong><a href="https://one.newrelic.com">one.newrelic.com</a></strong> <strong>> APM > (select an app) > Monitor > Transactions > Type > (select a type)</strong>. The type is defined by <a href="#category-name"><code>Category/Name</code></a>.</p>
<p>
  <img src="./images/custom_transactions.png" alt="custom_transactions.png" title="custom_transactions.png">
</p>
<p><strong><a href="https://one.newrelic.com">one.newrelic.com</a> > APM > (select an app) > Monitoring > Transactions > Type > (selected type)</strong>: Use the <strong>Type</strong> menu to view your custom transactions.</p>
<h2>Example: Instrument three methods [#example-custom-txn]</h2>
<p>This example presents a simple implementation of creating transactions.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1maWxlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJFeGFtcGxlIGN1c3RvbSBpbnN0cnVtZW50YXRpb24gZmlsZSJ9XQ==">
    <div data-prop-text="title">Example custom instrumentation file</div>
    <p>This custom instrumentation file defines the three methods to instrument. Only two are defined as transactions.</p>
    <pre><code>&#x3C;?xml version="1.0" encoding="utf-8"?>
&#x3C;extension xmlns="urn:newrelic-extension">
  &#x3C;instrumentation>
    &#x3C;!-- Define the method which triggers the creation of a transaction. -->
    &#x3C;tracerFactory name="NewRelic.Agent.Core.Tracer.Factories.BackgroundThreadTracerFactory" metricName="Bars">
      &#x3C;match assemblyName="Foo" className="Foo.Bar">
        &#x3C;exactMethodMatcher methodName="Bar1" />
        &#x3C;exactMethodMatcher methodName="Bar2" />
      &#x3C;/match>
    &#x3C;/tracerFactory>
    &#x3C;!-- Instrument 0 or more methods called by the trigger method. These methods appear in the transaction breakdown table and in transaction traces. -->
    &#x3C;tracerFactory>
      &#x3C;match assemblyName="Foo" className="Foo.Bar">
        &#x3C;exactMethodMatcher methodName="Bar3" />
      &#x3C;/match>
    &#x3C;/tracerFactory>
  &#x3C;/instrumentation>
&#x3C;/extension>

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1tZXRob2RzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJFeGFtcGxlIG1ldGhvZHMgdG8gYmUgaW5zdHJ1bWVudGVkIn1d">
    <div data-prop-text="title">Example methods to be instrumented</div>
    <p>This code contains the three methods, with comments explaining when each one will be instrumented by the agent:</p>
    <pre><code>var bar = new Bar();
bar.Bar1(); // Creates a transaction named Bars in the Custom category.
bar.Bar2(); // Creates a transaction named Bars in the Custom category.
bar.Bar3(); // Won't create a new transaction. See `If Bar3 is called directly`, below.

namespace Foo
{
    public class Bar
    {
        // The agent creates a transaction that includes an external service request in its transaction traces.
        public void Bar1()
        {
            new WebClient().DownloadString("http://www.google.com/");
        }

        // Creates  a transaction containing one segment.
        public void Bar2()
        {
            // The Bar3 segment will contain your SQL query inside of it and possibly an execution plan.
            Bar3();
        }

        // If Bar3 is called directly, the agent will not create a transaction.
        // However, if Bar3 is called from Bar1 or Bar2, Bar3 will appear as a segment containing its SQL query.
        private void Bar3()
        {
            using (var connection = new SqlConnection(ConnectionStrings["MsSqlConnection"].ConnectionString))
            {
                connection.Open();
                using (var command = new SqlCommand("SELECT * FROM table", connection))
                using (var reader = command.ExecuteReader())
                {
                    reader.Read();
                }
            }
        }
    }
}

</code></pre>
  </div>
</div>
<h2>Example: Instrument a console app [#example-custom-app]</h2>
<p>This simple console app demonstrates creating transactions. After running the application a few times, you see the transactions you created in the <a href="/docs/apm/applications-menu/monitoring/transactions-page">Transactions page</a> (at <strong><a href="https://one.newrelic.com">one.newrelic.com</a> > APM > (select an app) > Transactions > Type</strong>). The <strong>Dummy</strong> segment will be visible in the transactions breakdown table and in any transaction traces.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1hcHAtY2kifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkV4YW1wbGUgY3VzdG9tIGluc3RydW1lbnRhdGlvbiBmaWxlIn1d">
    <div data-prop-text="title">Example custom instrumentation file</div>
    <p>This custom instrumentation file defines two methods to instrument:</p>
    <pre><code>&#x3C;?xml version="1.0" encoding="utf-8"?>
&#x3C;extension xmlns="urn:newrelic-extension">
    &#x3C;instrumentation>
        &#x3C;!-- Define the method which triggers the creation of a transaction. -->
        &#x3C;tracerFactory name="NewRelic.Agent.Core.Tracer.Factories.BackgroundThreadTracerFactory" metricName="CustomTransaction">
          &#x3C;match assemblyName="ConsoleApplication1" className="ConsoleApplication1.CustomTransaction">
            &#x3C;exactMethodMatcher methodName="StartTransaction" />
          &#x3C;/match>
        &#x3C;/tracerFactory>
        &#x3C;!-- Instrument 0 or more methods called by the trigger method. These methods appear in the transaction breakdown table and in transaction traces. -->
        &#x3C;tracerFactory>
          &#x3C;match assemblyName="ConsoleApplication1" className="ConsoleApplication1.CustomTransaction">
            &#x3C;exactMethodMatcher methodName="Dummy" />
          &#x3C;/match>
        &#x3C;/tracerFactory>
    &#x3C;/instrumentation>
&#x3C;/extension>

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS1hcHAifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkV4YW1wbGUgYXBwIn1d">
    <div data-prop-text="title">Example app</div>
    <p>This code contains the two methods specified by the custom instrumentation file:</p>
    <pre><code>using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ConsoleApplication1
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("Custom Transactions");
            var t = new CustomTransaction();
            while (true)
                t.StartTransaction();
        }
    }
    class CustomTransaction
    {
        public void StartTransaction()
        {
            Console.WriteLine("StartTransaction");     
            Dummy();
        }
        void Dummy()
        {
            System.Threading.Thread.Sleep(5000);
        }
    }

}

</code></pre>
  </div>
</div>
