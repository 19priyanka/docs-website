
<p>New Relic's .NET agent provides several options for <a href="/docs/agents/net-agent/instrumentation/net-custom-instrumentation">custom instrumentation</a>. Custom instrumentation allows you to instrument parts of your app that are not instrumented automatically. This document describes how to instrument your app by decorating the methods in your app code with attributes.</p>
<ul>
  <li>Use the <code>Transaction</code> attribute to create a custom transaction. You can also mark the custom transaction as a web transaction with the attribute's <code>Web</code> property.</li>
  <li>Use the <code>Trace</code> attribute to add custom instrumentation to methods that are invoked within a preexisting transaction.</li>
</ul>
<h2>Requirements and recommendations [#requirements]</h2>
<p>Requirements include:</p>
<ul>
  <li>.NET agent version <a href="https://docs.newrelic.com/docs/release-notes/agent-release-notes/net-release-notes/net-agent-6161780">6.16.178.0</a> or higher.</li>
  <li>You must be willing to modify your source code. If you cannot or do not want to modify your source code, use <a href="/docs/agents/net-agent/custom-instrumentation/custom-instrumentation-xml-net">custom instrumentation via XML</a>.</li>
  <li>Your project must have a reference to <code>NewRelic.Api.Agent.dll</code> (for example, installing the package and placing <code>using NewRelic.Api.Agent;</code> in your code). This package is in the <a href="https://www.nuget.org/packages/NewRelic.Agent.Api/">NuGet gallery</a>.</li>
  <li>The <code>Transaction</code> and <code>Trace</code> attributes must be applied to concrete implementations of methods. They cannot be applied on interfaces or super class method definitions.</li>
</ul>
<h2>Transactions called within transactions [#tx-vs-trace]</h2>
<p>Methods decorated with the <code>[Transaction]</code> attribute will only create a new transaction when one does not already exist. When a method decorated with <code>[Transaction]</code> is called from <strong>within</strong> a previously started transaction, it will be treated as the <code>[Trace]</code> attribute instead, and will provide more information about the existing transaction.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhhbXBsZS10eC12cy10cmFjZSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjp7InR5cGUiOiJtZHhWYWx1ZUV4cHJlc3Npb24iLCJ2YWx1ZSI6Ijw+RXhhbXBsZTogQ2FsbGluZyA8SW5saW5lQ29kZT5UcmFuc2FjdGlvbjwvSW5saW5lQ29kZT4gaW4gYW4gYWxyZWFkeS1zdGFydGVkIHRyYW5zYWN0aW9uPC8+IiwicG9zaXRpb24iOnsic3RhcnQiOnsibGluZSI6MzcsImNvbHVtbiI6MTEsIm9mZnNldCI6MjMzNn0sImVuZCI6eyJsaW5lIjozNywiY29sdW1uIjoxMDUsIm9mZnNldCI6MjQzMH19fX1d">
    <div data-prop-text="title">[object Object]</div>
    <p>During the execution of this console application, <code>OuterMethod</code> will be called first and create a new transaction. The <code>InnerMethod</code> is called from within the transaction started by <code>OuterMethod</code>, so it will not create a new transaction. Instead, information about the execution of <code>InnerMethod</code> will be tracked as if the <code>[Trace]</code> attribute had been applied.</p>
    <pre><code>static void Main(string[] args)
{
    OuterMethod();
}

[Transaction]
public void OuterMethod()
{
    InnerMethod();
}

[Transaction]
public void InnerMethod()
{
}

</code></pre>
  </div>
</div>
<h2>Create a new non-web transaction [#create-background-txn]</h2>
<p>To start a non-web transaction (also known as a background request) with the <code>Transaction</code> attribute:</p>
<pre><code>[Transaction]
public void Run()
{
  // your background task
}
</code></pre>
<p>For details about why to use either web or non-web, see <a href="/docs/agents/net-agent/custom-instrumentation/introduction-net-custom-instrumentation#web-background">Classify as web or non-web</a>.</p>
<h2>Create a new web transaction [#create-web-txn]</h2>
<p>To tell the agent to mark a non-web task as a web browser transaction, use either of these options:</p>
<ul>
  <li>Set the <code>Web</code> property of the <code>Transaction</code> attribute to <code>true</code>.</li>
  <li>Set the transaction's URI with <a href="/docs/agents/net-agent/net-agent-api"><code>SetTransactionUri()</code></a>.</li>
</ul>
<pre><code>[Transaction(Web = true)]
public void Run()
{
  var uri = new Uri("http://www.mydomain.com/path");
  NewRelic.Api.Agent.NewRelic.SetTransactionUri(uri);
  
  // your web task
}
</code></pre>
<p>When used inside a <a href="#tx-vs-trace">previously started transaction</a>, this will be treated as a <code>[Trace]</code> attribute.</p>
<p>For details about why to use either web or non-web, see <a href="/docs/agents/net-agent/custom-instrumentation/introduction-net-custom-instrumentation#web-background">Classify as web or non-web</a>.</p>
<h2>Add detail to existing transactions with <code>Trace</code> [#add-trace]</h2>
<p>If your transaction traces show large blocks of un-instrumented time and you want to include additional methods within the trace, you can use the <code>Trace</code> attribute:</p>
<pre><code>[Trace]
protected void MethodWithinTransaction()
{
  // your app code
}
</code></pre>
<h2>Properties for [Transaction] [#properties]</h2>
<p>The <code>Transaction</code> attribute supports the following properties:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidHJhY2UtZGlzcGF0Y2hlciJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjp7InR5cGUiOiJtZHhWYWx1ZUV4cHJlc3Npb24iLCJ2YWx1ZSI6IjxJbmxpbmVDb2RlPldlYjwvSW5saW5lQ29kZT4iLCJwb3NpdGlvbiI6eyJzdGFydCI6eyJsaW5lIjoxMTYsImNvbHVtbiI6MTEsIm9mZnNldCI6NDc4OH0sImVuZCI6eyJsaW5lIjoxMTYsImNvbHVtbiI6NDEsIm9mZnNldCI6NDgxOH19fX1d">
    <div data-prop-text="title">[object Object]</div>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p>Type:</p>
          </div>
          <div>
            <p>Boolean</p>
          </div>
        </div>
        <div>
          <div>
            <p>Default:</p>
          </div>
          <div>
            <p><code>false</code></p>
          </div>
        </div>
      </div>
    </div>
    <p>If <code>true</code>, the agent starts a web transaction when it reaches this <code>Transaction</code> attribute. If a transaction is in progress, then that transaction will continue.</p>
    <p>If <code>false</code> (default), the agent starts a non-web transaction when it reaches this <code>Transaction</code> attribute. For example:</p>
    <pre><code>[Transaction(Web = true)]

</code></pre>
  </div>
</div>
<h2>Read forum posts about instrumentation [#discuss-posts]</h2>
<p>For more specific recommendations, check out these posts on our Explorers Hub community:</p>
<ul>
  <li><a href="https://discuss.newrelic.com/t/relic-solution-troubleshooting-attribute-based-custom-instrumentation-issues/68726">Troubleshoot attribute-based custom instrumentation issues</a></li>
  <li><a href="https://discuss.newrelic.com/t/relic-solution-troubleshooting-attribute-based-custom-instrumentation-issues/68726">Build custom instrumentation tracer factories from .NET agent log files</a></li>
</ul>
<h2>Use other API functions [#other-api]</h2>
<p>For more about the .NET agent API and its functionality, see New Relic's <a href="/docs/agents/net-agent/api-guides/guide-using-net-agent-api">.NET agent API guide</a>. For custom instrumentation without modifying your source code, see <a href="/docs/agents/net-agent/instrumentation/net-custom-transactions">Create transactions via XML</a> and <a href="/docs/agents/net-agent/custom-instrumentation/add-detail-transactions-xml-net">Add detail to transactions via XML</a>.</p>
