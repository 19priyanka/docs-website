
<p>This document explains a basic installation of the APM agent for Java applications in a Docker container. We discuss required configurations and also explore some optional configurations to help with the following:</p>
<ul>
  <li>How to use identical New Relic configuration files for each container, regardless of the environment the containers are used in.</li>
  <li>How to use the Docker layer when every agent in every environment needs slightly different configuration data.</li>
  <li>How to disable the New Relic agent in some environments and enable it in others.</li>
</ul>
<p>Although we don't discuss advanced options here, you can install the Java agent in Docker volumes and use your Docker container image in other software such as Swarm, ECS, AKS, EKS, OpenShift, and Kubernetes.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>Our Docker examples refer to Tomcat, so if you are using another application server, refer to your vendor’s documentation.</p>
</div>
<h2>Get the Java agent [#download-agent]</h2>
<p>Download <code>newrelic-java.zip</code> using <code>curl</code>, <code>Invoke-WebRequest</code> (PowerShell), or the New Relic UI:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZG93bmxvYWQtZnJvbS1jdXJsIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOnsidHlwZSI6Im1keFZhbHVlRXhwcmVzc2lvbiIsInZhbHVlIjoiPD5Eb3dubG9hZCB1c2luZyA8SW5saW5lQ29kZT5jdXJsPC9JbmxpbmVDb2RlPjwvPiIsInBvc2l0aW9uIjp7InN0YXJ0Ijp7ImxpbmUiOjMyLCJjb2x1bW4iOjExLCJvZmZzZXQiOjEzNTZ9LCJlbmQiOnsibGluZSI6MzIsImNvbHVtbiI6NjIsIm9mZnNldCI6MTQwN319fX1d">
    <div data-prop-text="title">[object Object]</div>
    <p>Complete the following:</p>
    <ol>
      <li>
        <p>Start a command-line session.</p>
      </li>
      <li>
        <p>Change to a temporary directory where you can download the zip file.</p>
      </li>
      <li>
        <p>Execute this <code>curl</code> command:</p>
        <pre><code>curl -O https://download.newrelic.com/newrelic/java-agent/newrelic-agent/current/newrelic-java.zip
</code></pre>
      </li>
      <li>
        <p>Unzip <code>newrelic-java.zip</code></p>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZG93bmxvYWQtZnJvbS1wb3dlcnNoZWxsIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOnsidHlwZSI6Im1keFZhbHVlRXhwcmVzc2lvbiIsInZhbHVlIjoiPD5Eb3dubG9hZCB1c2luZyA8SW5saW5lQ29kZT5JbnZva2UtV2ViUmVxdWVzdDwvSW5saW5lQ29kZT4gKFBvd2VyU2hlbGwpPC8+IiwicG9zaXRpb24iOnsic3RhcnQiOnsibGluZSI6NDgsImNvbHVtbiI6MTEsIm9mZnNldCI6MTgyNX0sImVuZCI6eyJsaW5lIjo0OCwiY29sdW1uIjo4OCwib2Zmc2V0IjoxOTAyfX19fV0=">
    <div data-prop-text="title">[object Object]</div>
    <p>Complete the following:</p>
    <ol>
      <li>
        <p>Start a PowerShell session.</p>
      </li>
      <li>
        <p>Change to a temporary directory where you can download the zip file.</p>
      </li>
      <li>
        <p>Execute this PowerShell command:</p>
        <pre><code>Invoke-WebRequest -Uri https://download.newrelic.com/newrelic/java-agent/newrelic-agent/current/newrelic-java.zip -OutFile newrelic-java.zip
</code></pre>
      </li>
      <li>
        <p>Unzip <code>newrelic-java.zip</code>:</p>
        <pre><code>Expand-Archive -Path newrelic-java.zip -DestinationPath DESTINATION_PATH
</code></pre>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZG93bmxvYWQtZnJvbS1VSSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiRG93bmxvYWQgZnJvbSB0aGUgTmV3IFJlbGljIFVJIn1d">
    <div data-prop-text="title">Download from the New Relic UI</div>
    <p>Complete the following:</p>
    <ol>
      <li><a href="http://www.newrelic.com/" title="Link opens in new window.">Log in to New Relic.</a></li>
      <li>From the <a href="/docs/accounts-partnerships/education/getting-started-new-relic/glossary#account-dropdown">account dropdown</a> in the New Relic UI, select <strong>Account settings</strong>.</li>
      <li>In the right sidebar under <strong>Most recent</strong>, select the Java agent, and save the <code>newrelic-java.zip</code> to a temporary directory.</li>
      <li>Unzip <code>newrelic-java.zip</code>.</li>
    </ol>
  </div>
</div>
<h2>Set up the installation directory [#install-directory]</h2>
<p>You can unzip the <code>newrelic-java.zip</code> file wherever it is convenient for you. In the subsequent sections we assume you extracted it in the current working directory, which puts the files we need in <code>./newrelic</code>.</p>
<h2>Modify startup scripts [#start-up-scripts]</h2>
<p>The startup script that contains the command to start your application server must include Java’s built-in argument <code>-javaagent</code>. We recommend that you set this argument with the <code>JAVA_OPTS</code> environment variable. The value of that argument must contain the location where you <code>ADD</code> the Java APM agent’s jar file to the image.</p>
<p>For example, with Tomcat, use commands like these in the <code>Dockerfile</code>:</p>
<pre><code>RUN mkdir -p /usr/local/tomcat/newrelic
ADD ./newrelic/newrelic.jar /usr/local/tomcat/newrelic/newrelic.jar
ENV JAVA_OPTS="$JAVA_OPTS -javaagent:/usr/local/tomcat/newrelic/newrelic.jar"
</code></pre>
<h2>Set agent configurations [#agent-configs]</h2>
<p>By default, agent behavior is controlled by configuration entries in <code>newrelic.yml</code>, which is typically located in the same directory as the agent. This section explains how to override these <code>newrelic.yml</code> configurations by using environment variables or Java system properties in the <code>Dockerfile</code>.</p>
<p>Before we look at some specific configurations, here’s how to load <code>newrelic.yml</code> using the <code>Dockerfile</code>:</p>
<pre><code>ADD ./newrelic/newrelic.yml /usr/local/tomcat/newrelic/newrelic.yml
</code></pre>
<p>For a basic Docker installation, complete these configurations:</p>
<ul>
  <li><a href="#app-name">Application name</a></li>
  <li><a href="#license-key">License key</a></li>
  <li><a href="#logs">Logs</a></li>
  <li><a href="#environment">Environment</a> (optional)</li>
  <li><a href="#enabled">Enabled</a> (optional)</li>
</ul>
<h3>Application name [#app-name]</h3>
<p>The application name is a configuration you set to identify your application in New Relic.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>You can reuse an application name for multiple apps serving the same role so that all the data from those apps rolls up into the same logical application in New Relic. For more detail about additional grouping options, see <a href="/docs/agents/manage-apm-agents/app-naming/use-multiple-names-app">Use multiple names for an app</a>.</p>
</div>
<p>Replace MY_APP_NAME with your application name in one of these <code>Dockerfile</code> commands:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Option</p>
      </div>
      <div>
        <p>Command</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Environment<br>variable</p>
      </div>
      <div>
        <pre><code>ENV NEW_RELIC_APP_NAME="MY_APP_NAME"

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Java system<br>property</p>
      </div>
      <div>
        <pre><code>ENV JAVA_OPTS="$JAVA_OPTS -Dnewrelic.config.app_name='MY_APP_NAME'"

</code></pre>
      </div>
    </div>
  </div>
</div>
<p>After you boot the container, your application name appears in New Relic.</p>
<h3>License key</h3>
<p>This configuration is required for you to report on any data in your New Relic Account.</p>
<p>To copy your license key:</p>
<ol>
  <li>
    <p>Go to <strong><a href="https://one.newrelic.com">one.newrelic.com</a> > (account dropdown) > Account settings</strong>.</p>
  </li>
  <li>
    <p>Under <strong>Account information</strong>, copy the license key.</p>
  </li>
  <li>
    <p>In one of these <code>Dockerfile</code> commands, replace MY_LICENSE_KEY with your license key:</p>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p>Option</p>
          </div>
          <div>
            <p>Command</p>
          </div>
        </div>
      </div>
      <div>
        <div>
          <div>
            <p>Environment<br>variable</p>
          </div>
          <div>
            <pre><code>ENV NEW_RELIC_LICENSE_KEY="MY_LICENSE_KEY"

</code></pre>
          </div>
        </div>
        <div>
          <div>
            <p>Java system<br>property</p>
          </div>
          <div>
            <pre><code>ENV JAVA_OPTS="$JAVA_OPTS -Dnewrelic.config.license_key='MY_LICENSE_KEY'"

</code></pre>
          </div>
        </div>
      </div>
    </div>
  </li>
</ol>
<h3>Logs</h3>
<p>By default, logs are written into the logs directory relative to the location of <code>newrelic.jar</code>. Make sure that the user account that starts your application server also has the right to perform tasks such as:</p>
<ul>
  <li>Creating the logs directory.</li>
  <li>Creating and appending to the log files in that directory.</li>
</ul>
<p>Here’s a Dockerfile example where <code>tomcat</code> is the user who starts Tomcat:</p>
<pre><code>RUN mkdir -p /usr/local/tomcat/newrelic/logs
RUN chown -R tomcat:tomcat /usr/local/tomcat/newrelic/logs
</code></pre>
<p>You can also send the logs to <code>STDOUT</code> by adding one of the following to the Dockerfile:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Option</p>
      </div>
      <div>
        <p>Command</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Environment<br>Variable</p>
      </div>
      <div>
        <pre><code>ENV NEW_RELIC_LOG_FILE_NAME=STDOUT

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Java system<br>property</p>
      </div>
      <div>
        <pre><code>ENV JAVA_OPTS=-Dnewrelic.config.log_file_name=STDOUT

</code></pre>
      </div>
    </div>
  </div>
</div>
<h3>Environment (optional) [#environment]</h3>
<p>You can pass either a Java property or an environment variable to determine which of the environment-specific stanzas the agent uses in <code>newrelic.yml</code>. Use this approach if you prefer to have the <code>newrelic.yml</code> file control environment-specific configurations instead of passing all the configurations via Docker.</p>
<p>Here’s a <code>Dockerfile</code> example of passing the <code>newrelic.environment</code> Java system property via Docker to use the custom value <code>dev</code> in the environment stanza of <code>newrelic.yml</code>:</p>
<ol>
  <li>
    <p>Using the shell form of the CMD instruction, include a reference to a new environment variable you choose (for example, <code>ENV</code>):</p>
    <pre><code>CMD java -Dnewrelic.environment=$ENV -jar myjar.jar
</code></pre>
  </li>
  <li>
    <p>In your <code>docker run</code> command line, include an argument to set the environment variable in the container:</p>
    <pre><code>docker run -it -e "ENV=dev" myDockerImage
</code></pre>
  </li>
</ol>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>If you don’t specify a value for <code>newrelic.environment</code>, the agent assumes it is running in your production environment and uses the values from the main body of the configuration file.</p>
</div>
<h3>Enabled (optional) [#enabled]</h3>
<p>This configuration controls whether the agent is enabled. Let’s say you want the same Docker image for every installation. However, you don’t want to run the New Relic agent every time an engineer spins up a test app because you don’t want to run up your instance count.</p>
<p>This problem can be solved using the <code>newrelic.environment</code> Java system property.</p>
<ol>
  <li>In the main body of <code>newrelic.yml</code>, disable the Java agent by setting <code>enabled: false</code>.</li>
  <li>In specific environment stanzas of <code>newrelic.yml</code>, set <code>enabled: true</code>.</li>
</ol>
<p>Then, you can run specific agents by specifying the environment at runtime.</p>
<h2>Additional Tomcat Dockerfile examples [#code-samples]</h2>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYm90aC1lbnYtYW5kLXByb3BzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJUb21jYXQgd2l0aCBlbnZpcm9ubWVudCBhbmQgSmF2YSBzeXN0ZW0gcHJvcGVydGllcyJ9XQ==">
    <div data-prop-text="title">Tomcat with environment and Java system properties</div>
    <pre><code>FROM tomcat:9
# Add the newrelic.jar and -javaagent parameters
RUN mkdir -p /usr/local/tomcat/newrelic
ADD ./newrelic/newrelic.jar /usr/local/tomcat/newrelic/
ENV JAVA_OPTS="$JAVA_OPTS -javaagent:/usr/local/tomcat/newrelic/newrelic.jar"
# Add the configuration file
ADD ./newrelic/newrelic.yml /usr/local/tomcat/newrelic/
# An example of setting a system property config
ENV JAVA_OPTS="$JAVA_OPTS -Dnewrelic.config.app_name='My Application'"
# An example of setting an Environment variable config
ENV NEW_RELIC_LICENSE_KEY="license_key"
# Config to include the agent logs in Docker's stdout logging
ENV JAVA_OPTS="$JAVA_OPTS -Dnewrelic.config.log_file_name=STDOUT"
EXPOSE 8080
CMD ["catalina.sh", "run"]

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic3RhcnQtdXAifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkhvdyB0byBzdGFydCBhbiBhcHBsaWNhdGlvbiB3aXRoIHRoZSBKYXZhIGFnZW50In1d">
    <div data-prop-text="title">How to start an application with the Java agent</div>
    <pre><code>FROM openjdk:8
ADD my-application.jar /app
ADD newrelic.jar  /app
ADD newrelic.yml  /app 
ENV NEW_RELIC_APP_NAME="My Application"
ENV NEW_RELIC_LICENSE_KEY="license_key"
ENV NEW_RELIC_LOG_FILE_NAME="STDOUT"
ENTRYPOINT ["java","-javaagent:/app/newrelic.jar","-jar","/app/my-application.jar"]

</code></pre>
  </div>
</div>
<h2>Next steps [#what-is-next]</h2>
<p>Now that you have a basic agent installation in Docker, here are some additional steps to consider:</p>
<ul>
  <li>Review other <a href="/docs/agents/java-agent/configuration/java-agent-configuration-config-file">configurations</a> for the agent.</li>
  <li>Read a detailed <a href="https://discuss.newrelic.com/t/relic-solution-what-you-need-to-know-about-new-relic-when-deploying-with-docker/52492">Explorers Hub post</a> about Docker and New Relic.</li>
</ul>
