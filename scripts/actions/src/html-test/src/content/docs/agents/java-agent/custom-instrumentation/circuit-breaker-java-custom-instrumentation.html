
<p>The New Relic Java agent includes a circuit breaker that protects applications from the effects of over-instrumentation. When the circuit breaker detects early symptoms of memory exhaustion, it automatically "trips" and limits instrumentation. The agent stops collecting transaction data until the circuit breaker automatically resets after deciding that resetting is safe.</p>
<p>The circuit breaker takes two parameters into account (<a href="#cpu-thresholds">heap usage and time spent in garbage collection</a>) to determine when it should trip. The default values for these thresholds are percentages:</p>
<ul>
  <li>Memory threshold: 20%</li>
  <li>Garbage collection CPU threshold: 10%</li>
</ul>
<p>When the percentage of free heap memory is less than <code>memory_threshold</code>, and the CPU time spent doing garbage collection is greater than <code>gc_cpu_threshold</code>, the circuit breaker trips. When the circuit breaker trips, the agent stops collecting transaction data. Throughput reported in the APM UI will be underreported, and you will not see transaction traces for a period of time.</p>
<h2>Reasons for memory exhaustion [#when]</h2>
<p>The circuit breaker trips when it detects signs of memory exhaustion. This can happen for several reasons:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoib3Zlci1pbnN0cnVtZW50ZWQifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IllvdXIgYXBwbGljYXRpb24gaXMgb3Zlci1pbnN0cnVtZW50ZWQuIn1d">
    <div data-prop-text="title">Your application is over-instrumented.</div>
    <p>Your application shows early signs of memory exhaustion due to recently deployed custom instrumentation (using XML, API calls, trace annotations, or the Java agent's <a href="/docs/apm/applications-menu/features/custom-instrumentation-editor-quickly-customize-your-java-instrumentation">custom instrumentation editor</a>) or due to built-in instrumentation.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibG9hZC1zcGlrZSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiWW91ciBhcHBsaWNhdGlvbiBoYXMgZXhwZXJpZW5jZWQgYSBsb2FkIHNwaWtlLiJ9XQ==">
    <div data-prop-text="title">Your application has experienced a load spike.</div>
    <p>Your application experienced a load spike and showed signs of memory exhaustion. In this case, the agent isn’t contributing to the spike, but the circuit breaker can help conserve resources and ensure that the agent doesn’t contribute to <code>OutOfMemoryErrors</code>.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibWVtb3J5LWxpbWl0In0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJZb3VyIGFwcGxpY2F0aW9uIHJ1bnMgY2xvc2UgdG8gaXRzIG1lbW9yeSBsaW1pdCBieSBkZXNpZ24uIn1d">
    <div data-prop-text="title">Your application runs close to its memory limit by design.</div>
    <p>Your application is tuned to run close to its memory limit.</p>
  </div>
</div>
<h2>Troubleshooting</h2>
<p>If the circuit breaker trips, try these troubleshooting tips.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZGlzYWJsZSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiSWRlbnRpZnkgYW5kIGRpc2FibGUgaW5zdHJ1bWVudGF0aW9uLiJ9XQ==">
    <div data-prop-text="title">Identify and disable instrumentation.</div>
    <p>Use the <strong>Top methods by call count</strong> table on the circuit breaker <strong>Events</strong> page to find methods that might be over-instrumented. Identify and disable custom instrumentation.</p>
    <p>In general, agent memory usage is proportional to the call count of a method. Custom instrumentation should be used on methods that are called no more than ten or so times per transaction. If the instrumentation is built into the agent, review New Relic's <a href="/docs/agents/java-agent/custom-instrumentation/java-custom-instrumentation">custom instrumentation</a> documentation for Java. If you need additional help, get support at <a href="https://support.newrelic.com/home">support.newrelic.com</a>.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiamF2YS1oZWFwIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJJbmNyZWFzZSBtYXhpbXVtIEphdmEgaGVhcCBzaXplLiJ9XQ==">
    <div data-prop-text="title">Increase maximum Java heap size.</div>
    <p>Carefully review your application's memory usage history and determine whether increasing the maximum Java heap size is necessary.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZGlzYWJsZSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiRGlzYWJsZSB0aGUgY2lyY3VpdCBicmVha2VyLiJ9XQ==">
    <div data-prop-text="title">Disable the circuit breaker.</div>
    <p>If your application is behaving as expected, you may want to disable the circuit breaker. To disable the circuit breaker, add <code>enabled: false</code> under the <code>circuitbreaker</code> stanza in your <code>newrelic.yml</code> configuration file:</p>
    <pre><code>common: &#x26;default_settings​
  circuitbreaker:
    enabled: false

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY3B1LXRocmVzaG9sZHMifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkFkanVzdCBtZW1vcnkgYW5kIGdhcmJhZ2UgY29sbGVjdGlvbiBDUFUgdGltZSB0aHJlc2hvbGRzLiJ9XQ==">
    <div data-prop-text="title">Adjust memory and garbage collection CPU time thresholds.</div>
    <p>To detect early signs of memory exhaustion, the circuit breaker uses a formula with two variables: <code>memory_threshold</code> and <code>gc_cpu_threshold</code>. When the percentage of free heap memory is less than <code>memory_threshold</code>, and the CPU time spent doing garbage collection is greater than <code>gc_cpu_threshold</code>, the circuit breaker trips. Adjust these values as needed, based on your application's operating performance and behavior.</p>
    <p>For configuration details, see <code>memory_threshold</code> and <code>gc_cpu_threshold</code>.</p>
  </div>
</div>
<h2>For more help [#data-collection]</h2>
<p>Additional documentation resources include:</p>
<ul>
  <li><a href="/docs/apm/other-features/metrics/custom-instrumentation">Custom instrumentation</a> (overview of custom instrumentation for all agents, including Java)</li>
  <li><a href="/docs/apm/applications-menu/features/custom-instrumentation-editor-quickly-customize-your-java-instrumentation">Custom instrumentation editor</a> (tool to customize your Java instrumentation)</li>
</ul>
