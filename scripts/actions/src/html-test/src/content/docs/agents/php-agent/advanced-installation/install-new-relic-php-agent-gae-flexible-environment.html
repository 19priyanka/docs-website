
<p>With New Relic APM's <a href="/docs/agents/php-agent/getting-started/introduction-new-relic-php">PHP agent</a>, you can monitor applications that reside in the <a href="https://cloud.google.com/appengine/docs/flexible/php/">Google App Engine (GAE) flexible environment</a>. Adding New Relic to your GAE flex app gives you insight into the health and performance of your app and extends GAE with metrics you can view in <a href="/docs/apm/new-relic-apm/getting-started/introduction-new-relic-apm">New Relic APM</a>, <a href="/docs/browser/new-relic-browser/getting-started/introduction-new-relic-browser">Browser</a>, and <a href="/docs/insights/use-insights-ui/getting-started/introduction-new-relic-insights">Insights</a>.</p>
<p>This document explains how to add New Relic to your GAE flex app by configuring a <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/about-custom-runtimes">custom runtime</a>, and gives an example of deploying a PHP app with Docker.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>The New Relic PHP agent can run in a GAE flexible environment using a custom runtime. Due to limitations of other environments, do not use the GAE standard environment or Google App Engine's <a href="/docs/accounts-partnerships/partnerships/google-cloud-platform-gcp/google-app-engine-environment#native-mode">"native mode"</a> installation.</p>
</div>
<h2>Build a custom runtime using Docker [#build-runtime]</h2>
<p>See <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/build">Google's documentation for building custom runtimes</a>. This example describes how to add New Relic to your GAE flex app by installing the New Relic PHP agent, building a custom runtime, and deploying a single PHP application via Debian. For best results with the GAE flex environment, always use Debian.</p>
<p>For more information about deploying and configuring your PHP app in the GAE flexible environment, see:</p>
<ul>
  <li><a href="https://cloud.google.com/appengine/docs/flexible/php/">Google App Engine's documentation</a> for PHP</li>
  <li><a href="https://cloud.google.com/appengine/docs/flexible/php/tutorials">Google App Engine's tutorials</a> to deploy a PHP app</li>
</ul>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic2V0dXAtZ2FlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIxLiBTZXQgdXAgdGhlIEdBRSBwcm9qZWN0IGFuZCBpbnN0YWxsIGRlcGVuZGVuY2llcyJ9XQ==">
    <div data-prop-text="title">1. Set up the GAE project and install dependencies</div>
    <ol>
      <li>
        <p>Follow standard procedures to <a href="/docs/agents/php-agent/installation/php-agent-installation-overview">install the New Relic PHP agent</a> for your specific app server, and obtain your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">license key</a>.</p>
      </li>
      <li>
        <p>Follow <a href="https://cloud.google.com/appengine/docs/flexible/php/quickstart">Google App Engine procedures for PHP</a> to create a new Cloud Platform project, create an App Engine application, and complete other prerequisites for the <a href="https://cloud.google.com/sdk/docs/">Google Cloud SDK</a>.</p>
        <p>The Google Cloud SDK provides the <code>gcloud</code> command line tool to manage and deploy GAE apps.</p>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY3VzdG9tIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIyLiBFeHRlbmQgdGhlIEdBRSBpbWFnZSBmb3IgUEhQIn1d">
    <div data-prop-text="title">2. Extend the GAE image for PHP</div>
    <p>In this example, the Dockerfile extends the generic PHP image with application files for a single application in Debian. You can add your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">New Relic license key</a> directly to your Dockerfile, or use an environment variable in your <code>docker run</code> command.</p>
    <pre><code>FROM gcr.io/google-appengine/php:latest
ENV DOCUMENT_ROOT /app

RUN DEBIAN_FRONTEND=noninteractive apt-get update; DEBIAN_FRONTEND=noninteractive apt-get -y install wget sudo
RUN wget -O - https://download.newrelic.com/548C16BF.gpg | sudo apt-key add -
RUN echo 'deb http://apt.newrelic.com/debian/ newrelic non-free' | tee /etc/apt/sources.list.d/newrelic.list
RUN DEBIAN_FRONTEND=noninteractive apt-get update &#x26;&#x26; DEBIAN_FRONTEND=noninteractive apt-get -y install newrelic-php5
RUN NR_INSTALL_KEY="new-relic-license-key" NR_INSTALL_SILENT=true newrelic-install install

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlndXJlLWFwcC15YW1sIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIzLiBDb25maWd1cmUgeW91ciBhcHAueWFtbCJ9XQ==">
    <div data-prop-text="title">3. Configure your app.yaml</div>
    <p>The <code>app.yaml</code> configuration file is required for a GAE flexible environment app with a custom runtime. At a minimum, make sure it contains:</p>
    <pre><code>env: flex
runtime: custom
runtime_config:
  document_root: .

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYnVpbGQtZG9ja2VyLWltYWdlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiI0LiBCdWlsZCBhIERvY2tlciBpbWFnZSJ9XQ==">
    <div data-prop-text="title">4. Build a Docker image</div>
    <p>The <a href="http://docs.docker.com/engine/reference/builder/">Dockerfile</a> defines the Docker image to be built and is required for a GAE flexible environment app. When building the Docker image, use the PHP image from Google App Engine. Standard Docker images from other providers may cause problems with GAE.</p>
    <p>To build the Docker image, run the following command. Be sure to include the period at the end of the code, to indicate the current directory contains the build files.</p>
    <pre><code>docker build --rm -t Docker-image-name .

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZGVwbG95LWRvY2tlci1pbWFnZS10by1nYWUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjUuIERlcGxveSBEb2NrZXIgaW1hZ2UgdG8gaW5pdGlhbGl6ZWQgR0FFIGZsZXhpYmxlIGVudmlyb25tZW50In1d">
    <div data-prop-text="title">5. Deploy Docker image to initialized GAE flexible environment</div>
    <ol>
      <li>
        <p>To deploy your Docker image to your <a href="https://cloud.google.com/sdk/docs/initializing">initialized GAE flexible environment</a>, run the following command:</p>
        <pre><code>gcloud app deploy --project php-app-name
</code></pre>
      </li>
      <li>
        <p>Wait until the deployment completes.</p>
      </li>
      <li>
        <p>To view your GAE flex app data in New Relic, go to the <a href="/docs/apm/applications-menu/monitoring/apm-overview-page">New Relic APM <strong>Overview</strong> page</a>.</p>
      </li>
    </ol>
  </div>
</div>
<h2>Optional: Disable health checks [#health-checks]</h2>
<p>Google App Engine sends <a href="https://cloud.google.com/appengine/docs/flexible/go/configuring-your-app-with-app-yaml#health_checks">periodic health check requests</a> to confirm that an instance has been successfully deployed, and to check that a running instance maintains a healthy status. A health check is an HTTP request to the URL <code>/_ah/health</code>.</p>
<p>If you create a custom runtime, your app must be able to handle a large number of health check requests. Otherwise, your app data may not display correctly in New Relic APM.</p>
<p>If you notice performance issues, disable GAE health checks. In your <code>app.yaml</code>, add:</p>
<pre><code>health_check:
  enable_health_check: False
</code></pre>
<h2>Get New Relic agent troubleshooting logs from GAE [#agent-logs]</h2>
<p>Use these resources to troubleshoot your GAE flex environment app:</p>
<ul>
  <li>
    <p>To connect to the GAE instance and start a shell in the Docker container running your code, see <a href="https://cloud.google.com/appengine/docs/flexible/php/debugging-an-instance">Debugging an instance</a>.</p>
  </li>
  <li>
    <p>To redirect New Relic PHP agent logs to the <a href="http://cloud.google.com/logging/docs/view/logs_viewer_v2">Stackdriver</a> in the <a href="https://cloud.google.com/compute/docs/console">Cloud Platform Console</a>, change the <code>newrelic.yml</code> file to:</p>
    <pre><code>log_file_name: STDOUT
</code></pre>
  </li>
  <li>
    <p>To view the logs, use the <a href="https://cloud.google.com/appengine/docs/flexible/php/writing-application-logs">Cloud Platform Console's Log Viewer</a>.</p>
  </li>
</ul>
