
<p><a href="http://www.openshift.com/" title="Link opens in a new window">OpenShift</a> is a Platform as a Service (PaaS) solution capable of hosting web applications using various languages, including the Python agent.</p>
<h2>Prepare your application [#preparing-your-application]</h2>
<p>Before installing the Python agent, make sure your Python web application is installed and running under OpenShift using one of the available Python cartridges. See the <a href="https://developers.openshift.com/en/python-overview.html" title="Link opens in a new window">OpenShift developer guides</a> for more information.</p>
<h2>Install the APM Python agent [#installing-the-python-agent]</h2>
<p>OpenShift support two different ways of installing third party Python packages. You can either list the package as a dependency in the <code>setup.py</code> for your web application, or in the <code>requirements.txt</code> file used by <code>pip</code>.</p>
<p>If you are using a <code>setup.py</code> file, install the agent by adding <code>newrelic</code> to the list of third party modules passed to <code>install_requires</code>:</p>
<pre><code>from setuptools import setup

setup(name='YourAppName',
      version='1.0',
      description='OpenShift App',
      author='Your Name',
      author_email='example@example.com',
      url='https://www.python.org/community/sigs/current/distutils-sig',
      install_requires=['Flask>=0.7.2', 'MarkupSafe', 'newrelic'],
     )
</code></pre>
<p>If you are using <code>pip</code>, add the following line to <code>requirements.txt</code>:</p>
<pre><code>newrelic
</code></pre>
<p>When you push your project up to OpenShift, this will install the Python agent package. It will use the latest version of the Python agent from the OpenShift mirror of the Python Package Index (PyPi). Updates to the OpenShift mirror of PyPi can be delayed, so you may have to wait up to a day before a new release on PyPi is available on OpenShift.</p>
<h2>Update the Python agent [#updating-the-python-agent]</h2>
<p>OpenShift will cache packages and will not detect when a newer version of the Python agent is available. To force an upgrade to a newer version, explicitly list the version against the package name in the <code>setup.py</code> or <code>requirements.txt</code> file and push your application. Use this syntax:</p>
<pre><code>newrelic==A.B.C.D
</code></pre>
<p>Replace <code>A.B.C.D</code> with the version of the the Python agent you wish to install.</p>
<h2>Use Python agent environment variables [#agent-environment-variables]</h2>
<p>In order for the Python agent to report data to the correct account, you need to tell it the <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">license key</a> for your New Relic account. For OpenShift, the most secure way to provide the license key is using an environment variable configured in your application configuration using the <code>rhc env set</code> command. This avoids storing sensitive information in your GIT repository and also works if you are using a scaled web application which is hosted on multiple physical hosts.</p>
<pre><code>rhc env set NEW_RELIC_LICENSE_KEY=YOUR_LICENSE_KEY -a YOUR_APP_NAME
</code></pre>
<p>While specifying your license key, also tell the Python agent where to record log messages:</p>
<pre><code>rhc env set NEW_RELIC_LOG=stderr -a YOUR_APP_NAME
</code></pre>
<p>To verify that the environment variables are being set, run:</p>
<pre><code>rhc env list -a YOUR_APP_NAME
</code></pre>
<p>Although set, these will only take effect the next time the web application gears are restarted.</p>
<h2>Test the agent installation [#testing-the-agent-installation]</h2>
<p>To test that the Python agent package has been installed correctly and that the agent environment variables are being set correctly, you can <code>ssh</code> into the main gear of your application and run:</p>
<pre><code>newrelic-admin validate-config - stdout
</code></pre>
<p>This admin script will create a connection and report test transaction data under the application <strong>Python Agent Test</strong> in your account.</p>
<p>Data can take up to five minutes to appear in the UI. If it doesn't appear after some time, capture the output from running the test and use the data to troubleshoot the issue. If you need further assistance, get support at <a href="https://support.newrelic.com" title="Link opens in a new window">support.newrelic.com</a>.</p>
<h2>Initialize the Python agent [#initializing-the-python-agent]</h2>
<p>The OpenShift Python cartridges provide two ways of running a WSGI application.</p>
<ul>
  <li>The first method uses a preconfigured Apache/mod_wsgi installation. In this case your WSGI application entry point must be defined in the <code>wsgi.py</code> file.</li>
  <li>The second method relies on you to provide a standalone Python web application script called <code>app.py</code>. This will typically start an embedded Python WSGI server, with the WSGI application entry point being specified within the <code>app.py</code> file, or be imported from a separate Python code file, such as the <code>wsgi.py</code> file.</li>
</ul>
<p>For either method, OpenShift controls the startup of the WSGI server. You must manually integrate the Python agent into your WSGI application. You cannot use the <code>newrelic-admin</code> wrapper script around the startup of the WSGI server.</p>
<p>If you are using the Apache/mod_wsgi approach, add the following code at the very start of the <code>wsgi.py</code> file:</p>
<pre><code>import newrelic.agent
newrelic.agent.initialize()
</code></pre>
<p>Make sure this precedes any other Python module imports appearing in the <code>wsgi.py</code> file. You do not need to provide any arguments to the <code>initialize()</code> call, because the license key information and destination for logging are read from the environment variables.</p>
<p>If you are using an embedded Python WSGI server from <code>app.py</code>, place these lines at the very top of the <code>app.py</code> file, even if you import the WSGI application entry point from a <code>wsgi.py</code> file. When using <code>app.py</code> with <code>wsgi.py</code>, do not add these lines to <code>wsgi.py</code>.</p>
<p>Avoid using the built-in development servers of any web framework. Also, do not use the OpenShift Python 2.6 cartridge or older Django versions. This is because these development servers are often based on the WSGI server from the <strong>wsgiref</strong> module from the Python standard library. The WSGI server from the <strong>wsgiref</strong> module had a bug, which meant it was not fully WSGI-compliant, and this would cause the Python agent to report incorrect data. This issue with the <strong>wsgiref</strong> module is only fixed in Python 2.7.4. The built-in WSGI server in older versions of Django prior to Django 1.4 had a similar problem.</p>
<h2>Wrap the WSGI application [#wrapping-the-wsgi-application]</h2>
<p>If you are using a Python web framework for which the agent provides automatic wrapping of the WSGI application entry point, this is all that needs to be done. Python web frameworks with automatic wrapping include Django, Flask, and Bottle.</p>
<p>For others, you must modify the Python code file with your WSGI application entry point to wrap the WSGI application object with a WSGI application wrapper. This will initiate the timing for the web requests received by your application.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Entry point</p>
      </div>
      <div>
        <p>Example code</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Enty point is a function</p>
      </div>
      <div>
        <p>Wrap it in a decorator.</p>
        <pre><code>import newrelic.agent

@newrelic.agent.wsgi_application()
def application(environ, start_response):
    ...

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Enty point is a function or object imported from a different module.</p>
      </div>
      <div>
        <p>Wrap it in pre decorator style.</p>
        <pre><code>import myapp
application = myapp.WSGIHandler()
application = newrelic.agent.WSGIApplicationWrapper(application)

</code></pre>
      </div>
    </div>
  </div>
</div>
<h2>Override the application name [#overriding-the-application-name]</h2>
<p>By default, your data is recorded under the app name <strong>Python Application</strong>. To change the display name, use the APM user interface. However, from the agent side, we highly recommends keeping this as a unique, unchanging value, independent of changes to the display name in the UI. This is required if you intend to run multiple distinct sites under the one New Relic account and want to have the data reported separately.</p>
<p>To override the application name, use the <code>rhc env set</code> command:</p>
<pre><code>rhc env set NEW_RELIC_APP_NAME='Web Site (Production)' -a yourappname
</code></pre>
<p>To verify that the configuration has been updated, run:</p>
<pre><code>rhc env list -a yourappname
</code></pre>
<p>Then look for:</p>
<pre><code>NEW_RELIC_APP_NAME=Web Site (Production)
</code></pre>
<p>Changes to environment variables only take effect the next time you restart your web application gears.</p>
<h2>Debug the Python agent [#debugging-the-python-agent]</h2>
<p>To begin debugging, collect the log output from the Python agent. When the <code>NEW_RELIC_LOG</code> environment variable is set to <code>stderr</code>, the log messages from the Python agent will be captured within the standard Python web application logs.</p>
<p>To tail the web application logs under OpenShift, run:</p>
<pre><code>rhc tail -a YOUR_APP_NAME
</code></pre>
<p>To get the complete log, copy back from each of your web applications the log file:</p>
<pre><code>$OPENSHIFT_PYTHON_LOG_DIR/python.log
</code></pre>
<p>By default the Python agent will log at <code>info</code> level. If the agent requires an alternate level of logging, you will need to manually add an additional environment variable. For example, to set logging output to <code>debug</code>, run:</p>
<pre><code>rhc env set NEW_RELIC_LOG_LEVEL=debug -a YOUR_APP_NAME
</code></pre>
<p>Environment variables do not take effect immediately, so be sure to restart your web application gears.</p>
<p>Run <code>debug</code> logging only when requested and only for the time required. Debug logging can produce a lot of output and will bloat your log files. Remove this setting as soon as it is no longer required by running the following command, and then restart your web application gears:</p>
<pre><code>rhc env unset NEW_RELIC_LOG_LEVEL -a YOUR_APP_NAME
</code></pre>
<p>Use the logfile to troubleshoot the issue. If you need further assistance, get support at <a href="https://support.newrelic.com" title="Link opens in a new window">support.newrelic.com</a></p>
<h2>Update agent configuration file [#agent-configuration-file]</h2>
<p>With OpenShift, the preferred way of specifying your account license key and defining where logging should go is to use environment variables. This means it is not necessary to use an agent configuration file to get the agent working. However, without the agent configuration file, it is not possible to <a href="/docs/agents/python-agent/installation-configuration/python-agent-configuration">customize other agent settings</a>.</p>
<p>If you enable server-side configuration for your application, you do not need an agent configuration file. This is done from the <strong>Application settings</strong> in the APM user interface application. Using server-side configuration you can override core settings for the agent. When a change is made to a setting via the UI, the agent running within each of your web application processes will be notified, and it will pick up the changed settings.</p>
<p>However, some agent features are incompatible with server-side configuration. In these cases, use an agent configuration file pushed up with your web application to OpenShift.</p>
<p>To add and enable an agent configuration file with OpenShift:</p>
<ol>
  <li>
    <p>Add the agent configuration file <strong>newrelic.ini</strong> to the root directory of your project repository that you are pushing up to OpenShift. This should contain a <code>[newrelic]</code> section along with just the specific configuration setting you need to set. For example:</p>
    <pre><code>[newrelic]
transaction_tracer.function_trace = mydbm:connect
</code></pre>
    <p>Do not use the agent configuration file for core settings such as the license key or app name, as doing so will override the environment variable settings. You also likely do not want the license key as part of your GIT repository, especially if the project source code is publicly available.</p>
    <p>Also note that if server-side configuration is enabled at the same time, any setting that can be set via server-side configuration will always override the local setting. Therefore only use this for settings that cannot be set using server-side configuration if server-side configuration is enabled.</p>
  </li>
  <li>
    <p>Now modify the <code>wsgi.py</code> or <code>app.py</code> file where you added the code to initialize the Python agent. Change the code you had already added to:</p>
    <pre><code>import os
import newrelic.agent

repo_dir = os.environ['OPENSHIFT_REPO_DIR']
config_file = os.path.join(repo_dir, 'newrelic.ini')

newrelic.agent.initialize(config_file)
</code></pre>
  </li>
  <li>
    <p>Commit the configuration file to your repository and push the change up to OpenShift.</p>
  </li>
</ol>
<h2>For more help [#more_help]</h2>
<p>Additional documentation resources include:</p>
<ul>
  <li><a href="/docs/python/new-relic-for-python">New Relic for Python</a> (an overview and system requirements for the Python agent)</li>
  <li><a href="/docs/python/python-agent-integration">Python agent integration</a> (integrating the Python agent into your app)</li>
</ul>
