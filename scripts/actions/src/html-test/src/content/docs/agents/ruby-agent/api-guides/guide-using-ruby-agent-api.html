
<p>The New Relic Ruby agent provides a public API with documentation available on GitHub. The GitHub documentation tells you how to set up custom instrumentation of your Ruby app and collect more in-depth data:</p>
<ul>
  <li><a href="https://rubydoc.info/github/newrelic/newrelic-ruby-agent">Overview</a></li>
  <li><a href="https://rubydoc.info/github/newrelic/newrelic-ruby-agent/NewRelic/Agent">Public API methods</a></li>
</ul>
<p>The following sections explain common goals, solutions, and links to relevant parts of the documentation.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>When using the Ruby agent API, ensure that you have the latest Ruby agent release. Several APIs used in the following examples require Ruby agent <a href="/docs/release-notes/agent-release-notes/ruby-release-notes/ruby-agent-3170325">version 4.6.0</a> or higher.</p>
</div>
<h2>Instrument missing sections of your code with transactions [#creating-transactions]</h2>
<p>To instrument your app, New Relic separates each path through your code into its own <a href="/docs/accounts-partnerships/education/getting-started-new-relic/glossary#transaction">transaction</a>. New Relic times (or "instruments") the parent method in these transactions to measure your app's overall performance, and collects <a href="/docs/apm/transactions/transaction-traces/introduction-transaction-traces">transaction traces</a> from long-running transactions for additional detail.</p>
<p>Use these methods when New Relic is not instrumenting a particular part of your code at all:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Do this...</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Time a method New Relic is not instrumenting automatically</p>
      </div>
      <div>
        <p>Create a new transaction. See <a href="/docs/agents/ruby-agent/customization/ruby-custom-instrumentation#transaction-tracers">Tracing transaction entry points</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Time something other than a single method call</p>
      </div>
      <div>
        <p>Use the <a href="/docs/agents/ruby-agent/customization/ruby-custom-instrumentation#advanced-tracing">Tracer API</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Prevent a transaction from reporting to New Relic</p>
      </div>
      <div>
        <p><a href="/docs/agents/ruby-agent/customization/ignoring-specific-transactions">Ignore</a> the transaction.</p>
      </div>
    </div>
  </div>
</div>
<h2>Time specific methods using segments [#segments]</h2>
<p>If a transaction is already visible in the New Relic UI, but you don't have enough data about a particular method that was called during that transaction, you can create segments to time those individual methods in greater detail. For example, you might want to time a particularly critical method with complex logic.</p>
<p>Use these methods when you want to instrument a method within an existing transaction:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Do this...</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Time a particular method</p>
      </div>
      <div>
        <p>See <a href="/docs/agents/ruby-agent/customization/ruby-custom-instrumentation#method_tracers">Method tracers</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Time something other than a single method call</p>
      </div>
      <div>
        <p>Use the <a href="/docs/agents/ruby-agent/customization/ruby-custom-instrumentation#advanced-tracing">Tracer API</a>.</p>
      </div>
    </div>
  </div>
</div>
<h2>Enhance the metadata of a transaction [#metadata]</h2>
<p>Sometimes the code you are targeting is visible in the New Relic UI, but some details of the method are not useful. For example:</p>
<ul>
  <li>The default name is causing a <a href="/docs/agents/manage-apm-agents/troubleshooting/metric-grouping-issues#video">metric grouping issue</a>.</li>
  <li>You want to add <a href="/docs/agents/manage-apm-agents/agent-data/collect-custom-attributes">custom attributes</a> to your transactions so you can filter them in the <a href="/docs/query-your-data/explore-query-data/query-builder/use-advanced-nrql-mode-specify-data">query builder</a>.</li>
</ul>
<p>Use these methods when you want to change how New Relic instruments a transaction that is already visible in the New Relic UI:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Do this...</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Change the name of a transaction</p>
      </div>
      <div>
        <p>See <a href="/docs/agents/ruby-agent/customization/ruby-custom-instrumentation#naming-transactions">Naming transactions</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Add metadata (such as your customer's account name or subscription level) to your transactions</p>
      </div>
      <div>
        <p>Use <a href="/docs/agents/manage-apm-agents/agent-data/collect-custom-attributes">custom attributes</a>. See <a href="/docs/agents/ruby-agent/attributes/ruby-agent-attributes#add-custom-attributes">Adding custom attributes</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Mark a transaction as a background job</p>
      </div>
      <div>
        <p>See <a href="/docs/agents/ruby-agent/background-jobs/monitor-ruby-background-processes#custom_background_jobs">Monitor custom background jobs</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Mark a transaction as a web transaction</p>
      </div>
      <div>
        <p>Pass a <code>:category => :controller</code> option to <code>set_transaction_name()</code>. For more information, see <a href="/docs/agents/ruby-agent/customization/ruby-custom-instrumentation#naming-transactions">Naming transactions</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Prevent a transaction from affecting your <a href="/docs/apm/new-relic-apm/apdex/apdex-measuring-user-satisfaction">Apdex score</a></p>
      </div>
      <div>
        <p>See <a href="/docs/agents/ruby-agent/customization/ignoring-specific-transactions#apdex">Ignoring Apdex contributions</a>.</p>
      </div>
    </div>
  </div>
</div>
<h2>Collect or ignore errors [#errors]</h2>
<p>Usually the agent detects errors automatically. However, you can manually mark an error with the agent. You can also mark errors as <a href="/docs/apm/applications-menu/error-analytics/ignoring-errors-new-relic-apm">ignored or expected</a>.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Do this...</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Report an error the agent does not report automatically</p>
      </div>
      <div>
        <p>See <a href="/docs/agents/ruby-agent/customization/sending-new-relic-handled-errors">Sending New Relic handled errors</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Prevent the agent from reporting an error at all</p>
      </div>
      <div>
        <p>Mark the error as ignored. See <a href="/docs/agents/ruby-agent/configuration/ruby-agent-configuration#error_collector">Error Collector</a> to use the <code>error_collector.ignore_errors</code> config option.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Prevent an error from affecting your Apdex or error rate, but still report it to New Relic</p>
      </div>
      <div>
        <p>Mark the error as expected. See <a href="/docs/agents/ruby-agent/customization/sending-new-relic-handled-errors">Sending New Relic handled errors</a>, and set <code>:expected</code> to <code>true</code>.</p>
      </div>
    </div>
  </div>
</div>
<h2>Send custom event and metric data from your app [#custom-data]</h2>
<p>APM includes a number of ways to record arbitrary custom data. For an explanation of New Relic data types, see <a href="/docs/data-analysis/metrics/analyze-your-metrics/data-collection-metric-timeslice-event-data">Data collection</a>.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Do this...</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Send data about an event so you can analyze it in dashboards</p>
      </div>
      <div>
        <p>Create a <a href="/docs/insights/insights-data-sources/custom-events">custom event</a>. See <a href="http://www.rubydoc.info/github/newrelic/newrelic-ruby-agent/NewRelic/Agent#record_custom_event-instance_method"><code>record_custom_event()</code></a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Tag your events with metadata to filter and facet them in dashboards or error analytics</p>
      </div>
      <div>
        <p>Add <a href="/docs/agents/manage-apm-agents/agent-data/collect-custom-attributes">custom attributes</a>. Pass a hash of attributes to <a href="http://www.rubydoc.info/github/newrelic/newrelic-ruby-agent/NewRelic/Agent#record_custom_event-instance_method"><code>record_custom_event()</code></a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Report custom performance data</p>
      </div>
      <div>
        <p>Create a <a href="/docs/agents/manage-apm-agents/agent-data/custom-metrics">custom metric</a>. See <a href="http://www.rubydoc.info/github/newrelic/newrelic-ruby-agent/NewRelic/Agent#record_metric-instance_method"><code>record_metric()</code></a>.</p>
      </div>
    </div>
  </div>
</div>
<h2>Control the Browser agent [#browser]</h2>
<p>Usually the Browser agent is added automatically to your pages or deployed by copy/pasting the JavaScript snippet. For more information about these recommended methods, see <a href="/docs/browser/new-relic-browser/installation-configuration/add-apps-new-relic-browser">Add apps to browser monitoring</a>. However, you can also retrieve the Browser agent via APM agent API calls. For more information, see <code>browser_timing_header()</code>.</p>
<h2>Instrument calls to datastores [#async]</h2>
<p>Use these methods to collect data about your app's connections to other datastores:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Do this...</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Time a call to a datastore not instrumented automatically by New Relic</p>
      </div>
      <div>
        <p>See <code>wrap()</code>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Time a datastore call that can't cleanly be wrapped in a Ruby block</p>
      </div>
      <div>
        <p>See <code>Tracer.start_datastore_segment()</code>. You <strong>must</strong> call <code>finish</code> on the object returned by this method.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Capture SQL queries along with timing</p>
      </div>
      <div>
        <p>See <code>notice_sql()</code>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Capture non-SQL queries along with timing</p>
      </div>
      <div>
        <p>See <code>notice_statement()</code>.</p>
      </div>
    </div>
  </div>
</div>
<h2>Instrument calls to externals [#externals]</h2>
<p>Use these methods to collect data for external requests:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Do this...</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Time a call to an external request not instrumented automatically by New Relic</p>
      </div>
      <div>
        <p>Use <code>Tracer.start_external_segment()</code>. You <strong>must</strong> call <code>finish</code> on the object returned by this method.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Add cross-account tracing (CAT) headers to an outbound HTTP request</p>
      </div>
      <div>
        <p>Use <code>add_request_headers()</code>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Read CAT headers from an inbound HTTP request</p>
      </div>
      <div>
        <p>Use <code>read_response_headers()</code>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Generate an obfuscated string to transport CAT information in an outbound request</p>
      </div>
      <div>
        <p>Use <code>get_request_metadata()</code>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Process an obfuscated string containing CAT information received from an inbound request</p>
      </div>
      <div>
        <p>Use <code>process_response_metadata()</code>.</p>
      </div>
    </div>
  </div>
</div>
<h2>Instrument calls for distributed tracing [#distributed]</h2>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>The following API examples require Ruby agent version 6.9.0 or higher.</p>
</div>
<p>These APIs require <a href="https://docs.newrelic.com/docs/enable-distributed-tracing">distributed tracing to be enabled</a>.</p>
<p><a href="/docs/apm/distributed-tracing/getting-started/introduction-distributed-tracing">Distributed tracing</a> lets you see the paths requests take as they travel through a distributed system.</p>
<p>For general instructions on how to use the calls below to implement distributed tracing, see <a href="https://docs.newrelic.com/docs/enable-distributed-tracing#agent-apis">Use distributed tracing APIs</a>.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Do this...</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Send a payload/header to the called service.</p>
      </div>
      <div>
        <p>See <code>insert_distributed_trace_headers()</code>.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Accept a payload/header received from the first service, which will link these services together in a trace</p>
      </div>
      <div>
        <p>See <code>accept_distributed_trace_headers()</code>.</p>
      </div>
    </div>
  </div>
</div>
