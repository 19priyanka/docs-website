
<p>With APM's <a href="/docs/agents/ruby-agent/getting-started/introduction-new-relic-ruby">Ruby agent</a>, you can monitor applications that reside in the <a href="https://cloud.google.com/appengine/docs/flexible/ruby/">Google App Engine (GAE) flexible environment</a>. Adding New Relic to your GAE flex app gives you insight into the health and performance of your app and extends GAE with metrics you can view using <a href="/docs/full-stack-observability/monitor-everything/get-started-new-relic-monitoring-tools/get-started-full-stack-observability">Full-Stack Observability</a> options like <a href="/docs/apm">APM</a> and <a href="/docs/browser/new-relic-browser/getting-started/introduction-new-relic-browser">browser monitoring</a>.</p>
<p>This document explains how to add New Relic to your GAE flex app using either of these methods:</p>
<ul>
  <li>Google App Engine's <a href="/docs/accounts-partnerships/partnerships/google-cloud-platform-gcp/google-app-engine-environment#native-mode">"native mode"</a> installation with a standard GAE runtime</li>
  <li>Docker installation using a <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/about-custom-runtimes">custom runtime</a></li>
</ul>
<p>The custom runtime method includes an example of deploying a Sinatra app. If you need specific libraries or headers, New Relic recommends using the custom runtime method.</p>
<h2>Deploy using GAE's native support [#native]</h2>
<p>When using Google App Engine <a href="/docs/accounts-partnerships/partnerships/google-cloud-platform-gcp/google-app-engine-environment#native-mode">"native mode"</a> installation, you provide your app code and an <code>app.yaml</code> file. Google App Engine then deploys to a standard prebuilt Docker image.</p>
<p>To deploy with native support for Sinatra or Rails:</p>
<ol>
  <li>Follow New Relic's standard procedures to <a href="/docs/agents/ruby-agent/installation/install-new-relic-ruby-agent#Installing_the_Gem">install the gem</a>, including your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">license key</a>.</li>
  <li>Install the Ruby agent <a href="/docs/agents/ruby-agent/installation/install-new-relic-ruby-agent#Configuration_file">configuration file</a>.</li>
</ol>
<p>Once the gem and configuration file have been installed, the Ruby agent can automatically monitor applications that reside in the GAE flexible environment. Wait until the deployment completes, then view your GAE flex app data in the <a href="/docs/apm/applications-menu/monitoring/apm-overview-page">APM Summary page</a>.</p>
<h2>Build a custom runtime using Docker [#build-runtime]</h2>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>If your Ruby app needs specific libraries or headers, New Relic recommends using the custom runtime method. In addition, New Relic recommends that you allow Google App Engine to handle health checks.</p>
</div>
<p>See <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/build">Google's documentation for building custom runtimes</a>. This example describes how to add New Relic to your GAE flex app by building a custom runtime for Docker. The example uses a Sinatra app for Ruby.</p>
<p>For more information about deploying and configuring your Ruby app in the GAE flexible environment, see:</p>
<ul>
  <li><a href="https://cloud.google.com/appengine/docs/flexible/ruby/">Google App Engine's documentation</a> for Ruby</li>
  <li><a href="https://cloud.google.com/appengine/docs/flexible/ruby/tutorials">Google App Engine's tutorials</a> for Ruby</li>
</ul>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic2V0dXAtZ2FlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIxLiBTZXQgdXAgdGhlIEdBRSBwcm9qZWN0IGFuZCBpbnN0YWxsIGRlcGVuZGVuY2llcyJ9XQ==">
    <div data-prop-text="title">1. Set up the GAE project and install dependencies</div>
    <ol>
      <li>
        <p>Follow standard procedures to install New Relic's Ruby agent, including your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">license key</a>.</p>
      </li>
      <li>
        <p>Follow Google App Engine procedures for Ruby to create a new <a href="https://cloud.google.com/appengine/docs/flexible/ruby/managing-projects-apps-billing#create">Google Cloud Platform project</a>, create an App Engine application, and complete other prerequisites for the <a href="http://cloud.google.com/appengine/docs/flexible/ruby/download">Google Cloud SDK</a>.</p>
        <p>The Google Cloud SDK provides the <code>gcloud</code> command line tool to manage and deploy GAE apps.</p>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlndXJlLWFwcC15YW1sIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIyLiBDb25maWd1cmUgeW91ciBhcHAueWFtbCJ9XQ==">
    <div data-prop-text="title">2. Configure your app.yaml</div>
    <p>The <code>app.yaml</code> configuration file is required for a GAE flexible environment app with a custom runtime. At a minimum, make sure it contains:</p>
    <pre><code>env: flex
runtime: custom
entrypoint: bundle exec ruby app.rb

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlndXJlLWRvY2tlcmZpbGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjMuIENvbmZpZ3VyZSBhIERvY2tlcmZpbGUifV0=">
    <div data-prop-text="title">3. Configure a Dockerfile</div>
    <p>The <a href="http://docs.docker.com/engine/reference/builder/">Dockerfile</a> defines the Docker image to be built and is required for a GAE flexible environment app. To create the recommended base image for apps monitored by the New Relic Ruby agent:</p>
    <pre><code>FROM gcr.io/google-appengine/ruby:latest

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYnVpbGQtZG9ja2VyLWltYWdlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiI0LiBCdWlsZCBhIERvY2tlciBpbWFnZSJ9XQ==">
    <div data-prop-text="title">4. Build a Docker image</div>
    <p>Be sure to include the period at the end of the code, to indicate the current directory contains the build files.</p>
    <pre><code>docker build -f Dockerfile -t custom_ruby_app_container:latest .

</code></pre>After running this command, verify that you have a Docker image named `custom_ruby_app_container` and tagged `latest`.
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZGVwbG95LWRvY2tlci1pbWFnZS10by1nYWUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjUuIERlcGxveSBEb2NrZXIgaW1hZ2UgdG8gaW5pdGlhbGl6ZWQgR0FFIGZsZXhpYmxlIGVudmlyb25tZW50In1d">
    <div data-prop-text="title">5. Deploy Docker image to initialized GAE flexible environment</div>
    <ol>
      <li>
        <p>To deploy your Docker image to your <a href="https://cloud.google.com/sdk/docs/initializing">initialized GAE flexible environment</a>, run the following command:</p>
        <pre><code>gcloud app deploy
</code></pre>
      </li>
      <li>
        <p>Wait until the deployment completes.</p>
      </li>
      <li>
        <p>To open the app in the browser, run the following command:</p>
        <pre><code>gcloud app browse
</code></pre>
      </li>
      <li>
        <p>To view your GAE flex app data in New Relic, go to the <a href="/docs/apm/applications-menu/monitoring/apm-overview-page">APM Summary page</a>.</p>
      </li>
    </ol>
  </div>
</div>
<h2>Recommendation: Handle health checks [#health-checks]</h2>
<p>Google App Engine sends <a href="https://cloud.google.com/appengine/docs/flexible/ruby/how-instances-are-managed">periodic health check requests</a> to confirm that an instance has been successfully deployed, and to check that a running instance maintains a healthy status. A health check is an HTTP request to the URL <code>/_ah/health</code>.</p>
<p>If you create a custom runtime, your app must be able to handle a large number of health check requests. Otherwise, your app data may not display correctly in APM.</p>
<p>New Relic recommends that you <a href="https://cloud.google.com/appengine/docs/flexible/ruby/how-instances-are-managed#health_checking">allow health checks for Ruby apps</a> so that Google can check that your service is up and balanced properly. However, if excessive health checks cause congested transaction traces, you can set the Ruby agent to ignore the health check requests.</p>
<ul>
  <li>To <strong>handle</strong> health checks, add a route for <code>_ah/health</code> in your app.</li>
  <li>To <strong>ignore</strong> health check requests, set the <code>rules.ignore_url_regexes</code> config setting in the applicationâ€™s Ruby agent config to include <code>'_ah/health'</code>.</li>
</ul>
<h2>Get New Relic agent troubleshooting logs from GAE [#agent-logs]</h2>
<p>Use these resources to troubleshoot your GAE flex environment app:</p>
<ul>
  <li>
    <p>To connect to the GAE instance and start a shell in the Docker container running your code, see <a href="https://cloud.google.com/appengine/docs/flexible/go/debugging-an-instance">Debugging an instance</a>.</p>
  </li>
  <li>
    <p>To redirect New Relic Ruby agent logs to <a href="http://cloud.google.com/logging/docs/view/logs_viewer_v2">Stackdriver</a> in the <a href="https://cloud.google.com/compute/docs/console">Cloud Platform Console</a>, change the <code>newrelic.js</code> configuration file to:</p>
    <pre><code>log_file_name: STDOUT
</code></pre>
  </li>
  <li>
    <p>To view the logs, use the <a href="https://cloud.google.com/appengine/docs/flexible/php/writing-application-logs">Cloud Platform Console's Log Viewer</a>.</p>
  </li>
</ul>
