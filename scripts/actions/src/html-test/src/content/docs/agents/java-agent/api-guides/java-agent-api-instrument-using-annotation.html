
<p>New Relic's Java agent provides several options for <a href="/docs/agents/java-agent/custom-instrumentation/java-custom-instrumentation">custom instrumentation</a>. One of those options is adding the Java agent API's <code>@Trace</code> annotations to your application code. This document describes how to use annotations.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>To use annotations, you must modify the source code. If you can't or don't want to modify your source code, see <a href="/docs/agents/java-agent/custom-instrumentation/java-custom-instrumentation">Custom instrumentation</a> for other instrumentation options.</p>
</div>
<h2>Configure your agent for annotations [#configure]</h2>
<p>By default, the configuration setting <code>enable_custom_tracing</code> is set to <code>true</code> in the Java agent, which is the setting required for @Trace annotations to function. This setting is <strong>not</strong> included in the <code>newrelic.yml</code> by default.</p>
<p>The only time you need to incorporate this setting into your configuration file is if you want to disable @Trace annotations altogether. To do this, set <code>enable_custom_tracing: false</code> (prefaced with two spaces) in the <code>common</code> stanza of your <code>newrelic.yml</code>.</p>
<p>To detect custom traces:</p>
<ol>
  <li>
    <p>Make sure that <code>newrelic-api.jar</code> appears in your classpath.</p>
  </li>
  <li>
    <p>Add <code>@Trace</code> annotations to your code. In each class containing a method you want to instrument, call:</p>
    <pre><code>import com.newrelic.api.agent.Trace;
</code></pre>
  </li>
  <li>
    <p>Place the <code>@Trace</code> annotation on each target method.</p>
  </li>
</ol>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>The <code>annotation com.newrelic.api.agent.Trace</code> is located in the <code>newrelic-api.jar</code>.</p>
</div>
<h2>Create a new transaction [#new-trans]</h2>
<p>If transactions do not appear and you want to start a new transaction, include <code>dispatcher=true</code> with the <code>@Trace</code> annotation:</p>
<pre><code>@Trace (dispatcher=true)
public void run() {
  // background task
}
</code></pre>
<h2>Add detail to your transactions [#detail]</h2>
<p>If your transaction traces show large blocks of uninstrumented time and you want to include some more methods within the trace, you can use the <code>@Trace</code> annotation without parameters:</p>
<pre><code>@Trace
protected void methodWithinTransaction() {
  // work
}
</code></pre>
<h2>Convert a transaction to a web request [#web-request]</h2>
<p>To make a background task report as a web browser transaction with a <a href="/docs/java/java-agent-api">Java agent API</a> call: In the method annotated with <code>@Trace(dispatcher=true)</code>, call:</p>
<pre><code>NewRelic.setRequestAndResponse(Request request, Response response)
</code></pre>
<p>The arguments are implementations of the <code>Request</code> and <code>Response</code> interfaces in <code>newrelic-api.jar</code>.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Even if your <code>Request</code> and <code>Response</code> objects already are present, you still need to add this API call.</p>
</div>
<h2>Define your own @Trace annotation class [#custom-class]</h2>
<p>If you define your own <code>@Trace</code> annotation class, there is no dependency on the <code>newrelic-api.jar</code>. To define the class:</p>
<pre><code>package com.test;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)

public @interface Trace {
  public static final String NULL = "";
  String metricName() default NULL;
  boolean dispatcher() default false;
  String tracerFactoryName() default NULL;
}
</code></pre>
<p>Then, configure the agent to use this annotation in the <code>common</code> section of the <code>newrelic.yml</code>:</p>
<pre><code>class_transformer:
  trace_annotation_class_name: com.test.Trace
</code></pre>
<h2>Properties for @Trace [#properties]</h2>
<p>The <code>@Trace</code> annotation supports the following properties.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidHJhY2UtZGlzcGF0Y2hlciJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjp7InR5cGUiOiJtZHhWYWx1ZUV4cHJlc3Npb24iLCJ2YWx1ZSI6IjxJbmxpbmVDb2RlPmRpc3BhdGNoZXI8L0lubGluZUNvZGU+IiwicG9zaXRpb24iOnsic3RhcnQiOnsibGluZSI6MTE2LCJjb2x1bW4iOjExLCJvZmZzZXQiOjQxMzR9LCJlbmQiOnsibGluZSI6MTE2LCJjb2x1bW4iOjQ4LCJvZmZzZXQiOjQxNzF9fX19XQ==">
    <div data-prop-text="title">[object Object]</div>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p>Type:</p>
          </div>
          <div>
            <p>Boolean</p>
          </div>
        </div>
        <div>
          <div>
            <p>Default:</p>
          </div>
          <div>
            <p><code>false</code></p>
          </div>
        </div>
      </div>
    </div>
    <p>If <code>true</code>, the agent will start a transaction when it reaches a method with this <code>@Trace</code> annotation if a transaction is not already in progress. If a transaction is already in progress, the method with this annotation will be included in the ongoing transaction, rather than starting a new one.</p>
    <p>If <code>false</code> (default), no metrics will be recorded if the agent has not started a transaction before the <code>@Trace</code> annotation is reached. For example:</p>
    <pre><code>@Trace(dispatcher=true)

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidHJhY2UtYXN5bmMifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6eyJ0eXBlIjoibWR4VmFsdWVFeHByZXNzaW9uIiwidmFsdWUiOiI8SW5saW5lQ29kZT5hc3luYzwvSW5saW5lQ29kZT4iLCJwb3NpdGlvbiI6eyJzdGFydCI6eyJsaW5lIjoxNTMsImNvbHVtbiI6MTEsIm9mZnNldCI6NTA1MH0sImVuZCI6eyJsaW5lIjoxNTMsImNvbHVtbiI6NDMsIm9mZnNldCI6NTA4Mn19fX1d">
    <div data-prop-text="title">[object Object]</div>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p>Type:</p>
          </div>
          <div>
            <p>Boolean</p>
          </div>
        </div>
        <div>
          <div>
            <p>Default:</p>
          </div>
          <div>
            <p><code>false</code></p>
          </div>
        </div>
      </div>
    </div>
    <p>If <code>true</code>, this method is marked as asynchronous and the agent will trace this method if it linked to an existing transaction. For example:</p>
    <pre><code>@Trace(async=true)

</code></pre>If `false` (default), the method is not marked as asynchronous. If other `@Trace` annotations are present and the method is not executing asynchronously, it will still be traced.
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidHJhY2UtbWV0cmljLW5hbWUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6eyJ0eXBlIjoibWR4VmFsdWVFeHByZXNzaW9uIiwidmFsdWUiOiI8SW5saW5lQ29kZT5tZXRyaWNOYW1lPC9JbmxpbmVDb2RlPiIsInBvc2l0aW9uIjp7InN0YXJ0Ijp7ImxpbmUiOjE5MCwiY29sdW1uIjoxMSwib2Zmc2V0Ijo1ODM2fSwiZW5kIjp7ImxpbmUiOjE5MCwiY29sdW1uIjo0OCwib2Zmc2V0Ijo1ODczfX19fV0=">
    <div data-prop-text="title">[object Object]</div>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p>Type:</p>
          </div>
          <div>
            <p>String</p>
          </div>
        </div>
        <div>
          <div>
            <p>Default:</p>
          </div>
          <div>
            <p>(none)</p>
          </div>
        </div>
      </div>
    </div>
    <p>This property affects transaction traces and error reporting. By default, the metric name will include the class name followed by the method name. If you do not want class followed by method, then you can use this property to change the metric name.</p>
    <p>If you set the <code>metricName</code>, as in <code>@Trace(metricName="YourMessageHere")</code>, then the time spent in this method will appear as YourMessageHere in any transaction trace.</p>
    <p>If you set the <code>metricName</code> in addition to the dispatcher, as in <code>@Trace(metricName="YourMessageHere", dispatcher=true)</code>, then the transaction name will appear as YourMessageHere in the APM <strong>Transactions</strong> page but the time spent in this method will not appear as YourMessageHere in any transaction trace.</p>
    <p>Here is an example:</p>
    <pre><code>@Trace(metricName="YourMetricName")

</code></pre>&#x3C;Callout variant="important">
    Do not use brackets `[suffix]` at the end of your transaction name. New Relic automatically strips brackets from the name. Instead, use parentheses `(suffix)` or other symbols if needed.
    &#x3C;/Callout>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidHJhY2UtZXhjbHVkZS10cmFjZSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjp7InR5cGUiOiJtZHhWYWx1ZUV4cHJlc3Npb24iLCJ2YWx1ZSI6IjxJbmxpbmVDb2RlPmV4Y2x1ZGVGcm9tVHJhbnNhY3Rpb25UcmFjZTwvSW5saW5lQ29kZT4iLCJwb3NpdGlvbiI6eyJzdGFydCI6eyJsaW5lIjoyMzUsImNvbHVtbiI6MTEsIm9mZnNldCI6NzMyMn0sImVuZCI6eyJsaW5lIjoyMzUsImNvbHVtbiI6NjUsIm9mZnNldCI6NzM3Nn19fX1d">
    <div data-prop-text="title">[object Object]</div>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p>Type:</p>
          </div>
          <div>
            <p>Boolean</p>
          </div>
        </div>
        <div>
          <div>
            <p>Default:</p>
          </div>
          <div>
            <p><code>false</code></p>
          </div>
        </div>
      </div>
    </div>
    <p>If <code>true</code>, the method will be excluded from the transaction trace. The agent will still collect metrics for the method. Here is an example:</p>
    <pre><code>@Trace(excludeFromTransactionTrace=true)

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibGVhZi10cmFjZXIifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6eyJ0eXBlIjoibWR4VmFsdWVFeHByZXNzaW9uIiwidmFsdWUiOiI8SW5saW5lQ29kZT5sZWFmPC9JbmxpbmVDb2RlPiIsInBvc2l0aW9uIjp7InN0YXJ0Ijp7ImxpbmUiOjI3MCwiY29sdW1uIjoxMSwib2Zmc2V0Ijo3OTYyfSwiZW5kIjp7ImxpbmUiOjI3MCwiY29sdW1uIjo0Miwib2Zmc2V0Ijo3OTkzfX19fV0=">
    <div data-prop-text="title">[object Object]</div>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p>Type:</p>
          </div>
          <div>
            <p>Boolean</p>
          </div>
        </div>
        <div>
          <div>
            <p>Default:</p>
          </div>
          <div>
            <p><code>false</code></p>
          </div>
        </div>
      </div>
    </div>
    <p>A leaf tracer has no child tracers. This is useful when you want all time attributed to the tracer, even if other trace points are encountered the tracer's execution.</p>
    <p>Database tracers often act as a leaf so that all time is attributed to database activity, even if instrumented external calls are made. Here is an example:</p>
    <pre><code>@Trace(leaf=true)

</code></pre>
    <pre><code>
@Trace(excludeFromTransactionTrace=true, leaf=true)

</code></pre>If a leaf tracer does not participate in transaction traces, the agent can create a tracer with lower overhead. Here is an example:
  </div>
</div>
<h2>More API functions [#other-api]</h2>
<p>For more about the Java agent API and its functionality, see the <a href="/docs/agents/java-agent/custom-instrumentation/java-agent-api">Java agent API introduction</a>.</p>
