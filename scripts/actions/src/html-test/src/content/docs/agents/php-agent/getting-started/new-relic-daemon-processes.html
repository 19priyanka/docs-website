
<p>The PHP agent consists of two parts:</p>
<ul>
  <li>The PHP extension module, <code>newrelic.so</code></li>
  <li>The agent daemon, <code>newrelic-daemon</code></li>
</ul>
<p>The daemon acts as a proxy between the PHP agent and the New Relic collector to reduce network traffic and to improve response time for instrumented applications. If the daemon is not running, no data is reported to New Relic.</p>
<h2>PHP daemon initial or idle states [#daemon]</h2>
<p>When the daemon is in an initial or idle state, <strong>two</strong> transactions must occur before it will start reporting.</p>
<p>In an <strong>initial</strong> state:</p>
<ul>
  <li>With the first transaction, the daemon adds your newly-reporting application to its own application information table.</li>
  <li>Once the application is added, the daemon reports the second transaction to New Relic.</li>
</ul>
<p>In an <strong>idle</strong> state:</p>
<ul>
  <li>The first transaction wakes up the daemon and re-establishes the connection to New Relic.</li>
  <li>The second transaction reports data to New Relic.</li>
</ul>
<h2>Watchdog and worker processes [#processes]</h2>
<p>If you do a process listing, you will see that there are always two daemon processes running:</p>
<pre><code>$ ps -ef | grep newrelic-daemon
newrelic     1368     1  0 00:28 ?     00:00:00 /usr/bin/newrelic-daemon ...
newrelic     1370  1368  0 00:28 ?     00:00:00 /usr/bin/newrelic-daemon ...
</code></pre>
<p>Having two processes running is normal behavior. The first column is the process owner, the second is the process ID (PID), and the third is the parent process ID (PPID).</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Daemon processes</p>
      </div>
      <div>
        <p>Comments</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Watchdog (first process)</p>
      </div>
      <div>
        <p>The first process, the one owned by PID 1, is the "watchdog" process. It watches the second process, which is the "worker" process.</p>
      </div>
    </div>
    <div>
      <div>
        <p>Worker (second process)</p>
      </div>
      <div>
        <p>The worker process does the following:</p>
        <ul>
          <li>Accepts connections from the PHP agent</li>
          <li>Gathers metrics</li>
          <li>Communicates with the New Relic collector</li>
        </ul>
      </div>
    </div>
    <div>
      <div>
        <p>Terminating processes</p>
      </div>
      <div>
        <p>When the daemon is being gracefully terminated (usually by running <code>/etc/init.d/newrelic-daemon stop</code>), it will send a termination signal to the watchdog process. This will cleanly terminate the worker process and give it a chance to send any pending data to New Relic.</p>
        <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
          <p>If you need to manually terminate the daemon, always terminate the watchdog, not the worker.</p>
        </div>
        <p>If the worker process encounters a fatal error and terminates unexpectedly, the watchdog process will immediately re-spawn a new worker process. This helps to ensure that the daemon experiences absolute minimum downtime.</p>
      </div>
    </div>
  </div>
</div>
<h2>Stop the daemon [#killing]</h2>
<p>The following methods can be used to kill the daemon:</p>
<ul>
  <li>
    <p><strong>Recommended process:</strong> Use <code>/etc/init.d/newrelic-daemon stop</code>. This is the preferred method for interacting with the daemon.</p>
  </li>
  <li>
    <p>Kill the process directly with its process ID:</p>
    <pre><code>kill 1368
</code></pre>
  </li>
  <li>
    <p>Use the watchdog PID file:</p>
    <pre><code>kill `cat /var/run/newrelic-daemon.pid`
</code></pre>
  </li>
</ul>
