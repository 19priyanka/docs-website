
<p>This document explains how to install APM's .NET agent on Microsoft's Azure Cloud Services platform. This is not the same as installing the <a href="/docs/integrations/microsoft-azure-integrations/getting-started/introduction-azure-monitoring-integrations">Infrastructure integrations for Microsoft Azure</a>. To make sure you are using the most relevant instructions, first see the <a href="/docs/agents/net-agent/installation/install-enable-new-relic-net-agent">.NET agent install overview</a>.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Before installing the NuGet package into a multi-project Visual Studio solution, make sure you have selected the correct project for your New Relic .NET application (for example, a specific website project).</p>
</div>
<h2>Check Web or Worker role's location [#web-worker-role]</h2>
<p>If <strong>Service</strong> files are nested within a <strong>Solution</strong> folder, the NuGet installer cannot locate or update the necessary files. This will cause issues with the .NET agent setup, which will in turn prevent the agent from reporting metrics on your Cloud Service.</p>
<p><strong>Recommendation:</strong> Place the <code>Web</code> or <code>Worker</code> role at the <strong>root</strong> of the solution before installing the NuGet package. Once the New Relic .NET agent is installed, you can move the Cloud role back into the <strong>Solution</strong> folder.</p>
<h2>Install the NuGet package for Cloud Services [#install_cloud_nuget]</h2>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>The NuGet packages in this procedure support only the old <code>packages.config</code>. They do not support the new <code>PackageReference</code> format. For more information see <a href="https://docs.microsoft.com/en-us/nuget/consume-packages/package-references-in-project-files">Microsoft's package reference documentation</a></p>
</div>
<p>For multi-project solutions, make sure you have selected the correct project (for example, a specific website project) before installing the NuGet package.</p>
<ol>
  <li>Open your Visual Studio solution, or create a new one by selecting <strong>File > New > Project</strong>. For multi-project solutions, make sure you have selected the correct project (for example, a specific website project).</li>
  <li>If you do not already have an Azure Cloud Service project in your solution, add one by right-clicking your app in the <strong>Solution Explorer</strong> and selecting <strong>Add Windows Azure Cloud Service Project</strong>.</li>
  <li>Open the <strong>Package Manager</strong> console by selecting <strong>Tools > Library Package Manager > Package Manager Console</strong>. Set your project as the default project.</li>
  <li>From the <strong>Package Manager</strong> command prompt, type <code>Install-Package NewRelicWindowsAzure</code> and press <strong>Enter</strong>.</li>
  <li>Follow the prompts to enter your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">New Relic license key</a> and your <a href="/docs/agents/net-agent/installation-configuration/name-your-net-application">application name</a> as you want it to appear in the New Relic UI. Or, use your solution name as the default app name.</li>
  <li>From the <strong>Solution Explorer</strong>, right-click your Azure Cloud Service project, and select <strong>Publish</strong>.</li>
  <li>If this is your first time deploying this app to Azure, enter your Azure credentials.</li>
  <li>If applicable, instrument methods for <code>Worker</code> roles.</li>
</ol>
<h2>Instrument Worker role [#requirements]</h2>
<p>A <code>Worker</code> role is a non-web process run as an Azure Cloud Service. To instrument a <code>Worker</code> role, you must create <a href="/docs/agents/net-agent/instrumentation/net-custom-transactions">custom transactions</a>.</p>
<p>The .NET agent automatically instruments external calls and database calls, but it does not instrument default methods for transactions. Creating custom transactions solves this. After the <code>Worker</code> role starts up and the method executes, transaction data will appear in the APM <strong>Summary</strong> and <strong>Transactions</strong> pages under the <a href="/docs/apm/transactions/intro-transactions/monitor-background-processes-other-non-web-transactions"><strong>Non-web</strong> category</a>.</p>
<p>The NuGet installer automatically adds the <code>NewRelic.AppName</code> parameter to the application config. This appears as <code>&#x3C;YOUR_WORKER_ROLE_NAME>.dll.config</code> in <code>E:\approot</code>.</p>
<p>The .NET agent also automatically instruments <code>WaWorkerHost.exe</code>. This is the name of the actual <code>Worker</code> role process.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY3VzdG9tLXRyYW5zYWN0aW9ucyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiQ3VzdG9tIGluc3RydW1lbnRhdGlvbiBleGFtcGxlIGZvciBXb3JrZXIgcm9sZSJ9XQ==">
    <div data-prop-text="title">Custom instrumentation example for Worker role</div>
    <p>This is a custom instrumentation example for a <code>Worker</code> role. It creates a custom transaction named <code>ProcessMessage</code>. The transaction begins when the <code>ProcessMessage</code> method is entered, and it ends when the method returns.</p>
    <p>The following example uses <code>MyWorkerRole</code> as the <code>namespace</code>. If you do not specify a name, it will default to the Solution name.</p>
    <pre><code>namespace MyWorkerRole
{
    public class NotificationQueue
    {
        public bool ProcessMessage(Message message) {
            // code to process message
        }
    }
}

</code></pre>On a local installation, place this instrumentation file in `C:\ProgramData\New Relic\.NET Agent\Extensions`.
    <pre><code>
&#x3C;?xml version="1.0" encoding="utf-8"?>
&#x3C;extension xmlns="urn:newrelic-extension">
  &#x3C;instrumentation>
    &#x3C;tracerfactory name="NewRelic.Agent.Core.Tracer.Factories.BackgroundThreadTracerFactory" metricName="Custom/ProcessMessage">
      &#x3C;match assemblyname="MyWorkerRole" classname="MyWorkerRole.NotificationQueue">
        &#x3C;exactmethodmatcher methodName="ProcessMessage" />
      &#x3C;/match>
    &#x3C;/tracerfactory>
  &#x3C;/instrumentation>
&#x3C;/extension>

</code></pre>Here is the custom instrumentation file for the code:
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic2VuZC1maWxlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJDdXN0b20gaW5zdHJ1bWVudGF0aW9uIGZpbGUgZGVwbG95bWVudCJ9XQ==">
    <div data-prop-text="title">Custom instrumentation file deployment</div>
    <p>Optional: To send the custom instrumentation file up with an Azure Cloud Service deployment:</p>
    <ol>
      <li>
        <p>In your Azure Cloud project, add the instrumentation file to your <code>Worker</code> role inside the <strong>Roles</strong> folder.</p>
      </li>
      <li>
        <p>After installing the New Relic .NET agent NuGet package, locate <code>newrelic.cmd</code> in your Worker Role project.</p>
      </li>
      <li>
        <p>Find the statement <code>IF %ERRORLEVEL% EQU 0</code> within the <code>:INSTALL_NEWRELIC_AGENT</code> block, and add the following statement to the conditional:</p>
        <pre><code>IF %ERRORLEVEL% EQU 0 (
      copy /Y "%RoleRoot%\approot\MyInstrumentation.xml" "%NR_HOME%\extensions" >> %RoleRoot%\nr.log
    ) ELSE (
</code></pre>
        <p>In this example, the <code>newrelic.cmd</code> batch file copies the custom instrumentation file to the <strong>Extensions</strong> folder in <code>D:\ProgramData\New Relic\.NET Agent\</code>, or <code>%NR_HOME%</code>. This example uses <code>MyInstrumentation.xml</code>, but any name will work as long as the file name and copy command match, and the file is valid XML.</p>
      </li>
    </ol>
  </div>
</div>
<h2>Optional: Create custom config file [#custom_config_file]</h2>
<p>You can create a custom configuration file in Visual Studio. This allows you to make changes to <code>newrelic.config</code> inside Visual Studio, without having to remote into your Azure Role instance every time you make a change. Whenever you publish your app, the config file in Visual Studio is automatically uploaded to the remote host.</p>
<p>The choices you make with the installation wizard do not matter. Installing locally does not affect your Azure development environment.</p>
<ol>
  <li>
    <p>In Visual Studio, select the <strong>Solution Explorer</strong>, then open <code>NewRelicAgent_x64_XYZ.msi</code>.</p>
  </li>
  <li>
    <p>Follow the steps to install the agent locally.</p>
  </li>
  <li>
    <p>Import <code>newrelic.config</code> into your project: In <strong>Solution Explorer > Cloud Project</strong>, right-click the <strong>Web Role</strong>, then select <strong>Add > Existing Item</strong>. Navigate to <strong>C:\ProgramData\New Relic\.NET Agent</strong> and select <code>newrelic.config</code>.</p>
  </li>
  <li>
    <p>From <strong>C:\ProgramData\New Relic\.NET Agent</strong>, edit <code>newrelic.cmd</code>.</p>
  </li>
  <li>
    <p>In the <code>:INSTALL_NEWRELIC_AGENT</code> section, find this statement:</p>
    <pre><code>IF $ERRORLEVEL% EQU 0 (
</code></pre>
  </li>
  <li>
    <p>Add the following code as another statement inside the <code>IF</code> block, then save the file:</p>
    <pre><code>copy /Y "%RoleRoot%\approot\newrelic.config" "%NR_HOME%" >> %RoleRoot%\nr.log
</code></pre>
  </li>
</ol>
<p>You can now edit the <code>newrelic.config</code> hosted in Visual Studio. Whenever you publish your app, the <code>copy</code> command will upload the config file to the remote host.</p>
<h2>View your app's performance [#checking-application-performance]</h2>
<p>Your application must receive traffic in order for you to view its performance in New Relic. You may need to wait a few minutes for data to start appearing. If no data appears, see the <a href="/docs/agents/net-agent/azure-troubleshooting/azure-cloud-services-no-data-appears">troubleshooting procedures</a> for Azure Cloud Services.</p>
<p>To view your app's performance in APM: Go to <strong><a href="https://one.newrelic.com">one.newrelic.com</a> > APM > (select an app)</strong>. The <a href="/docs/apm/applications-menu/monitoring/apm-overview-page">APM <strong>Summary</strong> page</a> automatically appears. You can also view detailed information about <a href="/docs/apm/applications-menu/error-analytics/introduction-error-analytics">errors</a>, <a href="/docs/apm/applications-menu/features/analyze-database-instance-level-performance-issues">database and instance performance issues</a>, and <a href="/docs/apm/new-relic-apm/getting-started/introduction-new-relic-apm">more</a>.</p>
<p>If you created your New Relic app prior to October 2017, you can use the Azure Portal to select the New Relic account blade. You will be automatically logged in with <a href="/docs/accounts-partnerships/accounts/saml-single-sign/new-relic-partners-saml-sso">SAML Single Sign-on (SSO)</a> to APM. You can also view your application's error rate and throughput data in the Azure Portal by going to <strong>New Relic Accounts > choose your application</strong>.</p>
