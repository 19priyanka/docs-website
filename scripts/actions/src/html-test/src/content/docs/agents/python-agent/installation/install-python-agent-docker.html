
<p>You can use the Python agent to instrument Python applications deployed in Docker containers. This document will show you how to build, configure, and deploy an instrumented version of your Dockerized Python application.</p>
<h2>Build your instrumented container [#build]</h2>
<p>This Dockerfile provides a base for your Python Docker image by installing the Python agent. You can customize it by changing the <code>FROM</code> instruction, for example to use another version of Python or a different Linux distribution.</p>
<ol>
  <li>
    <p>To get started, copy the code block below and save it as a new Dockerfile in your directory.</p>
    <pre><code>FROM python:3.6-alpine

RUN pip install --no-cache-dir newrelic

ENTRYPOINT ["newrelic-admin", "run-program"]
</code></pre>
  </li>
  <li>
    <p>Build the base image:</p>
    <pre><code>$ docker build -t python_newrelic:latest .
</code></pre>
  </li>
  <li>
    <p>You can use the new image as the base for your own Dockerfile, replacing your <code>FROM</code> line with <code>FROM python_newrelic:latest</code>. You'll need to put your app's command line in a <code>CMD</code> instruction, not in <code>ENTRYPOINT</code>, so that the <code>newrelic-admin</code> program can start it. For example:</p>
    <pre><code>CMD ["gunicorn", "-b :5000", "myapp:app"]
</code></pre>
  </li>
  <li>
    <p>To enable the agent, you'll need to configure it with environment variables. The <code>NEW_RELIC_LICENSE_KEY</code> and <code>NEW_RELIC_APP_NAME</code> variables are required. If you use <code>docker run</code>, for example, you can add <code>-e</code> options:</p>
    <pre><code>$ docker run -e NEW_RELIC_LICENSE_KEY=YOUR_LICENSE_KEY \
        -e NEW_RELIC_APP_NAME="YOUR APPLICATION NAME" \
        INSTRUMENTED_IMAGE_NAME
</code></pre>
    <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
      <p>If you're using <code>docker-compose</code>, you can use <a href="https://docs.docker.com/engine/swarm/secrets/#use-secrets-in-compose">secrets</a> to manage your license key.</p>
    </div>
  </li>
</ol>
<h2>Configure the agent [#configure]</h2>
<p>When configuring the agent, you have two options:</p>
<ul>
  <li><a href="#run-time-config">Recommended: Set the configuration with environment variables</a></li>
  <li><a href="#config-file">Use a configuration file</a></li>
</ul>
<h3>Recommended: Set the configuration with environment variables [#run-time-config]</h3>
<p>You can configure most agent settings with environment variables. You can do this at run time with the <code>-e</code> parameter to <code>docker run</code>, for example:</p>
<pre><code>$ docker run -e NEW_RELIC_APP_NAME="A Different App" \
        -e NEW_RELIC_LOG=stdout \
        -e NEW_RELIC_DISTRIBUTED_TRACING_ENABLED=true \
        -e NEW_RELIC_LICENSE_KEY=YOUR_LICENSE_KEY \ 
        INSTRUMENTED_IMAGE_NAME
</code></pre>
<p>Or you can include environment variables in your Dockerfile:</p>
<pre><code>ENV NEW_RELIC_LOG=stdout \
    NEW_RELIC_DISTRIBUTED_TRACING_ENABLED=true \
    NEW_RELIC_APP_NAME="My Application"
    # etc.
</code></pre>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>We <strong>strongly</strong> recommend not putting your license key in your Dockerfile or Docker image. Instead, set it at run time with the <code>-e</code> option.</p>
</div>
<h3>Use a configuration file [#config-file]</h3>
<p>When you can't or don't want to set options with environment variables, you can do this with a configuration file.</p>
<p>If you want to configure the Python agent with a configuration file, you can either add your <code>newrelic.ini</code> file to your Docker image at build time or <a href="https://docs.docker.com/storage/bind-mounts/">mount the file at run time</a>. The file needs to be placed in your app's root directory.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>If you choose to use file-based configuration, you <strong>must</strong> remove the <code>license_key</code> setting in the file, and any other settings you want to set with environment variables. Otherwise, the default value in the file will override the environment variable. We <strong>strongly</strong> recommend not including your license key in the Docker image.</p>
</div>
<ol>
  <li>
    <p>Generate or download the <code>newrelic.ini</code> file described in the <a href="https://docs.newrelic.com/docs/agents/python-agent/configuration/python-agent-configuration#agent-configuration-file">Python agent configuration docs</a>.</p>
  </li>
  <li>
    <p>Edit the <code>newrelic.ini</code> file to configure your settings. See the <a href="https://docs.newrelic.com/docs/agents/python-agent/configuration/python-agent-configuration">Python agent configuration documentation</a> for more details.</p>
  </li>
  <li>
    <p>Chose one of the following options:</p>
    <ul>
      <li>
        <p>Option 1: <code>ADD</code> the <code>newrelic.ini</code> file to your Docker image at build time. Add this line to your Dockerfile, replacing the placeholder with the path to your app (either relative to your <code>WORKDIR</code> or absolute) and build it you normally would.</p>
        <pre><code>ADD newrelic.ini /PATH/TO/YOUR/APP
</code></pre>
      </li>
      <li>
        <p>Option 2: Mount the <code>newrelic.ini</code> file at run time. Add the <code>-v</code> switch below to your <code>docker run</code> command, replacing <code>/PATH/TO/YOUR/APP</code> with the <em>absolute</em> path to your app's base directory in the Docker image.</p>
        <pre><code>$ docker run -v /local/path/to/newrelic.ini:/PATH/TO/YOUR/APP/newrelic.ini \
        -e NEW_RELIC_LICENSE_KEY=YOUR_LICENSE_KEY \
         INSTRUMENTED_IMAGE_NAME
</code></pre>
      </li>
    </ul>
  </li>
</ol>
