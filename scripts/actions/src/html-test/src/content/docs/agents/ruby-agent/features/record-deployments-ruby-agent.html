
<p>The <a href="/docs/agents/ruby-agent/getting-started/new-relic-ruby">New Relic Ruby agent</a> allows you to send information about application deployments by using the <a href="/docs/apm/new-relic-apm/maintenance/recording-deployments">REST API</a> or a Capistrano recipe (versions 2.x and 3.x) distributed with the Ruby agent. You can then <a href="/docs/apm/applications-menu/events/deployments-page">view deployments in the New Relic UI</a>. By default, all deployment information is recorded in your production environment. You can also customize the <code>rails_env</code> variable for other environments, such as staging.</p>
<h2>Assign an application name [#Installation]</h2>
<p>To assign an application name:</p>
<ol>
  <li>Download the <a href="/docs/release-notes/agent-release-notes/ruby-release-notes">latest version</a> of the Ruby agent.</li>
  <li>Set the <code>app_name</code> in your <code>newrelic.yml</code> file to a <a href="/docs/apm/new-relic-apm/installation-and-configuration/naming-your-application">meaningful name</a>.</li>
</ol>
<p>This will assign instances in the given environment the label given by <code>app_name</code> when browsing your data in the New Relic user interface. The deployment upload script will use that label to associate an app with the deployment.</p>
<h2>Record with the command line [#Manual]</h2>
<p>If you installed the Ruby agent as a gem, you can record deployments directly by using the <code>newrelic</code> executable:</p>
<pre><code>newrelic deployments
</code></pre>
<p>Depending on your environment, you may need to run:</p>
<pre><code>$bundle exec newrelic deployment
</code></pre>
<p>You can use several optional values with <code>newrelic</code>. The <code>description</code> is short text.</p>
<pre><code>deployments [OPTIONS] [description] 
OPTIONS:
   -a, --appname=name           Set the application name.
                                Default is app_name setting in newrelic.yml
   -e, --environment=name       Override the (RAILS|MERB|RUBY)_ENV setting
   -u, --user=USER              Specify the user deploying.
   -r, --revision=REV           Specify the revision being deployed
   -c, --changes                Read in a change log from the standard input
   -h                           Print this help
</code></pre>
<p>When using the <code>-c</code> option, you can pipe the change log into the script. If not piping when using the <code>-c</code> option, select <code>control-D</code> to signify the end of file (EOF).</p>
<h2>Record with Capistrano 3.x [#capistrano3]</h2>
<p>The New Relic Ruby agent contains a Capistrano recipe that can record app deployments. After <a href="#Installation">assigning your app name</a>, edit your Capistrano files to communicate with the agent:</p>
<ol>
  <li>
    <p>At the top of your Capfile, add the following line:</p>
    <pre><code>require 'new_relic/recipes'
</code></pre>
  </li>
  <li>
    <p>In your <code>deploy.rb</code> file, include:</p>
    <pre><code>after "deploy:updated", "newrelic:notice_deployment"
</code></pre>
  </li>
</ol>
<h2>Record with Capistrano 2.x [#capistrano2]</h2>
<p>You can record Capistrano 2.x deployments with the New Relic agent:</p>
<ol>
  <li>
    <p>Tell Capistrano to load New Relic's recipes:</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaW5zdGFsbGVkLXdpdGgtZ2VtIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJJZiBhZ2VudCB3YXMgaW5zdGFsbGVkIHdpdGggTmV3IFJlbGljIGdlbSJ9XQ==">
        <div data-prop-text="title">If agent was installed with New Relic gem</div>
        <p>Add this at the top of your <code>deploy.rb</code> file:</p>
        <pre><code>require 'new_relic/recipes'

</code></pre>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaW5zdGFsbGVkLWFzLXJhaWxzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJJZiBhZ2VudCB3YXMgaW5zdGFsbGVkIGFzIFJhaWxzIHBsdWdpbiJ9XQ==">
        <div data-prop-text="title">If agent was installed as Rails plugin</div>
        <p>In your Capfile, add the following line above <code>load deploy.rb</code> (if it is not already there):</p>
        <pre><code>Dir['vendor/plugins/*/recipes/*.rb'].each { |plugin| load(plugin) }

</code></pre>
      </div>
    </div>
  </li>
  <li>
    <p>Add the following hooks to your <code>deploy.rb</code> file:</p>
    <pre><code># Notify New Relic of deployments.
# This goes out even if the deploy fails, sadly.
after "deploy",            "newrelic:notice_deployment"
after "deploy:migrations", "newrelic:notice_deployment"
after "deploy:cold",       "newrelic:notice_deployment"
</code></pre>
  </li>
</ol>
<p>The next time you run <code>cap deploy</code>, the agent notifies New Relic of the deployment, and all time series charts will show the deployment event.</p>
<h2>Customize your Capistrano configuration [#customizing]</h2>
<p>If Capistrano is running the deployment notification recipe on a remote build machine,the build machine <strong>must</strong> have your <a href="/docs/accounts/install-new-relic/account-setup/license-key">New Relic License key</a>. You can either copy a valid <code>newrelic.yml</code> file to the build machine (possibly using a Capistrano <a href="https://capistranorb.com/documentation/getting-started/before-after/">Before Hook</a>) or call <code>set :newrelic_license_key, 'YOUR_LICENSE_KEY'</code> in your Capistrano configuration.</p>
<p>You can customize some deployment information by using Capistrano variables. If defined, these will override the defaults. These apply to both Capistrano 2 and 3.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Capistrano 2 and 3 variables</p>
      </div>
      <div>
        <p>Description</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p><code>newrelic_appname</code></p>
      </div>
      <div>
        <p>The app where the deployment will appear. By default this comes from the definition in the <code>newrelic.yml</code> file for the given <code>rails_env</code>.</p>
        <p>If you set this value from the command line, you can only specify one application name. If you set this value in <code>newrelic.yml</code>, only the first application name will be used.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>newrelic_changelog</code></p>
      </div>
      <div>
        <p>The change log, which is determined by running the svn/git <code>log</code> command from the local working directory where the Capistrano command was issued.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>newrelic_desc</code></p>
      </div>
      <div>
        <p>Descriptive text that appears with the deployment. Default is empty.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>newrelic_license_key</code></p>
      </div>
      <div>
        <p>The New Relic <a href="/docs/accounts/install-new-relic/account-setup/license-key">license key</a> to use. By default this comes from the definition in the <code>newrelic.yml</code> file for the given <code>rails_env</code>. This is <strong>not</strong> the same as your <a href="/docs/apis/getting-started/intro-apis/access-rest-api-keys">REST API key</a>.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>newrelic_revision</code></p>
      </div>
      <div>
        <p>The revision recorded for the deployment. <strong>Recommendation:</strong> If you are using Subversion, consider including the tag or branch name in addition to the revision.</p>
      </div>
    </div>
    <div>
      <div>
        <p><code>newrelic_user</code></p>
      </div>
      <div>
        <p>The user to associate with the deployment.</p>
      </div>
    </div>
  </div>
</div>
<h2>Override Capistrano settings [#override]</h2>
<p>In any version of Capistrano, you can override settings in your <code>deploy.rb</code>:</p>
<pre><code>set :newrelic_user, "username"
</code></pre>
<p>To override settings with Capistrano 2.x: From the command line:</p>
<pre><code>cap production deploy -Snewrelic_desc="Deploying beta Krakatau release"
</code></pre>
<p>This example will prompt for content that will appear in the deployment's change log:</p>
<pre><code>set(:newrelic_changelog) do
  Capistrano::CLI.ui.ask "Enter a summary of changes: "
end
</code></pre>
<h2>Deploy to staging [#staging]</h2>
<p>By default, the <code>newrelic_rpm</code> gem comes with Capistrano tasks to record all deployments in your production environment. If you have a separate staging application, you can change the <code>rails_env</code> variable setting so that staging deployments are recorded in the staging app instead of the production app.</p>
<p>To identify deployments to your staging environment, use Capistrano or the command line.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Deploy to staging</p>
      </div>
      <div>
        <p>Comments</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Capistrano multistage</p>
      </div>
      <div>
        <p>If you are using Capistrano multistage, add this line to <code>config/deploy/staging.rb</code>:</p>
        <pre><code>set :rails_env, "staging"

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Capistrano 2.x</p>
      </div>
      <div>
        <p>If you are using Capistrano 2.x, add this information from the command line:</p>
        <pre><code>cap -s rails_env=staging deployment_task_name

</code></pre>
      </div>
    </div>
  </div>
</div>
