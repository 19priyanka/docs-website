
<p>New Relic's .NET agent automatically includes asynchronous framework instrumentation as of agent <a href="/docs/release-notes/agent-release-notes/net-release-notes">version 6.0</a>. With the standard <code>async-await</code> pattern, introduced in .NET 4.5, calls to async methods can return even though the work being done in the called method is still in progress. The .NET agent observes this in-progress asynchronous work and waits for it to complete before recording timings.</p>
<h2>Features supporting async instrumentation [#features]</h2>
<p>With the addition of async support, new features are available in New Relic's .NET agent. However, as part of this enhancement, a small number of features previously provided by the agent currently are not available. Except as noted, the agent does not instrument async methods for any of the other <a href="/docs/agents/net-agent/getting-started/compatibility-requirements-net-agent">supported frameworks</a> for the .NET agent.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiSHR0cENsaWVudCJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiSHR0cENsaWVudCBhc3luYyBtZXRob2RzIn1d">
    <div data-prop-text="title">HttpClient async methods</div>
    <p>The agent instruments these <code>HttpClient</code> async methods:</p>
    <ul>
      <li><code>SendAsync</code></li>
      <li><code>GetAsync</code></li>
      <li><code>PostAsync</code></li>
      <li><code>PutAsync</code></li>
      <li><code>DeleteAsync</code></li>
      <li><code>GetStringAsync</code></li>
      <li><code>GetStreamAsync</code></li>
      <li><code>GetByteArrayAsync</code></li>
    </ul>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiUmVzdENsaWVudCBhc3luYyBtZXRob2RzIn1d">
    <div data-prop-text="title">RestClient async methods</div>
    <p>The agent instruments these <code>RestClient</code> async methods:</p>
    <ul>
      <li><code>ExecuteTaskAsync</code></li>
      <li><code>ExecuteGetTaskAsync</code></li>
      <li><code>ExecutePostTaskAsync</code></li>
    </ul>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiU3FsQ29tbWFuZCJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiU3FsQ29tbWFuZCBhc3luYyBtZXRob2RzIn1d">
    <div data-prop-text="title">SqlCommand async methods</div>
    <p>The agent instruments these <code>SqlCommand</code> async methods:</p>
    <ul>
      <li><code>ExecuteReaderAsync</code></li>
      <li><code>ExecuteNonQueryAsync</code></li>
      <li><code>ExecuteScalarAsync</code></li>
      <li><code>ExecuteXmlReaderAsync</code></li>
    </ul>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiU3FsRGF0YVJlYWRlciJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiU3FsRGF0YVJlYWRlciBhc3luYyBtZXRob2RzIn1d">
    <div data-prop-text="title">SqlDataReader async methods</div>
    <p>The agent instruments these <code>SqlDataReader</code> async methods:</p>
    <ul>
      <li><code>NextResultAsync</code></li>
      <li><code>ReadAsync</code></li>
    </ul>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiTnBnc3FsQ29tbWFuZCJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiTnBnc3FsQ29tbWFuZCBhc3luYyBtZXRob2RzIChQb3N0Z3JlcykifV0=">
    <div data-prop-text="title">NpgsqlCommand async methods (Postgres)</div>
    <p>The agent instruments these <code>NpgsqlCommand</code> async methods (Postgres):</p>
    <ul>
      <li><code>ExecuteReaderAsync</code></li>
      <li><code>ExecuteNonQueryAsync</code></li>
      <li><code>ExecuteScalarAsync</code></li>
    </ul>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY3VzdG9tLWluc3RydW1lbnRhdGlvbiJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiQ3VzdG9tIGluc3RydW1lbnRhdGlvbiJ9XQ==">
    <div data-prop-text="title">Custom instrumentation</div>
    <p>The .NET agent supports <a href="/docs/agents/net-agent/instrumentation/net-custom-transactions#example-custom-txn-async">custom instrumentation</a> of your own async methods.</p>
  </div>
</div>
<h2>Known limitations [#known-issues]</h2>
<p>Here is a summary of known limitations for async instrumentation with New Relic's .NET agent.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYmVnaW4tZW5kLXN0eWxlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJSZXF1aXJlcyB1cGRhdGVkIEFTUCBwaXBlbGluZSJ9XQ==">
    <div data-prop-text="title">Requires updated ASP pipeline</div>
    <p>The .NET agent will not instrument async methods if the legacy ASP pipeline is present. Since Microsoft replaced the legacy ASP pipeline well before async methods were introduced, this issue typically only affects applications created under .NET Framework 4.0 or lower, then migrated to .NET Framework 4.5 or higher. To see if this issue affects your application, and how to resolve it if it does, <a href="/docs/agents/net-agent/troubleshooting/missing-async-metrics">review the troubleshooting procedures</a>.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiSW5zdHJ1bWVudGVkIGFzeW5jIG1ldGhvZHMgbXVzdCBoYXZlIHJldHVybiB0eXBlIG9mIFRhc2sgb3IgVGFzazxUPiwgbm90IHZvaWQifV0=">
    <div data-prop-text="title">Instrumented async methods must have return type of Task or Task&#x3C;T>, not void</div>
    <p>The .NET agent does not support instrumentation of async methods that have return type of anything other than <code>Task</code> or <code>Task&#x3C;T></code>. The agent does not support <code>async void</code> methods.</p>
    <p>For more information, refer to the Microsoft documentation about <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/async-return-types">async return types</a>:</p>
    <ul>
      <li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/async-return-types#BKMK_TaskTReturnType">Task&#x3C;TResult></a> return type</li>
      <li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/async-return-types#BKMK_VoidReturnType">Async void</a> and <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/async-return-types#generalized-async-return-types-and-valuetasktresult">generalized async return types</a></li>
    </ul>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYmVnaW4tZW5kLXN0eWxlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJObyBpbnN0cnVtZW50YXRpb24gZm9yIGJlZ2luKiBhbmQgZW5kKiBzdHlsZSJ9XQ==">
    <div data-prop-text="title">No instrumentation for begin* and end* style</div>
    <p>The .NET agent does not instrument any .NET methods that use the <code>begin*</code> and <code>end*</code> style, except for <a href="https://docs.microsoft.com/en-us/dotnet/framework/wcf/feature-details/how-to-call-wcf-service-operations-asynchronously">WCF applications</a>. Outside of this exception, if your application calls these types of methods, the agent will not create segments for them. However, the rest of your transactions and segments will be created correctly.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibWFudWFsLWNyZWF0ZWQtdGhyZWFkcy1jYXB0dXJlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJObyBjYXB0dXJlIG9mIHNjb3BlZCBtZXRyaWNzL3NlZ21lbnRzIGluIG1hbnVhbGx5IGNyZWF0ZWQgdGhyZWFkcyJ9XQ==">
    <div data-prop-text="title">No capture of scoped metrics/segments in manually created threads</div>
    <p>The .NET agent does not capture scoped metrics or segments within threads that are manually created by your application.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYXN5bmMtYXdhaXQifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkZvciBpbnN0cnVtZW50ZWQgYXN5bmMgbWV0aG9kcywgdXNlIGF3YWl0LCBub3QgVGFzay5SZXN1bHQoKSJ9XQ==">
    <div data-prop-text="title">For instrumented async methods, use await, not Task.Result()</div>
    <p>If your application calls instrumented async methods, use <code>await</code> rather than <code>Task</code> related methods like <code>Task.Result()</code> to wait for the results. Otherwise, instrumentation may not work properly.</p>
    <p>In general, avoid using <code>Task.Result()</code> when calling async methods. It can lead to <a href="http://blog.stephencleary.com/2012/07/dont-block-on-async-code.html">deadlocks</a>.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29udGludWUtd2l0aC10aW1pbmcifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkNvbnRpbnVlV2l0aCh7fSkgYmxvY2sgbWF5IGFmZmVjdCB0aW1pbmcgbWVhc3VyZW1lbnRzIn1d">
    <div data-prop-text="title">ContinueWith({}) block may affect timing measurements</div>
    <p>If you add your own <code>ContinueWith({})</code> block to the promise returned by an instrumented async method, it may affect timing measurements reported by the instrumentation. For example, the time may include the time your <code>ContinueWith</code> takes to execute.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaWlzLXdjZi1uZXN0aW5nIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJQcm9ibGVtIHdpdGggbmVzdGluZyBpbiBJSVMtaG9zdGVkIFdDRiBhcHBzIn1d">
    <div data-prop-text="title">Problem with nesting in IIS-hosted WCF apps</div>
    <p>IIS-hosted <a href="/docs/agents/net-agent/instrumentation/instrumenting-wcf-applications">WCF services</a> do not properly nest the <strong>WCF</strong> segment under the <code>ExecuteRequestHandler</code> segment. The two segments will appear to be siblings within a transaction trace, even though their reported <a href="/docs/data-analysis/user-interface-functions/response-time#response-time-total-time">total time</a> will be accurate.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic3RhY2stdHJhY2VzLXNlZ21lbnRzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJTZWdtZW50cyBkb24ndCBhdXRvLWNyZWF0ZSBzdGFjayB0cmFjZXMifV0=">
    <div data-prop-text="title">Segments don't auto-create stack traces</div>
    <p>Segments in a transaction trace will not generate stack traces automatically, even if they run longer than <code>transaction_tracer.stack_trace_threshold</code>.</p>
  </div>
</div>
