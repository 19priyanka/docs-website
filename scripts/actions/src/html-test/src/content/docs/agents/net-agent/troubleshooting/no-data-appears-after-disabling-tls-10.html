
<h2>Problem</h2>
<p>No data appears in New Relic after disabling TLS 1.0. You checked if TLS 1.0 is disabled by inspecting the following registry key:</p>
<pre><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Client
</code></pre>
<p>TLS 1.0 is disabled if <code>"Enabled"</code> is set to <code>0</code> and <code>"DisabledByDefault"</code> is set to <code>1</code>.</p>
<p>Also, you also may have noticed an error message in the New Relic Agent logs due to this problem; for example:</p>
<ul>
  <li>
    <pre><code>NewRelic ERROR: Unable to connect to the New Relic service at collector.newrelic.com:443 : System.Net.WebException: 
The request was aborted: Could not create SSL/TLS secure channel.
</code></pre>
  </li>
  <li>
    <pre><code>NewRelic ERROR: Unable to connect to the New Relic service at collector.newrelic.com:443 : System.Net.WebException: 
The underlying connection was closed: An unexpected error occurred on a send. ---> System.IO.IOException: 
Received an unexpected EOF or 0 bytes from the transport stream.
</code></pre>
  </li>
  <li>
    <pre><code>NewRelic ERROR: Unable to connect to the New Relic service at collector.newrelic.com:443 : System.Net.WebException: 
The underlying connection was closed: An unexpected error occurred on a receive. ---> System.ComponentModel.Win32Exception: 
The client and server cannot communicate, because they do not possess a common algorithm.
</code></pre>
  </li>
</ul>
<h2>Solution</h2>
<p>The New Relic .NET agent requires at least one version of TLS to be enabled. For TLS 1.1/1.2 it also requires .NET to be configured to use it.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>If you set a TLS version as default, it will be used by both the application and the New Relic agent. You cannot use a different TLS version for each.</p>
</div>
<p>To enable a specific TLS version protocol:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoid2luZG93cy1yZWdpc3RyeSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiU3RlcCAxLiBFbmFibGUgVExTIHByb3RvY29scyBpbiBXaW5kb3dzIHJlZ2lzdHJ5LiJ9XQ==">
    <div data-prop-text="title">Step 1. Enable TLS protocols in Windows registry.</div>
    <p>Older versions of Windows Server (2008/2012) may not have TLS 1.1/1.2 support enabled by default.</p>
    <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJjYXV0aW9uIn1d">
      <p>Follow these steps carefully. Serious problems may occur if you modify the registry incorrectly. <strong>Recommendation:</strong> Before you modify the registry, make a backup.</p>
    </div>
    <p>Here's an example of how to update Windows registry to TLS 1.2. This requires TLS to be enabled for the <strong>Client</strong> role, because your server is connecting as a client to New Relic.</p>
    <ol>
      <li>
        <p>Copy and paste the following into a file:</p>
        <pre><code>Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2]

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Client]
"DisabledByDefault"=dword:00000000
"Enabled"=dword:00000001
</code></pre>
      </li>
      <li>
        <p>Save the file with a <code>.reg</code> extension.</p>
      </li>
      <li>
        <p>Run the script.</p>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoid2luZG93cy1yZWdpc3RyeSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiU3RlcCAyLiBUdXJuIG9uIC5ORVQgZGVmYXVsdCBwcm90b2NvbHMifV0=">
    <div data-prop-text="title">Step 2. Turn on .NET default protocols</div>
    <p>.NET Frameworks 4.5 or lower use protocols SSL v3 and TLS 1.0 by default.</p>
    <p>After you enabled TLS 1.1 or 1.2 via the registry, you still need to change the default protocols used by .NET.</p>
    <p>Choose one of the following options:</p>
    <div data-component="CollapserGroup" data-prop="W10=">
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic3Ryb25nY3J5cHRvIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJFbmFibGUgc3Ryb25nIGNyeXB0byBwcm9wZXJ0eSBpbiBXaW5kb3dzIHJlZ2lzdHJ5In1d">
        <div data-prop-text="title">Enable strong crypto property in Windows registry</div>
        <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJjYXV0aW9uIn1d">
          <p>Follow these steps carefully. Serious problems may occur if you modify the registry incorrectly. <strong>Recommendation:</strong> Before you modify the registry, make a backup.</p>
        </div>
        <p>Adding the <code>SchUseStrongCrypto</code> value to the .NET Framework registry keys will allow all .NET apps to use TLS 1.1 or 1.2. Both regkeys will need to be modified to ensure that both 32bit and 64bit .NET applications are able to use TLS 1.1/1.2.</p>
        <ol>
          <li>
            <p>Copy and paste the following into a file:</p>
            <pre><code>Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\.NETFramework\v4.0.30319] 
"SchUseStrongCrypto"=dword:00000001

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v4.0.30319]
"SchUseStrongCrypto"=dword:00000001
</code></pre>
          </li>
          <li>
            <p>Save the file with a <code>.reg</code> extension.</p>
          </li>
          <li>
            <p>Run the script.</p>
          </li>
        </ol>
      </div>
      <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYXBwLWNvZGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkluY2x1ZGUgcHJvdG9jb2wgaW4geW91ciBhcHAgY29kZSJ9XQ==">
        <div data-prop-text="title">Include protocol in your app code</div>
        <p>You can change .NET's default security protocols by modifying your application's source code. The following command enables TLS 1.2, 1.1, and 1.0 as default protocols for your application. It's a global setting and should be set early in your application's start-up. You can modify it to enable the specific protocols you want.</p>
        <pre><code>System.Net.ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 | SecurityProtocolType.Tls11 | SecurityProtocolType.Tls;

</code></pre>
      </div>
    </div>
  </div>
</div>
<h2>Cause</h2>
<p>If you require a specific version of TLS for external HTTP requests, then you must make sure your application and server are configured correctly. Not having proper configuration can lead to the New Relic .NET agent not being able to connect to New Relic.</p>
<p>New Relic's .NET agent communicates with New Relic servers using standard classes available with .NET for making external HTTP requests. Because the .NET agent code runs alongside your application code, the security protocols used for communicating with New Relic servers depend on your application's environment and configuration.</p>
<p>For more information on correctly configuring your system or application's TLS settings depending on your version of the .NET Framework, review <a href="https://docs.microsoft.com/en-us/dotnet/framework/network-programming/tls">Microsoft's documentation on (TLS) best practices</a>.</p>
