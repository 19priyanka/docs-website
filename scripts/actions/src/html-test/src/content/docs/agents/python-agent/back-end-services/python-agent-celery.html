
<p>If you are using Celery as a distributed task queuing system, you can use the Python agent to record Celery processes as <a href="/docs/apm/transactions/intro-transactions/monitor-background-processes-other-non-web-transactions">non-web transactions</a>.</p>
<p>To get the Python agent working with Celery, first follow the <a href="/docs/agents/python-agent/installation-and-configuration/python-agent-installation">agent installation instructions</a> to install, configure, and <a href="/docs/agents/python-agent/installation-and-configuration/testing-python-agent">test</a> the agent. Then use these Celery-specific instructions.</p>
<h2>Run Celery [#running-with-celery]</h2>
<p>The command you use to run Celery with the agent depends on your Celery version and your specific setup.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicnVuLWNlbGVyeS1jZWxlcnkifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6ImNlbGVyeSJ9XQ==">
    <div data-prop-text="title">celery</div>
    <p>If you use the <code>celery</code> command, include any custom options:</p>
    <pre><code>NEW_RELIC_CONFIG_FILE=/some/path/newrelic.ini newrelic-admin run-program celery YOUR_COMMAND_OPTIONS

</code></pre>
    <pre><code>
NEW_RELIC_CONFIG_FILE=/some/path/newrelic.ini newrelic-admin run-program celery -A tasks worker --loglevel=info

</code></pre>For example:
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicnVuLWNlbGVyeS1jZWxlcnlkIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJjZWxlcnlkIn1d">
    <div data-prop-text="title">celeryd</div>
    <p>The <code>celeryd</code> run command is deprecated in newer Celery releases. If you still use <code>celeryd</code>, include any custom options:</p>
    <pre><code>NEW_RELIC_CONFIG_FILE=some/path/newrelic.ini newrelic-admin run-program celeryd YOUR_COMMAND_OPTIONS

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicnVuLWNlbGVyeS1kamFuZ28ifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkRqYW5nbyJ9XQ==">
    <div data-prop-text="title">Django</div>
    <p>If you start Celery with a Django management command, use <code>manage.py</code>. Replace the <code>celery</code> command with your Django command, and include any custom options:</p>
    <pre><code>NEW_RELIC_CONFIG_FILE=/some/path/newrelic.ini newrelic-admin run-program python manage.py celery YOUR_COMMAND_OPTIONS

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicnVuLWNlbGVyeS1pbml0ZCJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiSW5pdCBzY3JpcHRzIn1d">
    <div data-prop-text="title">Init scripts</div>
    <p>If you are using one of Celery's generic init scripts, edit the script and wrap the <code>celery</code> command that is called when the script is used. This command usually looks like:</p>
    <pre><code>CELERY_BIN=${CELERY_BIN:-"celery"}

</code></pre>With this change, every time `CELERY_BIN` is called, it will be called with the agent wrapper script around the actual `celery` command.
    <pre><code>
CELERY_BIN=${CELERY_BIN:-"NEW_RELIC_CONFIG_FILE=/some/path/newrelic.ini /some/path/bin/newrelic-admin run-program /some/path/bin/celery"}

</code></pre>To add the agentâ€™s wrapper script, change the `CELERY_BIN` variable to the following, where `some/path/` is your actual path to the file or package:
  </div>
</div>
<h2>Select the application name [#selecting-the-application-name]</h2>
<p>The <code>app_name</code> setting in the Python agent configuration file sets the app name displayed in the New Relic One UI.</p>
<ul>
  <li>If your Python agent monitors Celery tasks and you set <code>app_name</code> to the same value used in your application agent's <code>app_name</code>, the data from both sources will be combined in the UI under that name.</li>
  <li>If you set different names, the data appears separately in the UI as two different names.</li>
</ul>
<p>By <a href="/docs/agents/manage-apm-agents/app-naming/use-multiple-names-app">setting multiple app names in the agent config files</a>, you can monitor both the combined data and the segregated data. Here's a common way to do this, using a Django application as an example:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibXVsdGlwbGUtYXBwLW5hbWVzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJVc2luZyBtdWx0aXBsZSBhcHBsaWNhdGlvbiBuYW1lcyJ9XQ==">
    <div data-prop-text="title">Using multiple application names</div>
    <p>For the agent monitoring the Django app, set the following:</p>
    <pre><code>app_name = Your_app_name (Django); Your_app_name (Combined)

</code></pre>This results in three displayed names in the UI:
    * `Your_app_name (Combined)`, which combines data from both Celery and the Django application
    * `Your_app_name (Django)`, which shows the Django app data
    * `Your_app_name (Celery)`, which shows the Celery data
    <pre><code>
app_name = Your_app_name (Celery); Your_app_name (Combined)

</code></pre>For the agent monitoring Celery, set the following:
  </div>
</div>
<h2>Ignore task retry errors [#ignoring-task-retry-errors]</h2>
<p>When using Celery, a task can possibly fail and raise a <code>celery.exceptions:Retry</code> or <code>celery.exceptions:RetryTaskError</code> exception. The exception depends on which version of Celery is used.</p>
<p>To ignore these errors, set this from the New Relic One <strong>Application settings</strong> UI or from the agent config file. UI changes override config file changes per the <a href="/docs/agents/python-agent/installation-configuration/python-agent-configuration#options">configuration precedence rules</a>.</p>
<p>To use ignore error settings from the UI:</p>
<ol>
  <li>From <a href="https://one.newrelic.com">one.newrelic.com</a>, select <strong>APM > (selected app) > Settings > Application</strong>.</li>
  <li>Select <strong>Server-side agent configuration</strong>.</li>
  <li>From <strong>Error collection</strong>, enter the errors you want to ignore, separated by commas.</li>
</ol>
<p>To ignore these errors using the agent config file, use the <a href="/docs/agents/python-agent/installation-configuration/python-agent-configuration#error-ignore"><code>ignore_errors</code></a> setting and a space-separated list of exceptions:</p>
<pre><code>error_collector.ignore_errors = celery.exceptions:Retry celery.exceptions:RetryTaskError
</code></pre>
<h2>Troubleshooting</h2>
<p>When a Celery worker process is killed suddenly, the agent is not able to complete its normal shutdown process, which means its final data payload is not sent. This results in the agent reporting fewer Celery transactions than expected or no transactions at all.</p>
<p>This may occur when using the <code>CELERYD_MAX_TASKS_PER_CHILD</code> setting, which defines the maximum number of tasks a pool worker process can execute before it's replaced with a new one. If used, the worker is forcibly shut down when that limit is reached, which means that that data is not recorded by the agent. For example, if <code>MAX_TASKS_PER_CHILD = 1</code>, this results in no data being reported.</p>
<p>How to troubleshoot this will depend on why you want to use the <code>MAX_TASKS_PER_CHILD</code> limit in your application.</p>
<ul>
  <li>To allow the normal shutdown process, return this to the default no-limit setting.</li>
  <li>To lessen the impact of the problem, raise the <code>MAX_TASKS_PER_CHILD</code> limit.</li>
</ul>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>For version 3.2.2.94 or higher, the Python agent will shut down when the <code>MAX_TASKS_PER_CHILD</code> limit is reached. No data will be lost.</p>
</div>
