
<h2>Problem</h2>
<p>You can configure the Python agent to log output. This configuration allows the agent to track whether it is connecting to New Relic properly and if any errors occur. This information will be useful to New Relic Support if you experience problems.</p>
<h2>Solution</h2>
<p>Detailed <code>debug</code> logging can help troubleshoot your standard Python agent installation.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Some partners use different procedures:</p>
  <ul>
    <li><a href="/docs/agents/python-agent/hosting-services/python-agent-and-heroku#debugging-the-python-agent">Debugging the Python agent with Heroku</a></li>
    <li><a href="/docs/agents/python-agent/hosting-services/python-agent-openshift#debugging-the-python-agent">Debugging the Python Agent with OpenShift</a></li>
  </ul>
</div>
<p>To enable <code>debug</code> logging:</p>
<ol>
  <li>
    <p>Open your <strong>newrelic.ini</strong>, usually located within your app hierarchy.</p>
  </li>
  <li>
    <p>Uncomment <code>#log_file = /tmp/newrelic-python-agent.log</code>. Ensure you have write permissions to the log location, changing the path and file name if necessary. If there is no suitable file location, you can set <code>log_file</code> to <code>stderr</code>.</p>
  </li>
  <li>
    <p>Change <code>log_level</code> to <code>debug</code> (from <code>info</code>).</p>
    <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJjYXV0aW9uIn1d">
      <p>Logging at <code>debug</code> can generate a lot of data very quickly. Monitor the size of your log file closely, changing <code>log_level</code> back to <code>info</code> as you finish troubleshooting.</p>
    </div>
  </li>
  <li>
    <p>Save and close the file. Restart your app for the settings to take affect.</p>
  </li>
  <li>
    <p>Generate a few minutes of traffic to your app.</p>
  </li>
  <li>
    <p>If sending your log file to New Relic Support, attach your <strong>newrelic.ini</strong> to your support ticket, and tell Support your time zone.</p>
  </li>
</ol>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>When troubleshooting your New Relic Python agent, ensure it has been configured to generate debug level log files, and monitor the size of your log file closely. Using <code>log_level = debug</code> generates a lot of data very quickly. After reproducing your problem, return the log file to <code>log_level = info</code>.</p>
</div>
<h3>Log to a file [#logging-to-a-file]</h3>
<p>The agent uses the Python logging module to output log messages. Output from the agent should therefore be factored into the overall logging strategy for your application.</p>
<p>If you are not using the logging module, the agent provides a simplified way to enable a log file for the Python agent. To use this, set the <code>log_file</code> and <code>log_level</code> options in the <a href="/docs/agents/python-agent/installation-and-configuration/python-agent-configuration">agent configuration file</a>.</p>
<p><strong>Example:</strong></p>
<pre><code>log_file = /tmp/newrelic-python-agent.log
log_level = info
</code></pre>
<p>The path provided for <code>log_file</code> should be writable to the user that your application runs as.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>If using <code>Apache/mod_wsgi</code> the Apache user has restricted access to the filesystem. Create a special directory into which the log file can be placed which is writable to the Apache user. Using an absolute path, and not a relative path is recommended.</p>
</div>
<p>The log level used can be one of <code>error</code>, <code>warning</code>, <code>info</code> or <code>debug</code>. Under normal circumstances, use <code>info</code>. More verbose debug options are used for <code>debug</code>. Do not use these verbose debug options for an extended period of time. They can generate excessive output and the log file handler from the logging module is the standard file handler and does not perform any log file rotation.</p>
<h3>Log to standard error [#logging-to-standard-error]</h3>
<p>For some hosting providers, it may not be possible to use a distinct log file for the agent. Configure the logging module to log to standard error output. This output is captured in the normal error log file for your hosting mechanism.</p>
<p>To do this within the agent configuration file, run:</p>
<pre><code>log_file = stderr
log_level = info
</code></pre>
<p>The value <code>stdout</code> may also be used instead of <code>stderr</code>.</p>
<h3>Log all data (audit log) [#audit-log]</h3>
<p>If you need to record and view information about <a href="/docs/agents/manage-apm-agents/configuration/log-audit-all-data-your-new-relic-agent-transmits"><strong>all</strong> data being transmitted</a> between the monitored process and the New Relic collector, you can enable <a href="/docs/agents/python-agent/installation-configuration/python-agent-configuration#audit-log-file">audit logging</a> for short periods of time. This is useful, for example, with debugging or auditing, when you need detailed information about what exactly is being transmitted.</p>
<h3>Troubleshoot log module conflicts [#logging-module-conflicts]</h3>
<p>If no logging is captured, there may be a conflict with the way in which the Python logging module is being initialized and/or configured. Problems may arise using the following functions:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlnLmZpbGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6eyJ0eXBlIjoibWR4VmFsdWVFeHByZXNzaW9uIiwidmFsdWUiOiI8PjxJbmxpbmVDb2RlPmxvZ2dpbmcuY29uZmlnLmZpbGVDb25maWcoKTwvSW5saW5lQ29kZT4gZnVuY3Rpb248Lz4iLCJwb3NpdGlvbiI6eyJzdGFydCI6eyJsaW5lIjo5NSwiY29sdW1uIjoxMSwib2Zmc2V0Ijo1MjMzfSwiZW5kIjp7ImxpbmUiOjk1LCJjb2x1bW4iOjc5LCJvZmZzZXQiOjUzMDF9fX19XQ==">
    <div data-prop-text="title">[object Object]</div>
    <p>One problem which can arise is when the monitored application is using the <code>logging.config.fileConfig()</code> function to initialize the Python logging module. If the Python logging module is initialized with this call, this will by default disable the agent logging if the agent had already been initialized prior to the call.</p>
    <p>If using Python 2.6 or higher and the call to <code>logging.config.fileConfig()</code> is under your control, one option is to modify the call to pass the argument <code>disable_existing_loggers</code> with the value of <code>False</code>. This will prevent the existing loggers being disabled and as such the agent loggers will be left alone.</p>
    <pre><code>logging.config.fileConfig('logging.cfg', disable_existing_loggers=False)

</code></pre>In this case, with the `handlers` setting being left unset, how messages will be logged will be dictated by the handler associated with the root logger. You can alternatively refer directly to the appropriate handler which should be used to log the messages.
    A similar issue as above can also arise when the monitored application is using `logging.config.dictConfig()`.
    <pre><code>
[loggers]
keys = root,newrelic

[logger_newrelic]
qualname = newrelic
level = INFO
handlers =

</code></pre>If you are unable to modify the call, or it would not be appropriate to do so, the alternative is to reinstate the logger installed by the agent. To do this, a logger section should be added to the logging configuration file being passed to `logging.config.fileConfig()`.
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhpc3RpbmcubG9nZ2VycyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjp7InR5cGUiOiJtZHhWYWx1ZUV4cHJlc3Npb24iLCJ2YWx1ZSI6Ijw+PElubGluZUNvZGU+ZGlzYWJsZV9leGlzdGluZ19sb2dnZXJzPC9JbmxpbmVDb2RlPiBmdW5jdGlvbiBhcmd1bWVudDwvPiIsInBvc2l0aW9uIjp7InN0YXJ0Ijp7ImxpbmUiOjEyNCwiY29sdW1uIjoxMSwib2Zmc2V0Ijo2OTAwfSwiZW5kIjp7ImxpbmUiOjEyNCwiY29sdW1uIjo4NSwib2Zmc2V0Ijo2OTc0fX19fV0=">
    <div data-prop-text="title">[object Object]</div>
    <p>When using a dictionary to configure the logging module, there is no function argument <code>disable_existing_loggers</code>. Instead, specify it as a key within the dictionary.</p>
    <pre><code>LOGGING = {
    'disable_existing_loggers': False,
    ...
}

</code></pre>For more information, see the [Python logging module](http://docs.python.org/library/logging.config.html) documentation.
    <pre><code>
LOGGING = {
    ...,

    'loggers': {
        'newrelic': {
            'level': 'INFO',
        },
        ...
    }
}

</code></pre>Similar to before, to avoid inherited existing loggers, an explicit logger definition should be added to the dictionary used to configure the logging module.
  </div>
</div>
<p>Refer to the documentation of any web framework or application being used. It may provide a specialized mechanism for configuring the Python logging module. For example, when using Django, the dictionary approach to setting up the Python logging module is supported automatically, with the definitions being set in the <code>LOGGING</code> attribute within the Django settings module.</p>
<p>For more information, see the <a href="https://docs.djangoproject.com/en/dev/topics/logging/#configuring-logging">Django logging configuration</a> documentation.</p>
<h3>Rotate agent log file [#rotation-of-agent-log-file]</h3>
<p>When using the <code>log_file</code> option in the agent configuration, the standard file handler from the logging module is used. This does not do any log file rotation. Log file rotation is not done automatically as we will not know what sort of rotating log file handler you may want to use, plus the standard rotating log file handlers supplied with Python are not necessarily safe for a multi process configuration. As such, it may be necessary to download and use one of the third party rotating log file handlers or use a dedicated logging system.</p>
<p>If your application runs in a single process you can safely use either of the <code>RotatingFileHandler</code> or <code>TimedRotatingFileHandler</code> handlers supplied with the logging module. To use this only for the output from the Python agent, include at the start of your WSGI script file or module, but before the import of the <code>newrelic</code> module, the following:</p>
<pre><code>_LOG_FORMAT = '%(asctime)s (%(process)d/%(threadName)s)' \
        ' %(name)s %(levelname)s - %(message)s'

_logger = logging.getLogger('newrelic')
_handler = logging.handlers.TimedRotatingFileHandler(
        'agent.log', when='midnight', backupCount=7)
_formatter = logging.Formatter(_LOG_FORMAT)
_handler.setFormatter(_formatter)
_logger.addHandler(_handler)
_logger.setLevel(logging.INFO)
</code></pre>
<p>This code accesses the root <code>newrelic</code> logger instance, attaches the rotating log file handler to it, and sets the log level for messages to be sent to this log file. We also show how to set up the log message format, but that is optional.</p>
<p>If the logging module as a whole is initialized, any log output will propagate up and be logged by any handler associated with the root logger, including possibly to standard error. To avoid duplicates, configure the log handler for the root logger.</p>
<p>The above code could also be simplified by using the <code>logging.fileConfig()</code> function and a configuration file. For further details of using a configuration file see Python logging module documentation on <a href="http://docs.python.org/howto/logging.html#configuring-logging">Logging configuration</a>.</p>
<h3>Rotate log in multi-process configuration [#multi-process-safe-log-rotation]</h3>
<p>The rotating log file handlers provided in the standard logging module are not entirely safe to use in a multi-process server configuration. Problems that can occur are intermingling of messages from multiple processes and attempts by multiple processes to perform log file rotation at the same time.</p>
<p>For a more robust log file rotation mechanism, use a third party log handler in conjunction with the Python logging module.</p>
<p>One such implementation available on PyPi is:</p>
<ul>
  <li><a href="http://pypi.python.org/pypi/ConcurrentLogHandler/">Concurrent Log Handler</a></li>
</ul>
<p>For a more complex solution you may also consider a logging service such as:</p>
<ul>
  <li><a href="http://code.google.com/p/python-loggingserver/">Python Logging Server</a></li>
</ul>
<p>Also consult the list of <a href="http://docs.python.org/library/logging.handlers.html#module-logging.handlers">other handlers</a> provided as standard in the Python logging module as those for sending to a socket or posting to a HTTP URL may also be reasonable solutions in some circumstances.</p>
