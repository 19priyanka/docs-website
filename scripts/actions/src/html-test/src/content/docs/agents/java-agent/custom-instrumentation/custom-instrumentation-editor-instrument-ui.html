
<p>New Relic's custom instrumentation editor allows Java app users to implement custom instrumentation via the New Relic user interface. The editor is the preferred choice when you cannot modify your application code and don't have that many methods to instrument. See <a href="/docs/agents/java-agent/custom-instrumentation/java-custom-instrumentation">Java custom instrumentation</a> for other instrumentation options and the reasons for using each.</p>
<p>To use the custom instrumentation editor: Go to <strong><a href="https://one.newrelic.com">one.newrelic.com</a> > APM > (select a Java app) > Settings > Instrumentation</strong>. Use the custom instrumentation editor to:</p>
<ul>
  <li>Instrument an unsupported framework.</li>
  <li>Gain additional insight into uninstrumented methods.</li>
  <li><a href="/docs/agents/java-agent/instrumentation/blocking-instrumentation-java">Ignore particular transactions</a>.</li>
</ul>
<h2>Requirements</h2>
<p>To use the custom instrumentation editor, you must meet the following requirements:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p><strong>Requirement</strong></p>
      </div>
      <div>
        <p><strong>Comments</strong></p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Agent</p>
      </div>
      <div>
        <p>Java agent version 3.17.0 or higher</p>
      </div>
    </div>
    <div>
      <div>
        <p>Security</p>
      </div>
      <div>
        <p>Users of <a href="/docs/accounts-partnerships/accounts/security/high-security">high security mode</a> must <a href="#manual-deploy">export their instrumentation</a> and manually import it to their app server.</p>
      </div>
    </div>
  </div>
</div>
<h2>Define custom instrumentation [#defining]</h2>
<p>To define custom instrumentation from the New Relic user interface, use a thread profiling session to collect detailed stack traces of each thread in your application. If possible, test your custom instrumentation in a pre-production environment before changing the instrumentation rules in your production app.</p>
<p>In either environment, use the custom instrumentation editor to define the methods you want instrumented, and apply your changes:</p>
<ol>
  <li>
    <p>Create a new <a href="/docs/apm/applications-menu/events/thread-profiler-dashboard#starting">thread profiler session</a>. To ensure you collect sufficient data, set the length of the session to at least two minutes.</p>
  </li>
  <li>
    <p>Go to <strong><a href="https://one.newrelic.com">one.newrelic.com</a> > APM > (select an app) > Settings > Instrumentation</strong>. Scroll down to the bottom of the page until you see the <strong>Recently collected thread profiles</strong> list, then select the most recent thread profile.</p>
  </li>
  <li>
    <p>Expand individual methods to locate uninstrumented
      <div data-component="Icon" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJzdHlsZSIsInZhbHVlIjp7InR5cGUiOiJtZHhWYWx1ZUV4cHJlc3Npb24iLCJ2YWx1ZSI6Intjb2xvcjogJyMzMDcwOTknfSIsInBvc2l0aW9uIjp7InN0YXJ0Ijp7ImxpbmUiOjcyLCJjb2x1bW4iOjY3LCJvZmZzZXQiOjI5ODR9LCJlbmQiOnsibGluZSI6NzIsImNvbHVtbiI6ODcsIm9mZnNldCI6MzAwNH19fX0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6Im5hbWUiLCJ2YWx1ZSI6ImZlLWNpcmNsZSJ9XQ=="></div>methods.
    </p>
  </li>
  <li>
    <p>To define instrumentation rules for particular nodes, select <strong>Instrument</strong> or <strong>Ignore</strong>, and <a href="#options">customize the rules if necessary</a>.</p>
  </li>
  <li>
    <p>To save your settings, select <strong>Confirm instrumentation changes</strong>.</p>
  </li>
  <li>
    <p>Deploy your changes from the <a href="#dashboard"><strong>Instrumentation</strong> page</a>:</p>
    <ul>
      <li>To deploy your changes automatically, select <strong>Deploy instrumentation changes</strong>.</li>
      <li>To deploy your changes manually, select <strong>Export XML</strong>, and see <a href="#manual-deploy">exporting your instrumentation</a>.</li>
    </ul>
  </li>
</ol>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJjYXV0aW9uIn1d">
  <p>Avoid over-instrumenting whenever possible. With each additional method that is instrumented, the agent will be using more resources and your application will incur more overhead. In addition, deploying your instrumentation will cause a brief period of higher overhead. This can noticeably slow application requests for several seconds.</p>
</div>
<p>If you applied your changes from the UI, the agent will begin instrumenting your methods within a few <a href="/docs/apm/new-relic-apm/getting-started/glossary#harvest-cycle">harvest cycles</a> (typically a few minutes).</p>
<h2>Manual instrumentation using the editor [#manual-instrumentation]</h2>
<p>You can also create instrumentation points directly in the editor without using a thread profile:</p>
<ol>
  <li>From the custom instrumentation editor, select <strong>Add manual instrumentation</strong> to manually enter a class and method to be instrumented or ignored.</li>
  <li>Follow the <a href="/docs/agents/java-agent/custom-instrumentation/java-custom-instrumentation-xml-examples#file-format">custom instrumentation by XML rules when defining your instrumentation points</a>.</li>
  <li>Deploy your changes from the instrumentation editor.</li>
</ol>
<p>Using this method to add instrumentation exposes additional functionality beyond what is available from a thread profile. In addition to matching methods by signature, you can also instrument methods by return type, methods on interfaces, and by Java annotation.</p>
<p>These more complex instrumentation types can be created and deleted in the editor, but not edited.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>If a method is marked <code>Instrumentation not allowed</code>, follow New Relic's <a href="/docs/agents/java-agent/custom-instrumentation/troubleshooting-java-custom-instrumentation">troubleshooting procedures for custom instrumentation</a>.</p>
</div>
<h2>Deploy changes manually [#manual-deploy]</h2>
<p>You can also use the custom instrumentation editor to build a custom instrumentation set, then export an instrumentation file and manually import it to your app server. This is required for users of <a href="/docs/accounts-partnerships/accounts/security/high-security">high security mode</a>.</p>
<p>To export your instrumentation, <a href="#defining">define custom instrumentation via the UI</a>. Then select <strong>Export xml</strong> from the <strong>Instrumentation</strong> page, and <a href="/docs/agents/java-agent/custom-instrumentation/java-instrumentation-xml#file-location">import the file on your app server</a>.</p>
<h2>Page functions [#dashboard]</h2>
<p>The <strong>Instrumentation</strong> page supports the following features:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to...</p>
      </div>
      <div>
        <p>Do this...</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Pause or disable custom instrumentation</p>
      </div>
      <div>
        <ul>
          <li>Select
            <div data-component="Icon" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJzdHlsZSIsInZhbHVlIjp7InR5cGUiOiJtZHhWYWx1ZUV4cHJlc3Npb24iLCJ2YWx1ZSI6Intjb2xvcjogJyM1NTU1NUEnfSIsInBvc2l0aW9uIjp7InN0YXJ0Ijp7ImxpbmUiOjEzMywiY29sdW1uIjozMCwib2Zmc2V0Ijo2MzE4fSwiZW5kIjp7ImxpbmUiOjEzMywiY29sdW1uIjo1MCwib2Zmc2V0Ijo2MzM4fX19fSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoibmFtZSIsInZhbHVlIjoiZmUtc2xhc2gifV0="></div><strong>Disable instrumentation</strong> to temporarily disable all UI-defined custom instrumentation.
          </li>
          <li>Select <strong>Enable instrumentation</strong> to re-enable your instrumentation settings.</li>
        </ul>
      </div>
    </div>
    <div>
      <div>
        <p>Import existing instrumentation</p>
      </div>
      <div>
        <ul>
          <li>You can import an existing <a href="/docs/agents/java-agent/custom-instrumentation/java-instrumentation-xml">custom instrumentation xml file</a> by selecting <strong>Import xml</strong>.</li>
          <li>You can also <strong>Export xml</strong> if you <a href="#manual-deploy">do not want to deploy your changes automatically</a>.</li>
        </ul>
      </div>
    </div>
    <div>
      <div>
        <p>Edit or delete instrumentation points</p>
      </div>
      <div>
        <p>You cannot edit <a href="#manual-instrumentation">manual instrumentation</a>, only delete it.</p>
        <ul>
          <li>Select <strong>Remove</strong> to stop instrumenting a particular method.</li>
          <li>Select <strong>Edit</strong> to change the instrumentation rules.</li>
        </ul>
      </div>
    </div>
    <div>
      <div>
        <p>View instrumentation history</p>
      </div>
      <div>
        <ul>
          <li>You can view each previous iteration of your custom instrumentation from the <strong>Instrumentation history</strong> tab, including who deployed changes and when.</li>
          <li>You can restore an old version by selecting <strong>export</strong> to download a copy of the custom instrumentation file, then <a href="#import">importing</a> it to the instrumentation editor.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<h2>Instrumentation options [#options]</h2>
<p>You can define the following options with the custom instrumentation editor:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p><strong>Instrumentation options</strong></p>
      </div>
      <div>
        <p><strong>Comments</strong></p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>Instrument methods</p>
      </div>
      <div>
        <p>Begin instrumenting the selected method. Instrumented methods will be visible in the New Relic UI. <strong>Instrument</strong> supports the following child options:</p>
        <ul>
          <li><strong>Name the transaction (transaction name)</strong>: Override the standard transaction name, defined by the <a href="/docs/agents/java-agent/instrumentation/naming-web-transactions">automatic naming rules</a>. The UI will instead use the listed name.</li>
          <li><strong>Start the transaction when this method executes</strong>: Rather than including metrics from this metric inside its parent transaction, create a new transaction for this method. <a href="#start-results">Agent behavior</a> with this option depends on whether there is a pre-existing transaction on the thread.</li>
        </ul>
      </div>
    </div>
    <div>
      <div>
        <p>Report custom attributes</p>
      </div>
      <div>
        <p>Method parameters can be captured as attributes on a transaction. New Relic reports these attributes to transaction traces, traced errors, and New Relic One <code>Transaction</code> events.</p>
        <p>For security reasons, capturing custom attributes using the Custom Instrumentation Editor is <strong>disabled</strong> by default and cannot be enabled while you are using <a href="/docs/agents/java-agent/getting-started/apm-agent-security-java">high security mode</a>. If you want to report custom attributes using the custom instrumentation editor and you do not want the Java agent to be in High security mode, disable <a href="/docs/agents/java-agent/configuration/java-agent-configuration-config-file#cfg-enable_high_security">High security mode</a> and then add the following text in the <code>common:</code> block of your <strong>newrelic.yml</strong>:</p>
        <pre><code>reinstrument:
    attributes_enabled: true

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p>Ignore transactions</p>
      </div>
      <div>
        <p><a href="/docs/agents/java-agent/instrumentation/blocking-instrumentation-java">Ignore this method entirely</a>. The agent will not report metrics from this method, and the method will not contribute to Apdex calculations.</p>
      </div>
    </div>
  </div>
</div>
<h2>Results with "start" option [#start-results]</h2>
<p>If you select <strong>Instrument methods > Start the transaction when this method executes</strong>, agent behavior depends on whether there is a pre-existing transaction on the thread.</p>
<p>When the class or method is instrumented:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Is the "<strong>Start the transaction"</strong> flag checked?</p>
      </div>
    </div>
    <div>
      <div>
        <p><strong>Yes</strong></p>
      </div>
      <div>
        <p><strong>No</strong></p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>If a pre-existing transaction <strong>is</strong> on that thread and the <strong>Start the transaction</strong> flag <strong>is</strong> checked:</p>
        <ol>
          <li>The agent ignores the <strong>Start the transaction</strong> flag.</li>
          <li>The agent includes the class/method into the pre-existing transaction.</li>
        </ol>
      </div>
      <div>
        <p>If a pre-existing transaction <strong>is</strong> on that thread and the <strong>Start the transaction</strong> flag is <strong>not</strong> checked, the agent includes the class/method into the pre-existing transaction.</p>
      </div>
    </div>
    <div>
      <div>
        <p>If a transaction is <strong>not</strong> on that thread and the <strong>Start the transaction</strong> flag <strong>is</strong> checked:</p>
        <ol>
          <li>The agent discovers there is no current transaction.</li>
          <li>The agent creates a new transaction starting with the class/method you have instrumented.</li>
        </ol>
      </div>
      <div>
        <p>If a transaction is <strong>not</strong> on that thread and the <strong>Start the transaction</strong> flag is <strong>not</strong> checked:</p>
        <ol>
          <li>The agent looks for a transaction on that thread and does not find one.</li>
          <li>The metric is dropped.</li>
        </ol>
      </div>
    </div>
  </div>
</div>
