
<h2>Problem</h2>
<p>The <a href="https://msdn.microsoft.com/en-us/library/bb384689.aspx">.NET Common Language Runtime (CLR)</a> only allows one profiler to access the profiling API of a process at any given time. If another profiler is installed on the system, the New Relic profiler will not instrument any applications.</p>
<h2>Solution</h2>
<p>To avoid a profiler conflict, fully remove the other profiler from the environment, then ensure the IIS registry keys or system environment variables have been restored.</p>
<p><strong>Exception:</strong> For conflicts with Microsoft's System Center Operations Manager (SCOM), follow the <a href="/docs/agents/net-agent/troubleshooting/resolve-net-scom-conflicts">troubleshooting procedures specifically for SCOM</a>.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY2hlY2stY29uZmxpY3RzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIxLiBDaGVjayBmb3IgcHJvZmlsZXIgY29uZmxpY3RzLiJ9XQ==">
    <div data-prop-text="title">1. Check for profiler conflicts.</div>
    <p>To see if there are any profiler conflicts:</p>
    <ol>
      <li>
        <p>Run <strong>Process Explorer</strong> as an Administrator.</p>
      </li>
      <li>
        <p>To find your app's process, right-click the app, then select <strong>Properties > Environment</strong>.</p>
      </li>
      <li>
        <p>Verify that the New Relic CLSID and environment variables are included in the <code>w3wp.exe</code>, <code>service</code>, or <code>non-IIS app</code> environment details:</p>
        <pre><code>COR_ENABLE_PROFILING=1
COR_PROFILER={71DA0A04-7777-4EC6-9643-7D28B46A8A41}
NEWRELIC_INSTALL_PATH=path\to\agent\directory
</code></pre>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicmVnaXN0cnkta2V5cyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiMi4gQ29tcGFyZSByZWdpc3RyeSBrZXlzIHRvIFByb2Nlc3MgRXhwbG9yZXIgaWYgbmVjZXNzYXJ5LiJ9XQ==">
    <div data-prop-text="title">2. Compare registry keys to Process Explorer if necessary.</div>
    <p>If the conflicting profiler has been disabled and there is still an issue, compare the registry keys to <a href="https://technet.microsoft.com/en-us/sysinternals/bb896653.aspx"><strong>Process Explorer</strong></a> to see which profiler is present. On the machine where you are experiencing this issue, check the <strong>WAS</strong> and <strong>W3SVC REG</strong> for IIS apps, or check your service keys or non-IIS app keys.</p>
    <div data-component="Table" data-prop="W10=">
      <div>
        <div>
          <div>
            <p>To check registry keys with this...</p>
          </div>
          <div>
            <p><strong>Do this...</strong></p>
          </div>
        </div>
      </div>
      <div>
        <div>
          <div>
            <p>PowerShell</p>
          </div>
          <div>
            <p>If using Microsoft PowerShell, execute the following commands:</p>
            <pre><code>(Get-Item -Path HKLM:\SYSTEM\CurrentControlSet\services\WAS).GetValue("Environment")
(Get-Item -Path HKLM:\SYSTEM\CurrentControlSet\services\W3SVC).GetValue("Environment")

</code></pre>
          </div>
        </div>
        <div>
          <div>
            <p>Command line</p>
          </div>
          <div>
            <p>If using <strong>cmd</strong>, do the following for either <strong>WAS</strong> and <strong>W3SVC REG</strong> or for your service/non-IIS app. Here is an example for an IIS application:</p>
            <ol>
              <li>On the command line, enter <code>regedit</code>.</li>
              <li>From the <strong>Registry Editor</strong>, select <strong>HKEY_LOCAL_MACHINE</strong> > <strong>SYSTEM</strong> > <strong>CurrentControlSet</strong> > <strong>Services</strong>.</li>
              <li>If applicable, select the <strong>WAS</strong> folder. From the <strong>WAS</strong> folder's list of registry keys, double-click <strong>Environment</strong>, and verify that <a href="#clsid">New Relic's CLSID</a> and environment variables appear in the text box.</li>
              <li>If applicable, select the <strong>W3SVC</strong> folder. From the <strong>W3SVC</strong> folder's list of registry keys, double-click <strong>Environment</strong>, and verify that <a href="#clsid">New Relic's CLSID</a> and environment variables appear in the text box.</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicmVnaXN0cnkta2V5cyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiMy4gUmVzdG9yZSBOZXcgUmVsaWMgcmVnaXN0cnkga2V5cyBvciBlbnZpcm9ubWVudCB2YXJpYWJsZXMuIn1d">
    <div data-prop-text="title">3. Restore New Relic registry keys or environment variables.</div>
    <p>Once the conflicting profiler has been disabled, you still may need to restore the New Relic registry keys or, if using Instrument All, the <a href="https://docs.newrelic.com/docs/agents/net-agent/troubleshooting/profiler-conflicts#check-conflicts">system-wide</a> <a href="https://docs.newrelic.com/docs/agents/net-agent/configuration/net-agent-configuration#net-framework-env-variables"></a><a href="https://docs.newrelic.com/docs/agents/net-agent/troubleshooting/profiler-conflicts#check-conflicts">environment</a> <a href="https://docs.newrelic.com/docs/agents/net-agent/configuration/net-agent-configuration#net-framework-env-variables"></a><a href="https://docs.newrelic.com/docs/agents/net-agent/troubleshooting/profiler-conflicts#check-conflicts">variables</a>.</p>
    <p>To resolve the profiler conflict for IIS applications, either re-run the installer and use the <code>Repair</code> feature, or restore the registry settings manually using PowerShell:</p>
    <pre><code>$HKLM = 2147483650 #HKEY_LOCAL_MACHINE
$reg = [wmiclass]"\\.\root\default:StdRegprov"
$key = "SYSTEM\CurrentControlSet\Services\W3SVC"
$name = "Environment"
$value = "COR_ENABLE_PROFILING=1","COR_PROFILER={71DA0A04-7777-4EC6-9643-7D28B46A8A41}","NEWRELIC_INSTALL_PATH=C:\Program Files\New Relic\.NET Agent\"
$reg.SetMultiStringValue($HKLM, $key, $name, $value)
$key = "SYSTEM\CurrentControlSet\Services\WAS"
$name = "Environment"
$value = "COR_ENABLE_PROFILING=1","COR_PROFILER={71DA0A04-7777-4EC6-9643-7D28B46A8A41}","NEWRELIC_INSTALL_PATH=C:\Program Files\New Relic\.NET Agent\"
$reg.SetMultiStringValue($HKLM, $key, $name, $value)
iisreset

</code></pre>For non-IIS applications and Windows services, either re-run the installer and use the `Repair` feature, or manually edit the system-wide environment variables. For some Windows services, a reboot is required to pick up the new variables.
  </div>
</div>
<h2>Cause</h2>
<p>Here are some commonly reported profiler conflicts. This is not an exhaustive list of .NET profilers, as any program that uses the .NET profiling API may cause conflicts with the New Relic .NET profiler.</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>Profiler name</p>
      </div>
      <div>
        <p>Profiler identifier</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>App Dynamics</p>
      </div>
      <div>
        <p>AppDynamics.AgentProfiler</p>
      </div>
    </div>
    <div>
      <div>
        <p>Dynatrace</p>
      </div>
      <div>
        <p>DA7CFC47-3E35-4c-4e-B495-534F93B28683</p>
        <p>B7038F67-52FC-4DA2-AB02-969B3C1EDA03</p>
      </div>
    </div>
    <div>
      <div>
        <p>Diagnostic Policy Service</p>
      </div>
      <div>
        <p>555908D1-A6D7-4695-8E1E-26931D2012F4</p>
      </div>
    </div>
    <div>
      <div>
        <p>IntelliTrace</p>
      </div>
      <div>
        <p>2AA1AA98-2CAA-4FCF-86CE-EFA007737E83</p>
      </div>
    </div>
    <div>
      <div>
        <p>Microsoft App Insights</p>
      </div>
      <div>
        <p>324F817A-7420-4E6D-B3C1-143FBED6D855</p>
        <p>COR_PROFILER_PATH</p>
        <pre><code>D:\home\SiteExtensions\Microsoft.ApplicationInsights.AzureWebSites\Agent\MicrosoftInstrumentationEngine.dll

</code></pre>
      </div>
    </div>
    <div>
      <div>
        <p><a href="/docs/agents/net-agent/troubleshooting/resolve-net-scom-conflicts">SCOM APM</a></p>
      </div>
      <div>
        <p>AD5651A8-B5C8-46ca-A11B-E82AEC2B8E78</p>
      </div>
    </div>
  </div>
</div>
