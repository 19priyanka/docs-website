
<p>With the <a href="/docs/agents/python-agent/getting-started/introduction-new-relic-python">Python agent</a>, you can monitor applications that reside in the <a href="https://cloud.google.com/appengine/docs/flexible/python/">Google App Engine (GAE) flexible environment</a>. Adding agent data to your GAE flex app gives you insight into the health and performance of your app and extends GAE with metrics you can view in New Relic One.</p>
<p>This document explains how to add agent data to your GAE flex app using either of these methods:</p>
<ul>
  <li>Google App Engine's <a href="/docs/accounts-partnerships/partnerships/google-cloud-platform-gcp/google-app-engine-environment#native-mode">"native mode"</a> installation with a standard GAE runtime</li>
  <li>Docker installation using a <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/about-custom-runtimes">custom runtime</a></li>
</ul>
<h2>Deploy using GAE's native support [#native]</h2>
<p>When using Google App Engine <a href="/docs/accounts-partnerships/partnerships/google-cloud-platform-gcp/google-app-engine-environment#native-mode">"native mode"</a> installation, you provide your app code and an <code>app.yaml</code> file. Google App Engine then deploys to a standard prebuilt Docker image.</p>
<p>For example, to deploy with native support for a Flask/Django app:</p>
<ol>
  <li>Follow standard procedures to <a href="/docs/agents/python-agent/getting-started/python-agent-quick-start#install">install the Python agent</a>, including your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">license key</a>.</li>
  <li>Set the <a href="/docs/agents/python-agent/installation-configuration/python-agent-configuration#agent-configuration-file"><code>NEW_RELIC_CONFIG_FILE</code></a> as an environment variable pointing to <code>newrelic.ini</code>.</li>
</ol>
<p>Once the agent and configuration file have been installed, the Python agent can automatically monitor applications that reside in the GAE flexible environment. Wait until the deployment completes, then view your GAE flex app data in the <a href="/docs/apm/applications-menu/monitoring/apm-overview-page">APM Summary page</a>.</p>
<h2>Build a custom runtime using Docker [#build-runtime]</h2>
<p>See <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/build">Google's documentation for building custom runtimes</a>. This example describes how to add agent data to your GAE flex app by building a custom runtime for Docker.</p>
<p>For more information about deploying and configuring your Node.js app in the GAE flexible environment, see:</p>
<ul>
  <li><a href="https://github.com/GoogleCloudPlatform/python-docs-samples/tree/master/appengine/flexible">Our GAE flex examples on Github</a> for Python</li>
  <li><a href="https://cloud.google.com/appengine/docs/flexible/python/">Google App Engine's documentation</a> for Python</li>
  <li><a href="https://cloud.google.com/appengine/docs/flexible/python/tutorials">Google App Engine's tutorials</a> to deploy a Python app</li>
</ul>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic2V0dXAtZ2FlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIxLiBTZXQgdXAgdGhlIEdBRSBwcm9qZWN0IGFuZCBpbnN0YWxsIGRlcGVuZGVuY2llcyJ9XQ==">
    <div data-prop-text="title">1. Set up the GAE project and install dependencies</div>
    <p>When building a custom runtime using Docker, set the <a href="/docs/agents/python-agent/installation-configuration/python-agent-configuration#agent-configuration-file"><code>NEW_RELIC_CONFIG_FILE</code></a> as an environment variable pointing to the Dockerfile instead of to your Python app's <code>newrelic.ini</code>.</p>
    <ol>
      <li>
        <p>Follow standard procedures to <a href="/docs/agents/python-agent/getting-started/python-agent-quick-start#install">install the Python agent</a>, including your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">license key</a>.</p>
      </li>
      <li>
        <p>Follow Google App Engine procedures Python to create a <a href="https://cloud.google.com/appengine/docs/flexible/python/managing-projects-apps-billing#create">Google Cloud Platform project</a>, create an App Engine application, and complete other prerequisites for the <a href="http://cloud.google.com/appengine/docs/flexible/python/download">Google Cloud SDK</a>.</p>
        <p>The Google Cloud SDK also provides the <code>gcloud</code> command line tool to manage and deploy GAE apps.</p>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlndXJlLWFwcC15YW1sIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIyLiBDb25maWd1cmUgeW91ciBhcHAueWFtbCJ9XQ==">
    <div data-prop-text="title">2. Configure your app.yaml</div>
    <p>The <code>app.yaml</code> configuration file is required for a GAE flexible environment app with a custom runtime. At a minimum, make sure it contains:</p>
    <pre><code>env: flex
runtime: custom

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlndXJlLWRvY2tlcmZpbGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjMuIENvbmZpZ3VyZSBhIERvY2tlcmZpbGUifV0=">
    <div data-prop-text="title">3. Configure a Dockerfile</div>
    <p>The <a href="http://docs.docker.com/engine/reference/builder/">Dockerfile</a> defines the Docker image to be built and is required for a GAE flexible environment app. The following Dockerfile example shows the Python agent installed for an application served with gunicorn.</p>
    <p>These procedures are similar to the <a href="/docs/agents/python-agent/getting-started/python-agent-quick-start">Python quick start guide</a>. The Dockerfile will contain customer-specific code, including Python version, installation requirements, etc).</p>
    <pre><code># [START dockerfile]
FROM gcr.io/google_appengine/python

# Install the fortunes binary from the debian repositories.
RUN apt-get update &#x26;&#x26; apt-get install -y fortunes

# Optional: Change the -p argument to use Python 2.7.
RUN virtualenv /env -p python3.5

# Set virtualenv environment variables. This is equivalent to running
# source /env/bin/activate.
ENV VIRTUAL_ENV /env
ENV PATH /env/bin:$PATH

ADD requirements.txt /app/
RUN pip install -r requirements.txt
ADD . /app/

CMD NEW_RELIC_CONFIG_FILE=newrelic.ini newrelic-admin run-program gunicorn -b :$PORT main:app
# [END dockerfile]

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZGVwbG95LWRvY2tlci1pbWFnZS10by1nYWUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjQuIERlcGxveSBEb2NrZXIgaW1hZ2UgdG8gaW5pdGlhbGl6ZWQgR0FFIGZsZXhpYmxlIGVudmlyb25tZW50In1d">
    <div data-prop-text="title">4. Deploy Docker image to initialized GAE flexible environment</div>
    <ol>
      <li>
        <p>To deploy your Docker image to your <a href="https://cloud.google.com/sdk/docs/initializing">initialized GAE flexible environment</a>, run the following command:</p>
        <pre><code>gcloud app deploy
</code></pre>
      </li>
      <li>
        <p>Wait until the deployment completes.</p>
      </li>
      <li>
        <p>To open the app in the browser, run the following command:</p>
        <pre><code>gcloud app browse
</code></pre>
      </li>
      <li>
        <p>To view your GAE flex app data, go to the <a href="/docs/apm/applications-menu/monitoring/apm-overview-page">APM Summary page</a>.</p>
      </li>
    </ol>
  </div>
</div>
<h2>Recommendation: Disable health checks [#health-checks]</h2>
<p>Google App Engine sends <a href="https://cloud.google.com/appengine/docs/flexible/python/how-instances-are-managed">periodic health check requests</a> to confirm that an instance has been successfully deployed, and to check that a running instance maintains a healthy status. A health check is an HTTP request to the URL <code>/_ah/health</code>.</p>
<p>If you create a custom runtime, your app must be able to handle a large number of health check requests. Otherwise, your app data may not display correctly in APM.</p>
<p><strong>Recommendation:</strong> Configure your <code>app.yaml</code> to <a href="https://cloud.google.com/appengine/docs/flexible/python/configuring-your-app-with-app-yaml#health_checks">disable health checks</a> by adding:</p>
<pre><code>health_check:
  enable_health_check: False
</code></pre>
<h2>Get agent troubleshooting logs from GAE [#agent-logs]</h2>
<p>Use these resources to troubleshoot your GAE flex environment app:</p>
<ul>
  <li>
    <p>To connect to the GAE instance and start a shell in the Docker container running your code, see <a href="https://cloud.google.com/appengine/docs/flexible/python/debugging-an-instance">Debugging an instance</a>.</p>
  </li>
  <li>
    <p>To redirect Python agent logs to <a href="http://cloud.google.com/logging/docs/view/logs_viewer_v2">Stackdriver</a> in the <a href="https://cloud.google.com/compute/docs/console">Cloud Platform Console</a>, add the following statement to the <code>newrelic.ini</code> configuration:</p>
    <pre><code>log_file = stderr
</code></pre>
  </li>
  <li>
    <p>To view the logs, use the <a href="https://cloud.google.com/appengine/docs/flexible/php/writing-application-logs">Cloud Platform Console's Log Viewer</a>.</p>
  </li>
</ul>
