
<p>The Ruby agent automatically instruments <a href="http://rack.github.io/">Rack</a> middlewares. If you are unfamiliar with the basics of Rack middlewares, review the <a href="http://guides.rubyonrails.org/rails_on_rack.html#resources">resources linked by the Rails on Rack guide</a>. Additionally, the Ruby agent provides some features via Rack middlewares:</p>
<ul>
  <li><a href="/docs/agents/ruby-agent/features/cross-application-tracing-ruby">Cross application traces</a></li>
  <li>Auto-instrumentation for <a href="/docs/agents/ruby-agent/features/page-load-timing-ruby">Browser monitoring</a></li>
</ul>
<p>New Relic automatically installs these middlewares for Rails and Sinatra.</p>
<h2>Rack instrumentation [#instrumentation]</h2>
<p>The two most common ways to configure Rack middlewares are the <code>Rack::Builder</code> API (most often from <strong>config.ru</strong>) and Rails' middleware stack configuration:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicmFja19idWlsZGVyIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJSYWNrOjpCdWlsZGVyIn1d">
    <div data-prop-text="title">Rack::Builder</div>
    <p>Middlewares in your <strong>config.ru</strong> file are configured using <code>Rack::Builder</code>. For the Ruby agent to instrument middlewares from <code>Rack::Builder</code>, your app must run version 1.1.0 or higher of the <code>rack</code> gem. This is the most common use of middlewares with Sinatra or pure-rack applications.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicmFpbHNfbWlkZGxld2FyZXMifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IlJhaWxzIG1pZGRsZXdhcmVzIn1d">
    <div data-prop-text="title">Rails middlewares</div>
    <p>Rails uses its own class (<code>ActionDispatch::MiddlewareStack</code>) instead of <code>Rack::Builder</code> to configure middlewares. Even if you haven't explicitly added middlewares to your Rails application, many components of Rails itself are implemented as middleware, so middleware data will appear by default.</p>
    <p>The Ruby agent automatically instruments middlewares added via <code>ActionDispatch::MiddlewareStack</code> on <strong>Rails 3.0 or higher</strong>. For more information about configuring middlewares with Rails, see the <a href="http://guides.rubyonrails.org/rails_on_rack.html">Ruby on Rails guide</a>.</p>
  </div>
</div>
<h2>Viewing middleware data [#viewing_middleware_data]</h2>
<p>You can view middleware data in APM.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYXBtLW92ZXJ2aWV3In0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJJbiB0aGUgQVBNIFN1bW1hcnkgcGFnZSJ9XQ==">
    <div data-prop-text="title">In the APM Summary page</div>
    <p>The main chart on your app's <a href="/docs/apm/applications-menu/monitoring/applications-overview-dashboard">APM <strong>Summary</strong> page</a> includes a purple bar that shows average time per request spent in all Rack middlewares for your application.</p>
    <p>
      <img src="./images/overview_graph_0.png" alt="overview_graph.png" title="overview_graph.png">
    </p>
    <p><strong>APM > (selected application) > Summary:</strong> Middleware time appears in purple on your app's main Overview chart.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYXBtLXRyYW5zYWN0aW9ucyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiSW4gdGhlIEFQTSBUcmFuc2FjdGlvbnMgcGFnZSJ9XQ==">
    <div data-prop-text="title">In the APM Transactions page</div>
    <p>You can also see time for individual middlewares for a specific transaction name from your app's APM <a href="https://docs.newrelic.com/docs/apm/applications-menu/monitoring/transactions-page"><strong>Transactions</strong> page</a>.</p>
    <p>
      <img src="./images/transaction_graph.png" alt="transaction_graph.png" title="transaction_graph.png">
    </p>
    <p><strong>APM > (selected application) > Monitor > Transactions > (selected transaction) > Trace details:</strong> Here is an example of middleware time for a selected transaction for your app.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYXBtLXRyYWNlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJJbiBBUE0gdHJhbnNhY3Rpb24gdHJhY2UgZGV0YWlscyJ9XQ==">
    <div data-prop-text="title">In APM transaction trace details</div>
    <p>Transaction traces also capture detailed middleware call information.</p>
    <p>
      <img src="./images/transaction_trace_0.png" alt="transaction_trace.png" title="transaction_trace.png">
    </p>
    <p><strong>APM > (selected application) > Monitor > Transactions > (selected transaction trace):</strong> Here is an example of middleware details in a transaction trace.</p>
  </div>
</div>
<h2>Disabling Rack instrumentation [#disabling]</h2>
<p>If you do not want to instrument Rack middlewares, you may disable Rack middleware instrumentation with the <a href="/docs/agents/ruby-agent/installation-configuration/ruby-agent-configuration"><code>disable_middleware_instrumentation</code></a> setting. You can also <a href="/docs/agents/ruby-agent/installation-configuration/ignoring-specific-transactions">ignore specific transactions</a>.</p>
<h2>Installing Ruby agent middlewares manually [#manual]</h2>
<p>The Ruby agent's implementation of New Relic's <a href="/docs/apm/traces/cross-application-traces/cross-application-tracing">Cross Application Tracing</a> feature uses Rack middleware instrumentation to read and write HTTP headers that are necessary to pass information between monitored applications. If you have disabled middleware instrumentation as described above and want to use cross application tracing, you must manually add the <code>NewRelic::Rack::AgentHooks</code> middleware to your middleware stack. For more information, see <a href="/docs/agents/ruby-agent/features/cross-application-tracing-ruby">Cross application tracing in Ruby</a>.</p>
<h2>Manual Rack instrumentation [#manual_instrumentation]</h2>
<p>Earlier versions of the Ruby agent supported manually instrumenting Rack middlewares via the <code>NewRelic::Agent::Instrumentation::Rack</code> module. This instrumentation is deprecated in Ruby agent versions 3.9.0 or higher, because it is unnecessary with automatic middleware instrumentation. New Relic recommends that you remove references to this module from your code after upgrading to 3.9.0 or higher.</p>
