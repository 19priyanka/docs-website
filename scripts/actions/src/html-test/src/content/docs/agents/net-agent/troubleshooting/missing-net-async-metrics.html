
<h2>Problem</h2>
<p>You do not see <a href="/docs/agents/net-agent/additional-installation/async-support-net">async transactions</a> for WebApi, HttpClient, SqlCommand, SqlDataReader, NpgsqlCommand, or custom instrumentation. This problem typically occurs for apps created with <a href="/docs/agents/net-agent/getting-started/compatibility-requirements-net-framework-agent#net-version">New Relic's .NET agent</a> under .NET Framework 4.0 or earlier, then migrated to .NET Framework 4.5 or higher.</p>
<h2>Solution</h2>
<h3>Upgrade appSetting for pipeline [#appsetting]</h3>
<p>A specific <code>appSetting</code> or <code>system.web</code> setting is required if you are using:</p>
<ul>
  <li>WebApi1 or WebApi2</li>
  <li>Async methods in HttpClient, SqlCommand, SqlDataReader, or NpgsqlCommand</li>
  <li>Async-related custom transactions or custom instrumentation</li>
  <li>New Relic .NET agent version 5.11.53.0 or higher</li>
  <li>.NET Framework 4.5 or higher as the target for your app</li>
</ul>
<p>If these conditions apply, then you must ensure your app uses the upgraded request processing pipeline introduced in .NET 4.5.</p>
<p>To use the upgraded pipeline, ensure your <code>web.config</code> includes one of the following settings. If neither setting appears, add one:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoidXNlLW5ldy1waXBlbGluZSJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiUmVjb21tZW5kZWQ6IFRlbGwgLk5FVCB0byB1c2UgdGhlIG5ldyBwaXBlbGluZSJ9XQ==">
    <div data-prop-text="title">Recommended: Tell .NET to use the new pipeline</div>
    <p>Tell .NET to use the new ASP request processing pipeline:</p>
    <pre><code>&#x3C;configuration>
  &#x3C;appSettings>
    &#x3C;add key="aspnet:UseTaskFriendlySynchronizationContext" value="true" />
  &#x3C;/appSettings>
&#x3C;configuration>

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic3BlY2lmeS10YXJnZXQtZnJhbWV3b3JrIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJTcGVjaWZ5IHlvdXIgdGFyZ2V0IGZyYW1ld29yayB2ZXJzaW9uIn1d">
    <div data-prop-text="title">Specify your target framework version</div>
    <p>If you want to specify the .NET Framework version you target, be aware that this imposes strict runtime checks that can cause compatibility issues. <strong>Recommendation:</strong> If possible, <a href="#use-new-pipeline">tell .NET to use the new pipeline</a> instead of using this option.</p>
    <p>The specified version of the .NET Framework must be installed on your machine, and it must be version 4.5.2 or higher:</p>
    <pre><code>&#x3C;configuration>
  &#x3C;system.web>
    &#x3C;httpRuntime targetFramework="YOUR_TARGET_NET_VERSION" /> 
  &#x3C;/system.web>
&#x3C;configuration>

</code></pre>
  </div>
</div>
<h3>Recommended: Verify compatibility with the new pipeline [#enforce-async]</h3>
<p>Optional: You can tell the .NET framework to perform additional checks of your async code at runtime. These checks catch common issues in async code, which may be masked by the legacy ASP pipeline.</p>
<p>If your app passes without any issues, you can be confident that your app correctly handles the new pipeline. For more information, see <a href="https://msdn.microsoft.com/en-us/library/hh975440%28v=vs.120%29.aspx?f=255&#x26;MSPPError=-2147217396">Microsoft's configuration documentation</a>.</p>
<p>To enforce additional checks, add the following to <code>web.config</code>:</p>
<pre><code>&#x3C;configuration>
  &#x3C;appSettings>
    &#x3C;add key="aspnet:AllowAsyncDuringSyncStages" value="false" />
  &#x3C;/appSettings>
&#x3C;configuration>
</code></pre>
<h2>Cause</h2>
<p>Async instrumentation is disabled if the legacy integrated pipeline is present. Before .NET 4.5, the integrated pipeline could cause deadlocks. For more information about this .NET Framework bug, see:</p>
<ul>
  <li><a href="http://stackoverflow.com/questions/18383923/why-is-httpcontext-current-null-after-await">Why is HttpContext.Current null after await?</a></li>
  <li><a href="http://blogs.msdn.com/b/webdev/archive/2012/11/19/all-about-httpruntime-targetframework.aspx">All about &#x3C;httpRuntime targetFramework></a></li>
</ul>
