
<p>The <a href="http://newrelic.github.io/java-agent-api/javadoc/com/newrelic/api/agent/NewRelic.html">New Relic Java agent API</a> lets you set up custom instrumentation for your Java application. This document shows an example of using custom instrumentation with annotation in an imaginary application.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>For best results when using the API, ensure you have the <a href="/docs/release-notes/agent-release-notes/java-release-notes">latest Java agent release</a>.</p>
</div>
<h2>Complete example app using API [#all]</h2>
<p>Below is an example of an imaginary store app's servlet using the Java agent API.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>If you copy and paste example code, be sure to use appropriate spacing on your command lines.</p>
</div>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29tcGxldGUtYXBpLWV4YW1wbGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkNvbXBsZXRlIEFQSSBjYWxsIGV4YW1wbGUifV0=">
    <div data-prop-text="title">Complete API call example</div>
    <pre><code>package test;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.Random;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
// Java agent API imports
import com.newrelic.api.agent.NewRelic;
import com.newrelic.api.agent.Trace;

public class TestServlet extends HttpServlet {
    // instrumentation via annotation
    @Trace(dispatcher = true)
    protected void
    processRequest(HttpServletRequest req,
    HttpServletResponse resp)
        throws ServletException, IOException {

        saveNewRelicInfo(req);
        doRequestWork(req);
        writeResponse(resp);
    }

    private void saveNewRelicInfo(HttpServletRequest req) {
        String storeId = req.getParameter("storeId");
        if (storeId != null) {
        // set the name of the Transaction
        NewRelic.setTransactionName(null, "/store");

    if (storeId.equals("betaStore")) {
        // prevent the method from contributing to the Apdex score
        NewRelic.ignoreApdex();
        }
    }

    String userId = req.getParameter("userId");
        if (userId != null) {
            // set the user name to associate with the RUM JavaScript footer 
            // for the current web transaction
            NewRelic.setUserName(userId);
            // add a key/value pair to the current transaction
            NewRelic.addCustomParameter("userId", userId);
        }

    String promotionId = req.getParameter("promotionId");
        if (promotionId != null) {
            // increment the metric counter for the given name
            NewRelic.incrementCounter("Custom/Promotion");
        }
    }

    protected void
    doRequestWork(HttpServletRequest req) {
    try {
        long millisToSleep  = new Random().nextInt(5000);
        Thread.sleep(millisToSleep);
        // record a response time in milliseconds for the given metric name
        NewRelic.recordResponseTimeMetric("Custom/RandomSleep",
        millisToSleep);
        } catch (InterruptedException e) {
            // report a handled exception
            NewRelic.noticeError(e, false);
        }
    }

    protected void
    writeResponse(HttpServletResponse resp)
        throws IOException {

    resp.setContentType("text/html;charset=UTF-8");
    PrintWriter out = resp.getWriter();
    out.println("&#x3C;html>");
    out.println("&#x3C;head>");

    // get the RUM JavaScript header for the current web transaction
    out.println(NewRelic.getBrowserTimingHeader());
    out.println("&#x3C;title>NewRelic API example servlet&#x3C;/title>");
    out.println("&#x3C;/head>");
    out.println("&#x3C;body>");
    out.println("&#x3C;h1>API example&#x3C;/h1>");
    // get the RUM JavaScript footer for the current web transaction
    out.println(NewRelic.getBrowserTimingFooter());
    out.println("&#x3C;/body>");
    out.println("&#x3C;/html>");
    out.close();
    }
    protected void doGet(HttpServletRequest req,
    HttpServletResponse resp)
        throws ServletException, IOException {
        processRequest(req, resp);
        }
    protected void doPost(HttpServletRequest req,
    HttpServletResponse resp)
        throws ServletException, IOException {
        processRequest(req, resp);
    }
}

</code></pre>
  </div>
</div>
<h2>How the example uses the API [#app-broken-down]</h2>
<p>Here is the same example app divided into sections that describe how the API is used:</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJjbGFzc05hbWUiLCJ2YWx1ZSI6ImZyZXEtbGluayJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaW1wb3J0LXBhY2thZ2VzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJJbXBvcnQgdGhlIG5lZWRlZCBwYWNrYWdlcyJ9XQ==">
    <div data-prop-text="title">Import the needed packages</div>
    <p>This part of the example shows the imports needed for the example application and Java agent API.</p>
    <pre><code>package test;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.Random;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
// Java agent API imports 
import com.newrelic.api.agent.NewRelic;
import com.newrelic.api.agent.Trace;

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJjbGFzc05hbWUiLCJ2YWx1ZSI6ImZyZXEtbGluayJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic2V0LWFubm90YXRpb24ifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IlNldCBAVHJhY2UgZm9yIHRyYW5zYWN0aW9uIHRyYWNlcyJ9XQ==">
    <div data-prop-text="title">Set @Trace for transaction traces</div>
    <p>This part of the API call provides instructions to instrument this call using New Relic's trace annotation <code>@Trace</code>. Any requests that hit <code>processRequest</code> will now show a segment in APM's <a href="/docs/apm/transactions/transaction-traces/viewing-transaction-traces">Transaction trace call chart</a>.</p>
    <pre><code>public class TestServlet extends HttpServlet {
    // instrumentation via annotation
    @Trace(dispatcher = true)
    protected void
processRequest(HttpServletRequest req,
HttpServletResponse resp)
    throws ServletException, IOException {
    saveNewRelicInfo(req);
    doRequestWork(req);
    writeResponse(resp);
}

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJjbGFzc05hbWUiLCJ2YWx1ZSI6ImZyZXEtbGluayJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibmFtZS10cmFuc2FjdGlvbnMifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkNyZWF0ZSBjdXN0b20gbmFtZXMgZm9yIHdlYiB0cmFuc2FjdGlvbnMifV0=">
    <div data-prop-text="title">Create custom names for web transactions</div>
    <p>This part of the API call instructs web transactions containing a <code>storeId</code> value to appear in APM's <a href="/docs/apm/applications-menu/monitoring/transactions-dashboard"><strong>Transactions</strong> page</a> with the custom transaction name you set. A request to any one store will appear under the same, aggregate name.</p>
    <pre><code>private void
saveNewRelicInfo(HttpServletRequest req) {
    String storeId = req.getParameter("storeId");
    if (storeId != null) {
        // set the name of the Transaction
        NewRelic.setTransactionName(null, "/store");
    }
}

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJjbGFzc05hbWUiLCJ2YWx1ZSI6ImZyZXEtbGluayJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaWdub3JlLWFwZGV4In0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJCeXBhc3MgQXBkZXggd2hlbiBjb2xsZWN0aW5nIG5vbi1wdWJsaWMgZGF0YSJ9XQ==">
    <div data-prop-text="title">Bypass Apdex when collecting non-public data</div>
    <p>This part of the API call excludes the non-public beta <code>storeID</code> from affecting the <a href="/docs/apm/new-relic-apm/apdex/view-your-apdex-score">Apdex score</a>.</p>
    <pre><code>if (storeId.equals("betaStore")) {
        // prevent the method from contributing to the Apdex score 
        NewRelic.ignoreApdex();
    }

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJjbGFzc05hbWUiLCJ2YWx1ZSI6ImZyZXEtbGluayJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoicmVjb3JkLXVzZXItaWQifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IlJlY29yZCB0aGUgdXNlciBJRCJ9XQ==">
    <div data-prop-text="title">Record the user ID</div>
    <p>This part of the API call inserts additional metadata into the <a href="/docs/browser/new-relic-browser/page-load-timing-resources/page-load-timing-process">page load timing</a> request so that browser traces can be tied with the <code>userId</code>. It also records the <code>userId</code> as a custom parameter on the transaction so that it appears in the <a href="/docs/apm/transactions/transaction-traces/transaction-trace-details">parameter details of a transaction trace</a>. (Page load timing sometimes is referred to as real user monitoring or RUM.)</p>
    <pre><code>String userId = req.getParameter("userId");
    if (userId != null) {
        // set the user name to associate with the RUM JavaScript footer 
        // for the current web transaction 
        NewRelic.setUserName(userId); 
        // add a key/value pair to the current transaction 
        NewRelic.addCustomParameter("userId", userId);     
    }

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJjbGFzc05hbWUiLCJ2YWx1ZSI6ImZyZXEtbGluayJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZ2V0LWN1c3RvbS1tZXRyaWMifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkNvbGxlY3QgcHJvbW90aW9uIGRhdGEifV0=">
    <div data-prop-text="title">Collect promotion data</div>
    <p>This part of the API call records the number of times a promotion was viewed so that the metrics can appear on a custom dashboard.</p>
    <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
      <p>For metrics you want to graph in <a href="/docs/dashboards/new-relic-dashboards/custom-dashboards/creating-custom-dashboards">custom dashboards</a>, be sure to prepend <code>Custom/</code> to the metric name; for example, <code>Custom/Promotion</code>.</p>
    </div>
    <pre><code>String promotionId = req.getParameter("promotionId");
    if (promotionId != null) {
        // increment the metric counter for the given name
        NewRelic.incrementCounter("Custom/Promotion");
    }

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJjbGFzc05hbWUiLCJ2YWx1ZSI6ImZyZXEtbGluayJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29udHJvbC1oYW5kbGVyIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJTZW5kIGluc3RydWN0aW9ucyB0byB0aGUgaGFuZGxlciJ9XQ==">
    <div data-prop-text="title">Send instructions to the handler</div>
    <p>This part of the API call sends a set of instructions to the handler for processing requests and handling exceptions.</p>
    <pre><code>protected void
doRequestWork(HttpServletRequest req) {
    try {
        long millisToSleep  = new Random().nextInt(5000);
        Thread.sleep(millisToSleep);
        // record a response time in milliseconds for the given metric name
        NewRelic.recordResponseTimeMetric("Custom/RandomSleep",
millisToSleep);
        } catch (InterruptedException e) {
            // report a handled exception
            NewRelic.noticeError(e, false);
        }
    }
protected void
writeResponse(HttpServletResponse resp)
    throws IOException {

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJjbGFzc05hbWUiLCJ2YWx1ZSI6ImZyZXEtbGluayJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiaW5jbHVkZS1icm93c2VyIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJJbmNsdWRlIHBhZ2UgbG9hZCB0aW1pbmcgY29kZSBpbiB0aGUgSFRUUCByZXNwb25zZSJ9XQ==">
    <div data-prop-text="title">Include page load timing code in the HTTP response</div>
    <p>This part of the API call defines what to include in the <code>HttpServletResponse</code>. For <a href="/docs/agents/java-agent/instrumentation/page-load-timing-java">manual instrumentation of Browser monitoring</a> to monitor page load timing (sometimes referred to as real user monitoring or RUM):</p>
    <ul>
      <li>
        <p>Set the header after the &#x3C;head> tag.</p>
      </li>
      <li>
        <p>Set the footer at the end of &#x3C;body> tag.</p>
        <pre><code>resp.setContentType("text/html;charset=UTF-8");
    PrintWriter out = resp.getWriter();
    out.println("&#x3C;html>");
    out.println("&#x3C;head>");
    // get the RUM JavaScript header for the current web transaction
    out.println(NewRelic.getBrowserTimingHeader());
    out.println("&#x3C;title>NewRelic API example servlet&#x3C;/title>");
    out.println("&#x3C;/head>");
    out.println("&#x3C;body>");
    out.println("&#x3C;h1>API example&#x3C;/h1>");
    // get the RUM JavaScript footer for the current web transaction
    out.println(NewRelic.getBrowserTimingFooter());
    out.println("&#x3C;/body>");
    out.println("&#x3C;/html>");
    out.close();
}
</code></pre>
      </li>
    </ul>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJjbGFzc05hbWUiLCJ2YWx1ZSI6ImZyZXEtbGluayJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29tcGxldGUtcmVzcG9uc2UifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkNvbXBsZXRlIHRoZSBIVFRQIHJlc3BvbnNlIn1d">
    <div data-prop-text="title">Complete the HTTP response</div>
    <p>This part of the API call defines the remaining information to include in the <code>HttpServletResponse</code> response.</p>
    <pre><code>protected void
doGet(HttpServletRequest req,
HttpServletResponse resp)
    throws ServletException, IOException {
    processRequest(req, resp);
    }
protected void
doPost(HttpServletRequest req,
HttpServletResponse resp)
    throws ServletException, IOException {
    processRequest(req, resp);
    }
}

</code></pre>
  </div>
</div>
