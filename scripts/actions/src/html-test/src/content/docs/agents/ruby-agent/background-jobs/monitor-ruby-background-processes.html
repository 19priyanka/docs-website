
<p>Our Ruby agent automatically instruments several common background job frameworks. You can also customize it to trace any background tasks. Data from background jobs appears in the <a href="/docs/apm/applications-menu/monitoring/transactions-page"><strong>Transactions</strong> page</a> in APM as <strong>Non-web transactions</strong>.</p>
<h2>Supported frameworks [#supported_frameworks]</h2>
<p>The following background job frameworks are supported by default in recent versions of the Ruby agent:</p>
<ul>
  <li><a href="/docs/agents/ruby-agent/background-jobs/resque-instrumentation">Resque instrumentation</a> (Ruby agent 3.4.0)</li>
  <li><a href="/docs/agents/ruby-agent/background-jobs/sidekiq-instrumentation">Sidekiq instrumentation</a> (Ruby agent 3.6.0)</li>
  <li><a href="/docs/agents/ruby-agent/background-jobs/delayedjob">Delayed::Job instrumentation</a> (Ruby agent 2.10)</li>
</ul>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p><a href="/docs/agents/ruby-agent/miscellaneous/new-relic-jruby">JRuby</a> users may see issues with CPU metrics.</p>
</div>
<p>If you are using these frameworks, monitoring background jobs typically doesn't require additional configuration.</p>
<h2>Monitor custom background jobs [#custom_background_jobs]</h2>
<p>You can instrument custom background jobs to appear in the APM <a href="/docs/apm/applications-menu/monitoring/transactions-page"><strong>Transactions</strong> page</a> as <strong>Non-web transactions</strong>. To monitor <strong>Non-web transactions</strong> while using an unsupported framework, you must add custom instrumentation.</p>
<p>As an example, a background job periodically runs a task called <code>SalesOrganization#find_new_leads</code>.</p>
<ol>
  <li>
    <p>Add the <code>ControllerInstrumentation</code> module.</p>
  </li>
  <li>
    <p>Use the <code>add_transaction_tracer</code> directive <strong>below</strong> the method definition</p>
  </li>
  <li>
    <p>Add <code>:category => :task</code> to tell the agent this trace is a <strong>Non-web transaction</strong>.</p>
    <pre><code>require 'newrelic_rpm' 

class SalesOrganization
  include 
::NewRelic::Agent::Instrumentation::ControllerInstrumentation 
  def find_new_leads 
    ... 
  end 
  add_transaction_tracer :find_new_leads, :category => :task 
end
</code></pre>
    <p>You can pass a string to the <code>:category</code>, but values will only appear on the APM <strong>Transactions</strong> page if the string begins with <code>OtherTransaction/</code>.</p>
  </li>
</ol>
<h2>Monitor custom background methods [#custom_methods]</h2>
<p>Using the Ruby agent API, you can designate specific methods to trace the <strong>Non-web transactions</strong>. This gathers traces for slow running jobs and associates captured errors to transactions.</p>
<p>To instrument a class method, use the class <code>singleton</code>.</p>
<p>As an example, a background job periodically runs a task called <code>SalesOrganization#find_new_leads</code>.</p>
<ol>
  <li>
    <p>Add the <code>ControllerInstrumentation</code> module <strong>below</strong> the method definition.</p>
  </li>
  <li>
    <p>Use the <code>add_transaction_tracer</code> directive</p>
  </li>
  <li>
    <p>Add <code>:category => :task</code> to tell the agent this trace is a <strong>Non-web transaction</strong>.</p>
    <pre><code>require 'newrelic_rpm' 

class SalesOrganization 
  def self.find_new_leads
    ... 
  end 
  class &#x3C;&#x3C; self 
      include 
::NewRelic::Agent::Instrumentation::ControllerInstrumentation 
    add_transaction_tracer :find_new_leads, :category => :task 
  end 
end
</code></pre>
    <p>For more information, see <a href="/docs/agents/ruby-agent/features/ruby-custom-metrics">Ruby custom metrics</a>.</p>
  </li>
</ol>
<h2>Monitor short-lived processes [#short]</h2>
<p>Make sure the process isn't running before the agent connects to the back-end servers. To do so, make the Ruby agent synchronously connect to New Relic, rather than the default asynchronous behavior.</p>
<p>Use <a href="http://www.rubydoc.info/github/newrelic/rpm/NewRelic%2FAgent%3Amanual_start"><code>manual_start</code></a> and pass in the <code>:sync_startup => true</code> option:</p>
<pre><code>require 'new_relic/agent' 
NewRelic::Agent.manual_start(:sync_startup => true)
</code></pre>
<p>Using <code>require 'new_relic/agent'</code> will require the agent's code, and it will make sure the agent doesn't run until you manually start it.</p>
<h2>Configure newrelic.yml for background processes [#config_file]</h2>
<p>Configuring your <strong>newrelic.yml</strong> depends on the context of the background application.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibm9uX3JhaWxzIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJOb24tUmFpbHMgYmFja2dyb3VuZCBhcHBsaWNhdGlvbiJ9XQ==">
    <div data-prop-text="title">Non-Rails background application</div>
    <p>If your background app is non-Rails application already running the Ruby agent, copy your <strong>newrelic.yml</strong> file to the directory where you launch the background job or in the <strong>config</strong> subdirectory. Make sure it includes your <a href="/docs/accounts-partnerships/accounts/account-setup/your-license-key">license key</a>.</p>
    <p>Background jobs that do not run in a Rails context will examine the <code>NEW_RELIC_ENV</code> environment variable to determine which section of the configuration file to read, falling back to the <code>RUBY_ENV</code>, <code>RAILS_ENV</code>, and <code>RACK_ENV</code> environment variables in sequence, and finally defaulting to <code>development</code> if none of these environment variables are set.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhpc3RpbmdfcmFpbHNfYXBwIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJCYWNrZ3JvdW5kIGpvYiBlbnZpcm9ubWVudCBtb25pdG9yZWQgYnkgTmV3IFJlbGljIn1d">
    <div data-prop-text="title">Background job environment monitored by New Relic</div>
    <p>If your background job runs in the context of an existing web application that is already monitored with New Relic, the Ruby agent will automatically pick up your existing <strong>newrelic.yml</strong> file. Background jobs that boot your application's Rails environment will use the <code>RAILS_ENV</code> environment variable in order to determine which section of the <strong>newrelic.yml</strong> file to read.</p>
  </div>
</div>
<h2>Report to an alternate application name [#reporting_to_an_alternate_application_name]</h2>
<p>You can make jobs that run in the context of an existing New Relic web application appear under a <a href="/docs/apm/new-relic-apm/installation-configuration/naming-your-application">different application name</a> in the APM UI.</p>
<ol>
  <li>
    <p>Begin <strong>before</strong> <code>newrelic_rpm</code> gets required by your worker code.</p>
  </li>
  <li>
    <p>Set the <code>NEW_RELIC_APP_NAME</code> environment variable to the application name to use for your background jobs when starting your background worker processes. This will override the <code>app_name</code> setting in your <strong>newrelic.yml</strong>.</p>
    <pre><code>$ NEW_RELIC_APP_NAME="My Background Jobs" 
./bin/my_background_worker.rb
</code></pre>
  </li>
</ol>
<h2>Ensure the agent starts [#start_agent]</h2>
<p>The Ruby agent will automatically start in most cases as soon as you <code>require 'newrelic_rpm'</code>, unless the agent detects a blacklisted executable name, rake task name, or constant. This prevents it from starting during common rake tasks and interactive console sessions.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoibm9uX3JhaWxzX3N0YW5kYWxvbmUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6Ik5vbi1SYWlscyBzdGFuZGFsb25lIHNjcmlwdCJ9XQ==">
    <div data-prop-text="title">Non-Rails standalone script</div>
    <p>Standalone scripts running without Rails generally will start the agent as soon as they <code>require 'newrelic_rpm'</code>. If you have a script that forks or daemonizes before it begins its main work, you may want to defer this <code>require</code> call until after the initial setup finishes.</p>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZXhpc3Rpbl9yYWlsc19hcHAifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IkJhY2tncm91bmQgdGFza3Mgd2l0aCBkYWVtb25zIGdlbSJ9XQ==">
    <div data-prop-text="title">Background tasks with daemons gem</div>
    <p>If you use the <a href="https://rubygems.org/gems/daemons">daemons gem</a> to start background tasks, the Ruby agent may fail to start and also not emit any logging. This happens because the daemons gem changes the working directory to <code>/</code> before executing your background code. The agent then attempts to resolve the paths to its configuration file and log file relative to the current working directory of the host process.</p>
    <p>To allow the agent to start in this situation, set environment variables with the locations of the agent configuration file and log file; for example:</p>
    <pre><code>ENV['NRCONFIG'] ||= File.dirname(__FILE__) + 
    '/../../config/newrelic.yml' 
    ENV['NEW_RELIC_LOG'] ||= File.dirname(__FILE__) + 
    '/../../log/newrelic_agent.log'

</code></pre>
  </div>
</div>
<p>For more information, see the documentation about <a href="/docs/agents/ruby-agent/troubleshooting/controlling-when-ruby-agent-starts">controlling agent startup</a></p>
<h2>Monitor scripts [#monitoring_scripts]</h2>
<p>The <a href="#start_agent">agent startup instructions</a> apply when running background jobs in a daemon. If a script executes a single background task and exits, manually shut down the agent with <code>::NewRelic::Agents.shutdown</code> when the script finishes. This ensures the New Relic collector receives the data. For example:</p>
<pre><code>require 'newrelic_rpm' 

class SalesOrganization 
  include 
::NewRelic::Agent::Instrumentation::ControllerInstrumentation 
  def find_new_leads 
    ...
  end 
  add_transaction_tracer :find_new_leads, :category => :task 
end 

SalesOrganization.new.find_new_leads 
::NewRelic::Agent.shutdown
</code></pre>
<h2>For more help [#more_help]</h2>
<p>Additional documentation resources include:</p>
<ul>
  <li><a href="/docs/agents/ruby-agent/features/ruby-custom-metrics">Ruby custom metrics</a> (method tracers, metric names, stats, examples</li>
  <li><a href="/docs/agents/ruby-agent/installation-and-configuration/ruby-agent-api">Ruby agent API</a> (public API methods for the New Relic Ruby agent)</li>
</ul>
