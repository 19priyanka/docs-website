
<p>With APM's <a href="/docs/agents/java-agent/getting-started/introduction-new-relic-java">Java agent</a>, you can monitor applications that reside in the <a href="https://cloud.google.com/appengine/docs/flexible/java/">Google App Engine (GAE) flexible environment</a>. Adding New Relic to your GAE flex app gives you insight into the health and performance of your app and extends GAE with metrics you can view in <a href="/docs/apm/new-relic-apm/getting-started/introduction-new-relic-apm">APM</a>, <a href="/docs/browser/new-relic-browser/getting-started/introduction-new-relic-browser">Browser</a>, and <a href="/docs/query-your-data/explore-query-data/dashboards/introduction-new-relic-one-dashboards">dashboards</a>.</p>
<p>This document explains how to add New Relic to your GAE flex app by configuring a <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/about-custom-runtimes">custom runtime</a>, and gives an example of deploying a Tomcat app with Docker.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>The New Relic Java agent can run in a GAE flexible environment using a custom runtime. Due to limitations of other environments, do not use the GAE standard environment or Google App Engine's <a href="/docs/accounts-partnerships/partnerships/google-cloud-platform-gcp/google-app-engine-environment#native-mode">"native mode"</a> installation.</p>
</div>
<h2>Build a custom runtime using Docker [#build-runtime]</h2>
<p>See <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/build">Google's documentation for building custom runtimes</a>. There are many ways to build a custom runtime that contains the New Relic Java agent (<a href="#tomcat-example">for example, using Tomcat</a>). In general, to build a custom runtime:</p>
<ol>
  <li><a href="#setup-gae">Set up your application</a> and install necessary GAE-related dependencies for custom runtimes. Include the New Relic Java agent in the project.</li>
  <li>Configure <a href="#configure-pom-xml">Maven or Gradle</a> as applicable.</li>
  <li>Configure the <a href="#configure-app-yaml"><code>app.yaml</code> file</a>.</li>
  <li>Configure the <a href="#configure-dockerfile">Dockerfile</a>.</li>
  <li><a href="#build-docker-image">Build the Docker image</a>.</li>
  <li><a href="#deploy-docker-image-to-gae">Deploy</a> the Docker image to the initialized GAE flexible environment.</li>
  <li><strong>Recommendation:</strong> <a href="#health-checks">Disable GAE health checks</a>.</li>
</ol>
<p>For more information about deploying and configuring your Java app in the GAE flexible environment, see:</p>
<ul>
  <li><a href="https://cloud.google.com/appengine/docs/flexible/java/">Google App Engine's documentation</a> for Java</li>
  <li><a href="https://cloud.google.com/appengine/docs/flexible/java/tutorials">Google App Engine's tutorials</a> to deploy a Java app</li>
</ul>
<h2>GAE flex example with Tomcat [#tomcat-example]</h2>
<p>This example describes how to add New Relic to your GAE flex app by installing the New Relic Java agent, building a custom runtime, and deploying an application WAR to Tomcat. Be sure to <a href="/docs/agents/java-agent/installation/include-java-agent-jvm-argument">install the Java agent</a> as necessary for your specific app server.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoic2V0dXAtZ2FlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIxLiBTZXQgdXAgR0FFIGZsZXhpYmxlIHByb2plY3QgYW5kIGluc3RhbGwgZGVwZW5kZW5jaWVzIn1d">
    <div data-prop-text="title">1. Set up GAE flexible project and install dependencies</div>
    <ol>
      <li>
        <p>Follow standard procedures to <a href="/docs/agents/java-agent/installation/include-java-agent-jvm-argument">install the Java agent</a> as necessary for your specific app server, and obtain your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">license key</a>.</p>
      </li>
      <li>
        <p>Follow <a href="https://cloud.google.com/appengine/docs/flexible/java/managing-projects-apps-billing#create">Google App Engine procedures for Java</a> to create a new Cloud Platform project, create an App Engine application, and complete other prerequisites for the <a href="https://cloud.google.com/sdk/gcloud/">Google Cloud SDK</a>.</p>
      </li>
      <li>
        <p>Install any necessary dependencies, such as the <a href="https://cloud.google.com/appengine/docs/flexible/java/using-maven">Maven</a> or <a href="https://cloud.google.com/appengine/docs/flexible/java/using-gradle">Gradle</a> App Engine plugin, and <a href="http://www.oracle.com/technetwork/java/javase/downloads/jre8-downloads-2133155.html">Java</a>.</p>
        <p>The Google Cloud SDKprovides the <code>gcloud</code> command line tool to manage and deploy GAE apps.</p>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlndXJlLXBvbS14bWwifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjIuIENvbmZpZ3VyZSBNYXZlbiBwb20ueG1sIHRvIGluY2x1ZGUgSmF2YSBhZ2VudCBhbmQgYnVpbGQgcHJvamVjdCJ9XQ==">
    <div data-prop-text="title">2. Configure Maven pom.xml to include Java agent and build project</div>
    <p>This example uses Maven to build the project, a Docker Tomcat image to run it, and the <code>gcloud</code> command line tool to deploy the Docker image to a GAE flexible environment.</p>
    <ol>
      <li>
        <p>Add the Java agent dependencies to the project's <code>target</code> directory when the project is built, when you <a href="/docs/agents/java-agent/frameworks/maven-installation-java#h2-zip">download and unzip all Java agent components</a>.</p>
      </li>
      <li>
        <p>After adding the Java agent dependencies to the <code>pom.xml</code>, build your application by running:</p>
        <pre><code>mvn clean install
</code></pre>
      </li>
      <li>
        <p>Check your project's <code>target</code> directory to find the app's <code>WAR</code> file and an unzipped <code>newrelic</code> directory.</p>
        <p>These files will be incorporated into a Docker image.</p>
        <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
          <p>You can also add the <a href="http://cloud.google.com/appengine/docs/flexible/java/using-maven#adding_the_app_engine_maven_and_jetty_maven_plugins">App Engine Maven or Jetty Maven plugin</a> to your <code>pom.xml</code>. This will allow you to use Maven to deploy your app to a GAE flexible environment.</p>
        </div>
      </li>
    </ol>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlndXJlLWFwcC15YW1sIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiIzLiBDb25maWd1cmUgeW91ciBhcHAueWFtbCJ9XQ==">
    <div data-prop-text="title">3. Configure your app.yaml</div>
    <p>The <a href="https://cloud.google.com/appengine/docs/flexible/java/configuring-your-app-with-app-yaml">app.yaml</a> configuration file is required for a GAE flexible environment app with a custom runtime. At a minimum, make sure it contains:</p>
    <pre><code>env: flex
runtime: custom

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY29uZmlndXJlLWRvY2tlcmZpbGUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjQuIENvbmZpZ3VyZSB0aGUgRG9ja2VyZmlsZSJ9XQ==">
    <div data-prop-text="title">4. Configure the Dockerfile</div>
    <p>The <a href="http://docs.docker.com/engine/reference/builder/">Dockerfile</a> defines the Docker image to be built and is required for a GAE flexible environment app. In the following Dockerfile example code, the <code>newrelic.yml</code> and <code>catalina.sh</code> files have been configured locally, to replace those already copied to the Docker image. (You can add your <a href="/docs/accounts-partnerships/accounts/account-setup/license-key">New Relic license key</a> directly to your Dockerfile, or use an environment variable in your <code>docker run</code> command.)</p>
    <pre><code># base Tomcat image to build Docker image from
FROM tomcat:8.5.14-jre8

MAINTAINER Jane Doe &#x3C;janedoe@mail.com>

# Tomcat directory to copy Java agent files to
ENV NEWRELIC_HOME /usr/local/tomcat/newrelic

# copy application war from target to Tomcat webapps
ADD target/*.war /usr/local/tomcat/webapps

# copy Java agent files from target to Tomcat NEWRELIC_HOME
ADD target/newrelic ${NEWRELIC_HOME}

# update Java agent yml with license_key and app_name and copy to image  
ADD newrelic.yml ${NEWRELIC_HOME}

# update catalina.sh with -javaagent:/path/to/newrelic.jar and copy to image 
ADD catalina.sh /usr/local/tomcat/bin/

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiYnVpbGQtZG9ja2VyLWltYWdlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiI1LiBCdWlsZCB0aGUgRG9ja2VyIGltYWdlIn1d">
    <div data-prop-text="title">5. Build the Docker image</div>
    <p>To build a Docker image that runs Tomcat with the New Relic Java agent monitoring your deployed application WAR, run the following command. Be sure to include the period at the end of the code, to indicate the current directory contains the build files.</p>
    <pre><code>docker build -f Dockerfile -t newrelic-tomcat .

</code></pre>After running this command, verify that you have a Docker image named `newrelic-tomcat`.
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiZGVwbG95LWRvY2tlci1pbWFnZS10by1nYWUifSx7InR5cGUiOiJtZHhBdHRyaWJ1dGUiLCJuYW1lIjoidGl0bGUiLCJ2YWx1ZSI6IjYuIERlcGxveSBEb2NrZXIgaW1hZ2UgdG8gaW5pdGlhbGl6ZWQgR0FFIGZsZXhpYmxlIGVudmlyb25tZW50In1d">
    <div data-prop-text="title">6. Deploy Docker image to initialized GAE flexible environment</div>
    <ol>
      <li>
        <p>To deploy your Docker image to your <a href="https://cloud.google.com/sdk/docs/initializing">initialized GAE flexible environment</a>, run the following command:</p>
        <pre><code>gcloud app deploy
</code></pre>
      </li>
      <li>
        <p>Wait until the deployment completes.</p>
      </li>
      <li>
        <p>To open the app in the browser, run the following command:</p>
        <pre><code>gcloud app browse
</code></pre>
      </li>
      <li>
        <p>To view your GAE flex app data in New Relic, go to the <a href="/docs/apm/applications-menu/monitoring/apm-overview-page">APM <strong>Summary</strong> page</a>.</p>
      </li>
    </ol>
  </div>
</div>
<h2>Recommendation: Disable health checks [#health-checks]</h2>
<p>Google App Engine sends <a href="https://cloud.google.com/appengine/docs/flexible/java/how-instances-are-managed">periodic health check requests</a> to confirm that an instance has been successfully deployed, and to check that a running instance maintains a healthy status. A health check is an HTTP request to the URL <code>/_ah/health</code>.</p>
<p>If you create a custom runtime, your app must be able to handle a large number of health check requests. Otherwise, your app data may not display correctly in APM. To avoid adding additional instrumentation overhead and skewing throughput for your application, we recommend that you disable the health check.</p>
<p><strong>Recommendation:</strong> Configure your <code>app.yaml</code> to <a href="https://cloud.google.com/appengine/docs/flexible/java/configuring-your-app-with-app-yaml#health_checks">disable health checks</a> by adding:</p>
<pre><code>health_check:
  enable_health_check: False
</code></pre>
<h2>Get Java agent troubleshooting logs from GAE [#java-agent-logs]</h2>
<p>Use these resources to troubleshoot your GAE flex environment app:</p>
<ul>
  <li>
    <p>To connect to the GAE instance and start a shell in the Docker container running your code, see <a href="https://cloud.google.com/appengine/docs/flexible/java/debugging-an-instance">Debugging an Instance</a>.</p>
  </li>
  <li>
    <p>To redirect New Relic Java agent logs to <a href="http://cloud.google.com/logging/docs/view/logs_viewer_v2">Stackdriver</a> in the <a href="https://cloud.google.com/compute/docs/console">Cloud Platform Console</a>, change the <code>newrelic.yml</code>file to:</p>
    <pre><code>log_file_name: STDOUT
</code></pre>
  </li>
  <li>
    <p>To view the logs, use the <a href="https://cloud.google.com/appengine/docs/flexible/php/writing-application-logs">Cloud Platform Console's Log Viewer</a>.</p>
  </li>
</ul>
