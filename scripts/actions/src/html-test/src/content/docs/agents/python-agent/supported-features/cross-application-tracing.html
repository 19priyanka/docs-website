
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>A <a href="https://docs.newrelic.com/docs/apm/distributed-tracing/getting-started/introduction-distributed-tracing">distributed tracing</a> feature is now available. Distributed tracing improves on cross application tracing and is recommended for monitoring activity in complex distributed systems.</p>
</div>
<p><a href="https://docs.newrelic.com/docs/apm/transactions/cross-application-traces/introduction-cross-application-traces">Cross application tracing</a> is supported by the Python agent through built in instrumentation and through the use of APIs for custom instrumentation.</p>
<p>The protocol used to communicate between applications involves attaching metadata to requests and responses. The metadata is processed by each application and the resulting data is reported by the agent.</p>
<h2>Requirements</h2>
<p>You must have <a href="/docs/release-notes/agent-release-notes/python-release-notes/python-agent-292078">Python agent version 2.92.0.78</a> or higher.</p>
<h2>Custom client (HTTP)</h2>
<p>
  <img src="./images/client_http_transport.png" alt="client_http_transport.png" title="client_http_transport.png">
</p>
<p>These APIs are used for custom HTTP communication libraries that are not instrumented as part of the built in instrumentation.</p>
<p>HTTP cross application tracing uses HTTP headers to transport transaction metadata across applications. To generate outbound cross application tracing headers, use the <code>generate_request_headers</code> API on the <code>ExternalTrace</code> class. To process inbound cross application tracing headers, use the <code>process_response_headers</code> API on the <code>ExternalTrace</code> class.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY3VzdG9tLWNsaWVudC1odHRwLW91dGdvaW5nIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJPdXRnb2luZyByZXF1ZXN0cyJ9XQ==">
    <div data-prop-text="title">Outgoing requests</div>
    <pre><code>import newrelic.agent

transaction = newrelic.agent.current_transaction()
# returns a list of tuples in the form (header_name, header_value)
outgoing_headers = newrelic.agent.ExternalTrace.generate_request_headers(transaction)
for header_name, header_value in outgoing_headers:
    ...request.putheader(header_name, header_value) # code to be instrumented
...make_request(request) # code to be instrumented

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY3VzdG9tLWNsaWVudC1odHRwLWluY29taW5nIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJJbmNvbWluZyByZXNwb25zZSJ9XQ==">
    <div data-prop-text="title">Incoming response</div>
    <pre><code>import newrelic.agent

transaction = newrelic.agent.current_transaction()
trace = newrelic.agent.ExternalTrace(transaction, 'library', 'http://example.com', 'get')
with trace:
    response = fetch_example_dot_com() # code to be instrumented
    trace.process_response_headers(...response.headers)

</code></pre>
  </div>
</div>
<h2>Custom client (non-HTTP)</h2>
<p>
  <img src="./images/client_custom_transport.png" alt="client_custom_transport.png" title="client_custom_transport.png">
</p>
<p>These APIs are used to instrument libraries that do not use the HTTP transport (and therefore may not be able to use headers as a metadata transport) and are not instrumented as part of the built in instrumentation.</p>
<h3>Example Instrumentation</h3>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY3VzdG9tLWNsaWVudC1ub24taHR0cC1vdXRnb2luZyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiT3V0Z29pbmcgcmVxdWVzdHMifV0=">
    <div data-prop-text="title">Outgoing requests</div>
    <pre><code>import newrelic.agent

transaction = newrelic.agent.current_transaction()
# returns a string value
outgoing_metadata = newrelic.agent.ExternalTrace.get_request_metadata(transaction)
...request.add_metadata(outgoing_metadata) # code to be instrumented
...make_request(request) # code to be instrumented

</code></pre>
  </div>
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY3VzdG9tLWNsaWVudC1ub24taHR0cC1pbmNvbWluZyJ9LHsidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ0aXRsZSIsInZhbHVlIjoiSW5jb21pbmcgcmVzcG9uc2UifV0=">
    <div data-prop-text="title">Incoming response</div>
    <pre><code>import newrelic.agent

transaction = newrelic.agent.current_transaction()
trace = newrelic.agent.ExternalTrace(transaction, 'library', 'myproto://service', 'fetch')
with trace:
    ...response = fetch_from_service() # code to be instrumented
    # extract the metadata string sent from the service
    metadata_value = response.metadata # code to be instrumented
    trace.process_response_metadata(metadata_value)

</code></pre>
  </div>
</div>
<h2>WSGI server [#wsgi]</h2>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p>The agent will automatically handle processing and sending responses to cross application trace metadata for all WSGI servers.</p>
</div>
<p>For information on instrumenting WSGI servers, see <a href="https://docs.newrelic.com/docs/agents/python-agent/python-agent-api/wsgi_application">the wsgi_application API documentation</a> for details.</p>
<h2>Custom non-HTTP server</h2>
<p>
  <img src="./images/server_nonhttp_transport.png" alt="server_nonhttp_transport.png" title="server_nonhttp_transport.png">
</p>
<p>Custom servers that are not WSGI based or do not use HTTP as a transport will have to process incoming cross application tracing metadata and generate cross application trace responses.</p>
<p>The following APIs allow processing of cross application tracing metadata sent on non-HTTP requests and generating response metadata to send back to the caller.</p>
<div data-component="CollapserGroup" data-prop="W10=">
  <div data-component="Collapser" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJpZCIsInZhbHVlIjoiY3VzdG9tLW5vbi1odHRwLXNlcnZlci1leGFtcGxlIn0seyJ0eXBlIjoibWR4QXR0cmlidXRlIiwibmFtZSI6InRpdGxlIiwidmFsdWUiOiJFeGFtcGxlIGluc3RydW1lbnRhdGlvbiJ9XQ==">
    <div data-prop-text="title">Example instrumentation</div>
    <pre><code>import newrelic.agent

def handle_incoming_request(request):
    transaction = newrelic.agent.current_transaction()
    if transaction:
    	transaction.process_request_metadata(...request.metadata)

    response = generate_response() # code to be instrumented

    if transaction:
    	# get_response_metadata returns a string
        ...response.metadata = transaction.get_response_metadata()
    return response

</code></pre>
  </div>
</div>
