
<p>This page documents how to embed Insights in Docs site pages. This helps New Relic Support help customers to do the same in Drupal and PHP environments.</p>
<p>This example uses the Drupal <a href="//www.drupal.org/project/new_relic_insights">Insights module</a>, created by <a href="//www.eric.pe/terson/">Eric Peterson</a> of <a href="//www.tableau.com">Tableau Software</a>. See the module documentation for details of its own operation.</p>
<h2>Drupal Insights example [#h2_example]</h2>
<p>Currently all content pages have a report at the top of the page that provides current customer satisfaction (CSAT) data for that page. This includes:</p>
<ul>
  <li>Page visits in the last 30 days</li>
  <li>Number of feedback responses to this page in the last 30 days if applicable</li>
  <li>CSAT performance in the past 30 days as a percentage and as the number of Yes and No votes</li>
  <li>A collapsible list of any comments provided with the feedback if applicable</li>
</ul>
<p>
  <img src="./images/2015-07-17_11-55-25.png" alt="Embedded CSAT bar" title="Embedded CSAT bar">
</p>
<p>The CSAT bar is embedded at the top of every content page in the Docs site.</p>
<h2>The block [#h2_block]</h2>
<p>This code defines the block to be included in the page. It is in <strong>nrkb_library.module</strong>. Numerous blocks could be declared here, but we are just declaring one.</p>
<p>The block is a container for our CSAT results. Blocks in use are assigned to template regions in the document using the Blocks menu (<strong>/admin/structure/block</strong>).</p>
<pre><code class="language-php">function nrkb_library_block_info(){
  $block['csat_results'] = array(
    'info' => t('CSAT Results'),
  );
  return $block;
}
</code></pre>
<h2>The code [#h2_code]</h2>
<p>This code generate the block contents for CSAT feedback. It is in <strong>nrkb_library.module</strong>.</p>
<p>We are using a hook to create a block view to live in the block defined above. It is semi-generic, allowing the implementation of other blocks within the same function call.</p>
<p>Inline comments have been removed. Important points will be called out with breaks i nthe code block.</p>
<pre><code class="language-php">function nrkb_library_block_view($block_key){
  $block = array();
  if($block_key == 'csat_results'){
</code></pre>
<p>To work with the <a href="//www.drupal.org/project/new_relic_insights">Insights module</a>, we need to use the <a href="//www.drupal.org/project/entity">Entity API</a>. We are using it to create a virtual data source we can interact with as if it were a database.</p>
<pre><code class="language-php">$efq = create_field_query('insight');
</code></pre>
<p>The query itself is just grabbed from a widget in Insights with variables added into the string to customize what we are looking for. For instance:</p>
<pre><code class="language-php">$nrql = "SELECT userComments as 'Comments' FROM csatFeedback WHERE path ='".current_path()."' SINCE 30 days ago";
</code></pre>
<p>Assemble our results. This is the bulk of our work.</p>
<p>This will be a pain point for customers trying to craft local code.</p>
<p>Insights is inconsistent in its output naming. The name of the field is determined by the type of data being returned, often the name of the NRQL function that generated the result. At present, the only way to determine which keys are applied to which fields is to reverse engineer the JSON query on a case by case basis.</p>
<p>Since different returned field types can have different formats or meanings, we have to determine what the field returned is, so we can determine how to return its value.</p>
<p>In this example, we grab the data type as <code>$key</code> so we can use it to get the value of the field. To test special cases, match the value of <code>$key</code> and conditions that pass the field to specific formatting functiions.</p>
<p>Examples of some fixes:</p>
<ul>
  <li>Insights is inconsistent with whether it returns blank or zero for zero, depending on the field type. Since we know we are only working with numbers, set blanks to zero.</li>
  <li>Convert a ratio value to a percentage, with two decimal places a percent sign.</li>
</ul>
<p>Each iteration grabs another field from the results and generates the HTML output for it.</p>
<pre><code class="language-php">foreach ($insights_result->results as $key => $value) {
      $insights_label = $insights_result->metadata->contents[$key]->alias;
      $insights_value = array();
      $object_array = get_object_vars($value);
      foreach ($object_array as $key => $value){ $insights_value[] = $value; }
      if ($insights_value[0] == '') { $insights_value[0] = 0; }
      if ($insights_label == 'CSAT') { $insights_value[0] = round(($insights_value[0]*100),2).'%'; }
      $pattern = '/([^\w\d]?)*/i';
      $insights_class = preg_replace($pattern, '', $insights_label);
      $insights_display.= '&#x3C;span class="results-field results-'.$insights_class.'">'.$insights_label.': '.$insights_value[0].'&#x3C;/span>'."\n";
    }
</code></pre>
