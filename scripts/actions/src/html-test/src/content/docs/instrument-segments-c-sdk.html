
<p>Once you <a href="https://docs.newrelic.com/docs/instrument-transactions-c-agent">instrument a transaction</a> using the C SDK, you can instrument <a href="/docs/apm/transactions/intro-transactions/transactions-new-relic-apm#segments">segments</a> in that <a href="/docs/apm/transactions/intro-transactions/transactions-new-relic-apm">transaction</a>. By instrumenting segments, you can monitor the individual functions and calls inside of a transaction.</p>
<p><strong>Example:</strong> You have a transaction associated with a checkout process, which processes both shipping information and credit card information. You can instrument your application to break that transaction up into two segments: one segment for shipping and one segment for payment.</p>
<h2>Contents [#in-page-toc]</h2>
<p>For an index of documentation during the private Beta, see the <a href="https://docs.newrelic.com/docs/c-agent-table-contents">C SDK table of contents</a>.</p>
<h2>Segment methods</h2>
<p>You can work with segments in these ways:</p>
<div data-component="Table" data-prop="W10=">
  <div>
    <div>
      <div>
        <p>If you want to monitor calls to...</p>
      </div>
      <div>
        <p>Do this...</p>
      </div>
    </div>
  </div>
  <div>
    <div>
      <div>
        <p>External services</p>
      </div>
      <div>
        <p><a href="#external-segments">Instrument external segments</a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Arbitrary code</p>
      </div>
      <div>
        <p><a href="#custom-segments">Instrument custom segments</a></p>
      </div>
    </div>
    <div>
      <div>
        <p>Datastores</p>
      </div>
      <div>
        <p><a href="#datastore-segments">Instrument datastore segments</a></p>
      </div>
    </div>
    <div>
      <div>
        <p>SQL databases</p>
      </div>
      <div>
        <p><a href="#slow-query-datastore">Report slow query traces for datastore segments</a></p>
      </div>
    </div>
  </div>
</div>
<h2>Instrument calls to external services [#external-segments]</h2>
<p>To monitor calls to external services, instrument external segments that are within an instrumented transaction. External segments appear in the New Relic UI in the <a href="/docs/apm/applications-menu/monitoring/transactions-page-find-specific-performance-problems">APM <strong>Transactions</strong> page's <strong>Breakdown</strong> table</a> and the <a href="/docs/apm/applications-menu/monitoring/external-services-page"><strong>External services</strong> page</a>.</p>
<p>To instrument an external segment, wrap the New Relic functions that start and stop instrumentation around the function you want to monitor:</p>
<ol>
  <li>
    <p><a href="/docs/instrument-transactions-c-agent">Instrument a transaction</a>.</p>
  </li>
  <li>
    <p>Create a <code>newrelic_external_segment_params_t</code> struct that describes the external segment.</p>
  </li>
  <li>
    <p>Add the following code immediately before the function you want to monitor, supplying the required parameters described in your <a href="https://source.datanerd.us/c-agent/c-agent/blob/master/GUIDE.md#getting-started"><code>libnewrelic.h</code></a>. For more information, see the <a href="https://source.datanerd.us/c-agent/c-agent/blob/master/examples/README.md">New Relic C SDK <strong>Examples/README.md</strong> on GitHub</a>.</p>
    <pre><code>newrelic_start_external_segment()
</code></pre>
  </li>
  <li>
    <p>Add the following code immediately after the function you want to monitor, supplying the required parameters described in your <a href="https://source.datanerd.us/c-agent/c-agent/blob/master/GUIDE.md#getting-started"><code>libnewrelic.h</code></a>. For more information, see the <a href="https://source.datanerd.us/c-agent/c-agent/blob/master/examples/README.md">New Relic C SDK <strong>Examples/README.md</strong> on GitHub</a>.</p>
    <pre><code>newrelic_end_segment()
</code></pre>
  </li>
</ol>
<p>For more information about external segments, see the <a href="https://source.datanerd.us/c-agent/c-agent/blob/master/GUIDE.md#external-segments">New Relic C SDK <strong>GUIDE.md</strong> on GitHub</a>.</p>
<h2>Instrument calls to arbitrary code [#datastore-segments]</h2>
<p>To monitor calls to arbitrary code, instrument custom segments that are within an instrumented transaction. Custom segments appear in the <a href="/docs/apm/applications-menu/monitoring/transactions-page-find-specific-performance-problems">APM <strong>Transactions</strong> page's <strong>Breakdown</strong> table</a>.</p>
<p>To instrument a custom segment, wrap the New Relic functions that start and stop instrumentation around the function you want to monitor:</p>
<ol>
  <li>
    <p><a href="/docs/instrument-transactions-c-agent">Instrument a transaction</a>.</p>
  </li>
  <li>
    <p>Add the following code immediately before the function you want to monitor:</p>
    <pre><code>newrelic_start_segment()
</code></pre>
  </li>
  <li>
    <p>Add the following code immediately after the function you want to monitor:</p>
    <pre><code>newrelic_end_segment()
</code></pre>
  </li>
</ol>
<p>For more information, see the <a href="https://source.datanerd.us/c-agent/c-agent/blob/master/examples/README.md">New Relic C SDK <strong>Examples/README.md</strong> on GitHub</a>.</p>
<h2>Instrument calls to datastores [#datastore-segments]</h2>
<p>Instrument datastore segments that are within an instrumented transaction to monitor calls to datastores. Datastore segments appear in the <strong>Breakdown</strong> table and <strong>Databases</strong> tab of the <a href="/docs/apm/applications-menu/monitoring/transactions-page"><strong>Transactions</strong> page</a> in the New Relic UI. You can also view datastore segments in <a href="/docs/insights/use-insights-ui/getting-started/introduction-new-relic-insights">New Relic Insights</a> as a <code>databaseDuration</code> attribute of <a href="/docs/insights/insights-data-sources/default-events-attributes/apm-default-event-attributes#transaction-event"><code>Transaction</code> events</a>.</p>
<p>To instrument a datastore segment, wrap the New Relic functions that start and stop instrumentation around the function you want to monitor:</p>
<ol>
  <li>
    <p><a href="/docs/instrument-transactions-c-agent">Instrument a transaction</a>.</p>
  </li>
  <li>
    <p>Create a <code>newrelic_datastore_segment_params_t</code> struct that describes the datastore segment.</p>
  </li>
  <li>
    <p>Add the following code immediately before the function you want to monitor:</p>
    <pre><code>newrelic_start_datastore_segment()
</code></pre>
  </li>
  <li>
    <p>Add the following code immediately after the function you want to monitor:</p>
    <pre><code>newrelic_end_segment()
</code></pre>
  </li>
</ol>
<h2>Report slow query traces for datastore segments [#slow-query-datastore]</h2>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>You can report slow query traces for SQL databases only.</p>
</div>
<p>To report slow query trace data for datastore segments that take longer than the time you specify, enable these settings in the C SDK configuration file:</p>
<ol>
  <li>Enable slow query tracing by setting <code>transaction_tracer.datastore_reporting.enabled</code> to <code>true</code>.</li>
  <li>To set the threshold, add a length of time in microseconds to <code>transaction_tracer.datastore_reporting.threshold_us</code>.</li>
</ol>
<p>Then, if a datastore call takes longer than the threshold, the C SDK reports it as a slow query. To view slow query trace details, use the <a href="/docs/apm/applications-menu/monitoring/databases-page"><strong>Databases</strong></a> and <a href="/docs/apm/applications-menu/monitoring/view-slow-query-details"><strong>Slow queries</strong></a> pages in the New Relic UI.</p>
<h2>For more help [#more_help]</h2>
<p>Beta support for the C SDK is being handled through <a href="https://discuss.newrelic.com/c/support-products-agents/c-agent-pre-release">New Relic's Explorers Hub in a private group</a>. If you need access to the support group, contact Jodee Varney (Product Manager) at <a href="mailto:jvarney@newrelic.com">jvarney@newrelic.com</a>. Normal support channels will re-route you to the community or the Product Manager.</p>
