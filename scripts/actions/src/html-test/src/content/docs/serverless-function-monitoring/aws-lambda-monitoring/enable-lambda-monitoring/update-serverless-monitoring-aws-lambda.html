
<p>After <a href="/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/enable-new-relic-monitoring-aws-lambda">enabling our monitoring for AWS Lambda</a>, you should occasionally update our Lambda function that's used to report AWS log data: <code>newrelic-log-ingestion</code>.</p>
<p>There are two ways to do this:</p>
<ul>
  <li><a href="#update-cli">Update via CLI</a>: Use this if you enabled our Lambda monitoring using our <a href="/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/enable-new-relic-monitoring-aws-lambda#cli">CLI tool</a>.</li>
  <li><a href="#update-sar">Update via AWS Serverless Application Repository</a>: Use this if you enabled using the <a href="/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/enable-new-relic-monitoring-aws-lambda#manual-nr-lambda">manual procedure</a>.</li>
</ul>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>These update procedures apply to our <a href="/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/introduction-new-relic-monitoring-aws-lambda">serverless monitoring for AWS Lambda</a>, and not to our <a href="/docs/integrations/amazon-integrations/aws-integrations-list/aws-lambda-monitoring-integration">infrastructure monitoring for AWS Lambda integration</a>.</p>
</div>
<h2>Update our Lambda integration via CLI [#update-cli]</h2>
<p>This section describes how to update if your Lambda monitoring was enabled using our recommended <a href="/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/enable-new-relic-monitoring-aws-lambda#cli">CLI tool</a>.</p>
<ol>
  <li>
    <p>Make sure you have the latest version of the CLI:</p>
    <pre><code>pip install --upgrade newrelic-lambda-cli
</code></pre>
  </li>
  <li>
    <p>For each region in which you've installed the <code>newrelic-log-ingestion</code> function, run the following command, replacing YOUR_REGION with your region identifier (for example, <code>us-west-2</code>).</p>
    <pre><code>newrelic-lambda integrations update \
    --aws-region YOUR_REGION
</code></pre>
  </li>
  <li>
    <p>If you do not have our logs enabled, you'll also need to update your Amazon CloudWatch log subscription filters with the following command:</p>
    <pre><code>newrelic-lambda subscriptions install \
    --function installed \
    --aws-region YOUR_REGION
</code></pre>
  </li>
</ol>
<h2>Update Layers via CLI [#update-layer-cli]</h2>
<p>This section describes how to update your function's Layer if you installed it with our <a href="/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/enable-new-relic-monitoring-aws-lambda#cli">CLI tool</a>.</p>
<ol>
  <li>
    <p>Make sure you have the latest version of the CLI:</p>
    <pre><code>pip install --upgrade newrelic-lambda-cli
</code></pre>
  </li>
  <li>
    <p>Pass the <code>--upgrade</code> flag to the install command:</p>
    <pre><code>newrelic-lambda layers install \
    --function installed \
    --nr-account-id NR_ACCOUNT_ID \
    --upgrade
</code></pre>
  </li>
</ol>
<h2>Update a manual Serverless Application Repository install [#update-sar]</h2>
<p>If you <a href="https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/enable-new-relic-monitoring-aws-lambda#manual-nr-lambda">manually installed the ingest function from the AWS Serverless Application Repository</a> (and didn't use the <a href="https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/enable-new-relic-monitoring-aws-lambda#cli">CLI</a>), update using this procedure:</p>
<ol>
  <li>
    <p>Run the following, replacing YOUR_REGION with your region (for example, <code>us-west-2</code>).</p>
    <pre><code>aws serverlessrepo create-cloud-formation-change-set \
 --application-id arn:aws:serverlessrepo:us-east-1:463657938898:applications/NewRelic-log-ingestion \
 --stack-name NewRelic-log-ingestion \
 --capabilities CAPABILITY_RESOURCE_POLICY \
 --region YOUR_REGION
</code></pre>
    <p>This command outputs several fields, one of which is the ChangeSetId: an ARN for the change set that you just created. Copy that ARN.</p>
  </li>
  <li>
    <p>Use the ARN in this command, which executes the change set:</p>
    <pre><code>aws cloudformation execute-change-set --change-set-name YOUR_CHANGE_SET_ARN
</code></pre>
  </li>
</ol>
<h2>Enabling log management</h2>
<p>If you currently don't have New Relic's log management enabled, but would like to:</p>
<ol>
  <li>
    <p>Make sure you have the latest version of the CLI:</p>
    <pre><code>pip install --upgrade newrelic-lambda-cli
</code></pre>
  </li>
  <li>
    <p>For each region in which you've installed the <code>newrelic-log-ingestion</code> function, run the following command, replacing YOUR_REGION with your region (for example, <code>us-west-2</code>).</p>
    <pre><code>newrelic-lambda integrations update \
    --enable-logs \
    --aws-region YOUR_REGION
</code></pre>
  </li>
  <li>
    <p>Then do either of the following:</p>
    <ul>
      <li>
        <p>Update your Amazon CloudWatch log subscription filters for each region with the following command:</p>
        <pre><code>newrelic-lambda subscriptions install \
    --function installed \
    --filter-pattern "" \
    --aws-region YOUR_REGION
</code></pre>
      </li>
      <li>
        <p>Or, you can send function logs to New Relic directly, bypassing CloudWatch and the <code>newrelic-log-ingestion</code> Lambda. To do this, set the environment variable <code>NEW_RELIC_EXTENSION_SEND_FUNCTION_LOGS=true</code> in your Lambda function configuration.</p>
        <p>After that, be sure to remove any existing New Relic log subscriptions for that function using this command:</p>
        <pre><code>newrelic-lambda subscriptions uninstall \
    --function FUNCTION_NAME \
    --aws-region YOUR_REGION
</code></pre>
        <p>If the log subscription is present while the extension is sending logs, logs will be sent twice, resulting in duplicate log records in New Relic.</p>
        <p>Optionally, if you'd like to avoid <a href="https://aws.amazon.com/cloudwatch/pricing/#Paid_tier">Amazon's charges</a> for CloudWatch Log ingestion, you can also modify your function's <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-intro-execution-role.html">execution role</a> so that it doesn't grant the CloudWatch Log permissions. This will prevent your function from logging to CloudWatch.</p>
        <div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJjYXV0aW9uIn1d">
          <p>CloudWatch Logs ingest fees can be considerable, but this step should be taken with caution. Make sure your New Relic log ingestion integration is working well and meeting your needs before disabling CloudWatch logs.</p>
        </div>
      </li>
    </ul>
  </li>
</ol>
