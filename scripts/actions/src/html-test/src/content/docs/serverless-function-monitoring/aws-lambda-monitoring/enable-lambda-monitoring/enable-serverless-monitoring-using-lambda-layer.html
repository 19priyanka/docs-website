
<p><a href="/docs/introduction-new-relic-monitoring-aws-lambda">Serverless monitoring for AWS Lambda</a> offers in-depth performance monitoring for your Lambda functions. Read on to learn how to enable this feature using our Lambda layer and get started using it.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJpbXBvcnRhbnQifV0=">
  <p>Using this feature may result in AWS charges. See <a href="/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/compatibility-requirements-aws-lambda-monitoring">Lambda monitoring requirements</a>.</p>
</div>
<h2>How does it work [#overview]</h2>
<p>When you enable serverless monitoring using <a href="https://github.com/newrelic/newrelic-lambda-extension">our Lambda extension</a>, this is what happens:</p>
<p>
  <img src="./images/Lambda-monitoring-with-New-Relic-layer.png" alt="Lambda monitoring with New Relic layer" title="Lambda monitoring with New Relic layer">
</p>
<p>Lambda monitoring with the New Relic Lambda layer</p>
<ol>
  <li>You configure your Lambda function to include our layer for the runtime you've chosen.</li>
  <li>As your code runs, our Lambda layer gathers telemetry data about the invocation and its execution.</li>
  <li>Just before execution finishes, the Lambda layer sends the data it has gathered to the New Relic Lambda extension, which is bundled with the layer.</li>
  <li>The extension sends the data to New Relic, along with additional information from AWS Lambda.</li>
</ol>
<h3>What's in the New Relic Lambda layer? [#lambda-layer]</h3>
<p>The layer for your runtime contains the <a href="https://github.com/newrelic/newrelic-lambda-extension">New Relic Lambda extension</a>. This executable extends your Lambda function. The extension sends telemetry data to New Relic, and interacts with AWS directly to enhance the data we gather, while minimizing the impact of instrumentation on your application's performance.</p>
<p>For Node.js and Python, the layer contains the New Relic agent code, and a wrapper for your Lambda handler. For other runtimes, we take an SDK approach, providing you with the tools to instrument your code, while taking advantage of emerging standards like OpenTracing and OpenTelemetry.</p>
<h2>What do you need [#requirements]</h2>
<p>To enable serverless monitoring using our Lambda layer, you need the following:</p>
<ul>
  <li><a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html">AWS CLI v2</a> installed and configured using <code>aws configure</code>.</li>
  <li>Python version 3.3 or higher installed.</li>
  <li><a href="https://github.com/newrelic/newrelic-lambda-cli#installation">newrelic-lambda CLI</a>, which you can install by running <code>pip install newrelic-lambda-cli</code>.</li>
  <li>A New Relic account. You must be an admin, or have the <strong>Infrastructure manager</strong> <a href="/docs/accounts/original-accounts-billing/original-users-roles/users-roles-original-user-model#add-on">add-on role</a>.</li>
  <li>A <a href="https://docs.newrelic.com/docs/apis/get-started/intro-apis/types-new-relic-api-keys#personal-api-key">user key</a>.</li>
  <li>An AWS account with permissions for creating IAM resources, managed secrets, and Lambdas. You also need permissions for creating CloudFormation stacks and S3 buckets.</li>
</ul>
<p>Note that you may need to use <code>pip3</code> instead of <code>pip</code> if your system uses Python 2 by default.</p>
<h2>Enable serverless monitoring [#enable-erverless-monitoring]</h2>
<p>There are a few things that have to happen to let New Relic gather telemetry from your Lambda functions.</p>
<ol>
  <li><a href="#link-accounts">Link your AWS account with your New Relic account</a>.</li>
  <li><a href="#configure-lambda">Configure each of your functions to include our Lambda extension</a>.</li>
</ol>
<p>While there are several ways to accomplish both steps, this guide focuses on the most frequent setup scenario.</p>
<h3>Link your AWS account with your New Relic account [#link-accounts]</h3>
<p>When you link your AWS account to New Relic, you're granting permission to New Relic to create an inventory of your AWS account, and gather CloudWatch metrics for your Lambda functions. Resources in your AWS account then show up as entities in the <a href="/docs/new-relic-one/use-new-relic-one/ui-data/new-relic-one-entity-explorer-view-performance-across-apps-services-hosts">entity explorer</a>, decorated with config information.</p>
<p>When all the <a href="#requirements">requirements</a> are in place, link your AWS account with your New Relic account by running the following command using your <a href="https://docs.newrelic.com/docs/apis/get-started/intro-apis/types-new-relic-api-keys#personal-api-key">user key</a> (replace all the highlighted values):</p>
<pre><code>newrelic-lambda integrations install --nr-account-id YOUR_NR_ACCOUNT_ID \
    --linked-account-name YOUR_LINKED_ACCOUNT_NAME \
    --nr-api-key YOUR_NEW_RELIC_USER_KEY
</code></pre>
<p>The <code>newrelic-lambda</code> CLI adds your New Relic license key as a secret in <a href="https://aws.amazon.com/secrets-manager/">AWS Secret Manager</a> for greater security. The <code>--linked-account-name</code> parameter is to name the integration that will appear in New Relic.</p>
<div data-component="Callout" data-prop="W3sidHlwZSI6Im1keEF0dHJpYnV0ZSIsIm5hbWUiOiJ2YXJpYW50IiwidmFsdWUiOiJ0aXAifV0=">
  <p><strong>Storing the New Relic license key in the AWS Secrets Manager</strong></p>
  <p>Your <a href="/docs/accounts/accounts-billing/account-setup/new-relic-license-key">New Relic license key</a> identifies and authenticates you to New Relic, allowing us to associate your telemetry with your New Relic account. Each function that sends telemetry needs access to this value, and it needs to be managed securely. The AWS Secrets Manager solves these problems.</p>
  <p>If your organization prevents you from using AWS Secrets Manager, see below for an alternative method to set your license key.</p>
</div>
<h3>Install or upgrade the Lambda layer [#upgrade-layer]</h3>
<p>After linking your accounts, you have to install or upgrade the New Relic Lambda layer to the latest version. All future layers versions will include the Lambda extension by default. To install/upgrade the layer, run:</p>
<pre><code>newrelic-lambda layers install --nr-account-id YOUR_NR_ACCOUNT_ID --function my-function --upgrade
</code></pre>
<p>This command automatically finds the available layer for your Lambda's region and runtime. If the layer can't be found, you can add a layer manually. To add the layer manually, read our <a href="https://github.com/newrelic/newrelic-lambda-extension/tree/main/examples">example code</a>.</p>
<p>Deploy our examples and verify they work</p>
<p>Once you've <a href="#link-accounts">linked your AWS and New Relic accounts</a>, instrumenting your Lambda function using our Lambda extension involves a series of steps:</p>
<ol>
  <li>Pick an example and install it.</li>
  <li>Invoke the Lambda and see data in New Relic.</li>
  <li>Clean up and adapt the example to your code.</li>
</ol>
<p>We recommend trying out our example code for the following languages:</p>
<ul>
  <li><a href="https://github.com/newrelic/newrelic-lambda-extension/tree/main/examples/node">Node.js</a></li>
  <li><a href="https://github.com/newrelic/newrelic-lambda-extension/tree/main/examples/python">Python</a></li>
  <li><a href="https://github.com/newrelic/newrelic-lambda-extension/tree/main/examples/go">Go</a></li>
  <li><a href="https://github.com/newrelic/newrelic-lambda-extension/tree/main/examples/java">Java</a></li>
  <li><a href="https://github.com/newrelic/newrelic-lambda-extension/tree/main/examples/dotnet">.NET</a></li>
</ul>
<p>Each example contains instructions, sample code, and a deploy script to get started. After you've gotten the example to work for you, you can clean up by deleting the CloudFormation stack, using either the AWS Console, or the AWS CLI: <code>aws cloudformation delete-stack --stack-name &#x3C;stack-name></code></p>
<p>Our examples are based on the AWS SAM CLI. There are other tools available for managing and deploying Lambda functions. New Relic offers a plugin for the Serverless Framework, and the CLI can modify your existing Lambda functions to add instrumentation. You can integrate the necessary Lambda layer and function permission using whatever AWS resource management tool you choose.</p>
<h2>Troubleshooting</h2>
<h3>Cannot Use AWS Secrets Manager [#cannot-use-secrets]</h3>
<p>If your organization does not allow the use of AWS Secrets Manager, the New Relic Lambda Extension will accept a <code>NEW_RELIC_LICENSE_KEY</code> environment variable. Add the <code>--disable-license-key-secret</code> flag from the <code>newrelic-lambda integrations install</code> command. Then set this environment variable to your <a href="/docs/accounts/accounts-billing/account-setup/new-relic-license-key">New Relic license key</a> in your Lambda function configuration.</p>
<h3>Multiple AWS regions and accounts [#multiple-regions-accounts]</h3>
<p>The <code>newrelic-lambda</code> CLI should be run once per region, with the <code>--aws-region</code> parameter. Use the same linked account name, and the tool will detect that the account link has been created already. The license key secret needs to be created in each region.</p>
<p>Similarly, several AWS accounts can be linked to a New Relic account. Give each account a different linked account name. The <code>--aws-profile</code> argument to the CLI tool will select the named profile. The tool uses the same configuration as the AWS CLI.</p>
<h3>Failure to retrieve license key <code>AccessDeniedException</code> [#fail-retrieve-license]</h3>
<p>Your lambda code requires the execution role which has permission to read AWS Secrets Manager. If you find a log like the following, add the appropriate permission to the policy of the execution role. In our examples, check out the <code>template.yaml</code> file to see an easy way to grant this permission.</p>
<pre><code>Failed to retrieve license key AccessDeniedException: User: &#x3C;ARN> is not authorized to perform: secretsmanager:GetSecretValue on resource: &#x3C;ARN>
</code></pre>
<h2>What's next? [#find-data]</h2>
<p>After you complete these steps, here's what you can do next:</p>
<ul>
  <li>Adapt the example code to your Lambda functions to start monitoring production code.</li>
  <li>See data reporting in the <a href="https://docs.newrelic.com/docs/lambda-monitoring-ui">Lambda monitoring UI</a>. If you're having trouble finding your data, see <a href="https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/troubleshooting/troubleshooting-enabling-new-relic-monitoring-aws-lambda">Lambda enable troubleshooting</a>.</li>
  <li>Use <a href="https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/configure-monitoring-aws-lambda-new-relic-serverless">configuration settings</a> to fine-tune your data.</li>
</ul>
<h2>For more help [#more-help]</h2>
