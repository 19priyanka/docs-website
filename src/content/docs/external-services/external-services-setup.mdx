---
title: The new external services setup
metaDescription: "Here are steps to enable and configure external services"
---
The new external services feature is available for New Relic APM agents and OpenTelemetry. Review the following to understand the steps to set up new externals for APM agents and OpenTelemetry. After you get the new external services set up, you may need to adjust the [sampling rate](#adjust-sampling) if you don't see enough data.

## APM agents [#externals-and-apm]

For some agents you only need to install the agent, while others require some additional steps. Here’s what you need to know about setting up the new external services:

This table works fine outside a list, but it blows up the file if I try to embed it 

1. If you haven’t already done so, complete the steps to enable distributed tracing (either standard distributed tracing and Infinite Tracing). If you were using cross-application tracing, the configuration for distributed tracing will automatically turn of cross-application tracing.
2. See your agent in the table below about additional setup steps:

    <table>
      <thead>
        <tr>
          <th style={{ width: "200px" }}>
            Agent
          </th>
          <th>
            Setup
          </th>
        </tr>
      </thead>
        <tbody>
        <tr>
          <td>
            C SDK
          </td>
          <td>
            See the documentation about [instrumenting segments](/docs/apm/agents/c-sdk/instrumentation/instrument-your-app-c-sdk/#external-segments).
          </td>
        </tr>
        <tr>
          <td>
            Go
          </td>
          <td>
            See the documentation about using [`NewRoundTripper()`](/docs/apm/agents/go-agent/instrumentation/instrument-go-segments/).
          </td>
        </tr>
        <tr>
          <td>
            Java
          </td>
          <td>
            See the documentation about using the [Java agent API](/docs/apm/agents/java-agent/api-guides/java-agent-api-instrument-external-calls-messaging-datastore-web-frameworks/) to instrument external calls. 
          </td>
        </tr>
        <tr>
          <td>
            .NET
          </td>
          <td>
            The .NET agent and the.NET agent in Azure automatically instrument external calls, but they don’t instrument methods for transactions. To see transactions, you need to use a combination of the following:
              * [Custom transactions](/docs/agents/net-agent/instrumentation/net-custom-transactions/)
              * [Instrumented worker roles](/docs/apm/agents/net-agent/azure-installation/install-net-agent-azure-cloud-services/#requirements)
          </td>
        </tr>
        <tr>
          <td>
            Node.js
          </td>
          <td>
            See the documentation about using the [Node.js agent API](/docs/apm/agents/nodejs-agent/api-guides/guide-using-nodejs-agent-api/#external-services).
          </td>
        </tr>
        <tr>
          <td>
            PHP
          </td>
          <td>
            See the documentation about using the [PHP agent API](/docs/apm/agents/php-agent/php-agent-api/guide-using-php-agent-api/#datastore) to instrument external calls.
          </td>
        </tr>
        <tr>
          <td>
            Python
          </td>
          <td>
            No extra steps are necessary: External calls are instrumented automatically.
          </td>
        </tr>
        <tr>
          <td>
            Ruby
          </td>
          <td>
            See the documentation about using the [Ruby agent API](/docs/apm/agents/ruby-agent/api-guides/guide-using-ruby-agent-api/#externals) to instrument external calls.
          </td>
        </tr>
        </tbody>
    </table>

## OpenTelemetry [#otel-setup]

The New Relic UI shows the new external services details once you complete the steps for setting up the OpenTelemetry instrumentation for your service and the [calls](https://opentelemetry.io/docs/java/manual_instrumentation/#span-attributes) it makes to other services. The new external services feature will then show calls between your services, broken down by transaction endpoints in each service. The name of each transaction is derived from the entry span for the process (`span.kind = "server"`).  

If your APM service is connected to an OpenTelemetry service (upstream or downstream), that OpenTelemetry service will currently not show up in the view for that APM service. This is because, when viewing an APM service, this feature uses metrics which are only reported by APM agents. When viewing an OpenTelemetry service, the APM service will show up as a connection.

The quality of the information you see depends on the sampling strategy you are using in the collector. See the following section about using sampling to control what you see in the UI.

<Callout variant="tip">
If you send 100% of your OpenTelemetry data to our Trace API, we store 100% of that data, unless you have a specific rate limit for your organization, or if you send enough data to trigger our default rate limit.
</Callout>

## Adjust sampling to see more UI data [#adjust-sampling]

If you see little or no data when you start drilling beyond the initial page of the map, you may need to adjust the span reservoir to sample more data. The reason for this is that map information beyond the initial page is populated by sampled trace data. 

Here is some information about the different routines for adjusting the reservoir for APM agents, as well as tips for adjusting sampling for OpenTelemetry.

### APM agent sampling [#sampling-agents]

All APM agents have a reservoir that stores spans, and most of these agent reservoirs are configurable. The size of this reservoir affects the likelihood that an agent is able to send all the spans that it creates. See [fragmented traces](/docs/distributed-tracing/ui-data/understand-use-distributed-tracing-ui/#fragmented-traces) for more details. 


Data for this feature is derived from adjacent client and server spans where external calls are made from one service to another. When an agent hits its span reservoir limit, there's a chance it will drop some spans representing these calls.

The default agent configuration value of 2000 defines the maximum number of events the agent collects per minute. If there are more spans than this number, the agent collects a statistical sampling, essentially degrading the amount of data that is used in the external services map.

If you’re not seeing the type of detail you want in the UI, you can increase the size of the reservoir up to 10,000. Review the following to adjust the agent reservoirs:


<table>
  <thead>
    <tr>
      <th style={{ width: "200px" }}>
        APM agent
      </th>
      <th>
        Documentation
      </th>
    </tr>
  </thead>
    <tbody>
    <tr>
      <td>
        C SDK
      </td>    
      <td>
       The reservoir is not currently configurable 
      </td>
    </tr>
    <tr>
      <td>
        Go
      </td>    
      <td>
       The reservoir is not currently configurable
      </td>
    </tr>
    <tr>
      <td>
        Java
      </td>    
      <td>
       [Java configuration](/docs/apm/agents/java-agent/configuration/java-agent-configuration-config-file/#cfg-span-events-max-samples-stored) 
      </td>
    </tr>
    <tr>
      <td>
        .NET
      </td>    
      <td>
        [.NET configuration](/docs/apm/agents/net-agent/configuration/net-agent-configuration/#paragrp-max-samples-stored) 
      </td>
    </tr>
    <tr>
      <td>
        Node.js
      </td>    
      <td>
        [Node.js configuration](/docs/apm/agents/nodejs-agent/installation-configuration/nodejs-agent-configuration/#span-events-max-samples-stored) 
      </td>
    </tr>
    <tr>
      <td>
        PHP
      </td>    
      <td>
       The reservoir is not currently configurable
      </td>
    </tr>
    <tr>
      <td>
        Python
      </td>    
      <td>
        [Python configuration](/docs/apm/agents/python-agent/configuration/python-agent-configuration/#environment-variables) (See `NEW_RELIC_SPAN_EVENTS_MAX_SAMPLES_STORED`) 
      </td>
    </tr>
    <tr>
      <td>
        Ruby
      </td>    
      <td>
        [Ruby configuration](/docs/apm/agents/ruby-agent/configuration/ruby-agent-configuration/#span_events-max_samples_stored) 
      </td>
    </tr>
    </tbody>
</table>

### OpenTelemetry sampling [#otel-sampling]

<Callout variant="tip">
This section doesn’t apply to you if you are sending OpenTelemetry directly from your service to the OTLP endpoint. This is because the data isn’t being sampled in an OpenTelemetry collector.
</Callout>
For OpenTelemetry, the initial and subsequent maps as you drill down are populated by sampled traces, which means that you may not see enough useful data. To resolve this, you can change the sampling in the collector to allow more data into New Relic. 

See [Sampling](https://docs.newrelic.com/docs/more-integrations/open-source-telemetry-integrations/opentelemetry/opentelemetry-concepts/#sampling) for tips about configuration.

## What's next? [#next]

If you have questions about how to understand the UI, see our [tips](/docs/externals/external-services-ui). 