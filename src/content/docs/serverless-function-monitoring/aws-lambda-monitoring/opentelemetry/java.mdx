---
title: Trace Your Java Lambda Functions with New Relic and OpenTelemetry
---

This guide will cover how you can use [OpenTelemetry Lambda][1] to trace your Java
Lambda functions using AWS' managed [OpenTelemetry Lambda Layers][2]. OpenTelemetry
makes it easy to instrument your functions, including automatic instrumentation for many
popular libraries.

[1]: https://github.com/open-telemetry/opentelemetry-lambda
[2]: https://aws-otel.github.io/docs/getting-started/lambda/lambda-java-auto-instr

## Prerequisites

This guide assumes you have the following:

* A New Relic account. If you don't have one, [create one for free][3].
* An AWS account. If you don't have one, [create one for free][4].
* A Lambda Function running under either the `java8.al2` or `java11` runtimes.
  If you don't have one yet, [create one now][5].

[3]: https://newrelic.com/signup
[4]: https://aws.amazon.com/
[5]: https://docs.aws.amazon.com/lambda/latest/dg/lambda-java.html

## Step 1: Installing the Layer

AWS publishes a managed layer that includes the [OpenTelemetry Lambda Collector][1],
the [OpenTelemetry Java SDK][6] and the [ADOT Auto Instrumentation Agent][8].

To install it:

1. Open up your function in the [Lambda Console][7].
2. Under **Layers** in the **Designer** section, choose **Add a layer**.
3. Under **Specify an ARN**, paste the layer ARN `arn:aws:lambda:{region}:901920570463:layer:aws-otel-java-agent-amd64-ver-1-10-1:1`, replacing `{region}` with your AWS region, such as `us-east-1`.
4. Then choose **Add**.

Alternatively, if you're using [SAM (Serverless Application Model)][9] or [CloudFormation][10] templates,
you can specify this layer by adding the following to your Lambda function's properties:

```yaml
  yourFunctionHere:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:901920570463:layer:aws-otel-java-agent-amd64-ver-1-10-1:1
```

[6]: https://github.com/open-telemetry/opentelemetry-java-instrumentation
[7]: https://console.aws.amazon.com/lambda
[8]: https://github.com/aws-observability/aws-otel-java-instrumentation
[9]: https://aws.amazon.com/serverless/sam/
[10]: https://aws.amazon.com/cloudformation/resources/templates/

## Step 2: Configure the Layer

To configure the layer we need to configure an [exec wrapper][11]. The exec wrapper is a
script that gets run during function initialization. In this case, the script configures
OpenTelemetry.

1. Open up your function in the [Lambda Console][7].
2. Choose **Configuration** and then **Environment variables**.
3. Under **Environment variables**, choose **Edit**.
4. Choose **Add environment variable**.
5. For the **Key** set it to `AWS_LAMBDA_EXEC_WRAPPER` and set the **Value** to one of the options
   below (depends on your handler type).
6. Then choose **Save**.

* `/opt/otel-handler`: for wrapping regular handlers (implementing RequestHandler)
* `/opt/otel-proxy-handler`: for wrapping regular handlers (implementing RequestHandler) proxied through API Gateway, enabling HTTP context propagation
* `/opt/otel-stream-handler`: for wrapping streaming handlers (implementing RequestStreamHandler), enabling HTTP context propagation for HTTP requests

For [SAM][9] / [CloudFormation][10] templates, add this to your function's properties:

```yaml
  yourFunctionHere:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Environment:
        Variables:
          AWS_LAMBDA_EXEC_WRAPPER: /opt/otel-handler
```

**Important:** Replace `/opt/otel-handler` if your function handler implements one of the
other handler types.

[11]: https://docs.aws.amazon.com/lambda/latest/dg/runtimes-modify.html#runtime-wrapper

## Step 3: Add New Relic Environment Variables

To send the OpenTelemetry data that this layer collects to New Relic, we need to
configure the [OpenTelemetry Lambda Collector][1] that is packaged with the layer to
export the telemetry it receives to the [New Relic OpenTelemetry Endpoint][12]. Before
we do that, we first need to set some environment variables that it will depend upon.

1. Generate and copy a [New Relic License Key][13] from your New Relic account.
2. Open up your function in the [Lambda Console][7].
3. Choose **Configuration** and then **Environment variables**.
4. Under **Environment variables**, choose **Edit**.
5. Choose **Add environment variable**.
6. For the **Key** set it to `NEW_RELIC_LICENSE_KEY` and set the **Value** to the value
   of the license key you generated in step 1.
7. Then choose **Save**.
8. Choose **Add environment variable** again.
9. For the **Key** set it to `NEW_RELIC_OPENTELEMETRY_ENDPOINT` and set the **Value** to one of the options below (depends on your New Relic region).
10. Then choose **Save**.

* `otlp.nr-data.net:4317`: If your New Relic account is in U.S. region
* `otlp.eu01.nr-data.net:4317`: If your New Relic account is in the E.U. region

For [SAM][9] / [CloudFormation][10] templates, add this to your function's properties:

```yaml
  yourFunctionHere:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Environment:
        Variables:
          ...
          NEW_RELIC_LICENSE_KEY: your-license-key-here
          NEW_RELIC_OPENTELEMETRY_ENDPOINT: otlp.nr-data.net:4317
```

**Important:** Replace `your-license-key-here` with your [New Relic License Key][13] and
`otlp.nr-data.net:4317` with the [New Relic OpenTelemetry Endpoint][12] for your region.

[12]: https://docs.newrelic.com/docs/more-integrations/open-source-telemetry-integrations/opentelemetry/opentelemetry-quick-start/
[13]: https://docs.newrelic.com/docs/apis/intro-apis/new-relic-api-keys/#ingest-keys

## Step 4: Configure the Collector

Now we will override the [OpenTelemetry Lambda Collector][1]'s default configuration
with one that exports telemetry to the [New Relic OpenTelemetry Endpoint][12]. To do
this we must include a `collector.yaml` config file with our function.

Create a `collector.yaml` file in your function's root directory with the following contents:

```yaml
receivers:
  otlp:
    protocols:
      grpc:
      http:

exporters:
  otlp:
    endpoint: ${NEW_RELIC_OPENTELEMETRY_ENDPOINT}
    headers:
      api-key: ${NEW_RELIC_LICENSE_KEY}

service:
  pipelines:
    traces:
      receivers: [otlp]
      exporters: [otlp]
    metrics:
      receivers: [otlp]
      exporters: [otlp]
    logs:
      receivers: [otlp]
      exporters: [otlp]
```

Bundle this `collector.yaml` file in the root of your function's zip package and re-deploy.

1. Open up your function in the [Lambda Console][7].
2. Choose **Configuration** and then **Environment variables**.
3. Under **Environment variables**, choose **Edit**.
4. Choose **Add environment variable**.
5. For the **Key** set `OPENTELEMETRY_COLLECTOR_CONFIG_FILE` and set the **Value** to
   `/var/task/collector.yaml`.
6. Then choose **save**.

For [SAM][9] / [CloudFormation][10] templates, add this to your function's properties:

```yaml
  yourFunctionHere:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Environment:
        Variables:
          ...
          OPENTELEMETRY_COLLECTOR_CONFIG_FILE: /var/task/collector.yaml
```

## Step 5: View Your Data in the New Relic UI

First you will want to [invoke your Lambda function][18] a few times to start generating
telemetry. From there, head over to New Relic to find your [traces][19], [metrics][20]
and [logs][21].

**Important:** Your telemetry will not appear under New Relic Serverless. Instead, you
will find your telemetry data under the New Relic OpenTelemetry Nerdlets.

[18]: https://docs.aws.amazon.com/lambda/latest/dg/lambda-invocation.html
[19]: https://one.newrelic.com/launcher/nr1-core.explorer?overlay=eyJuZXJkbGV0SWQiOiJkYXRhLWV4cGxvcmF0aW9uLnF1ZXJ5LWJ1aWxkZXIiLCJpbml0aWFsQWN0aXZlSW50ZXJmYWNlIjoibnJxbEVkaXRvciIsImluaXRpYWxOcnFsVmFsdWUiOiIiLCJpbml0aWFsUXVlcmllcyI6W3sibnJxbCI6IkZST00gU3BhbiBTRUxFQ1QgY291bnQoKikgd2hlcmUgbmV3cmVsaWMuc291cmNlPSclb3RscCUnIFRJTUVTRVJJRVMifV0sImluaXRpYWxDaGFydFNldHRpbmdzIjp7ImNoYXJ0VHlwZSI6IkNIQVJUX0xJTkUiLCJsaW1pdCI6NzU0MiwibGlua2VkRW50aXR5R3VpZCI6bnVsbCwibGlua2VkRGFzaGJvYXJkSWQiOm51bGwsInlTY2FsZSI6eyJzdGF0aWMiOmZhbHNlLCJkb21haW4iOltudWxsLG51bGxdfSwieVplcm8iOnRydWV9fQo=
[20]: https://one.newrelic.com/launcher/nr1-core.explorer?overlay=eyJuZXJkbGV0SWQiOiJkYXRhLWV4cGxvcmF0aW9uLnF1ZXJ5LWJ1aWxkZXIiLCJpbml0aWFsQWN0aXZlSW50ZXJmYWNlIjoibnJxbEVkaXRvciIsImluaXRpYWxOcnFsVmFsdWUiOiIiLCJpbml0aWFsUXVlcmllcyI6W3sibnJxbCI6IkZST00gTWV0cmljIFNFTEVDVCBjb3VudCgqKSB3aGVyZSBuZXdyZWxpYy5zb3VyY2UgTElLRSAnJW90bHAlJyBUSU1FU0VSSUVTIn1dLCJpbml0aWFsQ2hhcnRTZXR0aW5ncyI6eyJjaGFydFR5cGUiOiJDSEFSVF9MSU5FIiwibGltaXQiOjc1NDIsImxpbmtlZEVudGl0eUd1aWQiOm51bGwsImxpbmtlZERhc2hib2FyZElkIjpudWxsLCJ5U2NhbGUiOnsic3RhdGljIjpmYWxzZSwiZG9tYWluIjpbbnVsbCxudWxsXX0sInlaZXJvIjp0cnVlfX0K
[21]: https://one.newrelic.com/launcher/nr1-core.explorer?overlay=eyJuZXJkbGV0SWQiOiJkYXRhLWV4cGxvcmF0aW9uLnF1ZXJ5LWJ1aWxkZXIiLCJpbml0aWFsQWN0aXZlSW50ZXJmYWNlIjoibnJxbEVkaXRvciIsImluaXRpYWxOcnFsVmFsdWUiOiIiLCJpbml0aWFsUXVlcmllcyI6W3sibnJxbCI6IkZST00gTG9nIFNFTEVDVCBjb3VudCgqKSB3aGVyZSBuZXdyZWxpYy5zb3VyY2U9JyVvdGxwJScgVElNRVNFUklFUyJ9XSwiaW5pdGlhbENoYXJ0U2V0dGluZ3MiOnsiY2hhcnRUeXBlIjoiQ0hBUlRfTElORSIsImxpbWl0Ijo3NTQyLCJsaW5rZWRFbnRpdHlHdWlkIjpudWxsLCJsaW5rZWREYXNoYm9hcmRJZCI6bnVsbCwieVNjYWxlIjp7InN0YXRpYyI6ZmFsc2UsImRvbWFpbiI6W251bGwsbnVsbF19LCJ5WmVybyI6dHJ1ZX19Cg==

## Automatic Instrumentation Overhead

ADOT Lambda Layer for Java Auto-instrumentation Agent has a notable impact on startup
time on AWS Lambda and you will generally need to use this along with [provisioned concurrency][14]
to serve production requests without causing timeouts on initial requests while it initializes.
We recommend testing this configuration in a non-production environment first to determine the appropriate settings for your use case.

Alternatively, there is a manual instrumentation method available which is documented
below which by default requires fewer resources at function initialization. However, this
method requires a code change in most cases.

[14]: https://docs.aws.amazon.com/lambda/latest/dg/provisioned-concurrency.html

## Manual Instrumentation

The manual instrumentation method is very similar to the automatic instrumentation steps
documented above. The only difference is the Lambda Layer ARN you specify in Step 1.

Instead of `arn:aws:lambda:{region}:901920570463:layer:aws-otel-java-agent-amd64-ver-1-10-1:1`,
you would use `arn:aws:lambda:{region}:901920570463:layer:aws-otel-java-wrapper-amd64-ver-1-10-1:1`.
Replacing the `{region}` with your AWS region, such as `us-east-1`.

All other steps above remain the same. This alternative Lambda Layer will still wrap
your Lambda function like the automatic method. It will also instrument the
[AWS SDK][15] automatically. But all other libraries you use will require you to include
the library's OpenTelemetry instrumentation library from the [OpenTelemetry instrumentation Rrrepository][16]
in your function's dependencies and modify your code to initialize it.

You can see an example with OKHttp [here][17].

[15]: https://github.com/open-telemetry/opentelemetry-java-instrumentation/tree/main/instrumentation/aws-sdk/aws-sdk-2.2/library
[16]: https://github.com/open-telemetry/opentelemetry-java-instrumentation
[17]: https://github.com/open-telemetry/opentelemetry-lambda/tree/main/java#sample-applications

## More Information

For more information, check out the [New Relic OpenTelemetry Quick Start][12].
