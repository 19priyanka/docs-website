---
title: Instrument your own functions
tags:
  - Serverless function monitoring
  - AWS Lambda monitoring
  - Enable Lambda monitoring
  - Instrumentation
metaDescription: Instrumenting your own Lambda functions
---

<Callout variant="important">
  Because there are several steps to integration, it's important that you test your account link by deploying and
  testing [an example](instrument-example) function before instrumenting your own code.
</Callout>

## Deployment Strategies

There are many different deployment strategies for Lambda functions. New Relic offers direct support for several,
but we cannot cover every option. At its core, New Relic Lambda instrumentation relies on the Lambda service itself,
rather than any particular deployment strategy or tool, so we're confident that it can be made to work in your use case.

### `newrelic-lambda` CLI Quickstart

The CLI tool that we recommended for setting up the account link can also reconfigure your Lambda functions to use
New Relic.

To install or upgrade the New Relic instrumentation layer, run:

  ```
  newrelic-lambda layers install --nr-account-id <var><a href="/docs/accounts/accounts-billing/account-setup/account-id">YOUR_NR_ACCOUNT_ID</a></var> --function my-function --upgrade
  ```

This command automatically finds the newest available layer for your Lambda's region and runtime.

This is a great way to quick-start instrumentation, and this tool can easily be integrated into your existing CI/CD
processes. However, since it modifies existing Lambda function resources, when you deploy a code update to your
function, you may inadvertently remove the New Relic instrumentation. Be sure to re-run the command above after every
update, or (even better) integrate the layer and associated configuration with your existing deployment process.

Note that the CLI can operate on many functions in a batch: use `--function all`, `--function installed`, or
`--function not-installed` to operate on all functions in a region, or only those with or without existing
New Relic instrumentation.

### Continuous Deployment

In the long term, it's usually less work to integrate New Relic into your existing continuous deployment
process. Instead of running the CLI after updating your function, you can integrate New Relic into your continuous
deployment framework.

<CollapserGroup>
  <Collapser
    id="cloudformation"
    title="CloudFormation / SAM templates"
  >
  AWS's Serverless Application Model, or SAM is a variant of CloudFormation templates that simplifies relating functions
  to the resources they depend on, and managing the lifecycle of an entire application. We use SAM and CloudFormation for
  most of our Lambda example functions, and many other tools are built on top of CloudFormation templates, providing an
  addition layer of abstraction.

  At its core, CloudFormation is a way to express the target state of an AWS Resource (such as a Lambda function) using
  YAML or JSON, and an execution service that makes API calls to other services (such as AWS Lambda) to achieve that
  target state.

  Here's an example of a simple CloudFormation template for a NodeJS Lambda function:

  ```yaml
  AWSTemplateFormatVersion: '2010-09-09'
  Transform: AWS::Serverless-2016-10-31
  Description: And example of a simple instrumented NodeJS Lambda

  Resources:
    NewRelicExample:
      Type: AWS::Serverless::Function
      Properties:
        # In this example, we're using the SAM CLI to package and deploy our lambda. SAM will transform this value during the publish step.
        CodeUri: newrelic-example-node/
        # The handler for your function needs to be the one provided by the instrumentation layer, below.
        Handler: newrelic-lambda-wrapper.handler
        Runtime: nodejs12.x
        Environment:
          Variables:
            # For the instrumentation handler to invoke your real handler, we need this value
            NEW_RELIC_LAMBDA_HANDLER: app.lambdaHandler
            # Distributed tracing needs your account ID, and your trusted account ID
            NEW_RELIC_ACCOUNT_ID: YOUR_ACCOUNT_ID_HERE
            # If your New Relic account has a parent account, this value should be that account ID. Otherwise, just
            # your account id.
            NEW_RELIC_TRUSTED_ACCOUNT_KEY: YOUR_PARENT_ACCOUNT_ID_HERE
        Layers:
          # This layer includes the New Relic Lambda Extension, a sidecar process that sends telemetry,
          # as well as the New Relic Agent for Node.js, and a handler wrapper that makes integration easy.
          - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:451483290750:layer:NewRelicNodeJS12X:34
        Policies:
          # This policy allows the lambda to know the value of the New Relic licence key. We need this so
          # that we can send telemetry back to New Relic
          - AWSSecretsManagerGetSecretValuePolicy:
              SecretArn: !ImportValue NewRelicLicenseKeySecret-NewRelic-LicenseKeySecretARN
  ```

  Conventionally, you'll have a file named `template.yaml` that describes your function, and its resources.
  </Collapser>
  <Collapser
    id="serverless"
    title="Serverless Framework"
  >
  Serverless Framework is a popular development and deployment tool for serverless applications. It's written in NodeJS,
  and for AWS, acts mostly as a higher-level abstraction on top of CloudFormation templates. It works well for Node
  and Python functions.

  New Relic offers a [Serverless Framework Plugin](https://github.com/newrelic/serverless-newrelic-lambda-layers) to
  simplify instrumentation of your Serverless Framework application.

  #### Install the plugin

  First,

  ```
  npm install --save-dev serverless-newrelic-lambda-layers
  ```

  Or, alternatively,

  ```
  yarn add --dev serverless-newrelic-lambda-layers
  ```

  Find your [New Relic Account ID](https://docs.newrelic.com/docs/accounts/install-new-relic/account-setup/account-id),
  your [New Relic Personal API Key](https://docs.newrelic.com/docs/apis/get-started/intro-apis/types-new-relic-api-keys#personal-api-key)

  Then add the following to your `serverless.yaml` file:

  ```yaml
  plugins:
    - serverless-newrelic-lambda-layers
  custom:
    newRelic:
      accountId: your-new-relic-account-id-here
      apiKey: your-new-relic-personal-api-key-here
  ```
  </Collapser>
  <Collapser
    id="terraform"
    title="Terraform"
  >
    Terraform is a popular general-purpose infrastructure as code tool. It can be used to manage AWS resources, as
    well as many other things. We offer
    [some examples](https://github.com/newrelic/newrelic-lambda-extension/tree/main/examples/terraform) of New Relic
    instrumented Lambda functions deployed using Terraform scripts.
  </Collapser>
</CollapserGroup>
