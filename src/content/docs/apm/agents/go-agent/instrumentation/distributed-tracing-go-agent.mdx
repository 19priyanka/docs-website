---
title: 'Enable distributed tracing for your Go applications '
tags:
  - Agents
  - Go agent
  - Features
metaDescription: 'For the New Relic Go agent: how to implement distributed tracing across your Go language applications and services.'
redirects:
  - /docs/agents/go-agent/features/enable-distributed-tracing-your-go-applications
  - /docs/agents/go-agent/features/distributed-tracing-go
  - /docs/agents/go-agent/features/distributed-tracing-go-agent
  - /docs/agents/go-agent/instrumentation/distributed-tracing-go-agent
  - /docs/agents/go-agent/features/enable-distributed-tracing-go-agent
  - /docs/apm/agents/go-agent/features/enable-distributed-tracing-your-go-applications
---

import logsInContextTraces from 'images/logs-in-context-traces.png'

import gologo from 'images/gologo.png'

Distributed tracing allows you to see the entire journey of your requests throughout a [distributed system](/docs/distributed-tracing/concepts/introduction-distributed-tracing). The Go agent supports [standard distributed tracing](/docs/distributed-tracing/concepts/how-new-relic-distributed-tracing-works/#head-based) with head-based sampling, as well as the advanced option called Infinite Tracing.

The Go agent requires you to manually instrument your Go services, unlike the auto-instrumentation of the other New Relic agents. This means you need to add some lines to your code to use the Go agent and enable distributed tracing.

This default distributed tracing for Go agents uses head-based sampling. This means that before any traces arrive at New Relic, we apply an algorithm to determine how many traces to accept and analyze. This default head-based sampling can give you basic insights into what's happening in your distributed systems.

We also offer Infinite Tracing, which we recommend because it can give you even greater visibility into your distributed systems. This option uses tail-based sampling, which means that we don't do any sampling until after we've gathered and analyzed 100 percent of your traces. Your traces are sent to a cloud-based trace observer which collects and analyzes your data, looking for helpful traces.

Whether you want to get distributed tracing by installing a new agent or need help turning on distributed tracing in an older agent, we have instructions to get you going:

* [Set up tracing for new agents:](#new-agentsl) Steps for head- and tail-based sampling for new agent installations
* [Older APM agents:](#older-agents) Tracing options if you have older APM agents
* [Manual instrumentation:](#manual-instrumentation) Tips for additional instrumentation

<Callout variant="tip">
  If you want to get more background before getting started, check out these topics:
  * [How span sampling works](/docs/understand-dependencies/distributed-tracing/get-started/how-new-relic-distributed-tracing-works#sampling) explains distributed tracing options.
  * [Impacts to APM](/docs/apm/distributed-tracing/getting-started/transition-guide-distributed-tracing) tells you what to expect if you are a current APM user but haven't set up distributed tracing.
</Callout>

## Set up tracing for new agents [#new-agents]

Whether you just want to try out standard distributed tracing (head-based sampling) or also want to set up Infinite Tracing (tail-based sampling), you need to start by setting up standard distributed tracing. We'll get you through the APM agent installation to get head-based sampling going. Then, if you want to try out Infinite Tracing, you can take some additional steps.

### Install an agent to get standard distributed tracing [#quick-start-apm]

This is the best approach to set up [standard distributed tracing](/docs/distributed-tracing/concepts/how-new-relic-distributed-tracing-works/#head-based) if you haven't installed any APM agents for your services yet, or if you want to instrument additional services.

If you already have some services instrumented with this APM agent, and you want to include them in distributed tracing, you'll need to manually enable distributed tracing for each service. See [Options for older APM agents](#older-agents).

<Callout variant="tip">
  You'll need a New Relic account to set up distributed tracing. If you don't already have one, you can quickly [create a free account](https://newrelic.com/signup).
</Callout>

#### Step 1. Identify services

Figure out which services touch your request so you can instrument each of them to send trace data to New Relic.

#### Step 2. Instrument each service with an APM agent [#update-agents]

You'll repeat the agent installation routine for each service involved in your transactions. If some of your services use other languages, simply repeat the [installation steps](/docs/distributed-tracing/enable-configure/quick-start) for those languages.

To start the installation routine, click the tile below. When you are finished installing each agent, return here to see tips for [viewing your traces](#view-traces).

<TechTileGrid>
  <TechTile
    name="APM: Golang"
    to="https://one.newrelic.com/launcher/nr1-core.settings?pane=eyJuZXJkbGV0SWQiOiJ0dWNzb24ucGxnLWluc3RydW1lbnQtZXZlcnl0aGluZyJ9&cards[0]=eyJuZXJkbGV0SWQiOiJzZXR1cC1uZXJkbGV0cy5zZXR1cC1nby1pbnRlZ3JhdGlvbiIsImFjY291bnRJZCI6MjY0MDQwOX0=&platform[accountId]=2498654&platform[timeRange][duration]=1800000&platform[$isFallbackTimeRange]=true"
    icon={<img variant="TechTile" src={gologo} alt="Golang"/>}
  />
</TechTileGrid>

#### Step 3. View traces [#view-traces]

After you instrument each of your services with APM agents, generate some traffic in your application so we can capture some traces. Here are some ways to view your traces in the UI:

<CollapserGroup>
  <Collapser
    id="entity-explorer"
    title="View traces that include a specific service"
  >
    Here's one way you can see traces for a particular service:

    1. Go to **[one.newrelic.com](https://one.newrelic.com/)**.
    2. Click **APM** in the top menu bar.
    3. Click your service.
    4. In the left navigation's **Monitor** section, click **Distributed tracing**.
    5. If you don't see the traces you want, you can filter by the `trace.id`.
  </Collapser>

  <Collapser
    id="dt-launcher"
    title="View traces across accounts"
  >
    This option allows you to search all traces across all New Relic accounts in your organization that you have access to.

    1. Go to **[one.newrelic.com](https://one.newrelic.com/)**.
    2. Click **Browse data** in the top menu bar, and then click **Traces**.
    3. Select your entity in the left pane.
    4. If you don't see the traces you want, you can filter by the `trace.id`.
  </Collapser>

  <Collapser
    id="logs-context"
    title="Examine logs for trace details"
  >
    You can bring your logs and application's data together to make troubleshooting easier and faster. With [logs in context](/docs/logs/logs-context/configure-logs-context-apm-agents/), you can see log messages related to your errors and traces directly in your app's UI.

    1. From the **Transactions** page, click on a trace to go to the [**Trace details** page](/docs/apm/transactions/transaction-traces/transaction-traces-trace-details-page).
    2. From the trace details page, click **See logs**.
    3. To view details related to an individual log message, click directly on the message.
  </Collapser>
</CollapserGroup>

For more help finding your traces in the UI:

* [Understand and use the distributed tracing UI](/docs/distributed-tracing/ui-data/understand-use-distributed-tracing-ui)
* [Query distributed trace data](/docs/understand-dependencies/distributed-tracing/ui-data/query-distributed-trace-data)

### Set up Infinite Tracing (recommended) [#infinite-tracing]

Standard distributed tracing for APM agents (above) use [adaptive sampling](/docs/distributed-tracing/concepts/how-new-relic-distributed-tracing-works/#trace-origin-sampling) to capture up to 10 traces per minute, but if you want us to analyze all your data and find the most relevant traces, you can set up Infinite Tracing.

<Callout variant="tip">
  To learn more about this feature, see [Infinite Tracing](/docs/understand-dependencies/distributed-tracing/infinite-tracing/introduction-infinite-tracing).
</Callout>

Before beginning, first ensure you meet [the requirements](/docs/understand-dependencies/distributed-tracing/infinite-tracing/introduction-infinite-tracing#requirements).

#### Step 1. Complete the new agent installation [#install-agents-first] 

The Infinite Tracing setup builds on the instrumentation step from the [New agent installations](#quick-start-apm) for standard distributed tracing.

#### Step 2. Set up the trace observer [#provision-trace-observer]

The trace observer is a New Relic AWS-based service that collects and analyzes all your traces. Follow the instructions in [Set up trace observer](/docs/understand-dependencies/distributed-tracing/infinite-tracing/set-trace-observer). When you're done, return here with your trace observer information and continue with the next step to configure the agent.

#### Step 3: Configure the agent for Infinite Tracing

Infinite Tracing configuration settings include the standard distributed tracing plus information about the trace observer:

<CollapserGroup>
  <Collapser
    id="go-config"
    title="Go Infinite Tracing configuration"
  >
    Here's an overview of the settings.

    <table>
      <thead>
        <tr>
          <th style={{ width: "200px" }}>
            Type
          </th>

          <th>
            Required configuration
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            Infinite Tracing
          </td>

          <td>
            Configuration options:

            * `newrelic.Config` structure:

              ```
              app, err := newrelic.NewApplication(
                  newrelic.ConfigAppName(<var>YOUR_APP_NAME</var>),
                  newrelic.ConfigLicense(<var>YOUR_LICENSE_KEY</var>),
                  func(cfg *newrelic.Config) {
                      cfg.DistributedTracer.Enabled = true
                      cfg.InfiniteTracing.TraceObserver.Host = <var>YOUR_TRACE_OBSERVER_HOST</var>
                  },
              )
              ```
            * Environment variables:

              ```
              NEW_RELIC_DISTRIBUTED_TRACING_ENABLED=true
              NEW_RELIC_INFINITE_TRACING_TRACE_OBSERVER_HOST=<a href="/docs/understand-dependencies/distributed-tracing/infinite-tracing/set-trace-observer#ui-endpoints"><var>YOUR_TRACE_OBSERVER_HOST</var></a>
              ```
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>
</CollapserGroup>

#### Step 4. (Optional) Customize Infinite Tracing

After you add the agent configuration settings, you should start seeing data in the New Relic UI. After you spend some time analyzing your data, you may want to adjust some of the features of Infinite Tracing:

* [Configure trace observer monitoring](/docs/distributed-tracing/infinite-tracing/infinite-tracing-configure-trace-observer-monitoring)
* [Configure span attribute trace filter](/docs/distributed-tracing/infinite-tracing/infinite-tracing-configure-span-attribute-trace-filter)
* [Configure random trace filter](/docs/distributed-tracing/infinite-tracing/infinite-tracing-configure-random-trace-filter)

## Options for older APM agents [#older-agents]

If you have older Go agents, use this section to figure out if the distributed tracing features you want are supported.

Following the compatibility information is a section showing the basic configuration settings to turn on standard distributed tracing. If your older agent supports Infinite Tracing and you want to set it up, see the steps [above](#infinite-tracing).

### Compatibility guide

After reviewing the compatibility information below, follow the configuration settings:

<CollapserGroup>
  <Collapser
    id="go-version"
    title="Go agent compatibility"
  >
    [Install](/docs/agents/go-agent/installation/install-new-relic-go) or [update](/docs/agents/go-agent/installation/install-new-relic-go) to the required Go agent version. For best results, update to the [latest Go agent version](/docs/release-notes/agent-release-notes/go-release-notes).

    <table>
      <thead>
        <tr>
          <th style={{ width: "250px" }}>
            Option
          </th>

          <th>
            Go agent version
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            Standard distributed tracing
          </td>

          <td>
            2.1.0 or higher

            With W3C Trace Context: 3.1.0 or higher
          </td>
        </tr>

        <tr>
          <td>
            Infinite Tracing
          </td>

          <td>
            v3.5.0 (includes W3C Trace Context)

            Supported environments: Go 1.9 or higher
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>
</CollapserGroup>

### Configure standard distributed tracing for your older agents [#configure-agents]

Distributed tracing is enabled through configuration settings. Review the following agent-specific sections. For general help with agent configurations, see [Configure the agent](/docs/agents/manage-apm-agents/configuration/configure-agent).

<Callout variant="important">
  Server-side configuration is not available for Infinite Tracing.
</Callout>

<CollapserGroup>
  <Collapser
    id="go-config-standard"
    title="Go agent configuration"
  >
    Here's an overview of the settings. For more help with configuration, see [Enable distributed tracing for your Go applications](/docs/agents/go-agent/features/enable-distributed-tracing-go-agent).

    <table>
      <thead>
        <tr>
          <th style={{ width: "200px" }}>
            Type
          </th>

          <th>
            Required configuration
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            Standard distributed tracing
          </td>

          <td>
            Configuration options:

            * `ConfigOption` structure:

              ```
              newrelic.NewApplication(
                newrelic.ConfigAppName("Example App"),
                newrelic.ConfigLicense(os.Getenv("NEW_RELIC_LICENSE_KEY")),
                newrelic.ConfigDistributedTracerEnabled(true),
              )
              ```
            * Environment variable:

              ```
              NEW_RELIC_DISTRIBUTED_TRACING_ENABLED=true
              ```
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>
</CollapserGroup>

## Additional manual instrumentation [#guidelines]

All installations of the Go agent and distributed tracing require some manual instrumentation using the settings listed in [Go agent configuration settings](/docs/agents/go-agent/configuration/go-agent-configuration#distributed-tracing). Still, you may need to do some additional configuration to optize your setup. Here are some guidelines for instrumenting transactions and HTTP requests.

<CollapserGroup>
  <Collapser
    id="create-transactions"
    title="Instrument transactions (if using ServeMux)"
  >
    If you are using Go's [`http.ServeMux`](https://golang.org/pkg/net/http/#ServeMux) and want to enable New Relic's distributed tracing, your Go application must be instrumented with New Relic's `WrapHandle` and `WrapHandleFunc` wrappers. These wrappers automatically start and end transactions with the request and response writer, which will automatically add the correct distributed tracing headers. For more on how header propagation works, see [How distributed tracing works](/docs/apm/distributed-tracing/getting-started/how-new-relic-distributed-tracing-works).

    <CollapserGroup>
      <Collapser
        id="example-go-instrumentation"
        title="Before and after example"
      >
        Here is an example of code before instrumentation:

        ```
        http.HandleFunc("/users", usersHandler)
        ```

        And here is an example of that same code after instrumentation:

        ```
        http.HandleFunc(newrelic.WrapHandleFunc(app, "/users", usersHandler))
        ```
      </Collapser>
    </CollapserGroup>

    Read more about using these wrappers in [Instrument Go transactions](/docs/agents/go-agent/get-started/instrument-go-transactions#http-handler-txns).
  </Collapser>

  <Collapser
    id="make-http-requests"
    title="Instrument outbound HTTP requests as external segments"
  >
    In order to have your outbound HTTP requests eligible for distributed tracing, [create an external segment](/docs/agents/go-agent/get-started/instrument-go-segments#go-external-segments).

    The easiest way to create an external segment for your outbound HTTP request is to use the `newrelic.NewRoundTripper` method. Here is an example of making a request to `http://api.example.com` that includes the outgoing distributed tracing headers:

    ```
    func useNewRoundTripper(txn *newrelic.Transaction) (*http.Response, error) {
        client := &http.Client{}
        client.Transport = newrelic.NewRoundTripper(client.Transport)
        request, _ := http.NewRequest("GET", "http://example.com", nil)
        request = newrelic.RequestWithTransactionContext(request, txn)
        return client.Do(request)
    }
    ```

    If you have a more complex request that uses the Go standard library's `http.Request`, use the `newrelic.StartExternalSegment` method to ensure your outbound request is eligible for distributed tracing:

    ```
    func external(txn *newrelic.Transaction, req *http.Request) (*http.Response, error) { 
        s := newrelic.StartExternalSegment(txn, req) 
        response, err := http.DefaultClient.Do(req) 
        s.Response = response 
        s.End() 
        return response, err
    }
    ```

    An `ExternalSegment` created with a struct literal cannot be used for distributed tracing. Because of this, New Relic recommends using [`newrelic.NewRoundTripper` or `newrelic.StartExternalSegment`](/docs/agents/go-agent/get-started/instrument-go-segments#go-external-segments).

    ```
    func noGoodForDt(txn *newrelic.Transaction, url string) (*http.Response, error) {
        // Distributed tracing headers are not added to the outgoing request.
        // Use newrelic.NewRoundTripper or newrelicc.StartExternalSegment instead.
        defer newrelic.ExternalSegment{
            StartTime: txn.StartSegmentNow(),
            URL:       url,
        }.End()

        return http.Get(url)
    }
    ```
  </Collapser>

  <Collapser
    id="create-manually"
    title="Manually create and accept distributed trace payload"
  >
    The distributed trace payload contains information that allows New Relic to stitch together transactions occurring in multiple services into a complete transaction trace. If New Relic-monitored services are not sending trace context to each other, it will result in incomplete trace details.

    For general instructions on how to use the API calls below to implement distributed tracing, first see [Use distributed tracing APIs](/docs/enable-distributed-tracing#agent-apis).

    <table>
      <thead>
        <tr>
          <th>
            If you want to...
          </th>

          <th>
            Use this
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            Create a payload to be sent to the called service.
          </td>

          <td>
            ```
            <a href="https://godoc.org/github.com/newrelic/go-agent/v3/newrelic#Transaction.InsertDistributedTraceHeaders">InsertDistributedTraceHeaders(h http.Header)</a>
            ```
          </td>
        </tr>

        <tr>
          <td>
            Accept a payload sent from the first service; this will link these services together in a trace.
          </td>

          <td>
            ```
            <a href="https://godoc.org/github.com/newrelic/go-agent/v3/newrelic#Transaction.AcceptDistributedTraceHeaders">AcceptDistributedTraceHeaders(h http.Header)</a>
            ```
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>
</CollapserGroup>

For more details on using these, see the [Go agent GitHub repo](https://github.com/newrelic/go-agent/blob/master/GUIDE.md#distributed-tracing).
