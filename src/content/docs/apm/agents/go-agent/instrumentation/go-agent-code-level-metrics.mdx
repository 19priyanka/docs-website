---
title: Go agent code level metrics instrumentation
tags:
  - Agents
  - Go agent
  - Instrumentation
metaDescription: Add source code context to your application traces, associating the trace data with the specific code being instrumented.
redirects:
  - /docs/agents/go-agent/configuration/go-agent-code-level-metrics
  - /docs/agents/go-agent/instrumentation/go-agent-code-level-metrics
---

With code-level metrics enabled, the New Relic Go Agent will attach attributes to trace data which give the location in your application source code
responsible for the actions being instrumented by those traces. This data includes:
 * Source file name
 * Source file line number
 * Function name
 * Namespace

See [the configuration guide](/docs/apm/agents/go-agent/configuration/go-agent-code-level-metrics) to see how to enable and configure
code-level metrics for your application.

<Callout variant="important">
    This feature is available for transactions as of Go Agent version 3.18.0, and is turned off by default. To enable it, you must
    add `newrelic.ConfigCodeLevelMetricsEnabled(true)` to your application's configuration. Future releases may
    change this to be on by default and may expand the feature to be included with other trace types other than transactions.
</Callout>

## Instrumenting Transactions [#instrument-transactions-clm]

With code-level metrics enabled, the Go Agent will add source code context information to any transaction started by a call
to the `StartTransaction` method of the application. Without changing any of your existing instrumentation code, this means
that the source code location will be added based on the function which called `StartTransaction`. This is true even if
`StartTransaction` is called for you by an instrumentation package.

However, if you wish to exert some manual control over how code-level metrics are collected for a particular transaction,
you may add a number of `newrelic.TraceOption` functions as described below:

### Suppressing Code-Level Metrics for a Single Transaction [#instrument-transactions-suppress-clm]
If you don't want code-level metrics for a particular transaction (say, to avoid the overhead of collecting the information when you know you won't need that data),
add a `WithoutCodeLevelMetrics` function to the end of the `StartTransaction` call:
```go
txn := app.StartTransaction("nothing-here-to-see", newrelic.WithoutCodeLevelMetrics())
defer txn.End()
```

### Adjusting the File Path Prefix [#instrument-transactions-path-prefix-clm]
We saw in the [configuration guide](/docs/apm/agents/go-agent/configuration/go-agent-code-level-metrics)
that we can guide the agent's heuristic to skip functions it believes are internal to the agent itself
to accurately find the one that started the transaction by setting the `ConfigCodeLevelMetricsIgnorePrefix` value.
You can customize this on an individual transaction basis by adding a `WithIgnorePrefix` option to the 
end of the parameters to `StartTransaction`.
```go
txn := app.StartTransaction("mytransaction", newrelic.WithIgnorePrefix("github.com/ignore/this/"))
defer txn.End()
```

### Explicitly Mark the Code Location [#instrument-transactions-this-location-clm]
By adding `WithThisCodeLocation` to the end of the `StartTransaction` call, you can compensate for any difficulty that
may occur in identifying the point of interest to be reported (e.g., if the transaction is actually started
inside another framework). This will force the code-level metrics to report the
location in the source code where `WithThisCodeLocation` was invoked.
```go
txn := app.StartTransaction("mytransaction", newrelic.WithThisCodeLocation())
defer txn.End()
```

### Explicitly Mark Any Code Location [#instrument-transactions-any-location-clm]
You can also fully control the location in your source code to be associated with a transaction. In essence you can mark any
location by calling `ThisCodeLocation` to get a "marker" for that location. Then, use that saved marker with the `WithCodeLocation` option
to a `StartTransaction` call:
```go
here := newrelic.ThisCodeLocation()
.
.
.
txn := app.StartTransaction("mytransaction", newrelic.WithCodeLocation(here))
defer txn.End()
```

If needed, you can tell `ThisCodeLocation` to skip a number of calling functions so that the reported location is farther up the call stack.
For example, to skip 1 caller, so that `here` refers to the caller of the function that calls `ThisCodeLocation`, change the above example
to:
```go
here := newrelic.ThisCodeLocation(1)
.
.
.
txn := app.StartTransaction("mytransaction", newrelic.WithCodeLocation(here))
defer txn.End()
```

