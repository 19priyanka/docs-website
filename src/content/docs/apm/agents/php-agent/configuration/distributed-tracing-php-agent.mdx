---
title: Distributed tracing for the PHP agent
tags:
  - Agents
  - PHP agent
  - Features
metaDescription: 'For New Relic''s PHP agent: how to enable distributed tracing and manually instrument applications to get them to show up in a distributed trace.'
redirects:
  - /docs/agents/php-agent/features/distributed-tracing-php-agent
  - /docs/agents/php-agent/features/distributed-tracing
  - /docs/agents/php-agent/features/distributed-tracing-php
  - /docs/apm/agents/php-agent/features/distributed-tracing-php-agent
  - /docs/distributed-tracing/enable-configure/language-agents-enable-distributed-tracing
---

import phplogo from 'images/phplogo.png'

import LogsInContexTraces from 'images/logs-in-context-traces.png'

Distributed tracing allows you to see the entire journey of your requests throughout a [distributed system](/docs/distributed-tracing/concepts/introduction-distributed-tracing). It is turned on by default in current New Relic PHP agents, but you can also enable it manually in older agents.

The PHP agent automatically instruments with distributed tracing a number of native PHP functions, as well as some third party HTTP clients:

* PHP function [`file_get_contents`](http://php.net/manual/en/function.file-get-contents.php)
* PHP functions [`curl_exec`](http://php.net/manual/en/function.curl-exec.php) and [`curl_multi_exec`](http://php.net/manual/en/function.curl-multi-exec.php)
* Guzzle 4, Guzzle 5, Guzzle 6
* Drupal's `drupal_http_request function`
* Laravel's queue jobs

Here are several ways to set up distributed tracing:

* [Installation assistant for standard distributed tracing (recommended):](#quick-start-apm) A fast way to get started
* [Infinite Tracing:](#infinite-tracing) An advanced alternative to standard distributed tracing
* [Older APM agents:](#older-agents) Tracing options if you have older APM agents
* [Manual instrumentation:](#manual-instrumentation) Tips if automatic instrumentation doesn't work

<Callout variant="tip">
  If you want to get more background before getting started, check out these topics:
  * [How span sampling works](/docs/understand-dependencies/distributed-tracing/get-started/how-new-relic-distributed-tracing-works#sampling) explains distributed tracing options.
  * [Impacts to APM](/docs/apm/distributed-tracing/getting-started/transition-guide-distributed-tracing) tells you what to expect if you are a current APM user but haven't set up distributed tracing.
</Callout>

## Installation assistant for standard distributed tracing (recommended): [#quick-start-apm]

This is the best approach to set up [standard distributed tracing](/docs/distributed-tracing/concepts/how-new-relic-distributed-tracing-works/#head-based) in either of these cases:

* You haven't installed any APM agents for your services yet.
* You want to instrument additional services with this agent.

If you already have some services instrumented with this APM agent, and you want to include them in distributed tracing, you'll need to manually enable distributed tracing for each service. See [Options for older APM agents](#older-agents).

You'll need a New Relic account to set up distributed tracing. If you don't already have one, you can quickly [create a free account](https://newrelic.com/signup). Note that this link will take you to another site to complete the sign-up, but you can return here and follow the setup steps below:

### Step 1. Identify services

Figure out which services touch your request so you can instrument each of them to send trace data to New Relic.

### Step 2. Instrument each service with an APM agent [#update-agents]

For PHP services that are not currently instrumented with the New Relic agent, you can use the installation assistant to instrument your service and enable distributed tracing.

You should use the installation assistant for each service you want to instrument to ensure that each installation has a unique application name. If some of your services use other languages, simply follow the [installation assistant](/docs/distributed-tracing/enable-configure/quick-start) for those other languages.

To start the installation assistant, click the link below to go to the New Relic **Add your data** page. When you are finished, repeat this process for other services that handle your requests, and then come back here to see tips about viewing your traces.

<TechTileGrid>
  <TechTile
    name="APM: PHP"
    variant="TechTile"
    to="https://one.newrelic.com/launcher/nr1-core.settings?pane=eyJuZXJkbGV0SWQiOiJ0dWNzb24ucGxnLWluc3RydW1lbnQtZXZlcnl0aGluZyJ9&cards[0]=eyJuZXJkbGV0SWQiOiJzZXR1cC1uZXJkbGV0cy5zZXR1cC1waHAtaW50ZWdyYXRpb24iLCJhY2NvdW50SWQiOjI2NDA0MDl9&platform[accountId]=2498654&platform[timeRange][duration]=1800000&platform[$isFallbackTimeRange]=true"
    icon={<img src={phplogo} alt="PHP"/>}
  />
</TechTileGrid>

### Step 3. View traces [#view-traces]

After you instrument each of your services with APM agents, generate some traffic in your application so we can capture some traces. Here are some ways to view your traces in the UI:

<CollapserGroup>
  <Collapser
    id="entity-explorer"
    title="View traces that include a specific service"
  >
    Here's one way you can see traces for a particular service:

    1. Go to **[one.newrelic.com](https://one.newrelic.com/)**.
    2. Click **APM** in the top menu bar.
    3. Click your service.
    4. In the left navigation's **Monitor** section, click **Distributed tracing**.
    5. If you don't see the traces you want, you can filter by the `trace.id`.
  </Collapser>

  <Collapser
    id="dt-launcher"
    title="View traces across accounts"
  >
    This option allows you to search all traces across all New Relic accounts in your organization that you have access to.

    1. Go to **[one.newrelic.com](https://one.newrelic.com/)**.
    2. Click **Browse data** in the top menu bar, and then click **Traces**.
    3. Select your entity in the left pane.
    4. If you don't see the traces you want, you can filter by the `trace.id`.
  </Collapser>

  <Collapser
    id="logs-context"
    title="Examine logs for trace details"
  >
    You can bring your logs and application's data together to make troubleshooting easier and faster. With [logs in context](/docs/logs/logs-context/configure-logs-context-apm-agents/), you can see log messages related to your errors and traces directly in your app's UI.

    1. From the **Transactions** page, click on a trace to go to the [**Trace details** page](/docs/apm/transactions/transaction-traces/transaction-traces-trace-details-page).
    2. From the trace details page, click **See logs**.
    3. To view details related to an individual log message, click directly on the message.
  </Collapser>
</CollapserGroup>

For more help finding your traces in the UI:

* [Understand and use the distributed tracing UI](/docs/distributed-tracing/ui-data/understand-use-distributed-tracing-ui)
* [Query distributed trace data](/docs/understand-dependencies/distributed-tracing/ui-data/query-distributed-trace-data)

## Set up Infinite Tracing (advanced option) [#infinite-tracing] 

Standard distributed tracing for APM agents ([above](#quick-start-apm)) captures up to 10% of your traces, but if you want us to analyze all your data and find the most relevant traces, you can set up Infinite Tracing. 

<Callout variant="tip">
To learn more about this feature, see [Infinite Tracing](/docs/understand-dependencies/distributed-tracing/infinite-tracing/introduction-infinite-tracing).
</Callout>

Before beginning, first ensure you meet [the requirements](/docs/understand-dependencies/distributed-tracing/infinite-tracing/introduction-infinite-tracing#requirements).

### Step 1. Complete the instrumentation for standard distributed tracing in the guided installation above

The Infinite Tracing setup builds on the instrumentation step from the [guided installation](#quick-start-apm) for standard distributed tracing.

### Step 2. Set up the trace observer [#provision-trace-observer]

The trace observer is a New Relic AWS-based service that collects and analyzes all your traces. Follow the instructions in <a href="/docs/understand-dependencies/distributed-tracing/infinite-tracing/set-trace-observer" target="_blank">Set up trace observer</a>. When you're done, return here with your trace observer information and continue with the next step to configure the agent.

### Step 3: Configure the agent for Infinite Tracing

Infinite Tracing configuration settings include the standard distributed tracing plus information about the trace observer.

<Callout variant="important">
  Server-side configuration is not available for Infinite Tracing.
</Callout>

<CollapserGroup>
  <Collapser
    id="php-config"
    title="PHP Infinite Tracing configurations"
  >
    Here's an overview of the settings. For more help with configuration, see [PHP agent configuration](/docs/apm/agents/php-agent/configuration/php-agent-configuration).

    <table>
      <thead>
        <tr>
          <th style={{ width: "200px" }}>
            Type
          </th>

          <th>
            Required configuration
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            Infinite Tracing
          </td>

          <td>
            Configuration options:

            * Configuration file (`newrelic.ini`):

              ```
              newrelic.distributed_tracing_enabled = true
              newrelic.span_events_enabled = true
              newrelic.infinite_tracing.trace_observer.host= "<var><a href="/docs/understand-dependencies/distributed-tracing/infinite-tracing/set-trace-observer#ui-endpoints">YOUR_TRACE_OBSERVER_HOST</a></var>"
              ```
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>
</CollapserGroup>

### Step 4. (Optional) Customize Infinite Tracing

After you add the agent configuration settings, you should start seeing data in the New Relic UI. After you spend some time analyzing your data, you may want to adjust some of the features of Infinite Tracing:

* [Configure trace observer monitoring](/docs/distributed-tracing/infinite-tracing/infinite-tracing-configure-trace-observer-monitoring)
* [Configure span attribute trace filter](/docs/distributed-tracing/infinite-tracing/infinite-tracing-configure-span-attribute-trace-filter)
* [Configure random trace filter](/docs/distributed-tracing/infinite-tracing/infinite-tracing-configure-random-trace-filter)

## Options for older PHP agents [#older-agents]

If you have older APM agents, confirm the distributed tracing features you want are supported before enabling it.

### Compatibility guide [#compatibility]

After reviewing the compatibility information below, see [Configure your older PHP agents](#configure-agents).

  <Collapser
    id="php-version"
    title="PHP agent compatibility"
  >
    [Install](/docs/agents/php-agent/getting-started/introduction-new-relic-php) or [update](/docs/agents/php-agent/installation/upgrade-php-agent) to the required PHP agent version. For best results, update to the [latest PHP agent version](/docs/release-notes/agent-release-notes/php-release-notes).

    <table>
      <thead>
        <tr>
          <th style={{ width: "250px" }}>
            Option
          </th>

          <th>
            PHP agent version
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            Standard distributed tracing
          </td>

          <td>
            8.4 or higher

            With W3C Trace Context: 9.8 or higher
          </td>
        </tr>

        <tr>
          <td>
            Infinite Tracing
          </td>

          <td>
            9.12.0.268 or higher
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>

### Configure your older PHP agents [#configure-agents]

Distributed tracing is enabled through configuration settings. Review the following PHP-specific sections. For general help with agent configurations, see [Configure the agent](/docs/agents/manage-apm-agents/configuration/configure-agent).

<Callout variant="important">
  Server-side configuration is not available for Infinite Tracing.
</Callout>

<CollapserGroup>
  <Collapser
    id="php-config-standard"
    title="PHP configurations"
  >
    Here's an overview of the settings. For more help with configuration, see [Distributed tracing for the PHP agent](/docs/agents/php-agent/features/distributed-tracing-php-agent)

    <table>
      <thead>
        <tr>
          <th style={{ width: "200px" }}>
            Type
          </th>

          <th>
            Required configuration
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            Standard distributed tracing
          </td>

          <td>
            Configuration file options in `newrelic.ini`:

            * Enable distributed tracing:

              ```
              newrelic.distributed_tracing_enabled = true
              ```
            * Set [transaction tracer](/docs/agents/php-agent/configuration/php-agent-configuration#inivar-tt-settings)

              ```
              newrelic.transaction_tracer.enabled = true
              ```
            * Set [transaction tracer threshold](/docs/agents/php-agent/configuration/php-agent-configuration#inivar-tt-threshold) to a suitable value:
              * If you want to make all transactions eligible for a distributed trace, set this value to `0` seconds.
              * If you are only interested in traces for longer running transactions, or if generating a trace for every transaction creates unacceptable application performance, set this value higher than `0` seconds.

            ```
            newrelic.transaction_tracer.threshold = 0
            ```
            * Optionally, if you only want W3C Trace Context tracing, you can disable the New Relic distributed tracing headers the `newrelic.distributed_tracing_exclude_newrelic_header` configuration option:

            ```
            newrelic.distributed_tracing_exclude_newrelic_header = 1
            ```

            * Enable spans with the configuration setting:

            ```
            newrelic.span_events_enabled = true
            ```
          </td>
        </tr>
          <tr>
            <td>
              Infinite Tracing
            </td>

            <td>
              Configuration options:

              * Configuration file (`newrelic.ini`):

                ```
                newrelic.distributed_tracing_enabled = true
                newrelic.span_events_enabled = true
                newrelic.infinite_tracing.trace_observer.host= "<var><a href="/docs/understand-dependencies/distributed-tracing/infinite-tracing/set-trace-observer#ui-endpoints">YOUR_TRACE_OBSERVER_HOST</a>"</var>
                ```
            </td>
        </tr>
      </tbody>
    </table>
  </Collapser>
</CollapserGroup>

<Callout variant="tip">
  If you need help with proxy configuration, see [Proxy support](/docs/understand-dependencies/distributed-tracing/other-requirements/infinite-tracing-proxy-support).
</Callout>

## Set trace detail level [#performance]

Distributed tracing support depends on the PHP agent's [transaction tracer](/docs/agents/php-agent/configuration/php-agent-configuration#inivar-tt-enable). When [distributed tracing is enabled](#enable-distributed), a [span](/docs/apm/distributed-tracing/ui-data/distributed-tracing-attributes) is created for each segment seen by the transaction tracer.

As [spans are sampled](/docs/apm/distributed-tracing/getting-started/how-new-relic-distributed-tracing-works), the PHP agent will prioritize spans related to external calls above other spans, which are then recorded in descending order of their duration.

If you find that there are too many unimportant spans being reported for PHP function calls, you can reduce the detail of the transaction tracer by setting [`newrelic.transaction_tracer.detail`](/docs/agents/php-agent/configuration/php-agent-configuration#inivar-tt-detail) to `0`. You may then use the [`newrelic.transaction_tracer.custom`](/docs/agents/php-agent/configuration/php-agent-configuration#inivar-tt-custom) configuration setting or the [`newrelic_add_custom_tracer`](/docs/agents/php-agent/php-agent-api/newrelic_add_custom_tracer) API method to add trace segments and spans for the specific PHP function or methods you want to add to your traces.

<Callout variant="important">
  For PHP agent versions 8.4 to 8.7: When distributed tracing is enabled, these versions behave as if [`newrelic.transaction_tracer.detail`](/docs/agents/php-agent/configuration/php-agent-configuration#inivar-tt-detail) is set to `0` (as described above), which results in PHP function calls not generating spans. To get spans related to PHP function calls, update to version 9.0 or higher.
</Callout>

## Examine logs for trace details [#logs-context]

You can bring your logs and application's data together to make troubleshooting easier and faster. With [logs in context](/docs/logs/logs-context/configure-logs-context-php/), you can see log messages related to your errors and traces directly in your app's UI.

1. From the **Transactions** page, click on a trace to go to the [**Trace details** page](/docs/apm/transactions/transaction-traces/transaction-traces-trace-details-page).
2. From the trace details page, click **See logs**.
3. To view details related to an individual log message, click directly on the message.


  <img
    src={LogsInContexTraces}
    title="Logs in context of APM trace details"
    alt="Logs in context of APM trace details"
  />

  <figcaption>
    With logs in context, you can examine log data directly within your trace details.
  </figcaption>

You can also see logs in context of your [infrastructure data](/docs/logs/forward-logs/forward-your-logs-using-infrastructure-agent/), such as Kubernetes clusters. No need to switch to another UI page in New Relic One.

## Manual instrumentation (if automatic instrumentation doesn't work) [#manual-instrumentation]

**Recommendation:** Before performing any custom instrumentation, read:

* [How distributed tracing works](/docs/apm/distributed-tracing/getting-started/how-new-relic-distributed-tracing-works)
* [Troubleshoot missing data](/docs/apm/distributed-tracing/troubleshooting/troubleshooting-missing-trace-data)

If a service is not passing the trace header to other services, you can use the distributed tracing payload APIs to instrument the [calling service](#calling-service) and the [called service](#called-service). The calling service uses an API call to generate a payload, which is accepted by the called service.

<CollapserGroup>
  <Collapser
    id="calling-service"
    title="Instrument the calling service"
  >
    To instrument the calling service:

    1. Ensure the [version of the APM agent](#compatibility-requirements) that monitors the calling service supports distributed tracing.
    2. Invoke the agent API call for generating a distributed trace payload: [PHP](/docs/agents/php-agent/features/distributed-tracing-php#manual).

  <Callout variant="important">
         To maintain proper ordering of spans in a trace, ensure you **generate the payload in the context of the span that sends it**.
  </Callout>
    3. Add that payload to the call made to the destination service (for example, in a header).
  </Collapser>
  <Collapser
    id="called-service"
    title="Instrument the called service"
  >
    To instrument the called service:

    1. Ensure the [version of the APM agent](#compatibility-requirements) that monitors the called service supports distributed tracing.
    2. If the New Relic agent on the called service does not identify a New Relic transaction, use the agent API to declare a transaction:

        <Collapser
          id="php-create"
          title="PHP"
        >
          One way to tell that a transaction is not in progress: `newrelic_insert_distributed_trace_headers()` returns `false`. To create a transaction, see [newrelic_start_transaction](/docs/agents/php-agent/php-agent-api/newrelic_start_transaction).
        </Collapser>
    3. Extract the payload from the call that you received (for example, in a header).
    4. Invoke the call for accepting the payload: [PHP](/docs/agents/php-agent/features/distributed-tracing-php#manual).
  </Collapser>
</CollapserGroup>

## Manually instrument applications and services with PHP agent API [#manual]


<Callout variant="important">
  W3C Trace Context support was added in version 9.8. With this, the API for manually instrumenting applications has changed from the JSON payload related functions

  `newrelic_create_distributed_trace_payload()` and `newrelic_accept_distributed_trace_payload($payload),`

  to the header array forms `newrelic_insert_distributed_trace_headers($outbound_headers)` and `newrelic_accept_distributed_trace_headers($inbound_headers)`.

  The JSON functions are now considered deprecated, and will be removed in a future release.
</Callout>

If you're using an unsupported library, or have a non-HTTP based distributed system component (such as messaging queues), you can use the PHP agent API to manually identify transactions to be included in a distributed trace. This is a two step process:

1. Modify your service or application to **create** or **insert** the distributed tracing data
2. Modify your service or application to **accept** distributed trace data created by other transactions or requests.

The following example uses a generic message/job queue. While the actual details will vary depending on what sort of system you're trying to add to a distributed trace, the core concepts are the same. Also, while we've used a job queue as an example, you can use these methods with **any** distributed system component.

<Callout variant="tip">
  When you **create a payload** or **insert headers**, you're telling New Relic you want this request or transaction or request to participate in a distributed trace. When you **accept** them, you're linking the current request or transaction with its parent request or transaction.
</Callout>

For more information about using manual instrumentation to get more detail or to see connections between services, see the documentation about [distributed tracing APIs](/docs/apm/distributed-tracing/enable-configure/enable-distributed-tracing#agent-apis).

### Header API [#header-api]

<CollapserGroup>
  <Collapser
    id="example-dt-create"
    title="Insert distributed trace headers"
  >
    Somewhere in your application you'll have code that looks or acts like the following:

    ```
    // create a job object
    $job = new \Generic\Queue\Job;

    // set the information needed to run the queue job
    $job->setData('info', $info);

    // save the job
    $job->save();
    ```

    If you want this job to appear in a distributed trace, you need to insert distributed trace headers into an array by using `newrelic_insert_distributed_trace_headers`, and then add those headers to the job's data:

    ```
    $outbound_headers = array();
    if (newrelic_insert_distributed_trace_headers($outbound_headers)) {

        // create a job object
        $job = new \Generic\Queue\Job;

        // set the information needed to run the queue job
        $job->setData('info', $info);

        // add the headers to the job data
        $job->setData('nr_dt_headers', $outbound_headers);

        // save the job
        $job->save();
    } else {
        echo "Unable to obtain distributed tracing headers";
    }
    ```

    <Callout variant="tip">
      Tip: The headers created via `newrelic_insert_distributed_trace_headers()` are HTTP safe.
    </Callout>

    This is step one: You've inserted the distributed trace headers.
  </Collapser>

  <Collapser
    id="example-dt-accept"
    title="Accept the distributed tracing headers"
  >
    Next, somewhere in your application stack you'll have a queue runner that looks or acts like the following:

    ```
    // create the job runner
    $jobRunner = \Generic\Queue\Runner;

    // grab jobs until there aren't any
    while($job = $jobRunner->next()) {
        // run the job
        $job->run();
    }
    ```

    In order to accept distributed trace headers, use the `newrelic_accept_distributed_trace_headers` function

    ```
    // create the job runner
    $jobRunner = \Generic\Queue\Runner;

    while($job = $jobRunner->next()) {
        $inbound_headers = $job->getData('nr_dt_headers');
        if($inbound_headers) {
            newrelic_accept_distributed_trace_headers($inbound_headers);
        }
        $job->run();
    }
    ```
  </Collapser>
</CollapserGroup>

### Payload API (deprecated)

<CollapserGroup>
  <Collapser
    id="example-dt-create"
    title="Create a distributed trace payload"
  >
    Somewhere in your application you'll have code that looks or acts like the following:

    ```
    // create a job object
    $job = new \Generic\Queue\Job;

    // set the information needed to run the queue job
    $job->setData('info', $info);

    // save the job
    $job->save();
    ```

    If you want this job to appear in a distributed trace, you need to create a distributed trace payload using `newrelic_create_distributed_trace_payload`, and then add that payload to the job's data:

    ```
    $payload = newrelic_create_distributed_trace_payload();

    // create a job object
    $job = new \Generic\Queue\Job;

    // set the information needed to run the queue job
    $job->setData('info', $info);

    // add the payload data to the job data as a text json string
    $job->setData('dt_payload', $payload->Text());

    // save the job
    $job->save();
    ```

    This is step one: You've created a distributed trace payload.
  </Collapser>

  <Collapser
    id="example-dt-accept"
    title="Accept the distributed tracing payload"
  >
    Next, somewhere in your application stack you'll have a queue runner that looks or acts like the following:

    ```
    // create the job runner
    $jobRunner = \Generic\Queue\Runner;

    // grab jobs until there aren't any
    while($job = $jobRunner->next()) {
        // run the job
        $job->run();
    }
    ```

    In order to accept a distributed trace payload, use the `newrelic_accept_distributed_trace_payload` function

    ```
    // create the job runner
    $jobRunner = \Generic\Queue\Runner;

    while($job = $jobRunner->next()) {
        $payload = $job->getData('dt_payload');
        if($payload) {
            newrelic_accept_distributed_trace_payload($payload);
        }
        $job->run();
    }
    ```
  </Collapser>

  <Collapser
    id="example-dt-accept"
    title="Optional: Use HTTP safe payload strings"
  >
    If you need to transport the payload via a mechanism that requires HTTP safe strings, (HTTP headers, URL query strings, POST fields, etc.), the API includes distributed tracing methods and functions that will create and accept HTTP safe versions of the strings.

    ```
    // create the HTTP safe payload string 
    $payload = newrelic_create_distributed_trace_payload();
    $httpSafePayload = $payload->httpSafe();

    // ...

    // accept the HTTP safe payload string
    newrelic_accept_distributed_trace_payload_httpsafe($httpSafePayload);
    ```
  </Collapser>
</CollapserGroup>

## Command line PHP programs [#command-line]

PHP programs run from the PHP command line are always sampled by the agent's distributed tracer. Depending on the programs you run, these processes could see an over-representation in your collection of distributed traces. In these situations, you can opt to disable command line instrumentation by using the [`per-directory newrelic.enabled`](/docs/agents/php-agent/configuration/php-agent-configuration) setting in your `newrelic.ini files`.
