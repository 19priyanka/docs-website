---
title: Using the Node.js Agent in an ES Module application
tags:
  - Agents
  - Nodejs agent
  - ESM
  - ES Modules
  - Experimental
metaDescription: How to install and configure your Node.js APM agent for an application that uses ES Modules.
---

<Callout variant="caution">
  Node.js APM agent support for instrumentation in [ES Module](https://nodejs.org/api/esm.html) applications is experimental.
  The agent is reliant on an experimental Node.js feature in order to register instrumentation.
  Breaking changes can occur until the Node.js API for [ES Module Loaders](https://nodejs.org/api/esm.html#loaders) is stable.
</Callout>

<Callout variant="important">
  The minimum supported version of Node.js when using the Node.js APM agent in ES Module applications is v16.12.0.
</Callout>

## Overview
Prior to v12.0.0, Node.js only officially supported managing code using CommonJS modules.
CommonJS modules use `module.exports` and `require()` statements to manage code.
```js
'use strict'

const bar = require('./bar')

function echoBar() {
  console.log('this is bar:', bar)
}

module.exports = { 
  echoBar
}
```

Since Node.js v12.0.0, there are now two module systems officially supported: CommonJS and ECMAScript Modules (ES Modules/"ESM").
ES Modules use `import` and `export` statements instead of `require()` and `module.exports`.
```js
'use strict'

import bar from './bar.js'

export function echoBar() {
  console.log('this is bar:', bar)
}
```

ES Modules are the official ECMAScript standard for code management, and are the standard way browsers and other JS runtimes manage packages. In order to support
the evolving Node.js ecosystem, both now and in the future, the agent supports instrumenting applications written using ES Modules, as of version 9.1.0 of the agent.
The Node.js APM agent also continues to support CommonJS applications.

## Agent Setup

In order for the agent to successfully instrument an ES Modules application, you will need to first install the Node.js agent, as described in the [Installation documentation](/docs/apm/agents/nodejs-agent/installation-configuration/install-nodejs-agent).

### Configuration
If your application uses a configuration file to configure the agent, you will need to update update the configuration file's extension to be `.cjs` instead of `.js`.

The agent is written as a CommonJS module; it uses `require()` to read the configuration file in at startup.
By changing the file extension, we explicitly label the agent's configuration file as a CommonJS module, allowing the agent to load it successfully.

Failure to update the file extension may result in the following error during agent startup:
```
New Relic for Node.js is disabled due to an error:
Error [ERR_REQUIRE_ESM]: require() of ES Module /path/to/your/application/newrelic.js from /path/to/your/application/node_modules/newrelic/lib/config/index.js not supported.
```

### Add the ES Module Loader
In order for the agent to properly apply instrumentation within the ES Module ecosystem, you must include the agent's ES Module Loader to your application's invocation.
Adding the Loader to your application can be done by using Node.js' `--experimental-loader` [CLI argument](https://nodejs.org/api/cli.html#--experimental-loadermodule).
```sh
node --experimental-loader newrelic/esm-loader.mjs your-program.js
```

## Learn More
* [Node.js ES Module documentation](https://nodejs.org/api/esm.html#introduction)
* [Node.js Packaging documentation](https://nodejs.org/api/packages.html#introduction)
* [ECMAScript Standards documentation](https://tc39.es/ecma262/#sec-modules)